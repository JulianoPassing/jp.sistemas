<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JP-Caixa - Produtos</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/6N82fk2.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body class="app-layout">
  <header>
    <div class="header-content">
      <a href="index.html" class="logo" style="display: flex; align-items: center;">
        <img src="https://i.imgur.com/EQ1tjZX.png" alt="JP-Caixa" style="height: 5rem; width: auto; object-fit: contain;">
      </a>
      <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
      <div class="nav-wrapper">
        <nav>
          <a href="painel.html" class="nav-link">Painel</a>
          <a href="caixa.html" class="nav-link">Caixa</a>
          <a href="produtos.html" class="nav-link active">Produtos</a>
          <a href="vendas.html" class="nav-link">Vendas</a>
          <a href="#" class="nav-link" onclick="sair()">Sair</a>
        </nav>
      </div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="dashboard-header">
        <div class="welcome-message">Gerenciamento de Produtos</div>
        <div class="dashboard-title">Produtos</div>
        <div class="dashboard-subtitle">Cadastre e gerencie seus produtos</div>
      </div>

      <!-- Busca e Filtros -->
      <div class="search-container">
        <div style="display: flex; gap: 1rem; width: 100%;">
          <div style="flex: 1;">
            <input type="text" id="searchInput" placeholder="Buscar produtos..." class="form-input">
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <select id="categoriaFilter" class="form-input">
              <option value="">Todas as categorias</option>
              <option value="alimentos">Alimentos</option>
              <option value="bebidas">Bebidas</option>
              <option value="limpeza">Limpeza</option>
              <option value="higiene">Higiene</option>
              <option value="outros">Outros</option>
            </select>
            <button class="btn btn-primary" onclick="buscarProdutos()">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
        </div>
      </div>

      <!-- Botão Adicionar Produto -->
      <div class="section-header" style="margin-bottom: 1rem;">
        <button class="btn btn-primary" onclick="abrirModalProduto()">
          <i class="fas fa-plus"></i> Adicionar Produto
        </button>
      </div>

      <!-- Lista de Produtos -->
      <div class="section">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Código</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Preço</th>
                <th>Estoque</th>
                <th>Estoque Mínimo</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="produtosTable">
              <tr>
                <td colspan="8" class="text-center text-gray-500">Carregando produtos...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de Produto -->
  <div id="modalProduto" class="modal">
    <div class="modal-overlay" onclick="fecharModalProduto()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Adicionar Produto</h3>
        <button class="modal-close" onclick="fecharModalProduto()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="produtoForm">
          <div class="grid grid-cols-2" style="gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Código do Produto</label>
              <input type="text" id="codigo" name="codigo" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Nome do Produto</label>
              <input type="text" id="nome" name="nome" class="form-input" required>
            </div>
          </div>
          
          <div class="grid grid-cols-2" style="gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Categoria</label>
              <select id="categoria" name="categoria" class="form-input" required>
                <option value="">Selecione uma categoria</option>
                <option value="alimentos">Alimentos</option>
                <option value="bebidas">Bebidas</option>
                <option value="limpeza">Limpeza</option>
                <option value="higiene">Higiene</option>
                <option value="outros">Outros</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Preço (R$)</label>
              <input type="number" id="preco" name="preco" class="form-input" step="0.01" min="0" required>
            </div>
          </div>
          
          <div class="grid grid-cols-2" style="gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Estoque Atual</label>
              <input type="number" id="estoque" name="estoque" class="form-input" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Estoque Mínimo</label>
              <input type="number" id="estoqueMinimo" name="estoqueMinimo" class="form-input" min="0" required>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Descrição</label>
            <textarea id="descricao" name="descricao" class="form-input" rows="3"></textarea>
          </div>
          
          <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
            <button type="button" class="btn btn-secondary" onclick="fecharModalProduto()">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">Salvar Produto</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer class="text-center p-4 mt-8">
    © 2024 JP-Caixa. Todos os direitos reservados.
  </footer>
  
  <script src="./js/main.js"></script>
  <script>
    // Verificar autenticação
    if (sessionStorage.getItem('loggedIn') !== 'true') {
      window.location.href = 'login.html';
    }

    // Função de logout
    function sair() {
      sessionStorage.removeItem('loggedIn');
      sessionStorage.removeItem('username');
      sessionStorage.removeItem('loginTime');
      window.location.href = 'login.html';
    }

    let produtoEditando = null;

    // Carregar produtos
    async function carregarProdutos() {
      try {
        const response = await fetch('/api/caixa/produtos', {
          credentials: 'include'
        });
        
        if (response.ok) {
          const produtos = await response.json();
          renderizarProdutos(produtos);
        } else {
          mostrarNotificacao('Erro ao carregar produtos', 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao carregar produtos', 'error');
      }
    }

    // Renderizar produtos na tabela
    function renderizarProdutos(produtos) {
      const tbody = document.getElementById('produtosTable');
      
      if (produtos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">Nenhum produto encontrado</td></tr>';
        return;
      }

      tbody.innerHTML = produtos.map(produto => `
        <tr>
          <td>${produto.codigo}</td>
          <td>${produto.nome}</td>
          <td>${produto.categoria}</td>
          <td>R$ ${produto.preco.toFixed(2)}</td>
          <td>${produto.estoque}</td>
          <td>${produto.estoqueMinimo}</td>
          <td>
            ${produto.estoque <= produto.estoqueMinimo 
              ? '<span class="badge badge-warning">Baixo</span>' 
              : '<span class="badge badge-success">OK</span>'
            }
          </td>
          <td>
            <button class="btn btn-secondary" onclick="editarProduto(${produto.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger" onclick="excluirProduto(${produto.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Buscar produtos
    async function buscarProdutos() {
      const searchTerm = document.getElementById('searchInput').value;
      const categoria = document.getElementById('categoriaFilter').value;
      
      try {
        const params = new URLSearchParams();
        if (searchTerm) params.append('search', searchTerm);
        if (categoria) params.append('categoria', categoria);
        
        const response = await fetch(`/api/caixa/produtos?${params}`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const produtos = await response.json();
          renderizarProdutos(produtos);
        }
      } catch (error) {
        console.error('Erro na busca:', error);
      }
    }

    // Abrir modal de produto
    function abrirModalProduto(produto = null) {
      produtoEditando = produto;
      const modal = document.getElementById('modalProduto');
      const modalTitle = document.getElementById('modalTitle');
      const form = document.getElementById('produtoForm');
      
      if (produto) {
        modalTitle.textContent = 'Editar Produto';
        preencherFormulario(produto);
      } else {
        modalTitle.textContent = 'Adicionar Produto';
        form.reset();
      }
      
      modal.style.opacity = '1';
      modal.style.visibility = 'visible';
    }

    // Fechar modal
    function fecharModalProduto() {
      const modal = document.getElementById('modalProduto');
      modal.style.opacity = '0';
      modal.style.visibility = 'hidden';
      produtoEditando = null;
    }

    // Preencher formulário para edição
    function preencherFormulario(produto) {
      document.getElementById('codigo').value = produto.codigo;
      document.getElementById('nome').value = produto.nome;
      document.getElementById('categoria').value = produto.categoria;
      document.getElementById('preco').value = produto.preco;
      document.getElementById('estoque').value = produto.estoque;
      document.getElementById('estoqueMinimo').value = produto.estoqueMinimo;
      document.getElementById('descricao').value = produto.descricao || '';
    }

    // Editar produto
    async function editarProduto(id) {
      try {
        const response = await fetch(`/api/caixa/produtos/${id}`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const produto = await response.json();
          abrirModalProduto(produto);
        }
      } catch (error) {
        console.error('Erro ao carregar produto:', error);
        mostrarNotificacao('Erro ao carregar produto', 'error');
      }
    }

    // Excluir produto
    async function excluirProduto(id) {
      if (!confirm('Tem certeza que deseja excluir este produto?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/caixa/produtos/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (response.ok) {
          mostrarNotificacao('Produto excluído com sucesso', 'success');
          carregarProdutos();
        } else {
          mostrarNotificacao('Erro ao excluir produto', 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao excluir produto', 'error');
      }
    }

    // Salvar produto
    document.getElementById('produtoForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const produto = Object.fromEntries(formData.entries());
      
      // Converter preço para número
      produto.preco = parseFloat(produto.preco);
      produto.estoque = parseInt(produto.estoque);
      produto.estoqueMinimo = parseInt(produto.estoqueMinimo);
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Salvando...';
      submitBtn.disabled = true;
      
      try {
        const url = produtoEditando 
          ? `/api/caixa/produtos/${produtoEditando.id}`
          : '/api/caixa/produtos';
        
        const method = produtoEditando ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(produto)
        });
        
        if (response.ok) {
          mostrarNotificacao(
            produtoEditando ? 'Produto atualizado com sucesso' : 'Produto cadastrado com sucesso', 
            'success'
          );
          fecharModalProduto();
          carregarProdutos();
        } else {
          const data = await response.json();
          mostrarNotificacao(data.message || 'Erro ao salvar produto', 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao salvar produto', 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // Busca em tempo real
    document.getElementById('searchInput').addEventListener('input', function() {
      clearTimeout(this.searchTimeout);
      this.searchTimeout = setTimeout(buscarProdutos, 300);
    });

    document.getElementById('categoriaFilter').addEventListener('change', buscarProdutos);

    // Menu mobile
    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('mobile-menu-toggle');
      const navWrapper = document.querySelector('.nav-wrapper');
      
      if (menuBtn && navWrapper) {
        menuBtn.addEventListener('click', function() {
          navWrapper.classList.toggle('open');
        });
      }

      // Carregar produtos iniciais
      carregarProdutos();
    });
  </script>
</body>
</html> 