<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JP-Cobranças - Histórico de Pagamentos</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/6N82fk2.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./css/style.css">
  <style>
    .historico-tabs { display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; }
    .historico-tab { padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
    .historico-tab:hover { color: #002f4b; }
    .historico-tab.active { color: #002f4b; border-bottom-color: #00e6ff; }
    .historico-panel { display: none; }
    .historico-panel.active { display: block; }
    .pagamento-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
    .pagamento-badge.parcela { background: #d1fae5; color: #059669; }
    .pagamento-badge.juros { background: #dbeafe; color: #2563eb; }
    .pagamento-badge.emprestimo { background: #e0e7ff; color: #4f46e5; }
  </style>
</head>
<body class="app-layout">
  <header>
    <div class="header-content">
      <a href="index.html" class="logo" style="display: flex; align-items: center;">
        <img src="https://i.imgur.com/EQ1tjZX.png" alt="JP-Cobranças" style="height: 5rem; width: auto; object-fit: contain;">
      </a>
      <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
      <div class="nav-wrapper">
        <nav>
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="clientes.html" class="nav-link">Clientes</a>
          <a href="adicionar-cliente.html" class="nav-link">Adicionar Cliente</a>
          <a href="cobrancas.html" class="nav-link">Cobranças</a>
          <a href="atrasados.html" class="nav-link">Atrasados</a>
          <a href="lista-negra.html" class="nav-link">Lista Negra</a>
          <a href="emprestimos.html" class="nav-link">Empréstimos</a>
          <a href="historico.html" class="nav-link">Histórico</a>
          <a href="configuracoes.html" class="nav-link">Configurações</a>
          <a href="#" class="nav-link" onclick="sair()">Sair</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <nav class="breadcrumb">
        <a href="dashboard.html">Dashboard</a>
        <span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>
        <span>Histórico</span>
      </nav>
      <div class="page-header">
        <div class="page-header-icon">
          <i class="fas fa-history"></i>
        </div>
        <div class="page-header-text">
        <div class="welcome-message" id="welcomeMessage">Bem-vindo ao sistema JP-Cobranças!</div>
          <h1 class="dashboard-title">Histórico</h1>
          <p class="dashboard-subtitle">Visualize o histórico de pagamentos (parcelas e juros) registrados ao marcar como pago. Todas as datas de pagamento são gravadas automaticamente.</p>
        </div>
      </div>

      <!-- Abas -->
      <div class="historico-tabs">
        <div class="historico-tab active" data-tab="pagamentos">
          <i class="fas fa-money-bill-wave" style="margin-right: 0.5rem;"></i>Histórico de Pagamentos
        </div>
        <div class="historico-tab" data-tab="emprestimos">
          <i class="fas fa-list" style="margin-right: 0.5rem;"></i>Empréstimos
        </div>
      </div>

      <!-- Painel: Histórico de Pagamentos -->
      <div id="panel-pagamentos" class="historico-panel active">
      <div class="section">
          <div class="search-container" style="margin-bottom: 1rem;">
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
              <input type="date" id="filter-pag-data-inicio" class="form-input" style="min-width: 140px;" title="Data início">
              <input type="date" id="filter-pag-data-fim" class="form-input" style="min-width: 140px;" title="Data fim">
              <select id="filter-pag-tipo" class="form-input" style="min-width: 140px;">
                <option value="">Todos os tipos</option>
                <option value="parcela">Parcela</option>
                <option value="emprestimo">Empréstimo</option>
                <option value="juros">Juros</option>
              </select>
              <select id="filter-pag-cliente" class="form-input" style="min-width: 180px;">
                <option value="">Todos os clientes</option>
              </select>
              <button id="btn-buscar-pagamentos" class="btn btn-primary">Buscar</button>
              <button id="btn-limpar-pagamentos" class="btn btn-secondary">Limpar</button>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
              <span id="info-pagamentos">Carregando histórico de pagamentos...</span>
            </div>
          </div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Data Pagamento</th>
                  <th>Cliente</th>
                  <th>Empréstimo</th>
                  <th>Tipo</th>
                  <th>Valor</th>
                  <th>Detalhes</th>
                </tr>
              </thead>
              <tbody id="historico-pagamentos-tbody">
                <tr><td colspan="6"><div class="table-skeleton"><div class="skeleton-row"><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div></div><div class="skeleton-row"><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div></div></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Painel: Empréstimos -->
      <div id="panel-emprestimos" class="historico-panel">
        <div class="section">
          <div class="search-container" style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
              <input type="text" id="search-emprestimos" class="form-input" placeholder="Buscar por cliente, valor..." style="flex: 1; min-width: 200px;">
              <select id="filter-status" class="form-input" style="min-width: 120px;">
                <option value="">Todos os Status</option>
                <option value="Ativo">Ativo</option>
                <option value="Quitado">Quitado</option>
                <option value="Em Atraso">Em Atraso</option>
              </select>
              <input type="date" id="filter-data-inicio" class="form-input" style="min-width: 140px;">
              <input type="date" id="filter-data-fim" class="form-input" style="min-width: 140px;">
              <button id="clear-filters" class="btn btn-secondary">Limpar</button>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
            <span id="results-info">Mostrando todos os empréstimos</span>
          </div>
        </div>
        <div class="section-header">
          <h3 class="section-title">Empréstimos</h3>
          <button id="btn-novo-emprestimo" class="btn btn-primary">Novo Empréstimo</button>
        </div>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                  <th>Valor emprestado</th>
                  <th>Valor final</th>
                  <th>Data do empréstimo</th>
                <th>Vencimento</th>
                <th>Status</th>
                  <th>Histórico (pagas/pend/atrasadas)</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="emprestimos-tbody">
                <tr><td colspan="8"><div class="table-skeleton"><div class="skeleton-row"><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div></div><div class="skeleton-row"><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div></div></div></td></tr>
            </tbody>
          </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de Detalhes do Empréstimo -->
  <div id="modal-detalhes" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="fecharModal()"></div>
    <div class="modal-content modal-detalhes-emprestimo">
      <div class="modal-header">
        <h3>Detalhes do Empréstimo</h3>
        <button class="modal-close" onclick="fecharModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="section">
          <h4 class="section-title">Informações Gerais</h4>
          <div class="grid grid-cols-2">
            <div><label class="form-label">Cliente:</label><p id="modal-cliente" class="font-semibold"></p></div>
            <div><label class="form-label">Telefone:</label><p id="modal-telefone"></p></div>
            <div><label class="form-label">Valor Inicial:</label><p id="modal-valor-inicial" class="font-semibold text-green-600"></p></div>
            <div><label class="form-label">Valor Final:</label><p id="modal-valor-final" class="font-semibold text-terciary"></p></div>
            <div><label class="form-label">Data do Empréstimo:</label><p id="modal-data-emprestimo"></p></div>
            <div><label class="form-label">Vencimento:</label><p id="modal-vencimento"></p></div>
            <div><label class="form-label">Juros Mensal:</label><p id="modal-juros"></p></div>
            <div><label class="form-label">Status:</label><p id="modal-status"></p></div>
            </div>
          <div><label class="form-label">Observações:</label><p id="modal-observacoes" class="modal-observacoes"></p></div>
            </div>
        <div class="section">
          <h4 class="section-title">Parcelas (com datas de pagamento)</h4>
          <div id="parcelas-container" class="parcelas-detalhadas"></div>
          </div>
        <div class="section">
          <h4 class="section-title">Resumo de Pagamentos</h4>
          <div class="grid grid-cols-3">
            <div class="resumo-card resumo-pagas"><div class="text-sm text-gray-600">Parcelas Pagas</div><div id="resumo-pagas" class="text-lg font-semibold text-green-600">0</div></div>
            <div class="resumo-card resumo-pendentes"><div class="text-sm text-gray-600">Parcelas Pendentes</div><div id="resumo-pendentes" class="text-lg font-semibold text-yellow-500">0</div></div>
            <div class="resumo-card resumo-atrasadas"><div class="text-sm text-gray-600">Parcelas Atrasadas</div><div id="resumo-atrasadas" class="text-lg font-semibold text-red-600">0</div></div>
            </div>
            </div>
      </div>
    </div>
  </div>

  <footer class="text-center p-4 mt-8">
    © 2025 JP. Sistemas. Todos os direitos reservados. | jp-sistemas.com
  </footer>

  <script src="./js/main.js"></script>
  <script>
    let todosEmprestimos = [];
    let emprestimosFiltrados = [];
    let emprestimosProcessados = [];
    let historicoPagamentos = [];
    let historicoCompletoParaEmprestimos = []; // Histórico sem filtros, usado na coluna Histórico da aba Empréstimos

    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('mobile-menu-toggle');
      const navWrapper = document.querySelector('.nav-wrapper');
      if (menuBtn && navWrapper) {
        menuBtn.addEventListener('click', () => navWrapper.classList.toggle('open'));
      }

      // Abas
      document.querySelectorAll('.historico-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.historico-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.historico-panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
        });
      });

      // Restaurar filtros salvos
      const fPag = typeof loadFilters === 'function' ? loadFilters('historico-pagamentos') : {};
      if (fPag.data_inicio) document.getElementById('filter-pag-data-inicio').value = fPag.data_inicio;
      if (fPag.data_fim) document.getElementById('filter-pag-data-fim').value = fPag.data_fim;
      if (fPag.tipo) document.getElementById('filter-pag-tipo').value = fPag.tipo;
      if (fPag.cliente_id) document.getElementById('filter-pag-cliente').value = fPag.cliente_id;
      const fEmp = typeof loadFilters === 'function' ? loadFilters('historico-emprestimos') : {};
      if (fEmp.search) document.getElementById('search-emprestimos').value = fEmp.search;
      if (fEmp.status) document.getElementById('filter-status').value = fEmp.status;
      if (fEmp.data_inicio) document.getElementById('filter-data-inicio').value = fEmp.data_inicio;
      if (fEmp.data_fim) document.getElementById('filter-data-fim').value = fEmp.data_fim;

      // Histórico de Pagamentos
      carregarHistoricoPagamentos();
      carregarClientesParaFiltro();
      document.getElementById('btn-buscar-pagamentos').addEventListener('click', () => {
        if (typeof saveFilters === 'function') saveFilters('historico-pagamentos', {
          data_inicio: document.getElementById('filter-pag-data-inicio').value,
          data_fim: document.getElementById('filter-pag-data-fim').value,
          tipo: document.getElementById('filter-pag-tipo').value,
          cliente_id: document.getElementById('filter-pag-cliente').value
        });
        carregarHistoricoPagamentos();
      });
      document.getElementById('btn-limpar-pagamentos').addEventListener('click', () => {
        document.getElementById('filter-pag-data-inicio').value = '';
        document.getElementById('filter-pag-data-fim').value = '';
        document.getElementById('filter-pag-tipo').value = '';
        document.getElementById('filter-pag-cliente').value = '';
        if (typeof saveFilters === 'function') saveFilters('historico-pagamentos', {});
        carregarHistoricoPagamentos();
      });

      // Empréstimos
      carregarEmprestimos();
      document.getElementById('search-emprestimos').addEventListener('input', aplicarFiltros);
      document.getElementById('filter-status').addEventListener('change', aplicarFiltros);
      document.getElementById('filter-data-inicio').addEventListener('change', aplicarFiltros);
      document.getElementById('filter-data-fim').addEventListener('change', aplicarFiltros);
      document.getElementById('clear-filters').addEventListener('click', limparFiltros);
      document.getElementById('btn-novo-emprestimo').addEventListener('click', () => { if (window.novoEmprestimo) window.novoEmprestimo(); else window.location.href = 'emprestimos.html'; });

      window.addEventListener('resize', () => {
        if (emprestimosFiltrados.length > 0) renderizarEmprestimos();
      });
    });

    async function carregarClientesParaFiltro() {
      try {
        const clientes = await apiService.getClientes();
        const sel = document.getElementById('filter-pag-cliente');
        sel.innerHTML = '<option value="">Todos os clientes</option>';
        (clientes || []).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.nome || c.razao || 'N/A';
          sel.appendChild(opt);
        });
      } catch (e) { console.error(e); }
    }

    async function carregarHistoricoPagamentos() {
      const tbody = document.getElementById('historico-pagamentos-tbody');
      const info = document.getElementById('info-pagamentos');
      tbody.innerHTML = typeof getSkeletonRows === 'function' ? getSkeletonRows(6, 3) : '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';
      try {
        const params = {};
        const di = document.getElementById('filter-pag-data-inicio').value;
        const df = document.getElementById('filter-pag-data-fim').value;
        const tipo = document.getElementById('filter-pag-tipo').value;
        const cliente = document.getElementById('filter-pag-cliente').value;
        if (di) params.data_inicio = di;
        if (df) params.data_fim = df;
        if (tipo) params.tipo = tipo;
        if (cliente) params.cliente_id = cliente;

        historicoPagamentos = await apiService.getHistoricoPagamentos(params);

        if (!historicoPagamentos || historicoPagamentos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-money-bill-wave empty-state-icon"></i><div class="empty-state-title">Nenhum pagamento registrado</div><div class="empty-state-text">Os pagamentos são gravados automaticamente quando você marca parcelas ou juros como pagos no Dashboard ou Empréstimos.</div></div></td></tr>';
          info.textContent = 'Nenhum pagamento encontrado';
        } else {
          tbody.innerHTML = '';
          historicoPagamentos.forEach(p => {
            const dataStr = p.data_pagamento ? utils.formatDate(p.data_pagamento) : '-';
            const valorStr = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(p.valor || 0);
            const tipo = (p.tipo_pagamento || '').toLowerCase();
            const tipoClass = tipo === 'juros' ? 'juros' : tipo === 'emprestimo' ? 'emprestimo' : 'parcela';
            const detalhes = p.observacoes || '-';
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><strong>${dataStr}</strong></td>
              <td>${p.cliente_nome || 'N/A'}</td>
              <td>#${p.emprestimo_id || '-'}</td>
              <td><span class="pagamento-badge ${tipoClass}">${p.tipo_pagamento || 'Parcela'}</span></td>
              <td class="font-semibold text-green-600">${valorStr}</td>
              <td class="text-sm text-gray-600">${detalhes}</td>
            `;
            tbody.appendChild(row);
          });
          info.textContent = `Mostrando ${historicoPagamentos.length} pagamento(s)`;
        }
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500">Erro ao carregar histórico. Tente novamente.</td></tr>';
        info.textContent = 'Erro ao carregar';
      }
    }

    // Mesma lógica do emprestimos.html - status e datas corretos
    // Histórico (pagas/pend/atrasadas) puxa do mesmo lugar: historico de pagamentos
    async function carregarEmprestimos() {
      try {
        await fetch('/api/cobrancas/corrigir-status-emprestimos', { method: 'POST', credentials: 'include' }).catch(() => {});

        // Carregar histórico de pagamentos (sem filtros) para usar na coluna Histórico - mesma fonte da aba Histórico de Pagamentos
        const historicoCompleto = await apiService.getHistoricoPagamentos({}).catch(() => []);
        historicoCompletoParaEmprestimos = Array.isArray(historicoCompleto) ? historicoCompleto : [];

        const rawList = await apiService.getEmprestimos();
        const byId = new Map();
        (Array.isArray(rawList) ? rawList : []).forEach(e => { if (e && e.id != null && !byId.has(e.id)) byId.set(e.id, e); });
        const lista = Array.from(byId.values());

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        emprestimosProcessados = [];
        for (const emp of lista) {
          const valorFinal = Number(emp.valor_final || emp.valor || 0);
          const valorInicial = Number(emp.valor_inicial || emp.valor || 0);
          let vencimentoExibir = emp.data_vencimento;
          let status = (emp.status || '').toUpperCase();

          if (emp.tipo_emprestimo === 'in_installments' && emp.numero_parcelas > 1) {
            try {
              const parcelas = await apiService.getParcelasEmprestimo(emp.id);
              emp.parcelas = parcelas || [];
              if (emp.parcelas.length > 0) {
                const todasPagas = emp.parcelas.every(p => p.status === 'Paga');
                const parcelasNaoPagas = emp.parcelas.filter(p => p.status !== 'Paga');
                if (todasPagas) {
                  status = 'QUITADO';
                } else {
                  const parcelasAtrasadas = parcelasNaoPagas.filter(p => {
                    const dv = utils.createValidDate(p.data_vencimento);
                    return dv && dv < hoje;
                  });
                  if (parcelasAtrasadas.length > 0) {
                    status = 'ATRASADO';
                    parcelasAtrasadas.sort((a, b) => utils.createValidDate(a.data_vencimento) - utils.createValidDate(b.data_vencimento));
                    vencimentoExibir = parcelasAtrasadas[0].data_vencimento;
                } else {
                    status = 'ATIVO';
                    parcelasNaoPagas.sort((a, b) => utils.createValidDate(a.data_vencimento) - utils.createValidDate(b.data_vencimento));
                    if (parcelasNaoPagas.length > 0) vencimentoExibir = parcelasNaoPagas[0].data_vencimento;
                  }
                }
              }
            } catch (e) { emp.parcelas = []; }
          } else {
            emp.parcelas = [];
            if (status !== 'QUITADO' && emp.data_vencimento) {
              const venc = utils.createValidDate(emp.data_vencimento);
              if (venc && venc < hoje) status = 'ATRASADO';
              else if (status !== 'QUITADO') status = 'ATIVO';
            }
          }

          emprestimosProcessados.push({
            ...emp,
            valorFinal,
            valorInicial,
            vencimentoExibir,
            statusCalculado: status
          });
        }

        todosEmprestimos = emprestimosProcessados;
        aplicarFiltros();
      } catch (err) {
        console.error(err);
        document.getElementById('emprestimos-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-red-500">Erro ao carregar empréstimos</td></tr>';
      }
    }

    // Resumo a partir do histórico de pagamentos (mesma fonte da aba Histórico de Pagamentos)
    function calcularResumoDoHistorico(emprestimoId, parcelas, dataVencimentoEmp) {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const historico = historicoCompletoParaEmprestimos;

      // Pagas: contar do histórico de pagamentos (Parcela ou Empréstimo)
      const pagas = historico.filter(p =>
        String(p.emprestimo_id) === String(emprestimoId) &&
        ((p.tipo_pagamento || '').toLowerCase() === 'parcela' || (p.tipo_pagamento || '').toLowerCase() === 'emprestimo')
      ).length;

      // Pendentes e atrasadas: das parcelas não pagas (não estão no histórico)
      if (parcelas && parcelas.length > 0) {
        const naoPagas = parcelas.filter(p => p.status !== 'Paga');
        const atrasadas = naoPagas.filter(p => {
          const dv = utils.createValidDate(p.data_vencimento);
          return dv && dv < hoje;
        }).length;
        const pendentes = naoPagas.length - atrasadas;
        return { pagas, pendentes, atrasadas };
      }

      // Empréstimo valor fixo (sem parcelas): 0 ou 1 pagamento
      if (pagas >= 1) return { pagas, pendentes: 0, atrasadas: 0 };
      const venc = utils.createValidDate(dataVencimentoEmp);
      if (venc && venc < hoje) return { pagas: 0, pendentes: 0, atrasadas: 1 };
      return { pagas: 0, pendentes: 1, atrasadas: 0 };
    }

    function statusParaExibir(status) {
      if (status === 'ATRASADO') return 'Em Atraso';
      if (status === 'QUITADO') return 'Quitado';
      return 'Ativo';
    }

    function renderizarEmprestimos() {
      const tbody = document.getElementById('emprestimos-tbody');
      const container = tbody.parentElement.parentElement;

      if (emprestimosFiltrados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-search empty-state-icon"></i><div class="empty-state-title">Nenhum empréstimo encontrado</div><div class="empty-state-text">Tente ajustar os filtros de busca ou adicione um novo empréstimo.</div></div></td></tr>';
        const oldCards = container.querySelector('.mobile-historico-cards');
        if (oldCards) oldCards.remove();
        tbody.parentElement.style.display = '';
        return;
      }

      const ordenados = [...emprestimosFiltrados].sort((a, b) => {
        const sa = a.statusCalculado || '', sb = b.statusCalculado || '';
        if (sa === 'QUITADO' && sb !== 'QUITADO') return 1;
        if (sa !== 'QUITADO' && sb === 'QUITADO') return -1;
        const da = utils.createValidDate(a.vencimentoExibir);
        const db = utils.createValidDate(b.vencimentoExibir);
        if (!da && !db) return 0;
        if (!da) return 1;
        if (!db) return -1;
        return da - db;
      });

      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        tbody.parentElement.style.display = 'none';
        const oldCards = container.querySelector('.mobile-historico-cards');
        if (oldCards) oldCards.remove();
        const cards = document.createElement('div');
        cards.className = 'mobile-historico-cards';
        cards.style.cssText = 'display: flex; flex-direction: column; gap: 0.75rem; padding: 0.5rem;';
        ordenados.forEach(emp => {
          const status = statusParaExibir(emp.statusCalculado);
          const resumo = calcularResumoDoHistorico(emp.id, emp.parcelas || [], emp.data_vencimento);
          let cor = emp.statusCalculado === 'ATRASADO' ? '#ef4444' : emp.statusCalculado === 'ATIVO' ? '#10b981' : '#3b82f6';
          const card = document.createElement('div');
          card.style.cssText = `padding: 1rem; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid ${cor};`;
          card.innerHTML = `
            <div style="font-weight: 600; color: #1f2937;">${emp.cliente_nome || 'N/A'}</div>
            <div style="font-size: 0.8rem; color: #4b5563; margin: 0.5rem 0;">
              Emprestado: R$ ${utils.formatCurrency(emp.valorInicial)} | Final: R$ ${utils.formatCurrency(emp.valorFinal)}
            </div>
            <div style="font-size: 0.8rem;">Venc: ${utils.formatDate(emp.vencimentoExibir)} • <span class="badge badge-${emp.statusCalculado === 'QUITADO' ? 'info' : emp.statusCalculado === 'ATRASADO' ? 'danger' : 'success'}">${status}</span></div>
            <div style="font-size: 0.8rem; margin-top: 0.25rem;">${resumo.pagas} pagas · ${resumo.pendentes} pend. · ${resumo.atrasadas} atrasadas</div>
            <button class="btn btn-primary btn-sm" onclick="abrirDetalhes(${emp.id})" style="width: 100%; margin-top: 0.5rem;">Ver Detalhes</button>
          `;
          cards.appendChild(card);
        });
        container.appendChild(cards);
      } else {
        tbody.parentElement.style.display = '';
        const oldCards = container.querySelector('.mobile-historico-cards');
        if (oldCards) oldCards.remove();
        tbody.innerHTML = '';
        ordenados.forEach(emp => {
          const status = statusParaExibir(emp.statusCalculado);
          const resumo = calcularResumoDoHistorico(emp.id, emp.parcelas || [], emp.data_vencimento);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><div class="font-semibold">${emp.cliente_nome || 'N/A'}</div><div class="text-sm text-gray-500">${emp.telefone || ''}</div></td>
            <td class="font-semibold text-green-600">${utils.formatCurrency(emp.valorInicial)}</td>
            <td class="font-semibold text-terciary">${utils.formatCurrency(emp.valorFinal)}</td>
            <td>${utils.formatDate(emp.data_emprestimo)}</td>
            <td>${utils.formatDate(emp.vencimentoExibir)}</td>
            <td><span class="badge badge-${emp.statusCalculado === 'QUITADO' ? 'info' : emp.statusCalculado === 'ATRASADO' ? 'danger' : 'success'}">${status}</span></td>
            <td><div class="text-sm"><span class="text-green-600">${resumo.pagas} pagas</span> · <span class="text-yellow-500">${resumo.pendentes} pend.</span> · <span class="text-red-600">${resumo.atrasadas} atrasadas</span></div></td>
            <td><button class="btn btn-primary btn-sm" onclick="abrirDetalhes(${emp.id})">Ver Detalhes</button></td>
        `;
          tbody.appendChild(row);
        });
      }
    }

    function aplicarFiltros() {
      const termo = document.getElementById('search-emprestimos').value.toLowerCase().trim();
      const statusF = document.getElementById('filter-status').value;
      const di = document.getElementById('filter-data-inicio').value;
      const df = document.getElementById('filter-data-fim').value;
      if (typeof saveFilters === 'function') saveFilters('historico-emprestimos', { search: document.getElementById('search-emprestimos').value, status: statusF, data_inicio: di, data_fim: df });

      const statusFilterMap = { 'Ativo': 'ATIVO', 'Quitado': 'QUITADO', 'Em Atraso': 'ATRASADO' };
      const statusInterno = statusFilterMap[statusF] || statusF;

      emprestimosFiltrados = todosEmprestimos.filter(emp => {
        const matchSearch = !termo || (emp.cliente_nome && emp.cliente_nome.toLowerCase().includes(termo)) || String(emp.valorInicial ?? emp.valor ?? '').includes(termo) || String(emp.valorFinal ?? '').includes(termo) || (emp.observacoes && emp.observacoes.toLowerCase().includes(termo));
        const matchStatus = !statusF || (emp.statusCalculado || '') === statusInterno;
        const dataEmp = utils.createValidDate(emp.data_emprestimo);
        const matchDi = !di || !dataEmp || dataEmp >= new Date(di);
        const matchDf = !df || !dataEmp || dataEmp <= new Date(df);
        return matchSearch && matchStatus && matchDi && matchDf;
      });
      renderizarEmprestimos();
      atualizarInfoResultados();
    }

    function limparFiltros() {
      document.getElementById('search-emprestimos').value = '';
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-data-inicio').value = '';
      document.getElementById('filter-data-fim').value = '';
      if (typeof saveFilters === 'function') saveFilters('historico-emprestimos', {});
      emprestimosFiltrados = [...todosEmprestimos];
      renderizarEmprestimos();
      atualizarInfoResultados();
    }

    function atualizarInfoResultados() {
      const total = todosEmprestimos.length;
      const filtrado = emprestimosFiltrados.length;
      document.getElementById('results-info').textContent = filtrado === total ? `Mostrando todos os ${total} empréstimos` : `Mostrando ${filtrado} de ${total} empréstimos`;
    }

    function abrirDetalhes(emprestimoId) {
      const emp = todosEmprestimos.find(e => e.id === emprestimoId);
      if (!emp) return;

      document.getElementById('modal-cliente').textContent = emp.cliente_nome || 'N/A';
      document.getElementById('modal-telefone').textContent = emp.telefone || 'N/A';
      document.getElementById('modal-valor-inicial').textContent = utils.formatCurrency(emp.valorInicial ?? emp.valor ?? 0);
      document.getElementById('modal-valor-final').textContent = utils.formatCurrency(emp.valorFinal ?? emp.valor ?? 0);
      document.getElementById('modal-data-emprestimo').textContent = utils.formatDate(emp.data_emprestimo);
      document.getElementById('modal-vencimento').textContent = utils.formatDate(emp.data_vencimento);
      document.getElementById('modal-juros').textContent = (emp.juros_mensal || 0) + '%';
      const status = statusParaExibir(emp.statusCalculado);
      document.getElementById('modal-status').innerHTML = `<span class="badge badge-${emp.statusCalculado === 'QUITADO' ? 'info' : emp.statusCalculado === 'ATRASADO' ? 'danger' : 'success'}">${status}</span>`;
      document.getElementById('modal-observacoes').textContent = emp.observacoes || 'Nenhuma';

      const parcelas = emp.parcelas || [];
      const container = document.getElementById('parcelas-container');
      if (parcelas.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Nenhuma parcela (empréstimo valor fixo)</p>';
      } else {
        container.innerHTML = parcelas.map(p => {
          const statusClass = p.status === 'Paga' ? 'badge-success' : p.status === 'Atrasada' ? 'badge-danger' : 'badge-warning';
          const dataPgto = p.data_pagamento ? `<div class="text-sm text-green-600">Pago em: ${utils.formatDate(p.data_pagamento)}</div>` : '';
          return `
            <div class="parcela-item ${(p.status || '').toLowerCase()}" style="padding: 0.75rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                  <div class="font-semibold">Parcela ${p.numero_parcela}</div>
                  <div class="text-sm text-gray-600">Vencimento: ${utils.formatDate(p.data_vencimento)}</div>
                  ${dataPgto}
            </div>
            <div style="text-align: right;">
                  <div class="font-semibold">${utils.formatCurrency(p.valor_parcela)}</div>
                  <span class="badge ${statusClass}">${p.status}</span>
            </div>
          </div>
            </div>
          `;
        }).join('');
      }

      const resumo = calcularResumoDoHistorico(emp.id, parcelas, emp.data_vencimento);
      document.getElementById('resumo-pagas').textContent = resumo.pagas;
      document.getElementById('resumo-pendentes').textContent = resumo.pendentes;
      document.getElementById('resumo-atrasadas').textContent = resumo.atrasadas;

      document.getElementById('modal-detalhes').style.display = 'block';
    }

    function fecharModal() {
      document.getElementById('modal-detalhes').style.display = 'none';
    }

    function mostrarNotificacao(msg, tipo) {
      if (typeof ui !== 'undefined' && ui.showNotification) ui.showNotification(msg, tipo);
      else console.log(msg);
    }

    document.addEventListener('keydown', e => { if (e.key === 'Escape') fecharModal(); });
  </script>
</body>
</html>
