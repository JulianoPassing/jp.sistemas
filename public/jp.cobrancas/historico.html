<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JP-Cobranças - Histórico de Pagamentos</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/6N82fk2.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./css/style.css">
  <style>
    .historico-tabs { display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; }
    .historico-tab { padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
    .historico-tab:hover { color: #002f4b; }
    .historico-tab.active { color: #002f4b; border-bottom-color: #00e6ff; }
    .historico-panel { display: none; }
    .historico-panel.active { display: block; }
    .pagamento-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
    .pagamento-badge.parcela { background: #d1fae5; color: #059669; }
    .pagamento-badge.juros { background: #dbeafe; color: #2563eb; }
  </style>
</head>
<body class="app-layout">
  <header>
    <div class="header-content">
      <a href="index.html" class="logo" style="display: flex; align-items: center;">
        <img src="https://i.imgur.com/EQ1tjZX.png" alt="JP-Cobranças" style="height: 5rem; width: auto; object-fit: contain;">
      </a>
      <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
      <div class="nav-wrapper">
        <nav>
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="clientes.html" class="nav-link">Clientes</a>
          <a href="adicionar-cliente.html" class="nav-link">Adicionar Cliente</a>
          <a href="cobrancas.html" class="nav-link">Cobranças</a>
          <a href="atrasados.html" class="nav-link">Atrasados</a>
          <a href="lista-negra.html" class="nav-link">Lista Negra</a>
          <a href="emprestimos.html" class="nav-link">Empréstimos</a>
          <a href="historico.html" class="nav-link">Histórico</a>
          <a href="configuracoes.html" class="nav-link">Configurações</a>
          <a href="#" class="nav-link" onclick="sair()">Sair</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="dashboard-header">
        <div class="welcome-message" id="welcomeMessage">Bem-vindo ao sistema JP-Cobranças!</div>
        <div class="dashboard-title">Histórico de Pagamentos e Empréstimos</div>
        <div class="dashboard-subtitle">
          Visualize o histórico de pagamentos (parcelas e juros) registrados ao marcar como pago no Dashboard ou Empréstimos. Todas as datas de pagamento são gravadas automaticamente.
        </div>
      </div>

      <!-- Abas -->
      <div class="historico-tabs">
        <div class="historico-tab active" data-tab="pagamentos">
          <i class="fas fa-money-bill-wave" style="margin-right: 0.5rem;"></i>Histórico de Pagamentos
        </div>
        <div class="historico-tab" data-tab="emprestimos">
          <i class="fas fa-list" style="margin-right: 0.5rem;"></i>Empréstimos
        </div>
      </div>

      <!-- Painel: Histórico de Pagamentos -->
      <div id="panel-pagamentos" class="historico-panel active">
        <div class="section">
          <div class="search-container" style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
              <input type="date" id="filter-pag-data-inicio" class="form-input" style="min-width: 140px;" title="Data início">
              <input type="date" id="filter-pag-data-fim" class="form-input" style="min-width: 140px;" title="Data fim">
              <select id="filter-pag-tipo" class="form-input" style="min-width: 140px;">
                <option value="">Todos os tipos</option>
                <option value="parcela">Parcela</option>
                <option value="juros">Juros</option>
              </select>
              <select id="filter-pag-cliente" class="form-input" style="min-width: 180px;">
                <option value="">Todos os clientes</option>
              </select>
              <button id="btn-buscar-pagamentos" class="btn btn-primary">Buscar</button>
              <button id="btn-limpar-pagamentos" class="btn btn-secondary">Limpar</button>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
              <span id="info-pagamentos">Carregando histórico de pagamentos...</span>
            </div>
          </div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Data Pagamento</th>
                  <th>Cliente</th>
                  <th>Empréstimo</th>
                  <th>Tipo</th>
                  <th>Valor</th>
                  <th>Detalhes</th>
                </tr>
              </thead>
              <tbody id="historico-pagamentos-tbody">
                <tr><td colspan="6" class="text-center text-gray-500">Carregando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Painel: Empréstimos -->
      <div id="panel-emprestimos" class="historico-panel">
        <div class="section">
          <div class="search-container" style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
              <input type="text" id="search-emprestimos" class="form-input" placeholder="Buscar por cliente, valor..." style="flex: 1; min-width: 200px;">
              <select id="filter-status" class="form-input" style="min-width: 120px;">
                <option value="">Todos os Status</option>
                <option value="Ativo">Ativo</option>
                <option value="Quitado">Quitado</option>
                <option value="Em Atraso">Em Atraso</option>
              </select>
              <input type="date" id="filter-data-inicio" class="form-input" style="min-width: 140px;">
              <input type="date" id="filter-data-fim" class="form-input" style="min-width: 140px;">
              <button id="clear-filters" class="btn btn-secondary">Limpar</button>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
              <span id="results-info">Mostrando todos os empréstimos</span>
            </div>
          </div>
          <div class="section-header">
            <h3 class="section-title">Empréstimos</h3>
            <button id="btn-novo-emprestimo" class="btn btn-primary">Novo Empréstimo</button>
          </div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Valor Inicial</th>
                  <th>Valor Final</th>
                  <th>Data Empréstimo</th>
                  <th>Vencimento</th>
                  <th>Status</th>
                  <th>Parcelas</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="emprestimos-tbody">
                <tr><td colspan="8" class="text-center text-gray-500">Carregando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de Detalhes do Empréstimo -->
  <div id="modal-detalhes" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="fecharModal()"></div>
    <div class="modal-content modal-detalhes-emprestimo">
      <div class="modal-header">
        <h3>Detalhes do Empréstimo</h3>
        <button class="modal-close" onclick="fecharModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="section">
          <h4 class="section-title">Informações Gerais</h4>
          <div class="grid grid-cols-2">
            <div><label class="form-label">Cliente:</label><p id="modal-cliente" class="font-semibold"></p></div>
            <div><label class="form-label">Telefone:</label><p id="modal-telefone"></p></div>
            <div><label class="form-label">Valor Inicial:</label><p id="modal-valor-inicial" class="font-semibold text-green-600"></p></div>
            <div><label class="form-label">Valor Final:</label><p id="modal-valor-final" class="font-semibold text-terciary"></p></div>
            <div><label class="form-label">Data do Empréstimo:</label><p id="modal-data-emprestimo"></p></div>
            <div><label class="form-label">Vencimento:</label><p id="modal-vencimento"></p></div>
            <div><label class="form-label">Juros Mensal:</label><p id="modal-juros"></p></div>
            <div><label class="form-label">Status:</label><p id="modal-status"></p></div>
          </div>
          <div><label class="form-label">Observações:</label><p id="modal-observacoes" class="modal-observacoes"></p></div>
        </div>
        <div class="section">
          <h4 class="section-title">Parcelas (com datas de pagamento)</h4>
          <div id="parcelas-container" class="parcelas-detalhadas"></div>
        </div>
        <div class="section">
          <h4 class="section-title">Resumo de Pagamentos</h4>
          <div class="grid grid-cols-3">
            <div class="resumo-card resumo-pagas"><div class="text-sm text-gray-600">Parcelas Pagas</div><div id="resumo-pagas" class="text-lg font-semibold text-green-600">0</div></div>
            <div class="resumo-card resumo-pendentes"><div class="text-sm text-gray-600">Parcelas Pendentes</div><div id="resumo-pendentes" class="text-lg font-semibold text-yellow-500">0</div></div>
            <div class="resumo-card resumo-atrasadas"><div class="text-sm text-gray-600">Parcelas Atrasadas</div><div id="resumo-atrasadas" class="text-lg font-semibold text-red-600">0</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center p-4 mt-8">
    © 2025 JP. Sistemas. Todos os direitos reservados. | jp-sistemas.com
  </footer>

  <script src="./js/main.js"></script>
  <script>
    let todosEmprestimos = [];
    let emprestimosFiltrados = [];
    let historicoPagamentos = [];

    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('mobile-menu-toggle');
      const navWrapper = document.querySelector('.nav-wrapper');
      if (menuBtn && navWrapper) {
        menuBtn.addEventListener('click', () => navWrapper.classList.toggle('open'));
      }

      // Abas
      document.querySelectorAll('.historico-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.historico-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.historico-panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
        });
      });

      // Histórico de Pagamentos
      carregarHistoricoPagamentos();
      carregarClientesParaFiltro();
      document.getElementById('btn-buscar-pagamentos').addEventListener('click', carregarHistoricoPagamentos);
      document.getElementById('btn-limpar-pagamentos').addEventListener('click', () => {
        document.getElementById('filter-pag-data-inicio').value = '';
        document.getElementById('filter-pag-data-fim').value = '';
        document.getElementById('filter-pag-tipo').value = '';
        document.getElementById('filter-pag-cliente').value = '';
        carregarHistoricoPagamentos();
      });

      // Empréstimos
      carregarEmprestimos();
      document.getElementById('search-emprestimos').addEventListener('input', aplicarFiltros);
      document.getElementById('filter-status').addEventListener('change', aplicarFiltros);
      document.getElementById('filter-data-inicio').addEventListener('change', aplicarFiltros);
      document.getElementById('filter-data-fim').addEventListener('change', aplicarFiltros);
      document.getElementById('clear-filters').addEventListener('click', limparFiltros);
      document.getElementById('btn-novo-emprestimo').addEventListener('click', () => { if (window.novoEmprestimo) window.novoEmprestimo(); else window.location.href = 'emprestimos.html'; });

      window.addEventListener('resize', () => {
        if (emprestimosFiltrados.length > 0) renderizarEmprestimos();
      });
    });

    async function carregarClientesParaFiltro() {
      try {
        const clientes = await apiService.getClientes();
        const sel = document.getElementById('filter-pag-cliente');
        sel.innerHTML = '<option value="">Todos os clientes</option>';
        (clientes || []).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.nome || c.razao || 'N/A';
          sel.appendChild(opt);
        });
      } catch (e) { console.error(e); }
    }

    async function carregarHistoricoPagamentos() {
      const tbody = document.getElementById('historico-pagamentos-tbody');
      const info = document.getElementById('info-pagamentos');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';
      try {
        const params = {};
        const di = document.getElementById('filter-pag-data-inicio').value;
        const df = document.getElementById('filter-pag-data-fim').value;
        const tipo = document.getElementById('filter-pag-tipo').value;
        const cliente = document.getElementById('filter-pag-cliente').value;
        if (di) params.data_inicio = di;
        if (df) params.data_fim = df;
        if (tipo) params.tipo = tipo;
        if (cliente) params.cliente_id = cliente;

        historicoPagamentos = await apiService.getHistoricoPagamentos(params);

        if (!historicoPagamentos || historicoPagamentos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Nenhum pagamento registrado. Os pagamentos são gravados automaticamente quando você marca parcelas ou juros como pagos no Dashboard ou Empréstimos.</td></tr>';
          info.textContent = 'Nenhum pagamento encontrado';
        } else {
          tbody.innerHTML = '';
          historicoPagamentos.forEach(p => {
            const dataStr = p.data_pagamento ? formatarData(p.data_pagamento) : '-';
            const valorStr = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(p.valor || 0);
            const tipoClass = (p.tipo_pagamento || '').toLowerCase() === 'juros' ? 'juros' : 'parcela';
            const detalhes = p.numero_parcela ? `Parcela ${p.numero_parcela}` : (p.observacoes || '-');
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><strong>${dataStr}</strong></td>
              <td>${p.cliente_nome || 'N/A'}</td>
              <td>#${p.emprestimo_id || '-'}</td>
              <td><span class="pagamento-badge ${tipoClass}">${p.tipo_pagamento || 'Parcela'}</span></td>
              <td class="font-semibold text-green-600">${valorStr}</td>
              <td class="text-sm text-gray-600">${detalhes}</td>
            `;
            tbody.appendChild(row);
          });
          info.textContent = `Mostrando ${historicoPagamentos.length} pagamento(s)`;
        }
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500">Erro ao carregar histórico. Tente novamente.</td></tr>';
        info.textContent = 'Erro ao carregar';
      }
    }

    async function carregarEmprestimos() {
      try {
        await fetch('/api/cobrancas/corrigir-status-emprestimos', { method: 'POST', credentials: 'include' }).catch(() => {});

        const response = await fetch('/api/cobrancas/emprestimos', { method: 'GET', headers: { 'Content-Type': 'application/json' }, credentials: 'include' });
        if (!response.ok) throw new Error('Erro ao carregar empréstimos');
        const rawList = await response.json();
        const byId = new Map();
        (Array.isArray(rawList) ? rawList : []).forEach(e => { if (e && e.id != null && !byId.has(e.id)) byId.set(e.id, e); });
        todosEmprestimos = Array.from(byId.values());
        emprestimosFiltrados = [...todosEmprestimos];

        await Promise.all(todosEmprestimos.map(async (emp) => {
          try {
            const parcelasRes = await fetch(`/api/cobrancas/emprestimos/${emp.id}/parcelas`, { credentials: 'include' });
            emp.parcelas = parcelasRes.ok ? await parcelasRes.json() : [];
            if (emp.parcelas && emp.parcelas.length > 0) {
              const hoje = new Date();
              emp.parcelas.forEach(p => {
                if (p.status === 'Pendente') {
                  const dv = criarDataValida(p.data_vencimento);
                  if (dv && hoje > dv) p.status = 'Atrasada';
                }
              });
            }
          } catch (e) { emp.parcelas = []; }
        }));

        renderizarEmprestimos();
        atualizarInfoResultados();
      } catch (err) {
        console.error(err);
        document.getElementById('emprestimos-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-red-500">Erro ao carregar empréstimos</td></tr>';
      }
    }

    function obterDataVencimentoExibir(emp) {
      if (!emp.parcelas || emp.parcelas.length === 0) return emp.data_vencimento;
      const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
      const naoPagas = emp.parcelas.filter(p => p.status !== 'Paga');
      if (naoPagas.length === 0) return emp.data_vencimento;
      const atrasadas = naoPagas.filter(p => { const dv = criarDataValida(p.data_vencimento); return dv && dv < hoje; });
      const lista = atrasadas.length > 0 ? atrasadas : naoPagas;
      lista.sort((a, b) => criarDataValida(a.data_vencimento) - criarDataValida(b.data_vencimento));
      return lista[0].data_vencimento;
    }

    function determinarStatus(emp) {
      const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
      if (emp.parcelas && emp.parcelas.length > 0) {
        const todasPagas = emp.parcelas.every(p => p.status === 'Paga');
        if (todasPagas) return 'Quitado';
        const temAtrasada = emp.parcelas.some(p => { const dv = criarDataValida(p.data_vencimento); return p.status !== 'Paga' && dv && dv < hoje; });
        return temAtrasada ? 'Em Atraso' : 'Ativo';
      }
      if (emp.status === 'Quitado') return 'Quitado';
      const dv = criarDataValida(emp.data_vencimento);
      if (dv && hoje > dv && emp.status === 'Ativo') return 'Em Atraso';
      return emp.status || 'Ativo';
    }

    function calcularResumoParcelas(parcelas) {
      const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
      const pagas = (parcelas || []).filter(p => p.status === 'Paga').length;
      const naoPagas = (parcelas || []).filter(p => p.status !== 'Paga');
      const atrasadas = naoPagas.filter(p => { const dv = criarDataValida(p.data_vencimento); return dv && dv < hoje; }).length;
      return { pagas, pendentes: naoPagas.length - atrasadas, atrasadas };
    }

    function renderizarEmprestimos() {
      const tbody = document.getElementById('emprestimos-tbody');
      const container = tbody.parentElement.parentElement;

      if (emprestimosFiltrados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">Nenhum empréstimo encontrado</td></tr>';
        const oldCards = container.querySelector('.mobile-historico-cards');
        if (oldCards) oldCards.remove();
        tbody.parentElement.style.display = '';
        return;
      }

      const ordenados = [...emprestimosFiltrados].sort((a, b) => {
        const sa = determinarStatus(a), sb = determinarStatus(b);
        if (sa === 'Quitado' && sb !== 'Quitado') return 1;
        if (sa !== 'Quitado' && sb === 'Quitado') return -1;
        const da = criarDataValida(obterDataVencimentoExibir(a));
        const db = criarDataValida(obterDataVencimentoExibir(b));
        if (!da && !db) return 0;
        if (!da) return 1;
        if (!db) return -1;
        return da - db;
      });

      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        tbody.parentElement.style.display = 'none';
        const oldCards = container.querySelector('.mobile-historico-cards');
        if (oldCards) oldCards.remove();
        const cards = document.createElement('div');
        cards.className = 'mobile-historico-cards';
        cards.style.cssText = 'display: flex; flex-direction: column; gap: 0.75rem; padding: 0.5rem;';
        ordenados.forEach(emp => {
          const status = determinarStatus(emp);
          const resumo = calcularResumoParcelas(emp.parcelas || []);
          const venc = obterDataVencimentoExibir(emp);
          let cor = '#6b7280';
          if (status === 'Em Atraso') cor = '#ef4444';
          else if (status === 'Ativo') cor = '#10b981';
          else if (status === 'Quitado') cor = '#3b82f6';
          const card = document.createElement('div');
          card.style.cssText = `padding: 1rem; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid ${cor};`;
          card.innerHTML = `
            <div style="font-weight: 600; color: #1f2937;">${emp.cliente_nome || 'N/A'}</div>
            <div style="font-size: 0.8rem; color: #4b5563; margin: 0.5rem 0;">
              Inicial: R$ ${formatarMoeda(emp.valor_inicial ?? emp.valor ?? 0)} | Final: R$ ${formatarMoeda(emp.valor_final ?? emp.valor ?? 0)}
            </div>
            <div style="font-size: 0.8rem;"><span class="badge badge-${status === 'Quitado' ? 'info' : status === 'Em Atraso' ? 'danger' : 'success'}">${status}</span> ${resumo.pagas} pagas · ${resumo.pendentes} pend. · ${resumo.atrasadas} atrasadas</div>
            <button class="btn btn-primary btn-sm" onclick="abrirDetalhes(${emp.id})" style="width: 100%; margin-top: 0.5rem;">Ver Detalhes</button>
          `;
          cards.appendChild(card);
        });
        container.appendChild(cards);
      } else {
        tbody.parentElement.style.display = '';
        const oldCards = container.querySelector('.mobile-historico-cards');
        if (oldCards) oldCards.remove();
        tbody.innerHTML = '';
        ordenados.forEach(emp => {
          const status = determinarStatus(emp);
          const resumo = calcularResumoParcelas(emp.parcelas || []);
          const venc = obterDataVencimentoExibir(emp);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><div class="font-semibold">${emp.cliente_nome || 'N/A'}</div><div class="text-sm text-gray-500">${emp.telefone || ''}</div></td>
            <td class="font-semibold text-green-600">R$ ${formatarMoeda(emp.valor_inicial ?? emp.valor ?? 0)}</td>
            <td class="font-semibold text-terciary">R$ ${formatarMoeda(emp.valor_final ?? emp.valor ?? 0)}</td>
            <td>${formatarData(emp.data_emprestimo)}</td>
            <td>${formatarData(venc)}</td>
            <td><span class="badge badge-${status === 'Quitado' ? 'info' : status === 'Em Atraso' ? 'danger' : 'success'}">${status}</span></td>
            <td><div class="text-sm"><span class="text-green-600">${resumo.pagas} pagas</span><br><span class="text-yellow-500">${resumo.pendentes} pend.</span><br><span class="text-red-600">${resumo.atrasadas} atrasadas</span></div></td>
            <td><button class="btn btn-primary btn-sm" onclick="abrirDetalhes(${emp.id})">Ver Detalhes</button></td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    function aplicarFiltros() {
      const termo = document.getElementById('search-emprestimos').value.toLowerCase().trim();
      const statusF = document.getElementById('filter-status').value;
      const di = document.getElementById('filter-data-inicio').value;
      const df = document.getElementById('filter-data-fim').value;

      emprestimosFiltrados = todosEmprestimos.filter(emp => {
        const matchSearch = !termo || (emp.cliente_nome && emp.cliente_nome.toLowerCase().includes(termo)) || String(emp.valor_inicial ?? emp.valor ?? '').includes(termo) || String(emp.valor_final ?? emp.valor ?? '').includes(termo) || (emp.observacoes && emp.observacoes.toLowerCase().includes(termo));
        const statusEmp = determinarStatus(emp);
        const matchStatus = !statusF || statusEmp === statusF;
        const dataEmp = criarDataValida(emp.data_emprestimo);
        const matchDi = !di || !dataEmp || dataEmp >= new Date(di);
        const matchDf = !df || !dataEmp || dataEmp <= new Date(df);
        return matchSearch && matchStatus && matchDi && matchDf;
      });
      renderizarEmprestimos();
      atualizarInfoResultados();
    }

    function limparFiltros() {
      document.getElementById('search-emprestimos').value = '';
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-data-inicio').value = '';
      document.getElementById('filter-data-fim').value = '';
      emprestimosFiltrados = [...todosEmprestimos];
      renderizarEmprestimos();
      atualizarInfoResultados();
    }

    function atualizarInfoResultados() {
      const total = todosEmprestimos.length;
      const filtrado = emprestimosFiltrados.length;
      document.getElementById('results-info').textContent = filtrado === total ? `Mostrando todos os ${total} empréstimos` : `Mostrando ${filtrado} de ${total} empréstimos`;
    }

    function abrirDetalhes(emprestimoId) {
      const emp = todosEmprestimos.find(e => e.id === emprestimoId);
      if (!emp) return;

      document.getElementById('modal-cliente').textContent = emp.cliente_nome || 'N/A';
      document.getElementById('modal-telefone').textContent = emp.telefone || 'N/A';
      document.getElementById('modal-valor-inicial').textContent = 'R$ ' + formatarMoeda(emp.valor_inicial ?? emp.valor ?? 0);
      document.getElementById('modal-valor-final').textContent = 'R$ ' + formatarMoeda(emp.valor_final ?? emp.valor ?? 0);
      document.getElementById('modal-data-emprestimo').textContent = formatarData(emp.data_emprestimo);
      document.getElementById('modal-vencimento').textContent = formatarData(emp.data_vencimento);
      document.getElementById('modal-juros').textContent = (emp.juros_mensal || 0) + '%';
      const status = determinarStatus(emp);
      document.getElementById('modal-status').innerHTML = `<span class="badge badge-${status === 'Quitado' ? 'info' : status === 'Em Atraso' ? 'danger' : 'success'}">${status}</span>`;
      document.getElementById('modal-observacoes').textContent = emp.observacoes || 'Nenhuma';

      const parcelas = emp.parcelas || [];
      const container = document.getElementById('parcelas-container');
      if (parcelas.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Nenhuma parcela (empréstimo valor fixo)</p>';
      } else {
        container.innerHTML = parcelas.map(p => {
          const statusClass = p.status === 'Paga' ? 'badge-success' : p.status === 'Atrasada' ? 'badge-danger' : 'badge-warning';
          const dataPgto = p.data_pagamento ? `<div class="text-sm text-green-600">Pago em: ${formatarData(p.data_pagamento)}</div>` : '';
          return `
            <div class="parcela-item ${(p.status || '').toLowerCase()}" style="padding: 0.75rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div class="font-semibold">Parcela ${p.numero_parcela}</div>
                  <div class="text-sm text-gray-600">Vencimento: ${formatarData(p.data_vencimento)}</div>
                  ${dataPgto}
                </div>
                <div style="text-align: right;">
                  <div class="font-semibold">R$ ${formatarMoeda(p.valor_parcela)}</div>
                  <span class="badge ${statusClass}">${p.status}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      const resumo = calcularResumoParcelas(parcelas);
      document.getElementById('resumo-pagas').textContent = resumo.pagas;
      document.getElementById('resumo-pendentes').textContent = resumo.pendentes;
      document.getElementById('resumo-atrasadas').textContent = resumo.atrasadas;

      document.getElementById('modal-detalhes').style.display = 'block';
    }

    function fecharModal() {
      document.getElementById('modal-detalhes').style.display = 'none';
    }

    function criarDataValida(data) {
      if (!data) return null;
      try {
        if (data instanceof Date && !isNaN(data)) return data;
        const str = String(data).trim();
        if (str.match(/^\d{4}-\d{2}-\d{2}$/)) {
          const [y, m, d] = str.split('-').map(Number);
          return new Date(y, m - 1, d);
        }
        if (str.match(/^\d{4}-\d{2}-\d{2} /)) return new Date(str.replace(' ', 'T'));
        return new Date(data);
      } catch (e) { return null; }
    }

    function formatarMoeda(v) {
      return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v);
    }

    function formatarData(data) {
      if (!data) return 'N/A';
      const d = criarDataValida(data);
      return d ? d.toLocaleDateString('pt-BR') : 'N/A';
    }

    function mostrarNotificacao(msg, tipo) {
      if (typeof ui !== 'undefined' && ui.showNotification) ui.showNotification(msg, tipo);
      else console.log(msg);
    }

    document.addEventListener('keydown', e => { if (e.key === 'Escape') fecharModal(); });
  </script>
</body>
</html>
