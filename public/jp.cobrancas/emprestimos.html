<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JP-Cobranças - Sistema de Empréstimos</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/6N82fk2.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
  <style>
    /* Estilos modernos inspirados no EasierControl */
    .section-primary {
      background: white;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }

    .form-header {
      font-size: 1.25rem;
      font-weight: 700;
      color: #061058;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e5e7eb;
    }

    .form-header-modal {
      font-size: 1.125rem;
      font-weight: 600;
      color: #061058;
      margin-bottom: 1rem;
    }

    .label-primary {
      display: block;
      font-weight: 600;
      color: #061058;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .input-primary {
      width: 100%;
      border-radius: 0.375rem;
      border: 1px solid #6b7280;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      line-height: 1.5rem;
      background-color: #fff;
      transition: all 0.2s ease;
    }

    .input-primary:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      border-color: #1c64f2;
      box-shadow: 0 0 0 3px rgb(28 100 242 / 0.1);
    }

    .button-primary {
      background-color: #061058;
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .button-primary:hover {
      background-color: #0d2662;
    }

    .button-primary:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    /* Tipos de empréstimo com design moderno */
    .tipo-emprestimo-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .tipo-option {
      position: relative;
      cursor: pointer;
    }

    .tipo-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }

    .tipo-option label {
      display: block;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      text-align: center;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #fff;
      color: #374151;
    }

    .tipo-option input[type="radio"]:checked + label {
      border-color: #061058;
      background-color: #061058;
      color: white;
    }

    .tipo-option:hover label {
      border-color: #061058;
    }

    /* Grid responsivo */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    /* Simulação */
    .simulacao-container {
      background-color: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-top: 1.5rem;
      display: none;
    }

    .simulacao-container.show {
      display: block;
    }

    .simulacao-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .simulacao-item {
      text-align: center;
      padding: 1rem;
      background: white;
      border-radius: 0.375rem;
      border: 1px solid #e5e7eb;
    }

    .simulacao-label {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .simulacao-value {
      font-size: 1.125rem;
      font-weight: 700;
      color: #061058;
    }

    /* Botões de ação */
    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
    }

    .btn-secondary {
      background-color: #6b7280;
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background-color: #4b5563;
    }

    .btn-success {
      background-color: #10b981;
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-success:hover {
      background-color: #059669;
    }

    /* Cliente info */
    .cliente-info {
      background-color: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .cliente-info h4 {
      margin: 0 0 0.5rem 0;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
    }

    .cliente-info p {
      margin: 0.25rem 0;
      font-size: 0.875rem;
      color: #6b7280;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .tipo-emprestimo-container {
        grid-template-columns: 1fr;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .simulacao-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #061058;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="app-layout">
  <header>
    <div class="header-content">
      <a href="index.html" class="logo" style="display: flex; align-items: center;">
        <img src="https://i.imgur.com/EQ1tjZX.png" alt="JP-Cobranças" style="height: 5rem; width: auto; object-fit: contain;">
      </a>
      <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
      <div class="nav-wrapper">
        <nav>
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="clientes.html" class="nav-link">Clientes</a>
          <a href="adicionar-cliente.html" class="nav-link">Adicionar Cliente</a>
          <a href="cobrancas.html" class="nav-link">Cobranças</a>
          <a href="atrasados.html" class="nav-link">Atrasados</a>
          <a href="lista-negra.html" class="nav-link">Lista Negra</a>
          <a href="emprestimos.html" class="nav-link active">Histórico de Empréstimos</a>
          <a href="#" class="nav-link" onclick="sair()">Sair</a>
        </nav>
      </div>
    </div>
  </header>
  
  <main>
    <div class="container">
      <div class="dashboard-header">
        <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
        <div class="dashboard-title">Sistema de Empréstimos</div>
        <div class="dashboard-subtitle">
          Gerencie empréstimos com diferentes tipos de cálculo e simulações avançadas.
        </div>
      </div>

      <!-- Formulário de Novo Empréstimo -->
      <div class="section-primary" id="emprestimoForm" style="display: none;">
        <div class="form-header">Novo Empréstimo</div>
        
        <form id="novoEmprestimoForm">
          <!-- Seção: Informações do Cliente -->
          <div class="form-group">
            <label class="label-primary">Tipo de Cliente</label>
            <div class="tipo-emprestimo-container" style="grid-template-columns: repeat(2, 1fr);">
              <div class="tipo-option">
                <input type="radio" id="tipo-cliente-existente" name="tipoCliente" value="existente" checked>
                <label for="tipo-cliente-existente">Cliente Existente</label>
              </div>
              <div class="tipo-option">
                <input type="radio" id="tipo-cliente-novo" name="tipoCliente" value="novo">
                <label for="tipo-cliente-novo">Novo Cliente</label>
              </div>
            </div>
          </div>

          <!-- Cliente Existente -->
          <div id="clienteExistente" class="form-group">
            <label class="label-primary">Selecionar Cliente</label>
            <select name="clienteId" id="clienteSelect" class="input-primary">
              <option value="">Selecione um cliente</option>
            </select>
            
            <div class="cliente-info" id="clienteInfo" style="display: none;">
              <h4>Informações do Cliente Selecionado</h4>
              <p><strong>Nome:</strong> <span id="infoNome"></span></p>
              <p><strong>CPF/CNPJ:</strong> <span id="infoCpf"></span></p>
              <p><strong>Telefone:</strong> <span id="infoTelefone"></span></p>
            </div>
          </div>

          <!-- Novo Cliente -->
          <div id="novoCliente" class="form-group" style="display: none;">
            <div class="form-grid">
              <div class="form-group">
                <label class="label-primary">Nome Completo *</label>
                <input type="text" name="nomeCliente" id="nomeCliente" class="input-primary" placeholder="Nome completo do cliente">
              </div>
              <div class="form-group">
                <label class="label-primary">CPF/CNPJ *</label>
                <input type="text" name="cpfCliente" id="cpfCliente" class="input-primary" placeholder="000.000.000-00 ou 00.000.000/0000-00">
              </div>
              <div class="form-group">
                <label class="label-primary">Telefone</label>
                <input type="text" name="telefoneCliente" id="telefoneCliente" class="input-primary" placeholder="(00) 00000-0000">
              </div>
              <div class="form-group">
                <label class="label-primary">Email</label>
                <input type="email" name="emailCliente" id="emailCliente" class="input-primary" placeholder="email@exemplo.com">
              </div>
              <div class="form-group">
                <label class="label-primary">Endereço</label>
                <input type="text" name="enderecoCliente" id="enderecoCliente" class="input-primary" placeholder="Rua, número, bairro">
              </div>
              <div class="form-group">
                <label class="label-primary">Cidade</label>
                <input type="text" name="cidadeCliente" id="cidadeCliente" class="input-primary" placeholder="Nome da cidade">
              </div>
              <div class="form-group">
                <label class="label-primary">Estado</label>
                <select name="estadoCliente" id="estadoCliente" class="input-primary">
                  <option value="">Selecione o estado</option>
                  <option value="AC">Acre</option>
                  <option value="AL">Alagoas</option>
                  <option value="AP">Amapá</option>
                  <option value="AM">Amazonas</option>
                  <option value="BA">Bahia</option>
                  <option value="CE">Ceará</option>
                  <option value="DF">Distrito Federal</option>
                  <option value="ES">Espírito Santo</option>
                  <option value="GO">Goiás</option>
                  <option value="MA">Maranhão</option>
                  <option value="MT">Mato Grosso</option>
                  <option value="MS">Mato Grosso do Sul</option>
                  <option value="MG">Minas Gerais</option>
                  <option value="PA">Pará</option>
                  <option value="PB">Paraíba</option>
                  <option value="PR">Paraná</option>
                  <option value="PE">Pernambuco</option>
                  <option value="PI">Piauí</option>
                  <option value="RJ">Rio de Janeiro</option>
                  <option value="RN">Rio Grande do Norte</option>
                  <option value="RS">Rio Grande do Sul</option>
                  <option value="RO">Rondônia</option>
                  <option value="RR">Roraima</option>
                  <option value="SC">Santa Catarina</option>
                  <option value="SP">São Paulo</option>
                  <option value="SE">Sergipe</option>
                  <option value="TO">Tocantins</option>
                </select>
              </div>
              <div class="form-group">
                <label class="label-primary">CEP</label>
                <input type="text" name="cepCliente" id="cepCliente" class="input-primary" placeholder="00000-000">
              </div>
            </div>
          </div>

          <!-- Seção: Tipo de Empréstimo -->
          <div class="form-group">
            <label class="label-primary">Tipo de Empréstimo</label>
            <select name="tipoEmprestimo" id="tipoEmprestimo" class="input-primary" required>
              <option value="" disabled selected>Nenhum tipo selecionado</option>
              <option value="fixed">Fixo</option>
              <option value="in_installments">Parcelado</option>
            </select>
          </div>

          <!-- Seção: Valor -->
          <div class="form-group">
            <label class="label-primary">Valor (R$)</label>
            <input type="text" name="valor" id="valor" class="input-primary" placeholder="ex.: 1000" required>
          </div>

          <!-- Seção: Tipo de Cálculo -->
          <div class="form-group">
            <label class="label-primary">Tipo de Cálculo</label>
            <div class="tipo-emprestimo-container" id="tipoCalculoBtns" style="grid-template-columns: repeat(3, 1fr);">
              <button type="button" class="tipo-option" id="btnCalcValorFixo" data-calc="fixed">Valor Fixo (R$)</button>
              <button type="button" class="tipo-option" id="btnCalcParcelaFixa" data-calc="fixed-installment">Parcela Fixa (R$)</button>
              <button type="button" class="tipo-option" id="btnCalcPorcentagem" data-calc="percentage">Porcentagem (%)</button>
            </div>
          </div>

          <!-- Campos dinâmicos -->
          <div id="camposCalculo">
            <!-- Os campos específicos aparecerão aqui -->
          </div>

          <!-- Seção: Parcelas e Frequência -->
          <div class="form-grid">
            <div class="form-group">
              <label class="label-primary">Qtd. de Parcelas</label>
              <input type="number" name="numeroParcelas" id="numeroParcelas" class="input-primary" min="1" value="1" placeholder="ex.: 12">
            </div>
            <div class="form-group">
              <label class="label-primary">Frequência</label>
              <select name="frequencia" id="frequencia" class="input-primary">
                <option value="" disabled>Nenhuma frequência selecionada</option>
                <option value="daily">Diário</option>
                <option value="weekly">Semanal</option>
                <option value="biweekly">Quinzenal</option>
                <option value="monthly" selected>Mensal</option>
              </select>
            </div>
          </div>

          <!-- Seção: Data da Primeira Parcela -->
          <div class="form-group">
            <label class="label-primary">Data da Primeira Parcela</label>
            <input type="date" name="dataPrimeiraParcela" id="dataPrimeiraParcela" class="input-primary" required>
          </div>

          <!-- Seção: Afiliado (opcional) -->
          <div class="form-grid">
            <div class="form-group" style="grid-column: span 3;">
              <label class="label-primary">Afiliado</label>
              <select name="afiliado" id="afiliado" class="input-primary">
                <option value="">Nenhum afiliado selecionado</option>
              </select>
            </div>
            <div class="form-group">
              <label class="label-primary">%</label>
              <input type="number" name="percentualAfiliado" id="percentualAfiliado" class="input-primary" step="0.01" placeholder="0.00">
            </div>
          </div>

          <small class="font-semibold text-terciary text-xs">* Caso seja número decimal utilize ponto, exemplo <strong>(20,5)</strong> deve ser informado <strong>(20.5)</strong>.</small>

          <!-- Seção: Observações -->
          <div class="form-group">
            <label class="label-primary">Observações</label>
            <textarea name="observacoes" id="observacoes" class="input-primary" rows="3" placeholder="Observações adicionais sobre o empréstimo..."></textarea>
          </div>

          <!-- Botões de ação -->
          <div class="form-actions">
            <button type="button" id="btnSimular" class="btn-secondary">Simular Empréstimo</button>
            <button type="button" id="btnCancelar" class="btn-secondary">Cancelar</button>
            <button type="submit" id="btnSalvar" class="button-primary">Salvar Empréstimo</button>
          </div>
        </form>

        <!-- Preview da Simulação -->
        <div class="simulacao-container" id="simulacaoPreview">
          <div class="form-header-modal">Resumo da Simulação</div>
          <div class="simulacao-grid" id="simulacaoGrid">
            <!-- Dados da simulação serão inseridos aqui -->
          </div>
        </div>
      </div>

      <!-- Tabela de Histórico de Empréstimos -->
      <div class="section-primary">
        <div class="section-header">
          <h3 class="section-title">Empréstimos</h3>
          <button id="toggleForm" class="btn btn-primary">Novo Empréstimo</button>
        </div>
        
        <!-- Caixa de Busca -->
        <div class="search-container" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
              <input 
                type="text" 
                id="search-emprestimos" 
                class="form-input" 
                placeholder="Buscar por cliente, valor, status..."
                style="width: 100%;"
              >
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <select id="filter-status" class="form-input" style="min-width: 120px;">
                <option value="">Todos os Status</option>
                <option value="Ativo">Ativo</option>
                <option value="Pendente">Pendente</option>
                <option value="Em Atraso">Em Atraso</option>
                <option value="Quitado">Quitado</option>
                <option value="Cancelado">Cancelado</option>
              </select>
              <button id="clear-search" class="btn btn-secondary" style="white-space: nowrap;">Limpar</button>
            </div>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
            <span id="search-results-info">Mostrando todos os empréstimos</span>
          </div>
        </div>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Tipo</th>
                <th>Data Empréstimo</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="historico-emprestimos">
              <tr>
                <td colspan="7" class="text-center text-gray-500">Carregando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  
  <footer class="text-center p-4 mt-8">
    © 2024 JP-Cobranças. Todos os direitos reservados.
  </footer>
  
  <script src="./js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('mobile-menu-toggle');
      const navWrapper = document.querySelector('.nav-wrapper');
      if (menuBtn && navWrapper) {
        menuBtn.addEventListener('click', function() {
          navWrapper.classList.toggle('open');
        });
      }

      // Carregar histórico de empréstimos
      renderHistoricoEmprestimos();
      
      // Funcionalidade de busca
      const searchInput = document.getElementById('search-emprestimos');
      const filterStatus = document.getElementById('filter-status');
      const clearSearchBtn = document.getElementById('clear-search');
      const searchResultsInfo = document.getElementById('search-results-info');
      
      let allEmprestimos = []; // Armazenar todos os empréstimos
      let filteredEmprestimos = []; // Empréstimos filtrados
      
      // Função para aplicar filtros
      function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const statusFilter = filterStatus.value;
        
        filteredEmprestimos = allEmprestimos.filter(emp => {
          // Filtro por termo de busca
          const matchesSearch = !searchTerm || 
            (emp.cliente_nome && emp.cliente_nome.toLowerCase().includes(searchTerm)) ||
            (emp.valor && emp.valor.toString().includes(searchTerm)) ||
            (emp.status && emp.status.toLowerCase().includes(searchTerm)) ||
            (emp.data_emprestimo && emp.data_emprestimo.includes(searchTerm)) ||
            (emp.data_vencimento && emp.data_vencimento.includes(searchTerm));
          
          // Filtro por status
          const matchesStatus = !statusFilter || emp.status === statusFilter;
          
          return matchesSearch && matchesStatus;
        });
        
        // Atualizar tabela
        renderFilteredEmprestimos();
        
        // Atualizar informação de resultados
        updateSearchResultsInfo();
      }
      
      // Função para renderizar empréstimos filtrados
      function renderFilteredEmprestimos() {
        const tbody = document.getElementById('historico-emprestimos');
        if (!tbody) return;
        
        if (filteredEmprestimos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Nenhum empréstimo encontrado</td></tr>';
          return;
        }
        
        tbody.innerHTML = '';
        filteredEmprestimos.forEach(emp => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${emp.cliente_nome || 'N/A'}</td>
            <td>R$ ${utils.formatCurrency(emp.valor || 0)}</td>
            <td>${emp.tipo_emprestimo || 'Fixo'}</td>
            <td>${emp.data_emprestimo ? utils.formatDate(emp.data_emprestimo) : '-'}</td>
            <td>${emp.data_vencimento ? utils.formatDate(emp.data_vencimento) : '-'}</td>
            <td><span class="badge badge-${getStatusBadgeClass(emp.status)}">${emp.status || 'N/A'}</span></td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="viewEmprestimo(${emp.id})">Ver</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }
      
      // Função para obter classe do badge baseado no status
      function getStatusBadgeClass(status) {
        switch(status) {
          case 'Ativo': return 'success';
          case 'Pendente': return 'warning';
          case 'Em Atraso': return 'danger';
          case 'Quitado': return 'info';
          case 'Cancelado': return 'secondary';
          default: return 'secondary';
        }
      }
      
      // Função para atualizar informação de resultados
      function updateSearchResultsInfo() {
        const total = allEmprestimos.length;
        const filtered = filteredEmprestimos.length;
        
        if (filtered === total) {
          searchResultsInfo.textContent = `Mostrando todos os ${total} empréstimos`;
        } else {
          searchResultsInfo.textContent = `Mostrando ${filtered} de ${total} empréstimos`;
        }
      }
      
      // Função para limpar busca
      function clearSearch() {
        searchInput.value = '';
        filterStatus.value = '';
        filteredEmprestimos = [...allEmprestimos];
        renderFilteredEmprestimos();
        updateSearchResultsInfo();
      }
      
      // Event listeners
      searchInput.addEventListener('input', applyFilters);
      filterStatus.addEventListener('change', applyFilters);
      clearSearchBtn.addEventListener('click', clearSearch);
      
      // Sobrescrever a função renderHistoricoEmprestimos para incluir busca
      const originalRenderHistoricoEmprestimos = window.renderHistoricoEmprestimos;
      window.renderHistoricoEmprestimos = async function() {
        try {
          const emprestimos = await apiService.getEmprestimos();
          allEmprestimos = emprestimos || [];
          filteredEmprestimos = [...allEmprestimos];
          
          renderFilteredEmprestimos();
          updateSearchResultsInfo();
        } catch (err) {
          console.error('Erro ao carregar empréstimos:', err);
          const tbody = document.getElementById('historico-emprestimos');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-red-500">Erro ao carregar empréstimos</td></tr>';
          }
        }
      };

      // Inicializar formulário de novo empréstimo
      initNovoEmprestimoForm();
    });

    // Função para inicializar o formulário de novo empréstimo
    function initNovoEmprestimoForm() {
      const toggleFormBtn = document.getElementById('toggleForm');
      const emprestimoForm = document.getElementById('emprestimoForm');
      const novoEmprestimoForm = document.getElementById('novoEmprestimoForm');
      const btnSimular = document.getElementById('btnSimular');
      const btnCancelar = document.getElementById('btnCancelar');
      const clienteSelect = document.getElementById('clienteSelect');
      const tipoClienteInputs = document.querySelectorAll('input[name="tipoCliente"]');
      const clienteExistente = document.getElementById('clienteExistente');
      const novoCliente = document.getElementById('novoCliente');
      const tipoEmprestimoSelect = document.getElementById('tipoEmprestimo');
      const tipoCalculoBtns = document.getElementById('tipoCalculoBtns');
      const camposCalculo = document.getElementById('camposCalculo');
      let tipoCalculoSelecionado = 'fixed';

      // Toggle do formulário
      toggleFormBtn.addEventListener('click', async () => {
        if (emprestimoForm.style.display === 'none') {
          emprestimoForm.style.display = 'block';
          toggleFormBtn.textContent = 'Fechar Formulário';
          await carregarClientes();
          setDataPrimeiraParcelaPadrao();
        } else {
          emprestimoForm.style.display = 'none';
          toggleFormBtn.textContent = 'Novo Empréstimo';
          resetForm();
        }
      });

      // Controle de tipo de cliente (existente/novo)
      tipoClienteInputs.forEach(input => {
        input.addEventListener('change', () => {
          const tipoCliente = document.querySelector('input[name="tipoCliente"]:checked').value;
          if (tipoCliente === 'existente') {
            clienteExistente.style.display = 'block';
            novoCliente.style.display = 'none';
          } else {
            clienteExistente.style.display = 'none';
            novoCliente.style.display = 'block';
          }
        });
      });

      // Controle de tipo de empréstimo
      tipoEmprestimoSelect.addEventListener('change', () => {
        const tipoEmprestimo = tipoEmprestimoSelect.value;
        if (tipoEmprestimo === 'in_installments') {
          camposCalculo.style.display = 'block';
        } else {
          camposCalculo.style.display = 'none';
        }
      });

      // Substituir o controle de tipo de cálculo por botões e campos dinâmicos
      function renderCamposCalculo() {
        let html = '';
        if (tipoCalculoSelecionado === 'fixed') {
          html = `
            <div class="form-group">
              <label class="label-primary">Valor Final de Cobrança (R$)</label>
              <input type="text" name="valorFinal" id="valorFinal" class="input-primary" placeholder="ex.: 1000">
            </div>
          `;
        } else if (tipoCalculoSelecionado === 'fixed-installment') {
          html = `
            <div class="form-group">
              <label class="label-primary">Valor da Parcela (R$)</label>
              <input type="text" name="valorParcela" id="valorParcela" class="input-primary" placeholder="ex.: 100">
            </div>
          `;
        } else if (tipoCalculoSelecionado === 'percentage') {
          html = `
            <div class="form-group">
              <label class="label-primary">Porcentagem (%)</label>
              <input type="number" name="porcentagem" id="porcentagem" class="input-primary" placeholder="ex.: 20">
            </div>
          `;
        }
        camposCalculo.innerHTML = html;
      }

      tipoCalculoBtns.addEventListener('click', (e) => {
        if (e.target && e.target.dataset.calc) {
          tipoCalculoSelecionado = e.target.dataset.calc;
          // Atualiza visual dos botões
          Array.from(tipoCalculoBtns.children).forEach(btn => {
            btn.classList.toggle('active', btn.dataset.calc === tipoCalculoSelecionado);
          });
          renderCamposCalculo();
        }
      });

      // Inicializa campos dinâmicos
      renderCamposCalculo();

      // Carregar clientes
      async function carregarClientes() {
        try {
          const clientes = await apiService.getClientes();
          clienteSelect.innerHTML = '<option value="">Selecione um cliente</option>';
          clientes.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente.id;
            option.textContent = cliente.nome || cliente.razao || cliente.name;
            clienteSelect.appendChild(option);
          });
        } catch (error) {
          console.error('Erro ao carregar clientes:', error);
        }
      }

      // Preencher informações do cliente selecionado
      clienteSelect.addEventListener('change', async () => {
        const clienteId = clienteSelect.value;
        const clienteInfo = document.getElementById('clienteInfo');
        
        if (!clienteId) {
          clienteInfo.style.display = 'none';
          return;
        }

        try {
          const clientes = await apiService.getClientes();
          const cliente = clientes.find(c => c.id == clienteId);
          
          if (cliente) {
            document.getElementById('infoNome').textContent = cliente.nome || cliente.razao || cliente.name || '';
            document.getElementById('infoCpf').textContent = cliente.cpf || cliente.cpf_cnpj || '';
            document.getElementById('infoTelefone').textContent = cliente.telefone || cliente.phone || '';
            
            clienteInfo.style.display = 'block';
          }
        } catch (error) {
          console.error('Erro ao buscar cliente:', error);
        }
      });

      // Simular empréstimo
      btnSimular.addEventListener('click', () => {
        simularEmprestimo();
      });

      function simularEmprestimo() {
        const valor = parseFloat(document.getElementById('valor').value.replace(',', '.')) || 0;
        const valorFinal = parseFloat(document.getElementById('valorFinal').value.replace(',', '.')) || 0;
        const numeroParcelas = parseInt(document.getElementById('numeroParcelas').value) || 1;
        const tipoEmprestimo = document.getElementById('tipoEmprestimo').value;
        const tipoCalculo = tipoCalculoSelecionado;

        let simulacao = {
          valor: valor,
          numeroParcelas: numeroParcelas,
          tipoEmprestimo: tipoEmprestimo,
          tipoCalculo: tipoCalculo
        };

        switch (tipoCalculo) {
          case 'fixed':
            simulacao.valorFinal = valorFinal || valor;
            simulacao.valorParcela = simulacao.valorFinal;
            simulacao.jurosTotal = simulacao.valorFinal - valor;
            break;
          case 'fixed-installment':
            simulacao.valorParcela = valorFinal / numeroParcelas;
            simulacao.valorFinal = valorFinal;
            simulacao.jurosTotal = valorFinal - valor;
            break;
          case 'percentage':
            const porcentagem = valorFinal || 0;
            simulacao.jurosTotal = valor * (porcentagem / 100);
            simulacao.valorFinal = valor + simulacao.jurosTotal;
            simulacao.valorParcela = simulacao.valorFinal / numeroParcelas;
            break;
        }

        exibirSimulacao(simulacao);
      }

      function exibirSimulacao(simulacao) {
        const simulacaoGrid = document.getElementById('simulacaoGrid');
        simulacaoGrid.innerHTML = `
          <div class="simulacao-item">
            <div class="simulacao-label">Valor Principal</div>
            <div class="simulacao-value">R$ ${simulacao.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
          </div>
          <div class="simulacao-item">
            <div class="simulacao-label">Juros Total</div>
            <div class="simulacao-value">R$ ${(simulacao.jurosTotal || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
          </div>
          <div class="simulacao-item">
            <div class="simulacao-label">Valor Total</div>
            <div class="simulacao-value">R$ ${simulacao.valorFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
          </div>
          <div class="simulacao-item">
            <div class="simulacao-label">Valor da Parcela</div>
            <div class="simulacao-value">R$ ${simulacao.valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
          </div>
          <div class="simulacao-item">
            <div class="simulacao-label">Nº de Parcelas</div>
            <div class="simulacao-value">${simulacao.numeroParcelas}</div>
          </div>
          <div class="simulacao-item">
            <div class="simulacao-label">Tipo</div>
            <div class="simulacao-value">${getTipoDisplayName(simulacao.tipoCalculo)}</div>
          </div>
        `;

        simulacaoPreview.classList.add('show');
      }

      function getTipoDisplayName(tipo) {
        const tipos = {
          'fixed': 'Valor Fixo',
          'fixed-installment': 'Parcela Fixa',
          'percentage': 'Porcentagem'
        };
        return tipos[tipo] || tipo;
      }

      // Cancelar formulário
      btnCancelar.addEventListener('click', () => {
        resetForm();
        document.getElementById('emprestimoForm').style.display = 'none';
        document.getElementById('toggleForm').textContent = 'Novo Empréstimo';
      });

      // Reset do formulário
      function resetForm() {
        novoEmprestimoForm.reset();
        document.getElementById('clienteInfo').style.display = 'none';
        simulacaoPreview.classList.remove('show');
        camposCalculo.style.display = 'none';
        clienteExistente.style.display = 'block';
        novoCliente.style.display = 'none';
      }

      // Definir data da primeira parcela padrão (30 dias)
      function setDataPrimeiraParcelaPadrao() {
        const hoje = new Date();
        const primeiraParcela = new Date(hoje);
        primeiraParcela.setDate(hoje.getDate() + 30);
        
        const dataPrimeiraParcela = document.getElementById('dataPrimeiraParcela');
        dataPrimeiraParcela.value = primeiraParcela.toISOString().split('T')[0];
      }

      // Máscara de moeda para campos de valor
      function aplicarMascaraMoeda(elemento) {
        elemento.addEventListener('input', (e) => {
          let valor = e.target.value.replace(/\D/g, '');
          valor = (parseInt(valor, 10) / 100).toFixed(2);
          e.target.value = valor.replace('.', ',');
        });
      }

      // Aplicar máscaras
      aplicarMascaraMoeda(document.getElementById('valor'));
      aplicarMascaraMoeda(document.getElementById('valorFinal'));
      
      // Máscara para CPF/CNPJ
      function aplicarMascaraCPF(elemento) {
        elemento.addEventListener('input', (e) => {
          let valor = e.target.value.replace(/\D/g, '');
          if (valor.length <= 11) {
            valor = valor.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
          } else {
            valor = valor.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
          }
          e.target.value = valor;
        });
      }

      // Máscara para telefone
      function aplicarMascaraTelefone(elemento) {
        elemento.addEventListener('input', (e) => {
          let valor = e.target.value.replace(/\D/g, '');
          if (valor.length <= 10) {
            valor = valor.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
          } else {
            valor = valor.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
          }
          e.target.value = valor;
        });
      }

      // Máscara para CEP
      function aplicarMascaraCEP(elemento) {
        elemento.addEventListener('input', (e) => {
          let valor = e.target.value.replace(/\D/g, '');
          valor = valor.replace(/(\d{5})(\d{3})/, '$1-$2');
          e.target.value = valor;
        });
      }

      // Aplicar máscaras para novo cliente
      aplicarMascaraCPF(document.getElementById('cpfCliente'));
      aplicarMascaraTelefone(document.getElementById('telefoneCliente'));
      aplicarMascaraCEP(document.getElementById('cepCliente'));

      // Submit do formulário
      novoEmprestimoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(novoEmprestimoForm);
        const dados = Object.fromEntries(formData.entries());
        
        // Validações básicas
        const tipoCliente = document.querySelector('input[name="tipoCliente"]:checked').value;
        
        if (tipoCliente === 'existente' && !dados.clienteId) {
          alert('Selecione um cliente existente');
          return;
        }

        if (tipoCliente === 'novo') {
          if (!dados.nomeCliente || !dados.cpfCliente) {
            alert('Para novo cliente, preencha pelo menos nome e CPF/CNPJ');
            return;
          }
        }

        if (!dados.valor || parseFloat(dados.valor.replace(',', '.')) <= 0) {
          alert('Informe um valor válido');
          return;
        }

        if (!dados.tipoEmprestimo) {
          alert('Selecione o tipo de empréstimo');
          return;
        }

        try {
          // Criar cliente se necessário
          let clienteId = dados.clienteId;
          if (tipoCliente === 'novo') {
            const clienteData = {
              nome: dados.nomeCliente,
              cpf_cnpj: dados.cpfCliente.replace(/\D/g, ''),
              telefone: dados.telefoneCliente.replace(/\D/g, ''),
              email: dados.emailCliente || '',
              endereco: dados.enderecoCliente || '',
              cidade: dados.cidadeCliente || '',
              estado: dados.estadoCliente || '',
              cep: dados.cepCliente.replace(/\D/g, '') || ''
            };
            
            const clienteResponse = await apiService.createCliente(clienteData);
            clienteId = clienteResponse.id;
          }

          // Converter datas para o formato YYYY-MM-DD
          function toISODate(dateStr) {
            if (!dateStr) return '';
            const [d, m, y] = dateStr.split('/');
            if (y && m && d) return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            return dateStr; // já está no formato
          }

          // Montar payload conforme a API
          const payload = {
            cliente_id: parseInt(clienteId),
            valor: parseFloat(dados.valor.replace(',', '.')),
            data_emprestimo: toISODate(dados.dataPrimeiraParcela),
            data_vencimento: toISODate(dados.dataPrimeiraParcela),
            juros_mensal: parseFloat(dados.porcentagem || '0') || 0,
            multa_atraso: 0,
            observacoes: dados.observacoes || ''
          };

          // Se for parcelado, enviar campos extras
          if (dados.tipoEmprestimo === 'in_installments') {
            payload.numero_parcelas = parseInt(dados.numeroParcelas) || 1;
            payload.frequencia = dados.frequencia || 'monthly';
            // Valor final pode ser o campo valorFinal ou calculado
            payload.valor_final = parseFloat((dados.valorFinal || dados.valor).replace(',', '.'));
          }

          console.log('Payload enviado para API:', payload);
          await apiService.createEmprestimo(payload);
          
          alert('Empréstimo criado com sucesso!');
          resetForm();
          document.getElementById('emprestimoForm').style.display = 'none';
          document.getElementById('toggleForm').textContent = 'Novo Empréstimo';
          
          // Recarregar lista de empréstimos
          renderHistoricoEmprestimos();
          
        } catch (error) {
          console.error('Erro ao criar empréstimo:', error);
          alert('Erro ao criar empréstimo. Tente novamente.');
        }
      });
    }
  </script>
</body>
</html> 