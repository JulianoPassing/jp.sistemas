<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JP-Cobranças - Histórico de Empréstimos</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/6N82fk2.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
  <style>
    /* Estilos específicos para o modal de empréstimo baseado no emprestimosbase.html */
    .modal-emprestimo {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 16px #002f4b22;
      max-width: 600px;
      margin: 0 auto;
      overflow: hidden;
    }
    
    .modal-emprestimo .modal-header {
      background: var(--terciary);
      color: white;
      padding: 1.5rem;
      text-align: center;
      position: relative;
    }
    
    .modal-emprestimo .modal-header h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-emprestimo .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .modal-emprestimo .modal-close:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .modal-emprestimo .modal-body {
      padding: 2rem;
    }
    
    .form-section {
      margin-bottom: 2rem;
    }
    
    .form-section h4 {
      color: var(--terciary);
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--gray-200);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .form-row.full {
      grid-template-columns: 1fr;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.9rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--terciary);
      box-shadow: 0 0 0 3px rgba(0, 47, 75, 0.1);
    }
    
    .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 80px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: var(--terciary);
      box-shadow: 0 0 0 3px rgba(0, 47, 75, 0.1);
    }
    
    .btn-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .btn-primary {
      background: var(--terciary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      flex: 1;
    }
    
    .btn-primary:hover {
      background: var(--terciary-100);
    }
    
    .btn-secondary {
      background: var(--gray-300);
      color: var(--gray-700);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      flex: 1;
    }
    
    .btn-secondary:hover {
      background: var(--gray-400);
    }
    
    .btn-simular {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 0.9rem;
    }
    
    .btn-simular:hover {
      background: var(--secondary);
    }
    
    .simulacao-preview {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      display: none;
    }
    
    .simulacao-preview.show {
      display: block;
    }
    
    .simulacao-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .simulacao-item:last-child {
      border-bottom: none;
      font-weight: 600;
      color: var(--terciary);
    }
    
    .tipo-emprestimo-info {
      background: var(--gray-100);
      border-left: 4px solid var(--terciary);
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0 8px 8px 0;
    }
    
    .tipo-emprestimo-info h5 {
      color: var(--terciary);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .tipo-emprestimo-info p {
      color: var(--gray-600);
      font-size: 0.9rem;
      margin: 0;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .modal-emprestimo .modal-body {
        padding: 1rem;
      }
    }
  </style>
</head>
<body class="app-layout">
  <header>
    <div class="header-content">
      <a href="index.html" class="logo" style="display: flex; align-items: center;">
        <img src="https://i.imgur.com/EQ1tjZX.png" alt="JP-Cobranças" style="height: 5rem; width: auto; object-fit: contain;">
      </a>
      <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
      <div class="nav-wrapper">
        <nav>
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="clientes.html" class="nav-link">Clientes</a>
          <a href="adicionar-cliente.html" class="nav-link">Adicionar Cliente</a>
          <a href="cobrancas.html" class="nav-link">Cobranças</a>
          <a href="atrasados.html" class="nav-link">Atrasados</a>
          <a href="lista-negra.html" class="nav-link">Lista Negra</a>
          <a href="emprestimos.html" class="nav-link active">Histórico de Empréstimos</a>
          <a href="#" class="nav-link" onclick="sair()">Sair</a>
        </nav>
      </div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="dashboard-header">
        <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
        <div class="dashboard-title">Histórico de Empréstimos</div>
        <div class="dashboard-subtitle">
          Visualize todo o histórico de empréstimos do sistema.
        </div>
      </div>
      <!-- Tabela de Histórico de Empréstimos -->
      <div class="section">
        <div class="section-header">
          <h3 class="section-title">Empréstimos</h3>
          <button id="toggleForm" class="btn btn-primary">Novo Empréstimo</button>
        </div>
        
        <!-- Caixa de Busca -->
        <div class="search-container" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
              <input 
                type="text" 
                id="search-emprestimos" 
                class="form-input" 
                placeholder="Buscar por cliente, valor, status..."
                style="width: 100%;"
              >
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <select id="filter-status" class="form-input" style="min-width: 120px;">
                <option value="">Todos os Status</option>
                <option value="Ativo">Ativo</option>
                <option value="Pendente">Pendente</option>
                <option value="Em Atraso">Em Atraso</option>
                <option value="Quitado">Quitado</option>
                <option value="Cancelado">Cancelado</option>
              </select>
              <button id="clear-search" class="btn btn-secondary" style="white-space: nowrap;">Limpar</button>
            </div>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
            <span id="search-results-info">Mostrando todos os empréstimos</span>
          </div>
        </div>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Data Empréstimo</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="historico-emprestimos">
              <tr>
                <td colspan="6" class="text-center text-gray-500">Carregando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Modal de Novo Empréstimo -->
  <div id="modal-emprestimo" class="modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-emprestimo">
      <div class="modal-header">
        <h3>Adicionar Empréstimo</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="form-emprestimo">
          <!-- Seção: Tipo de Empréstimo -->
          <div class="form-section">
            <h4>Tipo de Empréstimo</h4>
            <div class="form-group">
              <label class="form-label">Selecione o tipo de empréstimo *</label>
              <select id="tipo-emprestimo" class="form-select" required>
                <option value="">Selecione um tipo</option>
                <option value="fixo">Fixo</option>
                <option value="parcelado-valor-fixo">Parcelado - Valor Fixo</option>
                <option value="parcelado-parcela-fixa">Parcelado - Parcela Fixa</option>
                <option value="parcelado-porcentagem">Parcelado - Porcentagem</option>
              </select>
            </div>
            
            <!-- Informações sobre o tipo selecionado -->
            <div id="tipo-info" class="tipo-emprestimo-info" style="display: none;">
              <h5 id="tipo-titulo"></h5>
              <p id="tipo-descricao"></p>
            </div>
          </div>

          <!-- Seção: Dados do Cliente -->
          <div class="form-section">
            <h4>Dados do Cliente</h4>
            <div class="form-group">
              <label class="form-label">Cliente existente</label>
              <select id="cliente-select" class="form-select">
                <option value="">Novo cliente (preencher dados abaixo)</option>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nome *</label>
                <input type="text" id="nome-cliente" class="form-input" required placeholder="Nome completo">
              </div>
              <div class="form-group">
                <label class="form-label">CPF/CNPJ</label>
                <input type="text" id="cpf-cliente" class="form-input" placeholder="CPF ou CNPJ">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Telefone</label>
                <input type="text" id="telefone-cliente" class="form-input" placeholder="Telefone">
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="email-cliente" class="form-input" placeholder="Email">
              </div>
            </div>
          </div>

          <!-- Seção: Dados do Empréstimo -->
          <div class="form-section">
            <h4>Dados do Empréstimo</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Valor do empréstimo (R$) *</label>
                <input type="number" id="valor-emprestimo" class="form-input" step="0.01" min="0" required placeholder="0,00">
              </div>
              <div class="form-group">
                <label class="form-label">Juros mensal (%) *</label>
                <input type="number" id="juros-mensal" class="form-input" step="0.01" min="0" required placeholder="0,00">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Multa por atraso (%) *</label>
                <input type="number" id="multa-atraso" class="form-input" step="0.01" min="0" required placeholder="0,00">
              </div>
              <div class="form-group">
                <label class="form-label">Número de parcelas *</label>
                <input type="number" id="numero-parcelas" class="form-input" min="1" value="1" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Data do empréstimo *</label>
                <input type="date" id="data-emprestimo" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Data de vencimento *</label>
                <input type="date" id="data-vencimento" class="form-input" required>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Observações</label>
              <textarea id="observacoes" class="form-textarea" placeholder="Observações sobre o empréstimo"></textarea>
            </div>
          </div>

          <!-- Botão de Simulação -->
          <div class="form-group">
            <button type="button" id="btn-simular" class="btn-simular">Simular Empréstimo</button>
          </div>

          <!-- Preview da Simulação -->
          <div id="simulacao-preview" class="simulacao-preview">
            <h5 style="color: var(--terciary); margin-bottom: 1rem;">Simulação do Empréstimo</h5>
            <div id="simulacao-content"></div>
          </div>

          <!-- Botões de Ação -->
          <div class="btn-group">
            <button type="submit" class="btn-primary">Adicionar Empréstimo</button>
            <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer class="text-center p-4 mt-8">
    © 2024 JP-Cobranças. Todos os direitos reservados.
  </footer>
  <script src="./js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('mobile-menu-toggle');
      const navWrapper = document.querySelector('.nav-wrapper');
      if (menuBtn && navWrapper) {
        menuBtn.addEventListener('click', function() {
          navWrapper.classList.toggle('open');
        });
      }

      // Carregar histórico de empréstimos
      renderHistoricoEmprestimos();
      
      // Funcionalidade de busca
      const searchInput = document.getElementById('search-emprestimos');
      const filterStatus = document.getElementById('filter-status');
      const clearSearchBtn = document.getElementById('clear-search');
      const searchResultsInfo = document.getElementById('search-results-info');
      
      let allEmprestimos = []; // Armazenar todos os empréstimos
      let filteredEmprestimos = []; // Empréstimos filtrados
      
      // Função para aplicar filtros
      function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const statusFilter = filterStatus.value;
        
        filteredEmprestimos = allEmprestimos.filter(emp => {
          // Filtro por termo de busca
          const matchesSearch = !searchTerm || 
            (emp.cliente_nome && emp.cliente_nome.toLowerCase().includes(searchTerm)) ||
            (emp.valor && emp.valor.toString().includes(searchTerm)) ||
            (emp.status && emp.status.toLowerCase().includes(searchTerm)) ||
            (emp.data_emprestimo && emp.data_emprestimo.includes(searchTerm)) ||
            (emp.data_vencimento && emp.data_vencimento.includes(searchTerm));
          
          // Filtro por status
          const matchesStatus = !statusFilter || emp.status === statusFilter;
          
          return matchesSearch && matchesStatus;
        });
        
        // Atualizar tabela
        renderFilteredEmprestimos();
        
        // Atualizar informação de resultados
        updateSearchResultsInfo();
      }
      
      // Função para renderizar empréstimos filtrados
      function renderFilteredEmprestimos() {
        const tbody = document.getElementById('historico-emprestimos');
        if (!tbody) return;
        
        if (filteredEmprestimos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Nenhum empréstimo encontrado</td></tr>';
          return;
        }
        
        tbody.innerHTML = '';
        filteredEmprestimos.forEach(emp => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${emp.cliente_nome || 'N/A'}</td>
            <td>R$ ${utils.formatCurrency(emp.valor || 0)}</td>
            <td>${emp.data_emprestimo ? utils.formatDate(emp.data_emprestimo) : '-'}</td>
            <td>${emp.data_vencimento ? utils.formatDate(emp.data_vencimento) : '-'}</td>
            <td><span class="badge badge-${getStatusBadgeClass(emp.status)}">${emp.status || 'N/A'}</span></td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="viewEmprestimo(${emp.id})">Ver</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }
      
      // Função para obter classe do badge baseado no status
      function getStatusBadgeClass(status) {
        switch(status) {
          case 'Ativo': return 'success';
          case 'Pendente': return 'warning';
          case 'Em Atraso': return 'danger';
          case 'Quitado': return 'info';
          case 'Cancelado': return 'secondary';
          default: return 'secondary';
        }
      }
      
      // Função para atualizar informação de resultados
      function updateSearchResultsInfo() {
        const total = allEmprestimos.length;
        const filtered = filteredEmprestimos.length;
        
        if (filtered === total) {
          searchResultsInfo.textContent = `Mostrando todos os ${total} empréstimos`;
        } else {
          searchResultsInfo.textContent = `Mostrando ${filtered} de ${total} empréstimos`;
        }
      }
      
      // Função para limpar busca
      function clearSearch() {
        searchInput.value = '';
        filterStatus.value = '';
        filteredEmprestimos = [...allEmprestimos];
        renderFilteredEmprestimos();
        updateSearchResultsInfo();
      }
      
      // Event listeners
      searchInput.addEventListener('input', applyFilters);
      filterStatus.addEventListener('change', applyFilters);
      clearSearchBtn.addEventListener('click', clearSearch);
      
      // Sobrescrever a função renderHistoricoEmprestimos para incluir busca
      const originalRenderHistoricoEmprestimos = window.renderHistoricoEmprestimos;
      window.renderHistoricoEmprestimos = async function() {
        try {
          const emprestimos = await apiService.getEmprestimos();
          allEmprestimos = emprestimos || [];
          filteredEmprestimos = [...allEmprestimos];
          
          renderFilteredEmprestimos();
          updateSearchResultsInfo();
        } catch (err) {
          console.error('Erro ao carregar empréstimos:', err);
          const tbody = document.getElementById('historico-emprestimos');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500">Erro ao carregar empréstimos</td></tr>';
          }
        }
      };

      // Modal de Novo Empréstimo
      const toggleFormBtn = document.getElementById('toggleForm');
      const modal = document.getElementById('modal-emprestimo');
      const form = document.getElementById('form-emprestimo');
      const tipoSelect = document.getElementById('tipo-emprestimo');
      const tipoInfo = document.getElementById('tipo-info');
      const tipoTitulo = document.getElementById('tipo-titulo');
      const tipoDescricao = document.getElementById('tipo-descricao');
      const btnSimular = document.getElementById('btn-simular');
      const simulacaoPreview = document.getElementById('simulacao-preview');
      const simulacaoContent = document.getElementById('simulacao-content');

      // Abrir modal
      toggleFormBtn.addEventListener('click', async () => {
        // Carregar clientes
        try {
          const clientes = await apiService.getClientes();
          const clienteSelect = document.getElementById('cliente-select');
          clienteSelect.innerHTML = '<option value="">Novo cliente (preencher dados abaixo)</option>';
          clientes.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente.id;
            option.textContent = cliente.nome || cliente.razao || cliente.name;
            clienteSelect.appendChild(option);
          });
        } catch (err) {
          console.error('Erro ao carregar clientes:', err);
        }

        // Preencher data atual
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('data-emprestimo').value = hoje;
        
        modal.style.display = 'flex';
      });

      // Fechar modal
      window.closeModal = function() {
        modal.style.display = 'none';
        form.reset();
        tipoInfo.style.display = 'none';
        simulacaoPreview.classList.remove('show');
      };

      // Informações sobre tipos de empréstimo
      const tiposInfo = {
        'fixo': {
          titulo: 'Empréstimo Fixo',
          descricao: 'Valor fixo a ser pago no vencimento. Juros simples aplicados sobre o valor principal.'
        },
        'parcelado-valor-fixo': {
          titulo: 'Parcelado - Valor Fixo',
          descricao: 'Cada parcela tem o mesmo valor fixo. O valor total pode variar conforme o número de parcelas.'
        },
        'parcelado-parcela-fixa': {
          titulo: 'Parcelado - Parcela Fixa',
          descricao: 'Valor total fixo dividido em parcelas iguais. O valor da parcela é calculado automaticamente.'
        },
        'parcelado-porcentagem': {
          titulo: 'Parcelado - Porcentagem',
          descricao: 'Juros compostos aplicados mensalmente. O valor das parcelas aumenta ao longo do tempo.'
        }
      };

      // Mostrar informações do tipo selecionado
      tipoSelect.addEventListener('change', function() {
        const tipo = this.value;
        if (tipo && tiposInfo[tipo]) {
          tipoTitulo.textContent = tiposInfo[tipo].titulo;
          tipoDescricao.textContent = tiposInfo[tipo].descricao;
          tipoInfo.style.display = 'block';
        } else {
          tipoInfo.style.display = 'none';
        }
      });

      // Preencher dados do cliente ao selecionar
      document.getElementById('cliente-select').addEventListener('change', function() {
        const selectedId = this.value;
        if (!selectedId) {
          document.getElementById('nome-cliente').value = '';
          document.getElementById('cpf-cliente').value = '';
          document.getElementById('telefone-cliente').value = '';
          document.getElementById('email-cliente').value = '';
        } else {
          // Buscar dados do cliente selecionado
          apiService.getClientes().then(clientes => {
            const cliente = clientes.find(c => String(c.id) === String(selectedId));
            if (cliente) {
              document.getElementById('nome-cliente').value = cliente.nome || cliente.razao || cliente.name || '';
              document.getElementById('cpf-cliente').value = cliente.cpf || cliente.cpf_cnpj || '';
              document.getElementById('telefone-cliente').value = cliente.telefone || cliente.phone || '';
              document.getElementById('email-cliente').value = cliente.email || '';
            }
          });
        }
      });

      // Simulação do empréstimo
      btnSimular.addEventListener('click', function() {
        const valor = parseFloat(document.getElementById('valor-emprestimo').value) || 0;
        const juros = parseFloat(document.getElementById('juros-mensal').value) || 0;
        const parcelas = parseInt(document.getElementById('numero-parcelas').value) || 1;
        const tipo = document.getElementById('tipo-emprestimo').value;

        if (!valor || !juros || !parcelas || !tipo) {
          alert('Preencha todos os campos obrigatórios para simular');
          return;
        }

        let simulacao = '';
        
        switch(tipo) {
          case 'fixo':
            const jurosTotal = valor * (juros / 100);
            const valorTotal = valor + jurosTotal;
            simulacao = `
              <div class="simulacao-item">
                <span>Valor principal:</span>
                <span>R$ ${valor.toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Juros (${juros}%):</span>
                <span>R$ ${jurosTotal.toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Valor total a pagar:</span>
                <span>R$ ${valorTotal.toFixed(2)}</span>
              </div>
            `;
            break;
            
          case 'parcelado-valor-fixo':
            const valorParcela = valor / parcelas;
            const jurosParcela = valorParcela * (juros / 100);
            const valorTotalParcela = valorParcela + jurosParcela;
            simulacao = `
              <div class="simulacao-item">
                <span>Valor da parcela:</span>
                <span>R$ ${valorParcela.toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Juros por parcela:</span>
                <span>R$ ${jurosParcela.toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Valor total por parcela:</span>
                <span>R$ ${valorTotalParcela.toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Total geral (${parcelas} parcelas):</span>
                <span>R$ ${(valorTotalParcela * parcelas).toFixed(2)}</span>
              </div>
            `;
            break;
            
          case 'parcelado-parcela-fixa':
            const valorTotalFixo = valor * (1 + juros / 100);
            const valorParcelaFixa = valorTotalFixo / parcelas;
            simulacao = `
              <div class="simulacao-item">
                <span>Valor principal:</span>
                <span>R$ ${valor.toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Juros total (${juros}%):</span>
                <span>R$ ${(valorTotalFixo - valor).toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Valor total a pagar:</span>
                <span>R$ ${valorTotalFixo.toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Valor de cada parcela:</span>
                <span>R$ ${valorParcelaFixa.toFixed(2)}</span>
              </div>
            `;
            break;
            
          case 'parcelado-porcentagem':
            let valorAtual = valor;
            let jurosAcumulado = 0;
            let valorParcelaAtual = 0;
            
            for (let i = 1; i <= parcelas; i++) {
              const jurosMes = valorAtual * (juros / 100);
              jurosAcumulado += jurosMes;
              valorParcelaAtual = valor / parcelas + jurosMes;
              valorAtual += jurosMes;
            }
            
            simulacao = `
              <div class="simulacao-item">
                <span>Valor principal:</span>
                <span>R$ ${valor.toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Juros acumulados:</span>
                <span>R$ ${jurosAcumulado.toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Valor total a pagar:</span>
                <span>R$ ${(valor + jurosAcumulado).toFixed(2)}</span>
              </div>
              <div class="simulacao-item">
                <span>Última parcela (aproximada):</span>
                <span>R$ ${valorParcelaAtual.toFixed(2)}</span>
              </div>
            `;
            break;
        }
        
        simulacaoContent.innerHTML = simulacao;
        simulacaoPreview.classList.add('show');
      });

      // Submissão do formulário
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const clienteId = document.getElementById('cliente-select').value;
        
        // Criar ou buscar cliente
        let clienteIdFinal = clienteId;
        if (!clienteId) {
          const clienteData = {
            nome: document.getElementById('nome-cliente').value,
            cpf_cnpj: document.getElementById('cpf-cliente').value,
            telefone: document.getElementById('telefone-cliente').value,
            email: document.getElementById('email-cliente').value
          };
          
          try {
            const clienteResponse = await fetch('/api/cobrancas/clientes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(clienteData)
            });
            
            if (!clienteResponse.ok) {
              throw new Error('Erro ao criar cliente');
            }
            
            const clienteResult = await clienteResponse.json();
            clienteIdFinal = clienteResult.id;
          } catch (err) {
            ui.showNotification('Erro ao criar cliente', 'error');
            return;
          }
        }
        
        // Dados do empréstimo
        const emprestimoData = {
          cliente_id: clienteIdFinal,
          valor: parseFloat(document.getElementById('valor-emprestimo').value),
          data_emprestimo: document.getElementById('data-emprestimo').value,
          data_vencimento: document.getElementById('data-vencimento').value,
          juros_mensal: parseFloat(document.getElementById('juros-mensal').value),
          multa_atraso: parseFloat(document.getElementById('multa-atraso').value),
          parcelas: parseInt(document.getElementById('numero-parcelas').value),
          tipo_emprestimo: document.getElementById('tipo-emprestimo').value,
          observacoes: document.getElementById('observacoes').value
        };
        
        try {
          const response = await fetch('/api/cobrancas/emprestimos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(emprestimoData)
          });
          
          if (!response.ok) {
            throw new Error('Erro ao criar empréstimo');
          }
          
          ui.showNotification('Empréstimo criado com sucesso!', 'success');
          closeModal();
          
          // Recarregar lista
          setTimeout(() => {
            renderHistoricoEmprestimos();
          }, 500);
          
        } catch (err) {
          ui.showNotification('Erro ao criar empréstimo', 'error');
        }
      });
    });
  </script>
</body>
</html> 