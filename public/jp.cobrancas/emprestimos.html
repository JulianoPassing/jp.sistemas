<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JP-Cobran√ßas - Hist√≥rico de Empr√©stimos</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/6N82fk2.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body class="app-layout">
  <header>
    <div class="header-content">
      <a href="index.html" class="logo" style="display: flex; align-items: center;">
        <img src="https://i.imgur.com/EQ1tjZX.png" alt="JP-Cobran√ßas" style="height: 5rem; width: auto; object-fit: contain;">
      </a>
      <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
      <div class="nav-wrapper">
        <nav>
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="clientes.html" class="nav-link">Clientes</a>
          <a href="adicionar-cliente.html" class="nav-link">Adicionar Cliente</a>
          <a href="cobrancas.html" class="nav-link">Cobran√ßas</a>
          <a href="atrasados.html" class="nav-link">Atrasados</a>
          <a href="lista-negra.html" class="nav-link">Lista Negra</a>
          <a href="emprestimos.html" class="nav-link active">Hist√≥rico de Empr√©stimos</a>
          <a href="#" class="nav-link" onclick="sair()">Sair</a>
        </nav>
      </div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="dashboard-header">
        <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
        <div class="dashboard-title">Hist√≥rico de Empr√©stimos</div>
        <div class="dashboard-subtitle">
          Visualize todo o hist√≥rico de empr√©stimos do sistema.
        </div>
      </div>
      <!-- Tabela de Hist√≥rico de Empr√©stimos -->
      <div class="section">
        <div class="section-header">
          <h3 class="section-title">Empr√©stimos</h3>
          <button id="toggleForm" class="btn btn-primary">Novo Empr√©stimo</button>
        </div>
        
        <!-- Caixa de Busca -->
        <div class="search-container" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
              <input 
                type="text" 
                id="search-emprestimos" 
                class="form-input" 
                placeholder="Buscar por cliente, valor, status..."
                style="width: 100%;"
              >
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <select id="filter-status" class="form-input" style="min-width: 120px;">
                <option value="">Todos os Status</option>
                <option value="Ativo">Ativo</option>
                <option value="Pendente">Pendente</option>
                <option value="Em Atraso">Em Atraso</option>
                <option value="Quitado">Quitado</option>
                <option value="Cancelado">Cancelado</option>
              </select>
              <button id="clear-search" class="btn btn-secondary" style="white-space: nowrap;">Limpar</button>
            </div>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
            <span id="search-results-info">Mostrando todos os empr√©stimos</span>
          </div>
        </div>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Data Empr√©stimo</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="historico-emprestimos">
              <tr>
                <td colspan="6" class="text-center text-gray-500">Carregando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  <footer class="text-center p-4 mt-8">
    ¬© 2024 JP-Cobran√ßas. Todos os direitos reservados.
  </footer>
  <script src="./js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('mobile-menu-toggle');
      const navWrapper = document.querySelector('.nav-wrapper');
      if (menuBtn && navWrapper) {
        menuBtn.addEventListener('click', function() {
          navWrapper.classList.toggle('open');
        });
      }

      // Carregar hist√≥rico de empr√©stimos
      renderHistoricoEmprestimos();
      
      // Funcionalidade de busca
      const searchInput = document.getElementById('search-emprestimos');
      const filterStatus = document.getElementById('filter-status');
      const clearSearchBtn = document.getElementById('clear-search');
      const searchResultsInfo = document.getElementById('search-results-info');
      
      let allEmprestimos = []; // Armazenar todos os empr√©stimos
      let filteredEmprestimos = []; // Empr√©stimos filtrados
      
      // Fun√ß√£o para aplicar filtros
      function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const statusFilter = filterStatus.value;
        
        filteredEmprestimos = allEmprestimos.filter(emp => {
          // Filtro por termo de busca
          const matchesSearch = !searchTerm || 
            (emp.cliente_nome && emp.cliente_nome.toLowerCase().includes(searchTerm)) ||
            (emp.valor && emp.valor.toString().includes(searchTerm)) ||
            (emp.status && emp.status.toLowerCase().includes(searchTerm)) ||
            (emp.data_emprestimo && emp.data_emprestimo.includes(searchTerm)) ||
            (emp.data_vencimento && emp.data_vencimento.includes(searchTerm));
          
          // Filtro por status
          const matchesStatus = !statusFilter || emp.status === statusFilter;
          
          return matchesSearch && matchesStatus;
        });
        
        // Atualizar tabela
        renderFilteredEmprestimos();
        
        // Atualizar informa√ß√£o de resultados
        updateSearchResultsInfo();
      }
      
      // Fun√ß√£o para renderizar empr√©stimos filtrados
      function renderFilteredEmprestimos() {
        console.log('üé® [DEBUG] Iniciando renderiza√ß√£o de empr√©stimos filtrados...');
        console.log(`üìã [DEBUG] Renderiza√ß√£o: ${filteredEmprestimos.length} empr√©stimos para renderizar`);
        
        const tbody = document.getElementById('historico-emprestimos');
        if (!tbody) {
          console.error('‚ùå [DEBUG] Tabela n√£o encontrada!');
          return;
        }
        
        // Verifica√ß√£o final de duplicatas antes da renderiza√ß√£o
        const idsRenderizacao = new Set();
        const emprestimosSemDuplicatas = [];
        
        for (const emprestimo of filteredEmprestimos) {
          if (idsRenderizacao.has(emprestimo.id)) {
            console.error(`üö® [DEBUG] DUPLICATA DETECTADA NA RENDERIZA√á√ÉO: ID ${emprestimo.id} - ${emprestimo.cliente_nome}`);
            continue;
          }
          idsRenderizacao.add(emprestimo.id);
          emprestimosSemDuplicatas.push(emprestimo);
        }
        
        console.log(`üîç [DEBUG] Ap√≥s verifica√ß√£o de renderiza√ß√£o: ${emprestimosSemDuplicatas.length} empr√©stimos √∫nicos`);
        
        if (emprestimosSemDuplicatas.length !== filteredEmprestimos.length) {
          console.warn(`‚ö†Ô∏è  [DEBUG] Foram removidas ${filteredEmprestimos.length - emprestimosSemDuplicatas.length} duplicatas na renderiza√ß√£o`);
        }
        
        tbody.innerHTML = '';
        
        if (emprestimosSemDuplicatas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Nenhum empr√©stimo encontrado</td></tr>';
          return;
        }
        
        console.log('üìù [DEBUG] Empr√©stimos que ser√£o renderizados:');
        emprestimosSemDuplicatas.forEach((emprestimo, index) => {
          console.log(`  ${index + 1}. ID: ${emprestimo.id} | Cliente: ${emprestimo.cliente_nome} | Status: ${emprestimo.status}`);
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-4 py-2 font-medium text-gray-900">${emprestimo.cliente_nome || 'N/A'}</td>
            <td class="px-4 py-2 text-gray-700">R$ ${parseFloat(emprestimo.valor || 0).toFixed(2).replace('.', ',')}</td>
            <td class="px-4 py-2 text-gray-700">${emprestimo.data_emprestimo ? new Date(emprestimo.data_emprestimo + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
            <td class="px-4 py-2 text-gray-700">${emprestimo.data_vencimento ? new Date(emprestimo.data_vencimento + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
            <td class="px-4 py-2">
              <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusColor(emprestimo.status)}">
                ${emprestimo.status || 'N/A'}
              </span>
            </td>
            <td class="px-4 py-2">
              <button 
                class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors"
                onclick="window.location.href='emprestimo-detalhes.html?id=${emprestimo.id}'"
              >
                Ver
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
        console.log(`‚úÖ [DEBUG] Renderiza√ß√£o conclu√≠da: ${emprestimosSemDuplicatas.length} linhas adicionadas √† tabela`);
      }
      
      // Fun√ß√£o para obter classe do badge baseado no status
      function getStatusBadgeClass(status) {
        switch(status) {
          case 'Ativo': return 'success';
          case 'Pendente': return 'warning';
          case 'Em Atraso': return 'danger';
          case 'Quitado': return 'info';
          case 'Cancelado': return 'secondary';
          default: return 'secondary';
        }
      }
      
      // Fun√ß√£o para atualizar informa√ß√£o de resultados
      function updateSearchResultsInfo() {
        const total = allEmprestimos.length;
        const filtered = filteredEmprestimos.length;
        
        if (filtered === total) {
          searchResultsInfo.textContent = `Mostrando todos os ${total} empr√©stimos`;
        } else {
          searchResultsInfo.textContent = `Mostrando ${filtered} de ${total} empr√©stimos`;
        }
      }
      
      // Fun√ß√£o para limpar busca
      function clearSearch() {
        searchInput.value = '';
        filterStatus.value = '';
        filteredEmprestimos = [...allEmprestimos];
        renderFilteredEmprestimos();
        updateSearchResultsInfo();
      }
      
      // Event listeners
      searchInput.addEventListener('input', applyFilters);
      filterStatus.addEventListener('change', applyFilters);
      clearSearchBtn.addEventListener('click', clearSearch);
      
      // Sobrescrever a fun√ß√£o renderHistoricoEmprestimos para incluir busca
      const originalRenderHistoricoEmprestimos = window.renderHistoricoEmprestimos;
      window.renderHistoricoEmprestimos = async function() {
        console.log('üîç [DEBUG] Hist√≥rico: Iniciando carregamento de empr√©stimos...');
        
        try {
          const emprestimos = await apiService.getEmprestimos();
          console.log(`üìã [DEBUG] Hist√≥rico: API retornou ${emprestimos ? emprestimos.length : 0} empr√©stimos`);
          
          if (!emprestimos || emprestimos.length === 0) {
            console.warn('‚ö†Ô∏è  [DEBUG] Nenhum empr√©stimo retornado pela API');
            allEmprestimos = [];
            filteredEmprestimos = [];
            renderFilteredEmprestimos();
            return;
          }
          
          // Log detalhado de TODOS os empr√©stimos recebidos
          console.log('üìù [DEBUG] Empr√©stimos recebidos da API:');
          emprestimos.forEach((emp, index) => {
            console.log(`  ${index + 1}. ID: ${emp.id} | Cliente: ${emp.cliente_nome} | Valor: R$ ${emp.valor} | Status: ${emp.status}`);
          });
          
          // Usar Set para garantir IDs √∫nicos de forma mais rigorosa
          const idsProcessados = new Set();
          const emprestimosUnicos = [];
          
          console.log('üîÑ [DEBUG] Iniciando filtragem de duplicatas...');
          
          for (let i = 0; i < emprestimos.length; i++) {
            const emprestimo = emprestimos[i];
            
            // Verificar se j√° processamos este ID
            if (idsProcessados.has(emprestimo.id)) {
              console.warn(`üö® [DEBUG] DUPLICATA DETECTADA E IGNORADA: ID ${emprestimo.id} - ${emprestimo.cliente_nome} (posi√ß√£o ${i + 1})`);
              continue;
            }
            
            console.log(`‚úÖ [DEBUG] Processando empr√©stimo √∫nico: ID ${emprestimo.id} - ${emprestimo.cliente_nome}`);
            
            // Verificar status baseado em parcelas
            try {
              const parcelas = await apiService.getParcelasEmprestimo(emprestimo.id);
              const hoje = new Date();
              hoje.setHours(0,0,0,0);
              let status = (emprestimo.status || '').toUpperCase();
              
              if (parcelas && parcelas.length > 0) {
                console.log(`  üìÖ [DEBUG] Empr√©stimo ${emprestimo.id} tem ${parcelas.length} parcelas`);
                
                const parcelasAtrasadas = parcelas.filter(p => {
                  const dataVencParcela = new Date(p.data_vencimento);
                  return dataVencParcela < hoje && (p.status !== 'Paga');
                });
                
                const parcelasPagas = parcelas.filter(p => p.status === 'Paga');
                
                if (parcelasPagas.length === parcelas.length) {
                  status = 'QUITADO';
                } else if (parcelasAtrasadas.length > 0) {
                  status = 'ATRASADO';
                } else {
                  status = 'ATIVO';
                }
                
                console.log(`  üîÑ [DEBUG] Status atualizado para: ${status} (${parcelasPagas.length}/${parcelas.length} pagas, ${parcelasAtrasadas.length} atrasadas)`);
              } else {
                console.log(`  üìÑ [DEBUG] Empr√©stimo ${emprestimo.id} sem parcelas, usando data de vencimento`);
                const dataVencimento = emprestimo.data_vencimento ? new Date(emprestimo.data_vencimento) : null;
                if (dataVencimento && dataVencimento < hoje && status !== 'QUITADO') {
                  status = 'ATRASADO';
                }
              }
              
              // Atualizar status no empr√©stimo
              emprestimo.status = status;
              
            } catch (error) {
              console.error(`‚ùå [DEBUG] Erro ao verificar parcelas do empr√©stimo ${emprestimo.id}:`, error);
            }
            
            // Marcar ID como processado e adicionar √† lista
            idsProcessados.add(emprestimo.id);
            emprestimosUnicos.push(emprestimo);
            
            console.log(`  ‚úÖ [DEBUG] Empr√©stimo ID ${emprestimo.id} adicionado √† lista √∫nica`);
          }
          
          console.log(`üìä [DEBUG] RESULTADO DA FILTRAGEM:`);
          console.log(`  - Empr√©stimos recebidos: ${emprestimos.length}`);
          console.log(`  - Empr√©stimos √∫nicos: ${emprestimosUnicos.length}`);
          console.log(`  - Duplicatas removidas: ${emprestimos.length - emprestimosUnicos.length}`);
          
          console.log('üìù [DEBUG] Lista final de empr√©stimos √∫nicos:');
          emprestimosUnicos.forEach((emp, index) => {
            console.log(`  ${index + 1}. ID: ${emp.id} | Cliente: ${emp.cliente_nome} | Valor: R$ ${emp.valor} | Status: ${emp.status}`);
          });
          
          // Garantir que n√£o h√° duplicatas na lista final
          const verificacaoFinal = new Set();
          const listaFinalLimpa = [];
          
          for (const emp of emprestimosUnicos) {
            if (!verificacaoFinal.has(emp.id)) {
              verificacaoFinal.add(emp.id);
              listaFinalLimpa.push(emp);
            } else {
              console.error(`üö® [DEBUG] ERRO: Ainda h√° duplicata na lista final! ID ${emp.id}`);
            }
          }
          
          console.log(`üîí [DEBUG] Verifica√ß√£o final: ${listaFinalLimpa.length} empr√©stimos √∫nicos confirmados`);
          
          allEmprestimos = listaFinalLimpa;
          filteredEmprestimos = [...allEmprestimos];
          
          renderFilteredEmprestimos();
          updateSearchResultsInfo();
          
          console.log('‚úÖ [DEBUG] Renderiza√ß√£o conclu√≠da com sucesso!');
          
        } catch (err) {
          console.error('‚ùå [DEBUG] Erro ao carregar empr√©stimos:', err);
          const tbody = document.getElementById('historico-emprestimos');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500">Erro ao carregar empr√©stimos</td></tr>';
          }
        }
      };

      // Fun√ß√£o para limpar cache e for√ßar recarregamento
      function limparCacheCompleto() {
        console.log('üßπ [DEBUG] Limpando cache completo...');
        
        // Limpar todas as vari√°veis globais
        allEmprestimos = [];
        filteredEmprestimos = [];
        
        // Limpar localStorage se existir
        if (typeof Storage !== 'undefined') {
          localStorage.removeItem('emprestimos');
          localStorage.removeItem('filteredEmprestimos');
          sessionStorage.removeItem('emprestimos');
          sessionStorage.removeItem('filteredEmprestimos');
        }
        
        // Limpar a tabela
        const tbody = document.getElementById('historico-emprestimos');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">Recarregando...</td></tr>';
        }
        
        console.log('üßπ [DEBUG] Cache limpo, recarregando dados...');
        
        // Aguardar um pouco e recarregar
        setTimeout(() => {
          window.renderHistoricoEmprestimos();
        }, 500);
      }

      // Adicionar bot√£o de debug na p√°gina
      const debugButton = document.createElement('button');
      debugButton.innerHTML = 'üîß Debug Limpar Cache';
      debugButton.className = 'bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors';
      debugButton.style.position = 'fixed';
      debugButton.style.top = '10px';
      debugButton.style.right = '10px';
      debugButton.style.zIndex = '9999';
      debugButton.onclick = limparCacheCompleto;
      document.body.appendChild(debugButton);
    });
  </script>
</body>
</html> 