<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JP-Cobran√ßas - Hist√≥rico de Empr√©stimos</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/6N82fk2.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body class="app-layout">
  <header>
    <div class="header-content">
      <a href="index.html" class="logo" style="display: flex; align-items: center;">
        <img src="https://i.imgur.com/EQ1tjZX.png" alt="JP-Cobran√ßas" style="height: 5rem; width: auto; object-fit: contain;">
      </a>
      <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
      <div class="nav-wrapper">
        <nav>
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="clientes.html" class="nav-link">Clientes</a>
          <a href="adicionar-cliente.html" class="nav-link">Adicionar Cliente</a>
          <a href="cobrancas.html" class="nav-link">Cobran√ßas</a>
          <a href="atrasados.html" class="nav-link">Atrasados</a>
          <a href="lista-negra.html" class="nav-link">Lista Negra</a>
          <a href="emprestimos.html" class="nav-link">Empr√©stimos</a>
          <a href="historico.html" class="nav-link">Hist√≥rico</a>
          <a href="#" class="nav-link" onclick="sair()">Sair</a>
        </nav>
      </div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="dashboard-header">
        <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
        <div class="dashboard-title">Hist√≥rico de Empr√©stimos</div>
        <div class="dashboard-subtitle">
          Visualize todo o hist√≥rico de empr√©stimos do sistema.
        </div>
      </div>
      <!-- Tabela de Hist√≥rico de Empr√©stimos -->
      <div class="section">
        <div class="section-header">
          <h3 class="section-title">Empr√©stimos</h3>
          <button id="toggleForm" class="btn btn-primary">Novo Empr√©stimo</button>
        </div>
        
        <!-- Caixa de Busca -->
        <div class="search-container" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
              <input 
                type="text" 
                id="search-emprestimos" 
                class="form-input" 
                placeholder="Buscar por cliente, valor, status..."
                style="width: 100%;"
              >
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <select id="filter-status" class="form-input" style="min-width: 120px;">
                <option value="">Todos os Status</option>
                <option value="Ativo">Ativo</option>
                <option value="Pendente">Pendente</option>
                <option value="Em Atraso">Em Atraso</option>
                <option value="Quitado">Quitado</option>
                <option value="Cancelado">Cancelado</option>
              </select>
              <button id="clear-search" class="btn btn-secondary" style="white-space: nowrap;">Limpar</button>
            </div>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
            <span id="search-results-info">Mostrando todos os empr√©stimos</span>
          </div>
        </div>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Valor Inicial</th>
                <th>Valor Final</th>
                <th>Data Empr√©stimo</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="historico-emprestimos">
              <tr>
                <td colspan="7" class="text-center text-gray-500">Carregando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  <footer class="text-center p-4 mt-8">
    ¬© 2025 JP. Sistemas. Todos os direitos reservados. | jp-sistemas.com
  </footer>
  <script src="./js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se utils est√° dispon√≠vel
      if (typeof utils === 'undefined') {
        console.error('‚ùå ERRO: utils n√£o est√° definido!');
      } else {
        console.log('‚úÖ utils est√° dispon√≠vel:', Object.keys(utils));
      }
      
      // Verificar se apiService est√° dispon√≠vel  
      if (typeof apiService === 'undefined') {
        console.error('‚ùå ERRO: apiService n√£o est√° definido!');
      } else {
        console.log('‚úÖ apiService est√° dispon√≠vel');
      }
      
      const menuBtn = document.getElementById('mobile-menu-toggle');
      const navWrapper = document.querySelector('.nav-wrapper');
      if (menuBtn && navWrapper) {
        menuBtn.addEventListener('click', function() {
          navWrapper.classList.toggle('open');
        });
      }

      // Vari√°veis para controle dos empr√©stimos
      let allEmprestimos = [];
      let filteredEmprestimos = [];
      let isLoading = false;
      
      // Elementos do DOM
      const searchInput = document.getElementById('search-emprestimos');
      const filterStatus = document.getElementById('filter-status');
      const clearSearchBtn = document.getElementById('clear-search');
      const searchResultsInfo = document.getElementById('search-results-info');
      const tbody = document.getElementById('historico-emprestimos');
      
      // Fun√ß√£o para carregar empr√©stimos apenas uma vez
      async function carregarEmprestimos() {
        if (isLoading) return;
        isLoading = true;
        
        console.log('üîç Carregando empr√©stimos...');
        
        try {
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Carregando...</td></tr>';
          }
          
          const emprestimos = await apiService.getEmprestimos();
          console.log(`üìã API retornou ${emprestimos ? emprestimos.length : 0} empr√©stimos`);
          
          if (emprestimos) {
            console.log('üìù IDs retornados pela API:', emprestimos.map(e => e.id));
          }
          
          // Processar empr√©stimos com verifica√ß√£o de status
          const emprestimosProcessados = [];
          
          for (const emprestimo of emprestimos || []) {
            console.log(`‚úÖ Processando empr√©stimo ID ${emprestimo.id} - ${emprestimo.cliente_nome} (status original: '${emprestimo.status}')`);
            
            // Remover todo o bloco que recalcula o status baseado em data de vencimento ou parcelas.
            // Usar apenas emp.status recebido da API para exibir na tabela.
            
            emprestimo.status = emprestimo.status || 'Ativo'; // Garantir que o status exista
            console.log(`  üìù Status final definido: '${emprestimo.status}'`);
            
            emprestimosProcessados.push(emprestimo);
          }
          
          console.log(`‚úÖ ${emprestimosProcessados.length} empr√©stimos processados`);
          
          allEmprestimos = emprestimosProcessados;
          filteredEmprestimos = [...allEmprestimos];
          
          console.log(`üìä allEmprestimos: ${allEmprestimos.length}, filteredEmprestimos: ${filteredEmprestimos.length}`);
          
          // Debug: Mostrar todos os status √∫nicos encontrados
          const statusUnicos = [...new Set(allEmprestimos.map(e => e.status))];
          console.log('üìã Status √∫nicos encontrados:', statusUnicos);
          
          // Debug: Mostrar alguns empr√©stimos de exemplo
          if (allEmprestimos.length > 0) {
            console.log('üìÑ Exemplos de empr√©stimos carregados:');
            allEmprestimos.slice(0, 3).forEach(emp => {
              console.log(`  - ID ${emp.id}: ${emp.cliente_nome} - Status: '${emp.status}'`);
            });
          }
          
          await renderFilteredEmprestimos();
          updateSearchResultsInfo();
          
        } catch (err) {
          console.error('‚ùå Erro ao carregar empr√©stimos:', err);
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-red-500">Erro ao carregar empr√©stimos</td></tr>';
          }
        } finally {
          isLoading = false;
        }
      }
      
      // Fun√ß√£o para aplicar filtros
      async function applyFilters() {
        if (!searchInput || !filterStatus || !allEmprestimos || allEmprestimos.length === 0) {
          console.log('‚ö†Ô∏è Filtros n√£o aplicados - dados n√£o dispon√≠veis');
          return;
        }
        
        const searchTerm = searchInput.value.toLowerCase().trim();
        const statusFilter = filterStatus.value;
        
        console.log(`üîç Aplicando filtros - Busca: '${searchTerm}', Status: '${statusFilter}'`);
        console.log(`üìä Total de empr√©stimos dispon√≠veis: ${allEmprestimos.length}`);
        
        // Filtrar empr√©stimos
        filteredEmprestimos = allEmprestimos.filter(emp => {
          // Primeiro verificar se tem busca por texto
          const matchesSearch = !searchTerm || 
            (emp.cliente_nome && emp.cliente_nome.toLowerCase().includes(searchTerm)) ||
            (emp.valor && emp.valor.toString().includes(searchTerm)) ||
            (emp.status && emp.status.toLowerCase().includes(searchTerm)) ||
            (emp.data_emprestimo && emp.data_emprestimo.includes(searchTerm)) ||
            (emp.data_vencimento && emp.data_vencimento.includes(searchTerm));
          
          // Depois verificar status
          const matchesStatus = !statusFilter || emp.status === statusFilter;
          
          // Debug apenas para os primeiros 3 empr√©stimos que n√£o passam no filtro
          if (!matchesStatus && statusFilter && filteredEmprestimos.length < 3) {
            console.log(`‚ùå N√£o passou no filtro - Empr√©stimo ${emp.id}: status='${emp.status}' ‚â† filtro='${statusFilter}'`);
          }
          
          return matchesSearch && matchesStatus;
        });
        
        console.log(`üîç Filtros aplicados: ${filteredEmprestimos.length} de ${allEmprestimos.length}`);
        
        // Se n√£o encontrou nenhum resultado mas deveria encontrar, fazer debug
        if (filteredEmprestimos.length === 0 && allEmprestimos.length > 0) {
          console.log('üö® PROBLEMA: Nenhum empr√©stimo passou nos filtros!');
          if (!statusFilter && !searchTerm) {
            console.log('üîç Filtros vazios mas nenhum resultado - problema na l√≥gica!');
            // For√ßar mostrar todos se n√£o h√° filtros
            filteredEmprestimos = [...allEmprestimos];
            console.log(`üîß For√ßando mostrar todos: ${filteredEmprestimos.length} empr√©stimos`);
          }
        }
        
        await renderFilteredEmprestimos();
        updateSearchResultsInfo();
      }
      
      // Fun√ß√£o para renderizar empr√©stimos filtrados
      async function renderFilteredEmprestimos() {
        console.log(`üé® Iniciando renderiza√ß√£o de ${filteredEmprestimos ? filteredEmprestimos.length : 0} empr√©stimos`);
        
        if (!tbody) {
          console.log('‚ùå Elemento tbody n√£o encontrado!');
          return;
        }
        
        if (!filteredEmprestimos || filteredEmprestimos.length === 0) {
          console.log('üì≠ Nenhum empr√©stimo filtrado para exibir');
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Nenhum empr√©stimo encontrado</td></tr>';
          return;
        }
        
        tbody.innerHTML = '';
        
        console.log(`üìã Renderizando ${filteredEmprestimos.length} empr√©stimos na tabela`);
        
        // Renderiza√ß√£o simplificada para teste
        filteredEmprestimos.forEach((emp, index) => {
          // Log apenas dos primeiros 3 empr√©stimos para n√£o poluir o console
          if (index < 3) {
            console.log(`üìÑ Renderizando empr√©stimo ${index + 1}/${filteredEmprestimos.length}: ID ${emp.id} - ${emp.cliente_nome} - Status: ${emp.status}`);
          }
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${emp.cliente_nome || 'N/A'}</td>
            <td>${emp.valor ? `R$ ${Number(emp.valor).toFixed(2)}` : 'R$ 0,00'}</td>
            <td>${emp.valor_final ? `R$ ${Number(emp.valor_final).toFixed(2)}` : (emp.valor ? `R$ ${Number(emp.valor).toFixed(2)}` : 'R$ 0,00')}</td>
            <td>${emp.data_emprestimo ? new Date(emp.data_emprestimo).toLocaleDateString('pt-BR') : '-'}</td>
            <td>${emp.data_vencimento ? emp.data_vencimento.split('-').reverse().join('/') : '-'}</td>
            <td><span class="badge badge-${getStatusBadgeClass(emp.status)}">${emp.status || 'N/A'}</span></td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="viewEmprestimo(${emp.id})">Ver</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
        console.log(`‚úÖ Renderiza√ß√£o conclu√≠da: ${tbody.children.length} linhas na tabela`);
      }
      
      // Fun√ß√£o para obter classe do badge baseado no status
      function getStatusBadgeClass(status) {
        switch(status) {
          case 'Ativo': return 'success';
          case 'Pendente': return 'warning';
          case 'Em Atraso': return 'danger';
          case 'Quitado': return 'info';
          case 'Cancelado': return 'secondary';
          default: return 'secondary';
        }
      }
      
      // Fun√ß√£o para atualizar informa√ß√£o de resultados
      function updateSearchResultsInfo() {
        if (!searchResultsInfo) {
          console.log('‚ö†Ô∏è Elemento searchResultsInfo n√£o encontrado');
          return;
        }
        
        const total = allEmprestimos ? allEmprestimos.length : 0;
        const filtered = filteredEmprestimos ? filteredEmprestimos.length : 0;
        
        if (filtered === total) {
          searchResultsInfo.textContent = `Mostrando todos os ${total} empr√©stimos`;
        } else {
          searchResultsInfo.textContent = `Mostrando ${filtered} de ${total} empr√©stimos`;
        }
        
        console.log(`üìä Info atualizada: ${filtered} de ${total} empr√©stimos`);
      }
      
      // Fun√ß√£o para limpar busca
      async function clearSearch() {
        if (searchInput) searchInput.value = '';
        if (filterStatus) filterStatus.value = '';
        filteredEmprestimos = [...allEmprestimos];
        await renderFilteredEmprestimos();
        updateSearchResultsInfo();
      }
      
      // Event listeners
      if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
      }
      if (filterStatus) {
        filterStatus.addEventListener('change', applyFilters);
      }
      if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', clearSearch);
      }
      
      // Fun√ß√£o de teste simples
      async function testeCarregamentoSimples() {
        console.log('üß™ TESTE: Carregamento simples de empr√©stimos');
        try {
          const emprestimos = await apiService.getEmprestimos();
          console.log(`‚úÖ TESTE: API retornou ${emprestimos ? emprestimos.length : 0} empr√©stimos`);
          if (emprestimos && emprestimos.length > 0) {
            console.log(`üìÑ TESTE: Primeiro empr√©stimo:`, emprestimos[0]);
          }
        } catch (error) {
          console.error('‚ùå TESTE: Erro na API:', error);
        }
      }
      
      // Executar teste primeiro
      testeCarregamentoSimples();
      
      // Carregar empr√©stimos apenas uma vez
      carregarEmprestimos();
      
      // Recarregar se necess√°rio ap√≥s um breve delay
      setTimeout(() => {
        if (allEmprestimos.length === 0) {
          console.log('üîÑ Recarregando empr√©stimos ap√≥s delay...');
          carregarEmprestimos();
        }
      }, 2000);
    });
  </script>
</body>
</html> 