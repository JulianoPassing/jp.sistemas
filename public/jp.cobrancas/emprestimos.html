<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JP-Cobran√ßas - Hist√≥rico de Empr√©stimos</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/6N82fk2.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body class="app-layout">
  <header>
    <div class="header-content">
      <a href="index.html" class="logo" style="display: flex; align-items: center;">
        <img src="https://i.imgur.com/EQ1tjZX.png" alt="JP-Cobran√ßas" style="height: 5rem; width: auto; object-fit: contain;">
      </a>
      <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
      <div class="nav-wrapper">
        <nav>
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="clientes.html" class="nav-link">Clientes</a>
          <a href="adicionar-cliente.html" class="nav-link">Adicionar Cliente</a>
          <a href="cobrancas.html" class="nav-link">Cobran√ßas</a>
          <a href="atrasados.html" class="nav-link">Atrasados</a>
          <a href="lista-negra.html" class="nav-link">Lista Negra</a>
          <a href="emprestimos.html" class="nav-link">Empr√©stimos</a>
          <a href="historico.html" class="nav-link">Hist√≥rico</a>
          <a href="#" class="nav-link" onclick="sair()">Sair</a>
        </nav>
      </div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="dashboard-header">
        <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
        <div class="dashboard-title">Hist√≥rico de Empr√©stimos</div>
        <div class="dashboard-subtitle">
          Visualize todo o hist√≥rico de empr√©stimos do sistema.
        </div>
      </div>
      <!-- Tabela de Hist√≥rico de Empr√©stimos -->
      <div class="section">
        <div class="section-header">
          <h3 class="section-title">Empr√©stimos</h3>
          <button id="toggleForm" class="btn btn-primary">Novo Empr√©stimo</button>
        </div>
        
        <!-- Caixa de Busca -->
        <div class="search-container" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
              <input 
                type="text" 
                id="search-emprestimos" 
                class="form-input" 
                placeholder="Buscar por cliente, valor, status..."
                style="width: 100%;"
              >
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <select id="filter-status" class="form-input" style="min-width: 120px;">
                <option value="">Todos os Status</option>
                <option value="Ativo">Ativo</option>
                <option value="Pendente">Pendente</option>
                <option value="Em Atraso">Em Atraso</option>
                <option value="Quitado">Quitado</option>
                <option value="Cancelado">Cancelado</option>
              </select>
              <button id="clear-search" class="btn btn-secondary" style="white-space: nowrap;">Limpar</button>
            </div>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
            <span id="search-results-info">Mostrando todos os empr√©stimos</span>
          </div>
        </div>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Valor Inicial</th>
                <th>Valor Final</th>
                <th>Data Empr√©stimo</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="historico-emprestimos">
              <tr>
                <td colspan="7" class="text-center text-gray-500">Carregando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  <footer class="text-center p-4 mt-8">
    ¬© 2024 JP-Cobran√ßas. Todos os direitos reservados.
  </footer>
  <script src="./js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('mobile-menu-toggle');
      const navWrapper = document.querySelector('.nav-wrapper');
      if (menuBtn && navWrapper) {
        menuBtn.addEventListener('click', function() {
          navWrapper.classList.toggle('open');
        });
      }

      // Vari√°veis para controle dos empr√©stimos
      let allEmprestimos = [];
      let filteredEmprestimos = [];
      let isLoading = false;
      
      // Elementos do DOM
      const searchInput = document.getElementById('search-emprestimos');
      const filterStatus = document.getElementById('filter-status');
      const clearSearchBtn = document.getElementById('clear-search');
      const searchResultsInfo = document.getElementById('search-results-info');
      const tbody = document.getElementById('historico-emprestimos');
      
      // Fun√ß√£o para carregar empr√©stimos apenas uma vez
      async function carregarEmprestimos() {
        if (isLoading) return;
        isLoading = true;
        
        console.log('üîç Carregando empr√©stimos...');
        
        try {
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Carregando...</td></tr>';
          }
          
          const emprestimos = await apiService.getEmprestimos();
          console.log(`üìã API retornou ${emprestimos ? emprestimos.length : 0} empr√©stimos`);
          
          if (emprestimos) {
            console.log('üìù IDs retornados pela API:', emprestimos.map(e => e.id));
          }
          
          // Processar empr√©stimos com verifica√ß√£o de status
          const emprestimosProcessados = [];
          
          for (const emprestimo of emprestimos || []) {
            console.log(`‚úÖ Processando empr√©stimo ID ${emprestimo.id} - ${emprestimo.cliente_nome}`);
            
            // Verificar status baseado em parcelas
            try {
              const parcelas = await apiService.getParcelasEmprestimo(emprestimo.id);
              const hoje = new Date();
              hoje.setHours(0,0,0,0);
              let status = (emprestimo.status || '').toUpperCase();
              
              if (parcelas && parcelas.length > 0) {
                console.log(`  üìÖ Empr√©stimo ${emprestimo.id} tem ${parcelas.length} parcelas`);
                
                const parcelasAtrasadas = parcelas.filter(p => {
                  const dataVencParcela = new Date(p.data_vencimento);
                  return dataVencParcela < hoje && (p.status !== 'Paga');
                });
                
                const parcelasPagas = parcelas.filter(p => p.status === 'Paga');
                
                if (parcelasPagas.length === parcelas.length) {
                  status = 'QUITADO';
                } else if (parcelasAtrasadas.length > 0) {
                  status = 'ATRASADO';
                } else {
                  status = 'ATIVO';
                }
                
                console.log(`  üîÑ Status atualizado para: ${status} (${parcelasPagas.length}/${parcelas.length} pagas, ${parcelasAtrasadas.length} atrasadas)`);
              } else {
                console.log(`  üìÑ Empr√©stimo ${emprestimo.id} sem parcelas, usando data de vencimento`);
                const dataVencimento = emprestimo.data_vencimento ? new Date(emprestimo.data_vencimento) : null;
                if (dataVencimento && dataVencimento < hoje && status !== 'QUITADO') {
                  status = 'ATRASADO';
                }
              }
              
              emprestimo.status = status;
              
            } catch (error) {
              console.error(`‚ùå Erro ao verificar parcelas do empr√©stimo ${emprestimo.id}:`, error);
            }
            
            emprestimosProcessados.push(emprestimo);
          }
          
          console.log(`‚úÖ ${emprestimosProcessados.length} empr√©stimos processados`);
          
          allEmprestimos = emprestimosProcessados;
          filteredEmprestimos = [...allEmprestimos];
          
          renderFilteredEmprestimos();
          updateSearchResultsInfo();
          
        } catch (err) {
          console.error('‚ùå Erro ao carregar empr√©stimos:', err);
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-red-500">Erro ao carregar empr√©stimos</td></tr>';
          }
        } finally {
          isLoading = false;
        }
      }
      
      // Fun√ß√£o para aplicar filtros
      function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const statusFilter = filterStatus.value;
        
        filteredEmprestimos = allEmprestimos.filter(emp => {
          const matchesSearch = !searchTerm || 
            (emp.cliente_nome && emp.cliente_nome.toLowerCase().includes(searchTerm)) ||
            (emp.valor && emp.valor.toString().includes(searchTerm)) ||
            (emp.status && emp.status.toLowerCase().includes(searchTerm)) ||
            (emp.data_emprestimo && emp.data_emprestimo.includes(searchTerm)) ||
            (emp.data_vencimento && emp.data_vencimento.includes(searchTerm));
          
          const matchesStatus = !statusFilter || emp.status === statusFilter;
          
          return matchesSearch && matchesStatus;
        });
        
        renderFilteredEmprestimos();
        updateSearchResultsInfo();
      }
      
      // Fun√ß√£o para renderizar empr√©stimos filtrados
      function renderFilteredEmprestimos() {
        if (!tbody) return;
        
        if (filteredEmprestimos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Nenhum empr√©stimo encontrado</td></tr>';
          return;
        }
        
        tbody.innerHTML = '';
        filteredEmprestimos.forEach(emp => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${emp.cliente_nome || 'N/A'}</td>
            <td>R$ ${utils.formatCurrency(emp.valor || 0)}</td>
            <td>R$ ${utils.formatCurrency(emp.valor_final || emp.valor || 0)}</td>
            <td>${emp.data_emprestimo ? utils.formatDate(emp.data_emprestimo) : '-'}</td>
            <td>${emp.data_vencimento ? utils.formatDate(emp.data_vencimento) : '-'}</td>
            <td><span class="badge badge-${getStatusBadgeClass(emp.status)}">${emp.status || 'N/A'}</span></td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="viewEmprestimo(${emp.id})">Ver</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }
      
      // Fun√ß√£o para obter classe do badge baseado no status
      function getStatusBadgeClass(status) {
        switch(status) {
          case 'ATIVO': return 'success';
          case 'PENDENTE': return 'warning';
          case 'ATRASADO': return 'danger';
          case 'QUITADO': return 'info';
          case 'CANCELADO': return 'secondary';
          default: return 'secondary';
        }
      }
      
      // Fun√ß√£o para atualizar informa√ß√£o de resultados
      function updateSearchResultsInfo() {
        const total = allEmprestimos.length;
        const filtered = filteredEmprestimos.length;
        
        if (filtered === total) {
          searchResultsInfo.textContent = `Mostrando todos os ${total} empr√©stimos`;
        } else {
          searchResultsInfo.textContent = `Mostrando ${filtered} de ${total} empr√©stimos`;
        }
      }
      
      // Fun√ß√£o para limpar busca
      function clearSearch() {
        searchInput.value = '';
        filterStatus.value = '';
        filteredEmprestimos = [...allEmprestimos];
        renderFilteredEmprestimos();
        updateSearchResultsInfo();
      }
      
      // Event listeners
      searchInput.addEventListener('input', applyFilters);
      filterStatus.addEventListener('change', applyFilters);
      clearSearchBtn.addEventListener('click', clearSearch);
      
      // Carregar empr√©stimos apenas uma vez
      carregarEmprestimos();
    });
  </script>
</body>
</html> 