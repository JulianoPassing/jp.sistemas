<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP Gestão - Caixa</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/TwZLW6a.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="app-layout">
    <header>
        <div class="header-content">
            <a href="dashboard.html" class="logo" style="display: flex; align-items: center;">
                <img src="https://i.imgur.com/TwZLW6a.png" alt="JP Gestão" style="height: 3rem; width: auto; object-fit: contain;">
            </a>
            <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
            <div class="nav-wrapper">
                <nav>
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                    <a href="produtos.html" class="nav-link">Produtos</a>
                    <a href="pedidos.html" class="nav-link">Pedidos</a>
                    <a href="clientes.html" class="nav-link">Clientes</a>
                    <a href="mesas.html" class="nav-link">Mesas</a>
                    <a href="caixa.html" class="nav-link active">Caixa</a>
                    <a href="relatorios.html" class="nav-link">Relatórios</a>
                    <a href="configuracoes.html" class="nav-link">Configurações</a>
                    <a href="#" class="nav-link" onclick="sair()">Sair</a>
                </nav>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div class="dashboard-header">
                <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
                <div class="dashboard-title">Controle de Caixa</div>
                <div class="dashboard-subtitle">Gerencie pagamentos e movimentações financeiras</div>
            </div>
            
            <!-- Estatísticas do Caixa -->
            <div class="cards">
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Saldo Atual</div>
                        <i class="fas fa-wallet card-icon"></i>
                    </div>
                    <div class="card-value" id="saldo-atual">R$ 0,00</div>
                    <div class="card-change positive">Disponível</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Vendas Hoje</div>
                        <i class="fas fa-chart-line card-icon"></i>
                    </div>
                    <div class="card-value" id="vendas-hoje">R$ 0,00</div>
                    <div class="card-change positive">+0%</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Pagamentos Pendentes</div>
                        <i class="fas fa-clock card-icon"></i>
                    </div>
                    <div class="card-value" id="pagamentos-pendentes">R$ 0,00</div>
                    <div class="card-change warning">Aguardando</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Total do Mês</div>
                        <i class="fas fa-calendar-alt card-icon"></i>
                    </div>
                    <div class="card-value" id="total-mes">R$ 0,00</div>
                    <div class="card-change positive">+0%</div>
                </div>
            </div>
            
            <!-- Ações Rápidas -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Ações Rápidas</h3>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button class="btn btn-primary" onclick="showPaymentModal()">
                        <i class="fas fa-credit-card"></i>
                        <div>Registrar Pagamento</div>
                    </button>
                    <button class="btn btn-secondary" onclick="showWithdrawalModal()">
                        <i class="fas fa-money-bill-wave"></i>
                        <div>Retirada</div>
                    </button>
                    <button class="btn btn-warning" onclick="showExpenseModal()">
                        <i class="fas fa-receipt"></i>
                        <div>Despesa</div>
                    </button>
                    <button class="btn btn-info" onclick="showTransferModal()">
                        <i class="fas fa-exchange-alt"></i>
                        <div>Transferência</div>
                    </button>
                </div>
            </div>
            
            <!-- Movimentações Recentes -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Movimentações Recentes</h3>
                    <button class="btn btn-secondary" onclick="exportMovements()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Tipo</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Forma Pagamento</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="movimentacoesTable">
                            <tr>
                                <td colspan="7" class="text-center text-gray-500">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center p-4 mt-8">
        © 2024 JP Gestão. Todos os direitos reservados.
    </footer>
    
    <script src="./js/main.js"></script>
    <script>
        let movimentacoesData = [];
        
        // Verificar autenticação
        if (sessionStorage.getItem('loggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
        
        // Configurar mensagem de boas-vindas
        function updateWelcomeMessage() {
            const username = sessionStorage.getItem('userDisplay') || sessionStorage.getItem('username') || 'Usuário';
            const capitalizedUsername = username.charAt(0).toUpperCase() + username.slice(1);
            document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${capitalizedUsername}!`;
        }
        
        // Carregar dados do caixa
        async function loadCaixaData() {
            try {
                // Carregar estatísticas
                const statsResponse = await fetch('/api/caixa/stats');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('saldo-atual').textContent = formatCurrency(stats.saldoAtual || 0);
                    document.getElementById('vendas-hoje').textContent = formatCurrency(stats.vendasHoje || 0);
                    document.getElementById('pagamentos-pendentes').textContent = formatCurrency(stats.pagamentosPendentes || 0);
                    document.getElementById('total-mes').textContent = formatCurrency(stats.totalMes || 0);
                }
                
                // Carregar movimentações
                const movResponse = await fetch('/api/caixa/movimentacoes');
                if (movResponse.ok) {
                    movimentacoesData = await movResponse.json();
                    renderMovimentacoes();
                }
            } catch (error) {
                console.error('Erro ao carregar dados do caixa:', error);
                showNotification('Erro ao carregar dados do caixa', 'error');
            }
        }
        
        // Renderizar movimentações
        function renderMovimentacoes() {
            const tbody = document.getElementById('movimentacoesTable');
            
            if (movimentacoesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Nenhuma movimentação encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = movimentacoesData.map(mov => `
                <tr>
                    <td>${formatDateTime(mov.data_hora)}</td>
                    <td>
                        <span class="badge badge-${getTipoBadge(mov.tipo)}">${getTipoText(mov.tipo)}</span>
                    </td>
                    <td>${mov.descricao}</td>
                    <td class="font-semibold ${mov.valor >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${mov.valor >= 0 ? '+' : ''}${formatCurrency(mov.valor)}
                    </td>
                    <td>${mov.forma_pagamento || 'N/A'}</td>
                    <td>
                        <span class="badge badge-${getStatusBadge(mov.status)}">${getStatusText(mov.status)}</span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="viewMovimentacao(${mov.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteMovimentacao(${mov.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Obter badge de tipo
        function getTipoBadge(tipo) {
            switch (tipo) {
                case 'entrada': return 'success';
                case 'saida': return 'danger';
                case 'transferencia': return 'info';
                default: return 'info';
            }
        }
        
        // Obter texto de tipo
        function getTipoText(tipo) {
            switch (tipo) {
                case 'entrada': return 'Entrada';
                case 'saida': return 'Saída';
                case 'transferencia': return 'Transferência';
                default: return tipo;
            }
        }
        
        // Obter badge de status
        function getStatusBadge(status) {
            switch (status) {
                case 'confirmado': return 'success';
                case 'pendente': return 'warning';
                case 'cancelado': return 'danger';
                default: return 'info';
            }
        }
        
        // Obter texto de status
        function getStatusText(status) {
            switch (status) {
                case 'confirmado': return 'Confirmado';
                case 'pendente': return 'Pendente';
                case 'cancelado': return 'Cancelado';
                default: return status;
            }
        }
        
        // Mostrar modal de pagamento
        function showPaymentModal() {
            const content = `
                <form id="paymentForm">
                    <div class="form-group">
                        <label for="valor" class="form-label">Valor *</label>
                        <input type="number" id="valor" name="valor" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="descricao" class="form-label">Descrição *</label>
                        <input type="text" id="descricao" name="descricao" class="form-input" placeholder="Ex: Pagamento pedido #123" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
                            <select id="forma_pagamento" name="forma_pagamento" class="form-input">
                                <option value="dinheiro">Dinheiro</option>
                                <option value="cartao_credito">Cartão de Crédito</option>
                                <option value="cartao_debito">Cartão de Débito</option>
                                <option value="pix">PIX</option>
                                <option value="transferencia">Transferência</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cliente" class="form-label">Cliente</label>
                            <input type="text" id="cliente" name="cliente" class="form-input" placeholder="Nome do cliente">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea id="observacoes" name="observacoes" class="form-input" rows="3" placeholder="Observações adicionais..."></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Registrar Pagamento</button>
                    </div>
                </form>
            `;
            showModal('Registrar Pagamento', content);
            
            // Adicionar evento de submit
            document.getElementById('paymentForm').addEventListener('submit', handlePayment);
        }
        
        // Manipular pagamento
        async function handlePayment(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const paymentData = {
                tipo: 'entrada',
                valor: parseFloat(formData.get('valor')),
                descricao: formData.get('descricao'),
                forma_pagamento: formData.get('forma_pagamento'),
                cliente: formData.get('cliente'),
                observacoes: formData.get('observacoes')
            };
            
            try {
                const response = await fetch('/api/caixa/movimentacoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                if (response.ok) {
                    showNotification('Pagamento registrado com sucesso!', 'success');
                    closeModal(e.target);
                    loadCaixaData();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao registrar pagamento', 'error');
                }
            } catch (error) {
                console.error('Erro ao registrar pagamento:', error);
                showNotification('Erro ao registrar pagamento', 'error');
            }
        }
        
        // Mostrar modal de retirada
        function showWithdrawalModal() {
            const content = `
                <form id="withdrawalForm">
                    <div class="form-group">
                        <label for="valor_retirada" class="form-label">Valor da Retirada *</label>
                        <input type="number" id="valor_retirada" name="valor" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="descricao_retirada" class="form-label">Motivo da Retirada *</label>
                        <input type="text" id="descricao_retirada" name="descricao" class="form-input" placeholder="Ex: Retirada para despesas" required>
                    </div>
                    <div class="form-group">
                        <label for="responsavel" class="form-label">Responsável</label>
                        <input type="text" id="responsavel" name="responsavel" class="form-input" placeholder="Nome do responsável">
                    </div>
                    <div class="form-group">
                        <label for="observacoes_retirada" class="form-label">Observações</label>
                        <textarea id="observacoes_retirada" name="observacoes" class="form-input" rows="3" placeholder="Observações adicionais..."></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Registrar Retirada</button>
                    </div>
                </form>
            `;
            showModal('Registrar Retirada', content);
            
            // Adicionar evento de submit
            document.getElementById('withdrawalForm').addEventListener('submit', handleWithdrawal);
        }
        
        // Manipular retirada
        async function handleWithdrawal(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const withdrawalData = {
                tipo: 'saida',
                valor: -parseFloat(formData.get('valor')),
                descricao: formData.get('descricao'),
                responsavel: formData.get('responsavel'),
                observacoes: formData.get('observacoes')
            };
            
            try {
                const response = await fetch('/api/caixa/movimentacoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(withdrawalData)
                });
                
                if (response.ok) {
                    showNotification('Retirada registrada com sucesso!', 'success');
                    closeModal(e.target);
                    loadCaixaData();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao registrar retirada', 'error');
                }
            } catch (error) {
                console.error('Erro ao registrar retirada:', error);
                showNotification('Erro ao registrar retirada', 'error');
            }
        }
        
        // Mostrar modal de despesa
        function showExpenseModal() {
            const content = `
                <form id="expenseForm">
                    <div class="form-group">
                        <label for="valor_despesa" class="form-label">Valor da Despesa *</label>
                        <input type="number" id="valor_despesa" name="valor" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="descricao_despesa" class="form-label">Descrição da Despesa *</label>
                        <input type="text" id="descricao_despesa" name="descricao" class="form-input" placeholder="Ex: Compra de ingredientes" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="categoria" class="form-label">Categoria</label>
                            <select id="categoria" name="categoria" class="form-input">
                                <option value="ingredientes">Ingredientes</option>
                                <option value="equipamentos">Equipamentos</option>
                                <option value="manutencao">Manutenção</option>
                                <option value="servicos">Serviços</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fornecedor" class="form-label">Fornecedor</label>
                            <input type="text" id="fornecedor" name="fornecedor" class="form-input" placeholder="Nome do fornecedor">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="observacoes_despesa" class="form-label">Observações</label>
                        <textarea id="observacoes_despesa" name="observacoes" class="form-input" rows="3" placeholder="Observações adicionais..."></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Registrar Despesa</button>
                    </div>
                </form>
            `;
            showModal('Registrar Despesa', content);
            
            // Adicionar evento de submit
            document.getElementById('expenseForm').addEventListener('submit', handleExpense);
        }
        
        // Manipular despesa
        async function handleExpense(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const expenseData = {
                tipo: 'saida',
                valor: -parseFloat(formData.get('valor')),
                descricao: formData.get('descricao'),
                categoria: formData.get('categoria'),
                fornecedor: formData.get('fornecedor'),
                observacoes: formData.get('observacoes')
            };
            
            try {
                const response = await fetch('/api/caixa/movimentacoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(expenseData)
                });
                
                if (response.ok) {
                    showNotification('Despesa registrada com sucesso!', 'success');
                    closeModal(e.target);
                    loadCaixaData();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao registrar despesa', 'error');
                }
            } catch (error) {
                console.error('Erro ao registrar despesa:', error);
                showNotification('Erro ao registrar despesa', 'error');
            }
        }
        
        // Mostrar modal de transferência
        function showTransferModal() {
            const content = `
                <form id="transferForm">
                    <div class="form-group">
                        <label for="valor_transferencia" class="form-label">Valor da Transferência *</label>
                        <input type="number" id="valor_transferencia" name="valor" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="descricao_transferencia" class="form-label">Descrição *</label>
                        <input type="text" id="descricao_transferencia" name="descricao" class="form-input" placeholder="Ex: Transferência entre contas" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="conta_origem" class="form-label">Conta de Origem</label>
                            <input type="text" id="conta_origem" name="conta_origem" class="form-input" placeholder="Conta de origem">
                        </div>
                        <div class="form-group">
                            <label for="conta_destino" class="form-label">Conta de Destino</label>
                            <input type="text" id="conta_destino" name="conta_destino" class="form-input" placeholder="Conta de destino">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="observacoes_transferencia" class="form-label">Observações</label>
                        <textarea id="observacoes_transferencia" name="observacoes" class="form-input" rows="3" placeholder="Observações adicionais..."></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-info">Registrar Transferência</button>
                    </div>
                </form>
            `;
            showModal('Registrar Transferência', content);
            
            // Adicionar evento de submit
            document.getElementById('transferForm').addEventListener('submit', handleTransfer);
        }
        
        // Manipular transferência
        async function handleTransfer(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const transferData = {
                tipo: 'transferencia',
                valor: parseFloat(formData.get('valor')),
                descricao: formData.get('descricao'),
                conta_origem: formData.get('conta_origem'),
                conta_destino: formData.get('conta_destino'),
                observacoes: formData.get('observacoes')
            };
            
            try {
                const response = await fetch('/api/caixa/movimentacoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transferData)
                });
                
                if (response.ok) {
                    showNotification('Transferência registrada com sucesso!', 'success');
                    closeModal(e.target);
                    loadCaixaData();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao registrar transferência', 'error');
                }
            } catch (error) {
                console.error('Erro ao registrar transferência:', error);
                showNotification('Erro ao registrar transferência', 'error');
            }
        }
        
        // Visualizar movimentação
        function viewMovimentacao(id) {
            const mov = movimentacoesData.find(m => m.id === id);
            if (!mov) return;
            
            const content = `
                <div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <strong>Data/Hora:</strong> ${formatDateTime(mov.data_hora)}
                        </div>
                        <div>
                            <strong>Tipo:</strong> 
                            <span class="badge badge-${getTipoBadge(mov.tipo)}">${getTipoText(mov.tipo)}</span>
                        </div>
                        <div>
                            <strong>Valor:</strong> 
                            <span class="font-semibold ${mov.valor >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${mov.valor >= 0 ? '+' : ''}${formatCurrency(mov.valor)}
                            </span>
                        </div>
                        <div>
                            <strong>Status:</strong> 
                            <span class="badge badge-${getStatusBadge(mov.status)}">${getStatusText(mov.status)}</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <strong>Descrição:</strong>
                        <div style="margin-top: 0.5rem; padding: 1rem; background-color: var(--gray-100); border-radius: var(--border-radius);">
                            ${mov.descricao}
                        </div>
                    </div>
                    
                    ${mov.forma_pagamento ? `
                        <div class="mb-4">
                            <strong>Forma de Pagamento:</strong> ${mov.forma_pagamento}
                        </div>
                    ` : ''}
                    
                    ${mov.cliente ? `
                        <div class="mb-4">
                            <strong>Cliente:</strong> ${mov.cliente}
                        </div>
                    ` : ''}
                    
                    ${mov.observacoes ? `
                        <div class="mb-4">
                            <strong>Observações:</strong>
                            <div style="margin-top: 0.5rem; padding: 1rem; background-color: var(--gray-100); border-radius: var(--border-radius);">
                                ${mov.observacoes}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            showModal(`Movimentação #${mov.id}`, content);
        }
        
        // Deletar movimentação
        function deleteMovimentacao(id) {
            const mov = movimentacoesData.find(m => m.id === id);
            if (!mov) return;
            
            confirmAction(`Tem certeza que deseja excluir esta movimentação?`, async () => {
                try {
                    const response = await fetch(`/api/caixa/movimentacoes/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showNotification('Movimentação excluída com sucesso!', 'success');
                        loadCaixaData();
                    } else {
                        const error = await response.json();
                        showNotification(error.message || 'Erro ao excluir movimentação', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao excluir movimentação:', error);
                    showNotification('Erro ao excluir movimentação', 'error');
                }
            });
        }
        
        // Exportar movimentações
        function exportMovements() {
            if (movimentacoesData.length === 0) {
                showNotification('Nenhuma movimentação para exportar', 'warning');
                return;
            }
            
            const exportData = movimentacoesData.map(mov => ({
                'Data/Hora': formatDateTime(mov.data_hora),
                'Tipo': getTipoText(mov.tipo),
                'Descrição': mov.descricao,
                'Valor': mov.valor,
                'Forma Pagamento': mov.forma_pagamento || '',
                'Status': getStatusText(mov.status),
                'Cliente': mov.cliente || '',
                'Observações': mov.observacoes || ''
            }));
            
            exportToCSV(exportData, 'movimentacoes_caixa');
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            updateWelcomeMessage();
            loadCaixaData();
        });
    </script>
</body>
</html> 