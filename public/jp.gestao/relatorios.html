<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP Gestão - Relatórios</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/TwZLW6a.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="app-layout">
    <header>
        <div class="header-content">
            <a href="dashboard.html" class="logo" style="display: flex; align-items: center;">
                <img src="https://i.imgur.com/TwZLW6a.png" alt="JP Gestão" style="height: 3rem; width: auto; object-fit: contain;">
            </a>
            <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
            <div class="nav-wrapper">
                <nav>
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                    <a href="produtos.html" class="nav-link">Produtos</a>
                    <a href="pedidos.html" class="nav-link">Pedidos</a>
                    <a href="clientes.html" class="nav-link">Clientes</a>
                    <a href="mesas.html" class="nav-link">Mesas</a>
                    <a href="caixa.html" class="nav-link">Caixa</a>
                    <a href="relatorios.html" class="nav-link active">Relatórios</a>
                    <a href="configuracoes.html" class="nav-link">Configurações</a>
                    <a href="#" class="nav-link" onclick="sair()">Sair</a>
                </nav>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div class="dashboard-header">
                <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
                <div class="dashboard-title">Relatórios e Análises</div>
                <div class="dashboard-subtitle">Visualize dados e insights do seu negócio</div>
            </div>
            
            <!-- Filtros de Período -->
            <div class="search-container">
                <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
                    <div>
                        <label for="periodo" class="form-label">Período</label>
                        <select id="periodo" class="form-input">
                            <option value="hoje">Hoje</option>
                            <option value="semana">Última Semana</option>
                            <option value="mes" selected>Último Mês</option>
                            <option value="trimestre">Último Trimestre</option>
                            <option value="ano">Último Ano</option>
                            <option value="personalizado">Personalizado</option>
                        </select>
                    </div>
                    <div id="datasPersonalizadas" style="display: none;">
                        <div>
                            <label for="dataInicio" class="form-label">Data Início</label>
                            <input type="date" id="dataInicio" class="form-input">
                        </div>
                        <div>
                            <label for="dataFim" class="form-label">Data Fim</label>
                            <input type="date" id="dataFim" class="form-input">
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="gerarRelatorio()">
                        <i class="fas fa-chart-bar"></i> Gerar Relatório
                    </button>
                    <button class="btn btn-secondary" onclick="exportarRelatorio()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>
            
            <!-- Cards de Resumo -->
            <div class="cards">
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Receita Total</div>
                        <i class="fas fa-dollar-sign card-icon"></i>
                    </div>
                    <div class="card-value" id="receita-total">R$ 0,00</div>
                    <div class="card-change positive">+0% vs período anterior</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Total de Pedidos</div>
                        <i class="fas fa-shopping-cart card-icon"></i>
                    </div>
                    <div class="card-value" id="total-pedidos">0</div>
                    <div class="card-change positive">+0% vs período anterior</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Ticket Médio</div>
                        <i class="fas fa-receipt card-icon"></i>
                    </div>
                    <div class="card-value" id="ticket-medio">R$ 0,00</div>
                    <div class="card-change positive">+0% vs período anterior</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Novos Clientes</div>
                        <i class="fas fa-user-plus card-icon"></i>
                    </div>
                    <div class="card-value" id="novos-clientes">0</div>
                    <div class="card-change positive">+0% vs período anterior</div>
                </div>
            </div>
            
            <!-- Relatórios Disponíveis -->
            <!-- INÍCIO DA REMOÇÃO -->
            <!-- <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Relatórios Disponíveis</h3>
                </div>
                <div class="menu-grid">
                    <div class="menu-card" onclick="gerarRelatorioVendas()">
                        <i class="fas fa-chart-line"></i>
                        <h3>Relatório de Vendas</h3>
                        <p>Análise detalhada das vendas por período</p>
                    </div>
                    <div class="menu-card" onclick="gerarRelatorioProdutos()">
                        <i class="fas fa-boxes"></i>
                        <h3>Relatório de Produtos</h3>
                        <p>Produtos mais vendidos e estoque</p>
                    </div>
                    <div class="menu-card" onclick="gerarRelatorioClientes()">
                        <i class="fas fa-users"></i>
                        <h3>Relatório de Clientes</h3>
                        <p>Análise de clientes e fidelização</p>
                    </div>
                    <div class="menu-card" onclick="gerarRelatorioFinanceiro()">
                        <i class="fas fa-calculator"></i>
                        <h3>Relatório Financeiro</h3>
                        <p>Fluxo de caixa e lucratividade</p>
                    </div>
                    <div class="menu-card" onclick="gerarRelatorioMesas()">
                        <i class="fas fa-chair"></i>
                        <h3>Relatório de Mesas</h3>
                        <p>Ocupação e utilização das mesas</p>
                    </div>
                    <div class="menu-card" onclick="gerarRelatorioEstoque()">
                        <i class="fas fa-warehouse"></i>
                        <h3>Relatório de Estoque</h3>
                        <p>Controle de estoque e reposição</p>
                    </div>
                </div>
            </div> -->
            <!-- FIM DA REMOÇÃO -->
            
            <!-- Gráficos e Tabelas -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Análise de Vendas</h3>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gráfico de Vendas -->
                    <div style="background-color: var(--white); border-radius: var(--border-radius-lg); padding: 1.5rem; box-shadow: var(--shadow);">
                        <h4 class="font-semibold mb-4">Vendas por Dia</h4>
                        <div id="graficoVendas" style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--gray-500);">
                            <div class="text-center">
                                <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>Clique em "Gerar Relatório" para ver os dados</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Produtos Mais Vendidos -->
                    <div style="background-color: var(--white); border-radius: var(--border-radius-lg); padding: 1.5rem; box-shadow: var(--shadow);">
                        <h4 class="font-semibold mb-4">Produtos Mais Vendidos</h4>
                        <div id="produtosVendidos" style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--gray-500);">
                            <div class="text-center">
                                <i class="fas fa-boxes" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>Clique em "Gerar Relatório" para ver os dados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabela de Dados Detalhados -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Dados Detalhados</h3>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Pedidos</th>
                                <th>Receita</th>
                                <th>Ticket Médio</th>
                                <th>Clientes</th>
                                <th>Produtos Vendidos</th>
                            </tr>
                        </thead>
                        <tbody id="dadosDetalhados">
                            <tr>
                                <td colspan="6" class="text-center text-gray-500">Clique em "Gerar Relatório" para ver os dados</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center p-4 mt-8">
        © 2024 JP Gestão. Todos os direitos reservados.
    </footer>
    
    <script src="./js/main.js"></script>
    <script>
        let relatorioData = {};
        
        // Verificar autenticação
        if (sessionStorage.getItem('loggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
        
        // Configurar mensagem de boas-vindas
        function updateWelcomeMessage() {
            const username = sessionStorage.getItem('userDisplay') || sessionStorage.getItem('username') || 'Usuário';
            const capitalizedUsername = username.charAt(0).toUpperCase() + username.slice(1);
            document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${capitalizedUsername}!`;
        }
        
        // Configurar filtros de período
        function setupPeriodFilters() {
            const periodoSelect = document.getElementById('periodo');
            const datasPersonalizadas = document.getElementById('datasPersonalizadas');
            
            periodoSelect.addEventListener('change', function() {
                if (this.value === 'personalizado') {
                    datasPersonalizadas.style.display = 'flex';
                } else {
                    datasPersonalizadas.style.display = 'none';
                }
            });
        }
        
        // Obter período selecionado
        function getSelectedPeriod() {
            const periodo = document.getElementById('periodo').value;
            
            if (periodo === 'personalizado') {
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                
                if (!dataInicio || !dataFim) {
                    showNotification('Selecione as datas de início e fim', 'warning');
                    return null;
                }
                
                return {
                    tipo: 'personalizado',
                    dataInicio: dataInicio,
                    dataFim: dataFim
                };
            }
            
            return {
                tipo: periodo
            };
        }
        
        // Gerar relatório
        async function gerarRelatorio() {
            const periodo = getSelectedPeriod();
            if (!periodo) return;
            
            try {
                showNotification('Gerando relatório...', 'info');
                
                const response = await fetch('/api/relatorios/geral', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(periodo)
                });
                
                if (response.ok) {
                    relatorioData = await response.json();
                    atualizarResumo();
                    atualizarGraficos();
                    atualizarTabelaDetalhada();
                    showNotification('Relatório gerado com sucesso!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao gerar relatório', 'error');
                }
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                showNotification('Erro ao gerar relatório', 'error');
            }
        }
        
        // Atualizar resumo
        function atualizarResumo() {
            if (!relatorioData.resumo) return;
            
            const resumo = relatorioData.resumo;
            
            document.getElementById('receita-total').textContent = formatCurrency(resumo.receitaTotal || 0);
            document.getElementById('total-pedidos').textContent = resumo.totalPedidos || 0;
            document.getElementById('ticket-medio').textContent = formatCurrency(resumo.ticketMedio || 0);
            document.getElementById('novos-clientes').textContent = resumo.novosClientes || 0;
        }
        
        // Atualizar gráficos
        function atualizarGraficos() {
            if (!relatorioData.vendasPorDia) return;
            
            // Gráfico de vendas por dia
            const graficoVendas = document.getElementById('graficoVendas');
            graficoVendas.innerHTML = `
                <div style="width: 100%; height: 100%;">
                    <div style="display: flex; align-items: end; justify-content: space-around; height: 250px; padding: 1rem;">
                        ${relatorioData.vendasPorDia.map(item => `
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div style="background-color: var(--primary); width: 30px; height: ${(item.valor / Math.max(...relatorioData.vendasPorDia.map(d => d.valor))) * 200}px; border-radius: 4px 4px 0 0;"></div>
                                <div style="font-size: 0.75rem; margin-top: 0.5rem; text-align: center;">
                                    ${formatCurrency(item.valor)}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${item.data}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Produtos mais vendidos
            if (relatorioData.produtosMaisVendidos) {
                const produtosVendidos = document.getElementById('produtosVendidos');
                produtosVendidos.innerHTML = `
                    <div style="width: 100%;">
                        ${relatorioData.produtosMaisVendidos.slice(0, 5).map((produto, index) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-200);">
                                <div style="display: flex; align-items: center;">
                                    <span style="background-color: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; margin-right: 0.5rem;">${index + 1}</span>
                                    <span>${produto.nome}</span>
                                </div>
                                <span class="font-semibold">${produto.quantidade}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
        
        // Atualizar tabela detalhada
        function atualizarTabelaDetalhada() {
            if (!relatorioData.dadosDetalhados) return;
            
            const tbody = document.getElementById('dadosDetalhados');
            
            if (relatorioData.dadosDetalhados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Nenhum dado encontrado para o período selecionado</td></tr>';
                return;
            }
            
            tbody.innerHTML = relatorioData.dadosDetalhados.map(dia => `
                <tr>
                    <td>${formatDate(dia.data)}</td>
                    <td>${dia.pedidos}</td>
                    <td class="font-semibold">${formatCurrency(dia.receita)}</td>
                    <td>${formatCurrency(dia.ticketMedio)}</td>
                    <td>${dia.clientes}</td>
                    <td>${dia.produtosVendidos}</td>
                </tr>
            `).join('');
        }
        
        // Gerar relatório específico
        function gerarRelatorioVendas() {
            const periodo = getSelectedPeriod();
            if (!periodo) return;
            
            showModal('Relatório de Vendas', `
                <div>
                    <p>Relatório detalhado de vendas em desenvolvimento.</p>
                    <p>Funcionalidades futuras:</p>
                    <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                        <li>Gráficos interativos</li>
                        <li>Comparação com períodos anteriores</li>
                        <li>Análise por categoria de produto</li>
                        <li>Projeções e tendências</li>
                    </ul>
                </div>
            `);
        }
        
        function gerarRelatorioProdutos() {
            const periodo = getSelectedPeriod();
            if (!periodo) return;
            
            showModal('Relatório de Produtos', `
                <div>
                    <p>Relatório detalhado de produtos em desenvolvimento.</p>
                    <p>Funcionalidades futuras:</p>
                    <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                        <li>Produtos mais vendidos</li>
                        <li>Análise de lucratividade</li>
                        <li>Controle de estoque</li>
                        <li>Sazonalidade</li>
                    </ul>
                </div>
            `);
        }
        
        function gerarRelatorioClientes() {
            const periodo = getSelectedPeriod();
            if (!periodo) return;
            
            showModal('Relatório de Clientes', `
                <div>
                    <p>Relatório detalhado de clientes em desenvolvimento.</p>
                    <p>Funcionalidades futuras:</p>
                    <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                        <li>Análise de fidelização</li>
                        <li>Segmentação de clientes</li>
                        <li>Comportamento de compra</li>
                        <li>Campanhas de marketing</li>
                    </ul>
                </div>
            `);
        }
        
        function gerarRelatorioFinanceiro() {
            const periodo = getSelectedPeriod();
            if (!periodo) return;
            
            showModal('Relatório Financeiro', `
                <div>
                    <p>Relatório detalhado financeiro em desenvolvimento.</p>
                    <p>Funcionalidades futuras:</p>
                    <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                        <li>Fluxo de caixa</li>
                        <li>Análise de lucratividade</li>
                        <li>Controle de despesas</li>
                        <li>Projeções financeiras</li>
                    </ul>
                </div>
            `);
        }
        
        function gerarRelatorioMesas() {
            const periodo = getSelectedPeriod();
            if (!periodo) return;
            
            showModal('Relatório de Mesas', `
                <div>
                    <p>Relatório detalhado de mesas em desenvolvimento.</p>
                    <p>Funcionalidades futuras:</p>
                    <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                        <li>Taxa de ocupação</li>
                        <li>Tempo médio de uso</li>
                        <li>Eficiência operacional</li>
                        <li>Otimização de layout</li>
                    </ul>
                </div>
            `);
        }
        
        function gerarRelatorioEstoque() {
            const periodo = getSelectedPeriod();
            if (!periodo) return;
            
            showModal('Relatório de Estoque', `
                <div>
                    <p>Relatório detalhado de estoque em desenvolvimento.</p>
                    <p>Funcionalidades futuras:</p>
                    <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                        <li>Controle de estoque</li>
                        <li>Alertas de reposição</li>
                        <li>Análise de perdas</li>
                        <li>Otimização de compras</li>
                    </ul>
                </div>
            `);
        }
        
        // Exportar relatório
        function exportarRelatorio() {
            if (!relatorioData.dadosDetalhados || relatorioData.dadosDetalhados.length === 0) {
                showNotification('Gere um relatório primeiro', 'warning');
                return;
            }
            
            const periodo = document.getElementById('periodo').value;
            const filename = `relatorio_${periodo}_${new Date().toISOString().split('T')[0]}`;
            
            const exportData = relatorioData.dadosDetalhados.map(dia => ({
                'Data': formatDate(dia.data),
                'Pedidos': dia.pedidos,
                'Receita': dia.receita,
                'Ticket Médio': dia.ticketMedio,
                'Clientes': dia.clientes,
                'Produtos Vendidos': dia.produtosVendidos
            }));
            
            exportToCSV(exportData, filename);
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            updateWelcomeMessage();
            setupPeriodFilters();
            
            // Definir datas padrão para o mês atual
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            document.getElementById('dataInicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('dataFim').value = fimMes.toISOString().split('T')[0];
        });
    </script>
</body>
</html> 