<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP Gestão - Dashboard</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/TwZLW6a.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="app-layout">
    <header>
        <div class="header-content">
            <a href="index.html" class="logo" style="display: flex; align-items: center;">
                <img src="https://i.imgur.com/TwZLW6a.png" alt="JP Gestão" style="height: 3rem; width: auto; object-fit: contain;">
            </a>
            <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
            <div class="nav-wrapper">
                <nav>
                    <a href="dashboard.html" class="nav-link active">Dashboard</a>
                    <a href="produtos.html" class="nav-link">Produtos</a>
                    <a href="pedidos.html" class="nav-link">Pedidos</a>
                    <a href="clientes.html" class="nav-link">Clientes</a>
                    <a href="mesas.html" class="nav-link">Mesas</a>
                    <a href="caixa.html" class="nav-link">Caixa</a>
                    <a href="relatorios.html" class="nav-link">Relatórios</a>
                    <a href="configuracoes.html" class="nav-link">Configurações</a>
                    <a href="#" class="nav-link" onclick="sair()">Sair</a>
                </nav>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div class="dashboard-header">
                <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
                <div class="dashboard-title">Dashboard</div>
                <div class="dashboard-subtitle">
                    <span id="currentDate"></span>
                    <small>(mês atual)</small>
                </div>
            </div>
            
            <!-- Cards de Estatísticas -->
            <div class="cards">
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Vendas Hoje</div>
                        <i class="fas fa-chart-line card-icon"></i>
                    </div>
                    <div class="card-value" id="vendas-hoje">R$ 0,00</div>
                    <div class="card-change positive">+0% este mês</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Pedidos Ativos</div>
                        <i class="fas fa-clipboard-list card-icon"></i>
                    </div>
                    <div class="card-value" id="pedidos-ativos">0</div>
                    <div class="card-change positive">+8% este mês</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Produtos em Estoque</div>
                        <i class="fas fa-boxes card-icon"></i>
                    </div>
                    <div class="card-value" id="produtos-estoque">0</div>
                    <div class="card-change positive">+15% este mês</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Clientes Cadastrados</div>
                        <i class="fas fa-users card-icon"></i>
                    </div>
                    <div class="card-value" id="clientes-cadastrados">0</div>
                    <div class="card-change positive">+5% este mês</div>
                </div>
            </div>
            
            <!-- Menu Principal -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Menu Principal</h3>
                </div>
                <div class="menu-grid">
                    <a href="produtos.html" class="menu-card">
                        <i class="fas fa-boxes"></i>
                        <h3>Produtos</h3>
                        <p>Gerenciar produtos e estoque</p>
                    </a>
                    <a href="pedidos.html" class="menu-card">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Pedidos</h3>
                        <p>Criar e gerenciar pedidos</p>
                    </a>
                    <a href="clientes.html" class="menu-card">
                        <i class="fas fa-users"></i>
                        <h3>Clientes</h3>
                        <p>Cadastrar e gerenciar clientes</p>
                    </a>
                    <a href="mesas.html" class="menu-card">
                        <i class="fas fa-chair"></i>
                        <h3>Mesas</h3>
                        <p>Controle de mesas e ocupação</p>
                    </a>
                    <a href="caixa.html" class="menu-card">
                        <i class="fas fa-cash-register"></i>
                        <h3>Caixa</h3>
                        <p>Controle financeiro e pagamentos</p>
                    </a>
                    <a href="relatorios.html" class="menu-card">
                        <i class="fas fa-chart-bar"></i>
                        <h3>Relatórios</h3>
                        <p>Relatórios e análises</p>
                    </a>
                    <a href="configuracoes.html" class="menu-card">
                        <i class="fas fa-cog"></i>
                        <h3>Configurações</h3>
                        <p>Configurações do sistema</p>
                    </a>
                    <a href="ajuda.html" class="menu-card">
                        <i class="fas fa-question-circle"></i>
                        <h3>Ajuda</h3>
                        <p>Manual e suporte</p>
                    </a>
                </div>
            </div>
            
            <!-- Pedidos Recentes -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Pedidos Recentes</h3>
                    <a href="pedidos.html" class="btn btn-primary">Novo Pedido</a>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nº Pedido</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="pedidos-recentes">
                            <tr>
                                <td colspan="6" class="text-center text-gray-500">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Produtos com Baixo Estoque -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Produtos com Baixo Estoque</h3>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Estoque Atual</th>
                                <th>Estoque Mínimo</th>
                                <th>Preço</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="produtos-baixo-estoque">
                            <tr>
                                <td colspan="5" class="text-center text-gray-500">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center p-4 mt-8">
        © 2024 JP Gestão. Todos os direitos reservados.
    </footer>
    
    <script src="./js/main.js"></script>
    <script>
        // Verificar autenticação
        if (sessionStorage.getItem('loggedIn') !== 'true') {
            window.location.href = 'login.html';
        }

        // Configurar data atual
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('pt-BR', options);
        }

        // Configurar mensagem de boas-vindas
        function updateWelcomeMessage() {
            const username = sessionStorage.getItem('userDisplay') || sessionStorage.getItem('username') || 'Usuário';
            const capitalizedUsername = username.charAt(0).toUpperCase() + username.slice(1);
            document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${capitalizedUsername}!`;
        }

        // Função de logout
        function sair() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // Carregar dados do dashboard
        async function loadDashboardData() {
            try {
                // Carregar estatísticas usando a API existente
                const statsResponse = await fetch('/api/relatorios/estatisticas', { credentials: 'include' });
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('vendas-hoje').textContent = `R$ ${parseFloat(stats.vendasMes || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                    document.getElementById('pedidos-ativos').textContent = stats.pedidosMesProcessamento || '0';
                    document.getElementById('produtos-estoque').textContent = stats.totalProdutos || '0';
                    document.getElementById('clientes-cadastrados').textContent = stats.totalClientes || '0';
                }

                // Carregar pedidos recentes usando a API de pedidos
                const pedidosResponse = await fetch('/api/pedidos', { credentials: 'include' });
                if (pedidosResponse.ok) {
                    const pedidos = await pedidosResponse.json();
                    const pedidosRecentes = pedidos.slice(0, 5); // Pegar apenas os 5 mais recentes
                    const tbody = document.getElementById('pedidos-recentes');
                    if (pedidosRecentes.length > 0) {
                        tbody.innerHTML = pedidosRecentes.map(pedido => `
                            <tr>
                                <td>#${pedido.id}</td>
                                <td>${pedido.nome_cliente || 'N/A'}</td>
                                <td>R$ ${parseFloat(pedido.valor_total || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                <td><span class="badge badge-${pedido.status === 'Concluído' || pedido.status === 'concluído' ? 'success' : pedido.status === 'Em Processamento' || pedido.status === 'em processamento' ? 'warning' : 'info'}">${pedido.status}</span></td>
                                <td>${new Date(pedido.data_pedido).toLocaleDateString('pt-BR')}</td>
                                <td>
                                    <a href="pedidos.html?id=${pedido.id}" class="btn btn-secondary btn-sm">Ver</a>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Nenhum pedido encontrado</td></tr>';
                    }
                }

                // Carregar produtos com baixo estoque usando a API de produtos
                const produtosResponse = await fetch('/api/produtos', { credentials: 'include' });
                if (produtosResponse.ok) {
                    const produtos = await produtosResponse.json();
                    const produtosBaixoEstoque = produtos.filter(produto => 
                        (produto.estoque || 0) <= (produto.estoque_minimo || 0)
                    ).slice(0, 5); // Pegar apenas os 5 com menor estoque
                    
                    const tbody = document.getElementById('produtos-baixo-estoque');
                    if (produtosBaixoEstoque.length > 0) {
                        tbody.innerHTML = produtosBaixoEstoque.map(produto => `
                            <tr>
                                <td>${produto.nome}</td>
                                <td>${produto.estoque || 0}</td>
                                <td>${produto.estoque_minimo || 0}</td>
                                <td>R$ ${parseFloat(produto.preco_venda || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                <td><span class="badge badge-${(produto.estoque || 0) <= 0 ? 'danger' : 'warning'}">${(produto.estoque || 0) <= 0 ? 'Sem estoque' : 'Baixo estoque'}</span></td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">Todos os produtos com estoque adequado</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        }

        // Menu mobile
        document.addEventListener('DOMContentLoaded', function() {
            const menuBtn = document.getElementById('mobile-menu-toggle');
            const navWrapper = document.querySelector('.nav-wrapper');
            
            if (menuBtn && navWrapper) {
                menuBtn.addEventListener('click', function() {
                    navWrapper.classList.toggle('open');
                });
            }

            updateCurrentDate();
            updateWelcomeMessage();
            loadDashboardData();
        });
    </script>
</body>
</html> 