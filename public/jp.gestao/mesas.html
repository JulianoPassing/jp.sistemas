<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP Gestão - Mesas</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/TwZLW6a.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .mesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .mesa-card {
            background-color: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            border: 2px solid var(--gray-200);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mesa-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .mesa-card.livre {
            border-color: var(--green-500);
            background-color: var(--green-500);
            color: var(--white);
        }
        
        .mesa-card.ocupada {
            border-color: var(--red-500);
            background-color: var(--red-500);
            color: var(--white);
        }
        
        .mesa-card.reservada {
            border-color: var(--yellow-400);
            background-color: var(--yellow-400);
            color: var(--white);
        }
        
        .mesa-numero {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .mesa-status {
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .mesa-info {
            margin-top: 1rem;
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .mesa-acoes {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .mesa-acoes .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .itens-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
        }
        
        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .item-row:last-child {
            border-bottom: none;
        }
        
        .item-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .item-quantity {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .item-price {
            font-size: 0.875rem;
            color: var(--gray-500);
        }
        
        .item-subtotal {
            font-weight: 600;
            color: var(--primary-color);
        }
    </style>
</head>
<body class="app-layout">
    <header>
        <div class="header-content">
            <a href="dashboard.html" class="logo" style="display: flex; align-items: center;">
                <img src="https://i.imgur.com/TwZLW6a.png" alt="JP Gestão" style="height: 3rem; width: auto; object-fit: contain;">
            </a>
            <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
            <div class="nav-wrapper">
                <nav>
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                    <a href="produtos.html" class="nav-link">Produtos</a>
                    <a href="pedidos.html" class="nav-link">Pedidos</a>
                    <a href="clientes.html" class="nav-link">Clientes</a>
                    <a href="mesas.html" class="nav-link active">Mesas</a>
                    <a href="caixa.html" class="nav-link">Caixa</a>
                    <a href="relatorios.html" class="nav-link">Relatórios</a>
                    <a href="configuracoes.html" class="nav-link">Configurações</a>
                    <a href="#" class="nav-link" onclick="sair()">Sair</a>
                </nav>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div class="dashboard-header">
                <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
                <div class="dashboard-title">Controle de Mesas</div>
                <div class="dashboard-subtitle">Gerencie a ocupação e status das mesas</div>
            </div>
            
            <!-- Estatísticas -->
            <div class="cards">
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Total de Mesas</div>
                        <i class="fas fa-chair card-icon"></i>
                    </div>
                    <div class="card-value" id="total-mesas">0</div>
                    <div class="card-change positive">Configurável</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Mesas Livres</div>
                        <i class="fas fa-check-circle card-icon"></i>
                    </div>
                    <div class="card-value" id="mesas-livres">0</div>
                    <div class="card-change positive">Disponíveis</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Mesas Ocupadas</div>
                        <i class="fas fa-users card-icon"></i>
                    </div>
                    <div class="card-value" id="mesas-ocupadas">0</div>
                    <div class="card-change negative">Em uso</div>
                </div>
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="card-title">Mesas Reservadas</div>
                        <i class="fas fa-clock card-icon"></i>
                    </div>
                    <div class="card-value" id="mesas-reservadas">0</div>
                    <div class="card-change warning">Reservadas</div>
                </div>
            </div>
            
            <!-- Controles -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Gerenciar Mesas</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="showAddMesaModal()">
                            <i class="fas fa-plus"></i> Adicionar Mesa
                        </button>
                        <button class="btn btn-secondary" onclick="showConfigModal()">
                            <i class="fas fa-cog"></i> Configurar
                        </button>
                    </div>
                </div>
                
                <!-- Grid de Mesas -->
                <div class="mesas-grid" id="mesasGrid">
                    <!-- Mesas serão carregadas aqui -->
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center p-4 mt-8">
        © 2024 JP Gestão. Todos os direitos reservados.
    </footer>
    
    <script src="./js/main.js"></script>
    <script>
        let mesasData = [];
        let produtosData = [];
        
        // Verificar autenticação
        if (sessionStorage.getItem('loggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
        
        // Configurar mensagem de boas-vindas
        function updateWelcomeMessage() {
            const username = sessionStorage.getItem('userDisplay') || sessionStorage.getItem('username') || 'Usuário';
            const capitalizedUsername = username.charAt(0).toUpperCase() + username.slice(1);
            document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${capitalizedUsername}!`;
        }
        
        // Carregar mesas (usando pedidos em aberto)
        async function loadMesas() {
            try {
                // Carregar pedidos
                const response = await fetch('/api/pedidos', { credentials: 'include' });
                if (response.ok) {
                    const allPedidos = await response.json();
                    // Filtrar apenas pedidos em aberto/processamento para representar mesas
                    mesasData = allPedidos.filter(pedido => 
                        pedido.status === 'Em Processamento' || 
                        pedido.status === 'em processamento' || 
                        pedido.status === 'pendente' ||
                        pedido.status === 'Pendente'
                    ).map(pedido => ({
                        id: pedido.id,
                        numero: pedido.mesa || `Pedido ${pedido.id}`,
                        status: pedido.status === 'Em Processamento' || pedido.status === 'em processamento' ? 'ocupada' : 'livre',
                        capacidade: 4,
                        localizacao: 'Sala principal',
                        cliente: pedido.nome_cliente || 'Cliente não identificado',
                        horario: pedido.data_pedido,
                        observacoes: pedido.observacoes || '',
                        valor_total: pedido.valor_total || 0,
                        itens: pedido.itens || []
                    }));
                } else {
                    showNotification('Erro ao carregar mesas', 'error');
                }

                // Carregar produtos
                const produtosResponse = await fetch('/api/produtos', { credentials: 'include' });
                if (produtosResponse.ok) {
                    produtosData = await produtosResponse.json();
                } else {
                    showNotification('Erro ao carregar produtos', 'error');
                }

                updateStats();
                renderMesas();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showNotification('Erro ao carregar dados', 'error');
            }
        }
        
        // Atualizar estatísticas
        function updateStats() {
            const total = mesasData.length;
            const livres = mesasData.filter(m => m.status === 'livre').length;
            const ocupadas = mesasData.filter(m => m.status === 'ocupada').length;
            const reservadas = mesasData.filter(m => m.status === 'reservada').length;
            
            document.getElementById('total-mesas').textContent = total;
            document.getElementById('mesas-livres').textContent = livres;
            document.getElementById('mesas-ocupadas').textContent = ocupadas;
            document.getElementById('mesas-reservadas').textContent = reservadas;
        }
        
        // Renderizar mesas
        function renderMesas() {
            const grid = document.getElementById('mesasGrid');
            if (mesasData.length === 0) {
                grid.innerHTML = '<div class="text-center text-gray-500" style="grid-column: 1 / -1; padding: 2rem;">Nenhuma mesa configurada</div>';
                return;
            }
            grid.innerHTML = mesasData.map(mesa => `
                <div class="mesa-card ${mesa.status}">
                    <div class="mesa-numero">${mesa.numero}</div>
                    <div class="mesa-status">${getStatusText(mesa.status)}</div>
                    ${mesa.cliente ? `<div class="mesa-info">${mesa.cliente}</div>` : ''}
                    ${mesa.horario ? `<div class="mesa-info">${formatTime(mesa.horario)}</div>` : ''}
                    ${mesa.valor_total > 0 ? `<div class="mesa-info">Total: ${formatCurrency(mesa.valor_total)}</div>` : ''}
                    ${mesa.itens && mesa.itens.length > 0 ? `<div class="mesa-info">${mesa.itens.length} item(s)</div>` : ''}
                    <div class="mesa-acoes">
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); viewMesa(${mesa.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); addProdutoMesa(${mesa.id})">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); editMesa(${mesa.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteMesa(${mesa.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Obter texto de status
        function getStatusText(status) {
            switch (status) {
                case 'livre': return 'Livre';
                case 'ocupada': return 'Ocupada';
                case 'reservada': return 'Reservada';
                default: return status;
            }
        }
        
        // Formatar hora
        function formatTime(time) {
            if (!time) return '';
            return new Date(time).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        
        // Alternar status da mesa (usando API de pedidos)
        async function toggleMesaStatus(id) {
            const mesa = mesasData.find(m => m.id === id);
            if (!mesa) return;
            
            const newStatus = mesa.status === 'livre' ? 'Em Processamento' : 'Concluído';
            
            try {
                const response = await fetch(`/api/pedidos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        status: newStatus,
                        itens: mesa.itens || []
                    })
                });
                
                if (response.ok) {
                    showNotification(`Pedido ${mesa.numero} ${newStatus === 'Concluído' ? 'finalizado' : 'reativado'}!`, 'success');
                    loadMesas();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao alterar status', 'error');
                }
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                showNotification('Erro ao alterar status', 'error');
            }
        }
        
        // Mostrar modal de adicionar mesa
        function showAddMesaModal() {
            const content = `
                <form id="addMesaForm">
                    <div class="form-group">
                        <label for="numero" class="form-label">Nome/Número da Mesa *</label>
                        <input type="text" id="numero" name="numero" class="form-input" placeholder="Ex: Mesa 1, João, Família Silva..." required>
                    </div>
                    <div class="form-group">
                        <label for="capacidade" class="form-label">Capacidade</label>
                        <input type="number" id="capacidade" name="capacidade" class="form-input" min="1" value="4">
                    </div>
                    <div class="form-group">
                        <label for="localizacao" class="form-label">Localização</label>
                        <input type="text" id="localizacao" name="localizacao" class="form-input" placeholder="Ex: Área externa, Varanda, etc." value="Sala principal">
                    </div>
                    <div class="form-group">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea id="observacoes" name="observacoes" class="form-input" rows="3" placeholder="Observações sobre a mesa..."></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Adicionar Mesa</button>
                    </div>
                </form>
            `;
            showModal('Adicionar Nova Mesa', content);
            
            // Adicionar evento de submit
            document.getElementById('addMesaForm').addEventListener('submit', handleAddMesa);
        }
        
        // Manipular adição de mesa (criando novo pedido)
        async function handleAddMesa(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const mesaData = Object.fromEntries(formData.entries());
            const now = new Date().toISOString();
            const pedidoData = {
                nome_cliente: mesaData.numero || '',
                status: 'Em Processamento',
                mesa: mesaData.numero || '',
                observacoes: mesaData.observacoes || '',
                itens: [{ produto: 'Aguardando pedido', quantidade: 1, preco_unitario: 0, subtotal: 0 }],
                telefone: '',
                valor_total: 0,
                created_at: now,
                updated_at: now
            };
            try {
                const response = await fetch('/api/pedidos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(pedidoData)
                });
                if (response.ok) {
                    showNotification('Mesa adicionada com sucesso!', 'success');
                    closeModal(e.target);
                    loadMesas();
                } else {
                    const error = await response.json();
                    showNotification(error.error || error.message || 'Erro ao adicionar mesa', 'error');
                }
            } catch (error) {
                console.error('Erro ao adicionar mesa:', error);
                showNotification('Erro ao adicionar mesa', 'error');
            }
        }
        
        // Visualizar mesa
        function viewMesa(id) {
            const mesa = mesasData.find(m => m.id === id);
            if (!mesa) return;
            const content = `
                <div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <strong>Número:</strong> ${mesa.numero}
                        </div>
                        <div>
                            <strong>Status:</strong> 
                            <span class="badge badge-${mesa.status === 'livre' ? 'success' : mesa.status === 'ocupada' ? 'danger' : 'warning'}">${getStatusText(mesa.status)}</span>
                        </div>
                        <div>
                            <strong>Cliente:</strong> ${mesa.cliente || 'Não informado'}
                        </div>
                        <div>
                            <strong>Capacidade:</strong> ${mesa.capacidade || 4} pessoas
                        </div>
                    </div>
                    ${mesa.horario ? `
                        <div class="mb-4">
                            <strong>Horário de Ocupação:</strong> ${formatTime(mesa.horario)}
                        </div>
                    ` : ''}
                    ${mesa.valor_total > 0 ? `
                        <div class="mb-4">
                            <strong>Valor Total:</strong> ${formatCurrency(mesa.valor_total)}
                        </div>
                    ` : ''}
                    ${mesa.itens && mesa.itens.length > 0 ? `
                        <div class="mb-4">
                            <strong>Itens do Pedido:</strong>
                            <div class="itens-list">
                                ${mesa.itens.map(item => `
                                    <div class="item-row">
                                        <div class="item-info">
                                            <strong>${item.produto}</strong>
                                            <span class="item-quantity">x${item.quantidade}</span>
                                        </div>
                                        <div class="item-price">
                                            ${formatCurrency(item.preco_unitario)} cada
                                        </div>
                                        <div class="item-subtotal">
                                            ${formatCurrency(item.preco_unitario * item.quantidade)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<div class="mb-4"><em>Nenhum produto adicionado</em></div>'}
                    ${mesa.observacoes ? `
                        <div class="mb-4">
                            <strong>Observações:</strong>
                            <div style="margin-top: 0.5rem; padding: 1rem; background-color: var(--gray-100); border-radius: var(--border-radius);">
                                ${mesa.observacoes}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            const modalContent = `
                ${content}
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <button class="btn btn-success" onclick="addProdutoMesa(${mesa.id})">Adicionar Produto</button>
                    <button class="btn btn-primary" onclick="editMesa(${mesa.id})">Editar Mesa</button>
                    <button class="btn btn-danger" onclick="finalizarMesa(${mesa.id})">Finalizar Mesa</button>
                    <button class="btn btn-secondary" onclick="closeModal(this)">Fechar</button>
                </div>
            `;
            showModal(`Mesa ${mesa.numero}`, modalContent);
        }
        
        // Editar mesa
        function editMesa(id) {
            const mesa = mesasData.find(m => m.id === id);
            if (!mesa) return;
            
            const content = `
                <form id="editMesaForm">
                    <input type="hidden" name="id" value="${mesa.id}">
                    <div class="form-group">
                        <label for="edit_numero" class="form-label">Nome/Número da Mesa *</label>
                        <input type="text" id="edit_numero" name="numero" class="form-input" value="${mesa.numero}" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_capacidade" class="form-label">Capacidade</label>
                        <input type="number" id="edit_capacidade" name="capacidade" class="form-input" value="${mesa.capacidade || 4}" min="1">
                    </div>
                    <div class="form-group">
                        <label for="edit_localizacao" class="form-label">Localização</label>
                        <input type="text" id="edit_localizacao" name="localizacao" class="form-input" value="${mesa.localizacao || 'Sala principal'}" placeholder="Ex: Área externa, Varanda, etc.">
                    </div>
                    <div class="form-group">
                        <label for="edit_observacoes" class="form-label">Observações</label>
                        <textarea id="edit_observacoes" name="observacoes" class="form-input" rows="3" placeholder="Observações sobre a mesa...">${mesa.observacoes || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Atualizar Mesa</button>
                    </div>
                </form>
            `;
            showModal('Editar Mesa', content);
            
            // Adicionar evento de submit
            document.getElementById('editMesaForm').addEventListener('submit', handleEditMesa);
        }
        
        // Manipular edição de mesa (usando API de pedidos)
        async function handleEditMesa(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const mesaData = Object.fromEntries(formData.entries());
            const id = mesaData.id;
            delete mesaData.id;
            
            // Atualizar o pedido correspondente
            const pedidoData = {
                nome_cliente: mesaData.numero,
                mesa: mesaData.numero,
                observacoes: mesaData.observacoes || ''
            };
            
            try {
                const response = await fetch(`/api/pedidos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(pedidoData)
                });
                
                if (response.ok) {
                    showNotification('Mesa atualizada com sucesso!', 'success');
                    closeModal(e.target);
                    loadMesas();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao atualizar mesa', 'error');
                }
            } catch (error) {
                console.error('Erro ao atualizar mesa:', error);
                showNotification('Erro ao atualizar mesa', 'error');
            }
        }
        
        // Deletar mesa
        function deleteMesa(id) {
            const mesa = mesasData.find(m => m.id === id);
            if (!mesa) return;
            
            confirmAction(`Tem certeza que deseja excluir a mesa ${mesa.numero}?`, async () => {
                try {
                    const response = await fetch(`/api/pedidos/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        showNotification('Mesa excluída com sucesso!', 'success');
                        loadMesas();
                    } else {
                        const error = await response.json();
                        showNotification(error.message || 'Erro ao excluir mesa', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao excluir mesa:', error);
                    showNotification('Erro ao excluir mesa', 'error');
                }
            });
        }
        
        // Mostrar modal de configuração
        function showConfigModal() {
            const content = `
                <div>
                    <p>Configurações de mesas em desenvolvimento.</p>
                    <p>Funcionalidades futuras:</p>
                    <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                        <li>Configuração automática de mesas</li>
                        <li>Layout personalizado</li>
                        <li>Horários de funcionamento</li>
                        <li>Reservas automáticas</li>
                    </ul>
                </div>
            `;
            showModal('Configurações de Mesas', content);
        }
        
        // Adicionar produto à mesa
        function addProdutoMesa(id) {
            const mesa = mesasData.find(m => m.id === id);
            if (!mesa) return;
            
            if (produtosData.length === 0) {
                showNotification('Nenhum produto disponível', 'warning');
                return;
            }
            
            const content = `
                <form id="addProdutoForm">
                    <input type="hidden" name="mesa_id" value="${mesa.id}">
                    <div class="form-group">
                        <label for="produto_id" class="form-label">Produto *</label>
                        <select id="produto_id" name="produto_id" class="form-input" required>
                            <option value="">Selecione um produto</option>
                            ${produtosData.map(produto => `
                                <option value="${produto.id}" data-preco="${produto.preco_venda || 0}" data-estoque="${produto.estoque || 0}">
                                    ${produto.nome} - R$ ${formatCurrency(produto.preco_venda || 0)} (Estoque: ${produto.estoque || 0})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quantidade" class="form-label">Quantidade *</label>
                        <input type="number" id="quantidade" name="quantidade" class="form-input" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="preco_unitario" class="form-label">Preço Unitário</label>
                        <input type="number" id="preco_unitario" name="preco_unitario" class="form-input" step="0.01" min="0" readonly>
                    </div>
                    <div class="form-group">
                        <label for="subtotal" class="form-label">Subtotal</label>
                        <input type="text" id="subtotal" class="form-input" readonly>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Adicionar Produto</button>
                    </div>
                </form>
            `;
            showModal(`Adicionar Produto - Mesa ${mesa.numero}`, content);
            
            // Adicionar eventos
            const form = document.getElementById('addProdutoForm');
            const produtoSelect = document.getElementById('produto_id');
            const quantidadeInput = document.getElementById('quantidade');
            const precoInput = document.getElementById('preco_unitario');
            const subtotalInput = document.getElementById('subtotal');
            
            // Atualizar preço quando produto for selecionado
            produtoSelect.addEventListener('change', function() {
                const option = this.options[this.selectedIndex];
                const preco = parseFloat(option.dataset.preco) || 0;
                const estoque = parseInt(option.dataset.estoque) || 0;
                
                precoInput.value = preco.toFixed(2);
                quantidadeInput.max = estoque;
                updateSubtotal();
            });
            
            // Atualizar subtotal quando quantidade mudar
            quantidadeInput.addEventListener('input', updateSubtotal);
            
            function updateSubtotal() {
                const preco = parseFloat(precoInput.value) || 0;
                const quantidade = parseInt(quantidadeInput.value) || 0;
                const subtotal = preco * quantidade;
                subtotalInput.value = formatCurrency(subtotal);
            }
            
            // Adicionar evento de submit
            form.addEventListener('submit', handleAddProduto);
        }
        
        // Manipular adição de produto
        async function handleAddProduto(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const mesaId = parseInt(formData.get('mesa_id'));
            const produtoId = parseInt(formData.get('produto_id'));
            const quantidade = parseInt(formData.get('quantidade'));
            const precoUnitario = parseFloat(formData.get('preco_unitario'));
            
            const mesa = mesasData.find(m => m.id === mesaId);
            const produto = produtosData.find(p => p.id === produtoId);
            
            if (!mesa || !produto) {
                showNotification('Erro: Mesa ou produto não encontrado', 'error');
                return;
            }
            
            // Verificar estoque
            if (quantidade > (produto.estoque || 0)) {
                showNotification('Quantidade maior que o estoque disponível', 'warning');
                return;
            }
            
            // Criar novo item
            const novoItem = {
                produto_id: produtoId,
                produto: produto.nome,
                quantidade: quantidade,
                preco_unitario: precoUnitario,
                subtotal: precoUnitario * quantidade
            };
            
            // Adicionar item à mesa
            const itensAtualizados = [...(mesa.itens || []), novoItem];
            const valorTotalAtualizado = itensAtualizados.reduce((total, item) => total + item.subtotal, 0);
            
            try {
                const response = await fetch(`/api/pedidos/${mesaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        status: mesa.status === 'livre' ? 'pendente' : 'Em Processamento',
                        itens: itensAtualizados,
                        valor_total: valorTotalAtualizado
                    })
                });
                
                if (response.ok) {
                    showNotification('Produto adicionado com sucesso!', 'success');
                    closeModal(e.target);
                    loadMesas();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao adicionar produto', 'error');
                }
            } catch (error) {
                console.error('Erro ao adicionar produto:', error);
                showNotification('Erro ao adicionar produto', 'error');
            }
        }
        
        // Finalizar mesa
        async function finalizarMesa(id) {
            const mesa = mesasData.find(m => m.id === id);
            if (!mesa) return;
            try {
                const response = await fetch(`/api/pedidos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        status: 'Concluído',
                        itens: mesa.itens || []
                    })
                });
                if (response.ok) {
                    showNotification('Mesa finalizada com sucesso!', 'success');
                    closeModal();
                    loadMesas();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao finalizar mesa', 'error');
                }
            } catch (error) {
                console.error('Erro ao finalizar mesa:', error);
                showNotification('Erro ao finalizar mesa', 'error');
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            updateWelcomeMessage();
            loadMesas();
        });
    </script>
</body>
</html> 