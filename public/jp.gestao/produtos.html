<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP Gestão - Produtos</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/TwZLW6a.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="app-layout">
    <header>
        <div class="header-content">
            <a href="dashboard.html" class="logo" style="display: flex; align-items: center;">
                <img src="https://i.imgur.com/TwZLW6a.png" alt="JP Gestão" style="height: 3rem; width: auto; object-fit: contain;">
            </a>
            <button id="mobile-menu-toggle" class="mobile-menu-btn" aria-label="Abrir menu"><span class="menu-icon"></span></button>
            <div class="nav-wrapper">
                <nav>
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                    <a href="produtos.html" class="nav-link active">Produtos</a>
                    <a href="pedidos.html" class="nav-link">Pedidos</a>
                    <a href="clientes.html" class="nav-link">Clientes</a>
                    <a href="mesas.html" class="nav-link">Mesas</a>
                    <a href="caixa.html" class="nav-link">Caixa</a>
                    <a href="relatorios.html" class="nav-link">Relatórios</a>
                    <a href="configuracoes.html" class="nav-link">Configurações</a>
                    <a href="#" class="nav-link" onclick="sair()">Sair</a>
                </nav>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div class="dashboard-header">
                <div class="welcome-message" id="welcomeMessage">Bem-vindo(a)!</div>
                <div class="dashboard-title">Gerenciamento de Produtos</div>
                <div class="dashboard-subtitle">Cadastre e gerencie seus produtos e estoque</div>
            </div>
            
            <!-- Busca e Filtros -->
            <div class="search-container">
                <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
                    <div style="flex: 1;">
                        <input type="text" id="searchInput" placeholder="Buscar produtos..." class="form-input">
                    </div>
                    <div>
                        <select id="categoryFilter" class="form-input">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    <div>
                        <select id="statusFilter" class="form-input">
                            <option value="">Todos os status</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                            <option value="sem_estoque">Sem estoque</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Novo Produto
                    </button>
                    <button class="btn btn-secondary" onclick="exportProducts()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>
            
            <!-- Tabela de Produtos -->
            <div class="section">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Preço</th>
                                <th>Estoque</th>
                                <th>Status</th>
                                <th>Última Atualização</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="produtosTable">
                            <tr>
                                <td colspan="7" class="text-center text-gray-500">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center p-4 mt-8">
        © 2024 JP Gestão. Todos os direitos reservados.
    </footer>
    
    <script src="./js/main.js"></script>
    <script>
        let produtosData = [];
        let filteredData = [];
        
        // Verificar autenticação
        if (sessionStorage.getItem('loggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
        
        // Configurar mensagem de boas-vindas
        function updateWelcomeMessage() {
            const username = sessionStorage.getItem('userDisplay') || sessionStorage.getItem('username') || 'Usuário';
            const capitalizedUsername = username.charAt(0).toUpperCase() + username.slice(1);
            document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${capitalizedUsername}!`;
        }
        
        // Carregar produtos
        async function loadProdutos() {
            try {
                const response = await fetch('/api/produtos');
                if (response.ok) {
                    produtosData = await response.json();
                    filteredData = [...produtosData];
                    renderProdutos();
                    updateCategoryFilter();
                } else {
                    showNotification('Erro ao carregar produtos', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                showNotification('Erro ao carregar produtos', 'error');
            }
        }
        
        // Renderizar produtos na tabela
        function renderProdutos() {
            const tbody = document.getElementById('produtosTable');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Nenhum produto encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredData.map(produto => `
                <tr>
                    <td>
                        <div>
                            <div class="font-semibold">${produto.nome}</div>
                            <div class="text-sm text-gray-500">${produto.descricao || 'Sem descrição'}</div>
                        </div>
                    </td>
                    <td>${produto.categoria || 'Sem categoria'}</td>
                    <td class="font-semibold">${formatCurrency(produto.preco)}</td>
                    <td>
                        <span class="font-semibold ${produto.estoque <= (produto.estoque_minimo || 0) ? 'text-red-600' : 'text-green-600'}">
                            ${produto.estoque}
                        </span>
                        ${produto.estoque_minimo ? `<div class="text-xs text-gray-500">Mín: ${produto.estoque_minimo}</div>` : ''}
                    </td>
                    <td>
                        <span class="badge badge-${getStatusBadge(produto)}">${getStatusText(produto)}</span>
                    </td>
                    <td>${formatDateTime(produto.updated_at || produto.created_at)}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="editProduto(${produto.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="adjustStock(${produto.id})">
                                <i class="fas fa-boxes"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduto(${produto.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Obter badge de status
        function getStatusBadge(produto) {
            if (produto.estoque <= 0) return 'danger';
            if (produto.estoque <= (produto.estoque_minimo || 0)) return 'warning';
            return 'success';
        }
        
        // Obter texto de status
        function getStatusText(produto) {
            if (produto.estoque <= 0) return 'Sem estoque';
            if (produto.estoque <= (produto.estoque_minimo || 0)) return 'Baixo estoque';
            return 'Disponível';
        }
        
        // Atualizar filtro de categorias
        function updateCategoryFilter() {
            const categories = [...new Set(produtosData.map(p => p.categoria).filter(Boolean))];
            const select = document.getElementById('categoryFilter');
            
            // Manter a opção "Todas as categorias"
            select.innerHTML = '<option value="">Todas as categorias</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }
        
        // Filtrar produtos
        function filterProdutos() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredData = produtosData.filter(produto => {
                // Filtro de busca
                const matchesSearch = !searchTerm || 
                    produto.nome.toLowerCase().includes(searchTerm) ||
                    (produto.descricao && produto.descricao.toLowerCase().includes(searchTerm));
                
                // Filtro de categoria
                const matchesCategory = !categoryFilter || produto.categoria === categoryFilter;
                
                // Filtro de status
                let matchesStatus = true;
                if (statusFilter) {
                    if (statusFilter === 'sem_estoque') {
                        matchesStatus = produto.estoque <= 0;
                    } else if (statusFilter === 'ativo') {
                        matchesStatus = produto.estoque > (produto.estoque_minimo || 0);
                    } else if (statusFilter === 'inativo') {
                        matchesStatus = produto.estoque <= (produto.estoque_minimo || 0) && produto.estoque > 0;
                    }
                }
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            renderProdutos();
        }
        
        // Mostrar modal de adicionar produto
        function showAddProductModal() {
            const content = `
                <form id="addProductForm">
                    <div class="form-group">
                        <label for="nome" class="form-label">Nome do Produto *</label>
                        <input type="text" id="nome" name="nome" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="descricao" class="form-label">Descrição</label>
                        <textarea id="descricao" name="descricao" class="form-input" rows="3"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="categoria" class="form-label">Categoria</label>
                            <input type="text" id="categoria" name="categoria" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="preco" class="form-label">Preço *</label>
                            <input type="number" id="preco" name="preco" class="form-input" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="estoque" class="form-label">Estoque Inicial *</label>
                            <input type="number" id="estoque" name="estoque" class="form-input" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="estoque_minimo" class="form-label">Estoque Mínimo</label>
                            <input type="number" id="estoque_minimo" name="estoque_minimo" class="form-input" min="0">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Produto</button>
                    </div>
                </form>
            `;
            showModal('Adicionar Novo Produto', content);
            
            // Adicionar evento de submit
            document.getElementById('addProductForm').addEventListener('submit', handleAddProduct);
        }
        
        // Manipular adição de produto
        async function handleAddProduct(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/produtos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });
                
                if (response.ok) {
                    showNotification('Produto adicionado com sucesso!', 'success');
                    closeModal(e.target);
                    loadProdutos();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao adicionar produto', 'error');
                }
            } catch (error) {
                console.error('Erro ao adicionar produto:', error);
                showNotification('Erro ao adicionar produto', 'error');
            }
        }
        
        // Editar produto
        function editProduto(id) {
            const produto = produtosData.find(p => p.id === id);
            if (!produto) return;
            
            const content = `
                <form id="editProductForm">
                    <input type="hidden" name="id" value="${produto.id}">
                    <div class="form-group">
                        <label for="edit_nome" class="form-label">Nome do Produto *</label>
                        <input type="text" id="edit_nome" name="nome" class="form-input" value="${produto.nome}" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_descricao" class="form-label">Descrição</label>
                        <textarea id="edit_descricao" name="descricao" class="form-input" rows="3">${produto.descricao || ''}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="edit_categoria" class="form-label">Categoria</label>
                            <input type="text" id="edit_categoria" name="categoria" class="form-input" value="${produto.categoria || ''}">
                        </div>
                        <div class="form-group">
                            <label for="edit_preco" class="form-label">Preço *</label>
                            <input type="number" id="edit_preco" name="preco" class="form-input" step="0.01" min="0" value="${produto.preco}" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="edit_estoque" class="form-label">Estoque Atual *</label>
                            <input type="number" id="edit_estoque" name="estoque" class="form-input" min="0" value="${produto.estoque}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit_estoque_minimo" class="form-label">Estoque Mínimo</label>
                            <input type="number" id="edit_estoque_minimo" name="estoque_minimo" class="form-input" min="0" value="${produto.estoque_minimo || ''}">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Atualizar Produto</button>
                    </div>
                </form>
            `;
            showModal('Editar Produto', content);
            
            // Adicionar evento de submit
            document.getElementById('editProductForm').addEventListener('submit', handleEditProduct);
        }
        
        // Manipular edição de produto
        async function handleEditProduct(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData.entries());
            const id = productData.id;
            delete productData.id;
            
            try {
                const response = await fetch(`/api/produtos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });
                
                if (response.ok) {
                    showNotification('Produto atualizado com sucesso!', 'success');
                    closeModal(e.target);
                    loadProdutos();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao atualizar produto', 'error');
                }
            } catch (error) {
                console.error('Erro ao atualizar produto:', error);
                showNotification('Erro ao atualizar produto', 'error');
            }
        }
        
        // Ajustar estoque
        function adjustStock(id) {
            const produto = produtosData.find(p => p.id === id);
            if (!produto) return;
            
            const content = `
                <form id="adjustStockForm">
                    <input type="hidden" name="id" value="${produto.id}">
                    <div class="form-group">
                        <label class="form-label">Produto</label>
                        <div class="form-input" style="background-color: var(--gray-100);">${produto.nome}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estoque Atual</label>
                        <div class="form-input" style="background-color: var(--gray-100);">${produto.estoque}</div>
                    </div>
                    <div class="form-group">
                        <label for="ajuste" class="form-label">Ajuste de Estoque</label>
                        <input type="number" id="ajuste" name="ajuste" class="form-input" placeholder="+10 ou -5" required>
                        <small class="text-gray-500">Use números positivos para adicionar, negativos para remover</small>
                    </div>
                    <div class="form-group">
                        <label for="motivo" class="form-label">Motivo do Ajuste</label>
                        <textarea id="motivo" name="motivo" class="form-input" rows="3" placeholder="Ex: Compra de fornecedor, Venda, Perda, etc."></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Aplicar Ajuste</button>
                    </div>
                </form>
            `;
            showModal('Ajustar Estoque', content);
            
            // Adicionar evento de submit
            document.getElementById('adjustStockForm').addEventListener('submit', handleAdjustStock);
        }
        
        // Manipular ajuste de estoque
        async function handleAdjustStock(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`/api/produtos/${data.id}/estoque`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ajuste: parseInt(data.ajuste),
                        motivo: data.motivo
                    })
                });
                
                if (response.ok) {
                    showNotification('Estoque ajustado com sucesso!', 'success');
                    closeModal(e.target);
                    loadProdutos();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao ajustar estoque', 'error');
                }
            } catch (error) {
                console.error('Erro ao ajustar estoque:', error);
                showNotification('Erro ao ajustar estoque', 'error');
            }
        }
        
        // Deletar produto
        function deleteProduto(id) {
            const produto = produtosData.find(p => p.id === id);
            if (!produto) return;
            
            confirmAction(`Tem certeza que deseja excluir o produto "${produto.nome}"?`, async () => {
                try {
                    const response = await fetch(`/api/produtos/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showNotification('Produto excluído com sucesso!', 'success');
                        loadProdutos();
                    } else {
                        const error = await response.json();
                        showNotification(error.message || 'Erro ao excluir produto', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao excluir produto:', error);
                    showNotification('Erro ao excluir produto', 'error');
                }
            });
        }
        
        // Exportar produtos
        function exportProducts() {
            if (filteredData.length === 0) {
                showNotification('Nenhum produto para exportar', 'warning');
                return;
            }
            
            const exportData = filteredData.map(produto => ({
                Nome: produto.nome,
                Descrição: produto.descricao || '',
                Categoria: produto.categoria || '',
                Preço: produto.preco,
                Estoque: produto.estoque,
                'Estoque Mínimo': produto.estoque_minimo || '',
                Status: getStatusText(produto),
                'Última Atualização': formatDateTime(produto.updated_at || produto.created_at)
            }));
            
            exportToCSV(exportData, 'produtos');
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            updateWelcomeMessage();
            loadProdutos();
            
            // Busca em tempo real
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce(filterProdutos, 300));
            
            // Filtros
            document.getElementById('categoryFilter').addEventListener('change', filterProdutos);
            document.getElementById('statusFilter').addEventListener('change', filterProdutos);
        });
    </script>
</body>
</html> 