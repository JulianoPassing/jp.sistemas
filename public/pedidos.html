<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pedidos e Vendas - J.P Sistemas Comercial</title>
  <link rel="icon" href="https://i.imgur.com/QgVsPmF.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #3b82f6;
      --secondary-color: #1e40af;
      --accent-color: #60a5fa;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --background: #f8fafc;
      --surface: #ffffff;
      --border: #e5e7eb;
      --shadow: rgba(37, 99, 235, 0.1);
      --shadow-hover: rgba(37, 99, 235, 0.2);
      --success-color: #059669;
      --danger-color: #dc2626;
      --light-color: #f9fafb;
      --dark-color: #111827;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --border-radius: 12px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text-primary);
      padding: 0;
      min-height: 100vh;
    }
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 20px 0;
      box-shadow: 0 4px 20px rgba(37, 99, 235, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      display: flex;
      align-items: center;
    }
    .logo img {
      width: 150px;
      height: 67px;
      object-fit: contain;
      background: none;
      box-shadow: none;
      border-radius: 0;
      margin: 0;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-info span {
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      font-weight: 500;
    }
    .user-info #userDisplay {
      font-weight: 700;
    }
    .logout-btn {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }
    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
    }
    .main-content {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    #logo-container { text-align: center; margin-bottom: 25px; }
    #logo { 
      max-width: 100%; 
      height: auto; 
      max-height: 80px; 
      filter: brightness(0) invert(1);
      opacity: 0.9;
    }
    .card { 
      background-color: var(--card-bg); 
      border-radius: var(--border-radius); 
      box-shadow: var(--shadow); 
      padding: 25px; 
      margin-bottom: 25px; 
      border: 1px solid var(--border-color); 
    }
    .card-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    .card-header .btn-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      width: 100%;
    }
    .card-header h2 { 
      font-size: 1.8em; 
      color: var(--dark-color); 
      font-weight: 600; 
      text-align: center;
    }
    .btn { 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: 8px; 
      padding: 12px 20px; 
      border-radius: 8px; 
      border: none; 
      font-family: "Poppins", sans-serif; 
      font-weight: 500; 
      font-size: 0.95em; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      text-decoration: none; 
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
      color: white; 
    }
    .btn-primary:hover { 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    .btn-success { 
      background: linear-gradient(135deg, var(--success-color), #20c997); 
      color: white; 
    }
    .btn-success:hover { 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }
    .btn-danger { 
      background: linear-gradient(135deg, var(--danger-color), #c82333); 
      color: white; 
    }
    .btn-danger:hover { 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      color: white;
    }
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280, #9ca3af);
      color: white;
    }
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(107, 114, 128, 0.3);
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85em;
      margin: 0 2px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    thead th { 
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
      color: white; 
      font-weight: 600; 
      white-space: nowrap; 
    }
    tbody tr:hover { background-color: #f8f9fa; }
    .search-box {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 400px;
      background: #fff;
      border-radius: 24px;
      border: 2px solid var(--border-color);
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
      padding: 4px 16px 4px 14px;
      margin: 0 auto 24px auto;
      transition: all 0.3s ease;
    }
    .search-box:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
    }
    .search-icon {
      font-size: 1.35em;
      color: var(--primary-color);
      margin-right: 10px;
      opacity: 0.85;
      transition: color 0.2s;
    }
    #busca-pedido {
      border: none;
      background: transparent;
      outline: none;
      font-size: 1.13em;
      font-family: "Poppins", sans-serif;
      width: 100%;
      padding: 10px 0 10px 0;
      color: var(--text-color);
      letter-spacing: 0.01em;
    }
    #busca-pedido::placeholder {
      color: #b0b0b0;
      opacity: 1;
      font-size: 1em;
      letter-spacing: 0.01em;
    }
    .table-responsive { max-height: 420px; overflow-y: auto; }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      margin: 2% auto;
      padding: 0;
      border-radius: var(--border-radius);
      width: 98%;
      max-width: 1200px;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      animation: slideIn 0.3s ease;
      position: relative;
    }

    @keyframes slideIn {
      from { 
        transform: translateY(-50px);
        opacity: 0;
      }
      to { 
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
    }

    .close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .modal-body {
      padding: 24px;
    }

    .form-section {
      margin-bottom: 24px;
    }

    .form-section h4 {
      color: var(--dark-color);
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary-color);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      color: var(--dark-color);
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-family: "Poppins", sans-serif;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .items-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .item-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }

    .item-row:last-child {
      margin-bottom: 0;
    }

    .remove-item {
      background: var(--danger-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .remove-item:hover {
      transform: scale(1.1);
      background: #c82333;
    }

    .add-item-btn {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: "Poppins", sans-serif;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .add-item-btn:hover {
      background: #20c997;
      transform: translateY(-1px);
    }

    .total-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 16px;
      border-radius: 8px;
      text-align: right;
    }

    .total-section h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .modal-footer {
      padding: 20px 24px;
      background: rgba(0, 0, 0, 0.02);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      position: sticky;
      bottom: 0;
    }

    /* Estilos para o modal de visualização */
    .pedido-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary-color);
    }

    .pedido-numero {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
    }

    .pedido-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .status-concluido {
      background: var(--success-color);
      color: white;
    }

    .status-cancelado {
      background: var(--danger-color);
      color: white;
    }

    .status-processamento {
      background: #f59e0b;
      color: white;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-section {
      background: white;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--border-color);
    }

    .info-section h4 {
      color: var(--primary-color);
      margin-bottom: 10px;
      font-size: 1rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 5px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 5px 0;
    }

    .info-label {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .info-value {
      color: var(--text-primary);
      text-align: right;
    }

    .itens-table {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .itens-table table {
      margin: 0;
    }

    .itens-table th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
      padding: 12px;
    }

    .itens-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .total-section-visualizacao {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      text-align: right;
      font-size: 1.2rem;
      font-weight: bold;
    }

    .observacoes-section {
      background: white;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--border-color);
      margin-top: 20px;
    }

    .observacoes-section h4 {
      color: var(--primary-color);
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .observacoes-texto {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid var(--primary-color);
      font-style: italic;
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 99%;
        margin: 1% auto;
        max-width: 99vw;
        max-height: 98vh;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .item-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .item-row > * {
        width: 100%;
      }

      .info-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .modal-footer {
        flex-direction: column;
        gap: 8px;
      }

      .modal-footer .btn {
        width: 100%;
      }
    }

    .footer {
      width: 100%;
      text-align: center;
      padding: 18px 0 12px 0;
      color: #000;
      font-size: 15px;
      background: transparent;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.02em;
    }

    /* Estilos específicos para botões de ação de pedidos */
    .btn-concluir {
      background: linear-gradient(135deg, #059669, #10b981) !important;
      color: white !important;
      border: none !important;
    }
    
    .btn-concluir:hover {
      background: linear-gradient(135deg, #047857, #059669) !important;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3);
    }
    
    .btn-cancelar {
      background: linear-gradient(135deg, #dc2626, #ef4444) !important;
      color: white !important;
      border: none !important;
    }
    
    .btn-cancelar:hover {
      background: linear-gradient(135deg, #b91c1c, #dc2626) !important;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
    }
  </style>
</head>
<body>
  <!-- Modal para Novo Pedido -->
  <div id="novoPedidoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Novo Pedido</h3>
        <span class="close" id="closeNovoPedido">&times;</span>
      </div>
      <div class="modal-body">
        <form id="novoPedidoForm">
          <!-- Informações do Cliente -->
          <div class="form-section">
            <h4>Informacoes do Cliente</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="cliente">Cliente *</label>
                <select id="cliente" required>
                  <option value="">Carregando clientes...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="formaPagamento">Forma de Pagamento *</label>
                <select id="formaPagamento" required>
                  <option value="">Selecione</option>
                  <option value="Cartao de Credito">Cartao de Credito</option>
                  <option value="Cartao de Debito">Cartao de Debito</option>
                  <option value="PIX">PIX</option>
                  <option value="Boleto Bancario">Boleto Bancario</option>
                  <option value="Dinheiro">Dinheiro</option>
                  <option value="Transferencia">Transferencia</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="telefone">Telefone</label>
                <input type="tel" id="telefone" placeholder="(11) 99999-9999">
              </div>
              <div class="form-group">
                <label for="email">E-mail</label>
                <input type="email" id="email" placeholder="cliente@empresa.com">
              </div>
            </div>
            <div class="form-group full-width">
              <label for="endereco">Endereco</label>
              <input type="text" id="endereco" placeholder="Rua, numero, bairro, cidade/estado">
            </div>
          </div>

          <!-- Itens do Pedido -->
          <div class="form-section">
            <h4>Itens do Pedido</h4>
            <div class="items-section">
              <div id="itensContainer">
                <!-- Itens serão adicionados aqui dinamicamente -->
              </div>
              <button type="button" class="add-item-btn" id="addItemBtn">
                <i class="fas fa-plus"></i> Adicionar Item
              </button>
            </div>
            <div class="total-section">
              <h3>Total: R$ <span id="totalPedido">0,00</span></h3>
            </div>
          </div>

          <!-- Observacoes -->
          <div class="form-section">
            <h4>Observacoes</h4>
            <div class="form-group full-width">
              <textarea id="observacoes" rows="3" placeholder="Observacoes sobre o pedido, instrucoes de entrega, etc."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="salvarPedido">
          <i class="fas fa-save"></i> Salvar Pedido
        </button>
        <button type="button" class="btn btn-danger" id="cancelarPedido">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Visualização do Pedido -->
  <div id="visualizarPedidoModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3><i class="fas fa-eye"></i> Visualizar Pedido</h3>
        <span class="close" id="closeVisualizarPedido">&times;</span>
      </div>
      <div class="modal-body">
        <div id="pedidoDetalhes">
          <!-- Conteúdo será preenchido dinamicamente -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="concluirPedido">
          <i class="fas fa-check"></i> Concluir Pedido
        </button>
        <button type="button" class="btn btn-warning" id="cancelarPedidoBtn">
          <i class="fas fa-ban"></i> Cancelar Pedido
        </button>
        <button type="button" class="btn btn-primary" id="gerarPDFPedidoBtn">
          <i class="fas fa-file-pdf"></i> Gerar PDF
        </button>
        <button type="button" class="btn btn-secondary" id="fecharVisualizarPedido">
          <i class="fas fa-times"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <header class="header">
    <div class="header-content">
      <div class="logo">
        <img src="https://i.imgur.com/2jT2EPD.png" alt="Logo J.P Sistemas" style="width: 150px; height: 67px; display: block; object-fit: contain; background: none; box-shadow: none; border-radius: 0; margin: 0;" />
      </div>
      <div class="user-info">
        <span>Bem-vindo, <span id="userDisplay"></span></span>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Sair
        </button>
        <a href="painel.html" class="logout-btn" style="background: var(--primary-light); margin-left: 8px;">
          <i class="fas fa-arrow-left"></i> Voltar
        </a>
      </div>
    </div>
  </header>
  <main class="main-content">
    <div class="card">
      <div class="card-header">
        <h2>Pedidos e Vendas</h2>
        <div class="btn-group">
          <button class="btn btn-primary" id="btn-novo-pedido">
            <i class="fas fa-plus"></i> Novo Pedido
          </button>
          <button class="btn btn-success" id="btn-exportar-pdf">
            <i class="fas fa-file-pdf"></i> Exportar PDF
          </button>
          <button class="btn btn-warning" id="btn-exportar-excel">
            <i class="fas fa-file-excel"></i> Exportar Excel
          </button>
          <a href="caixa.html" class="btn btn-secondary" style="text-decoration:none;">
            <i class="fas fa-cash-register"></i> Ir para o Caixa
          </a>
          <a href="mesas.html" class="btn btn-secondary" style="text-decoration:none;">
            <i class="fas fa-chair"></i> Ir para Mesas
          </a>
        </div>
      </div>
      <div style="display: flex; justify-content: center; position: relative;">
        <div class="search-box" style="width:100%;">
          <span class="search-icon">&#128269;</span>
          <input type="text" id="busca-pedido" placeholder="Buscar pedido..." autocomplete="off" />
        </div>
      </div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Data</th>
              <th>Status</th>
              <th>Valor Total</th>
              <th>Lucro</th>
              <th>Acoes</th>
            </tr>
          </thead>
          <tbody id="pedidos-tbody">
            <!-- Os pedidos serão carregados dinamicamente do banco de dados -->
          </tbody>
        </table>
      </div>
    </div>
  </main>
  <footer class="footer">
    © 2025 J.P Sistemas. Todos os direitos reservados. <a href="https://whatsa.me/5548996852138/?t=Ola,%20gostaria%20de%20mais%20informacoes%20sobre%20os%20sistemas." target="_blank" style="color: #000; text-decoration: underline; font-weight: 500;">Fale conosco no WhatsApp</a>
  </footer>
  <script>
    // Array para armazenar pedidos carregados do banco
    let pedidos = [];
    let clientes = []; // Array para armazenar clientes do banco
    let produtos = []; // Array para armazenar produtos do banco
    let novoPedidoItens = []; // Array para itens do novo pedido
    let itemCounter = 0; // Contador para IDs dos itens

    // Função para carregar produtos do banco de dados
    async function carregarProdutos() {
      try {
        const response = await fetch('/api/produtos');
        if (!response.ok) throw new Error('Erro ao carregar produtos');
        produtos = await response.json();
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        alert('Erro ao carregar produtos do banco de dados');
      }
    }

    // Função para carregar clientes do banco de dados
    async function carregarClientes() {
      try {
        const response = await fetch('/api/clientes', { credentials: 'include' });
        if (!response.ok) throw new Error('Erro ao carregar clientes');
        clientes = await response.json();
        atualizarSelectClientes();
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        alert('Erro ao carregar clientes do banco de dados');
      }
    }

    // Função para atualizar o select de clientes
    function atualizarSelectClientes() {
      const select = document.getElementById('cliente');
      if (!select) return;
      
      select.innerHTML = '<option value="">Selecione um cliente</option>';
      
      if (clientes.length === 0) {
        select.innerHTML += '<option value="" disabled>Nenhum cliente cadastrado</option>';
        return;
      }
      
      clientes.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente.id;
        option.textContent = `${cliente.razao}${cliente.cnpj ? ` - ${cliente.cnpj}` : ''}`;
        select.appendChild(option);
      });
    }

    // Função para preencher informações do cliente automaticamente
    function preencherInfoCliente() {
      const clienteId = document.getElementById('cliente').value;
      const cliente = clientes.find(c => c.id == clienteId);
      
      if (cliente) {
        document.getElementById('telefone').value = cliente.telefone || '';
        document.getElementById('email').value = cliente.email || '';
        document.getElementById('endereco').value = `${cliente.endereco || ''}${cliente.bairro ? `, ${cliente.bairro}` : ''}${cliente.cidade ? `, ${cliente.cidade}/${cliente.estado || ''}` : ''}`.trim();
      } else {
        // Limpar campos se nenhum cliente selecionado
        document.getElementById('telefone').value = '';
        document.getElementById('email').value = '';
        document.getElementById('endereco').value = '';
      }
    }

    // Função para carregar pedidos do banco de dados
    async function carregarPedidos() {
      try {
        console.log('Carregando pedidos...');
        const response = await fetch('/api/pedidos', { credentials: 'include' });
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
        }
        pedidos = await response.json();
        console.log('Pedidos carregados:', pedidos);
        renderTabelaPedidos();
      } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        alert('Erro ao carregar pedidos do banco de dados: ' + error.message);
        // Inicializar array vazio para evitar erros
        pedidos = [];
        renderTabelaPedidos();
      }
    }

    // Renderizar tabela de pedidos
    function renderTabelaPedidos(filtro = "") {
      const tbody = document.getElementById('pedidos-tbody');
      tbody.innerHTML = '';
      let filtrados = pedidos.filter(p => {
        const texto = `${p.id} ${p.nome_cliente || p.cliente_id || ''} ${p.data_pedido || ''} ${p.status || ''} ${p.valor_total || ''}`.toLowerCase();
        return texto.includes(filtro.toLowerCase());
      });
      filtrados.forEach(pedido => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${pedido.id}</td>
          <td>${pedido.nome_cliente || pedido.cliente_id || 'Cliente não identificado'}</td>
          <td>${formatarDataHora(pedido.data_pedido)}</td>
          <td><span style="color: ${pedido.status === 'Concluído' ? 'var(--success-color)' : pedido.status === 'Cancelado' ? 'var(--danger-color)' : '#f59e0b'}; font-weight: bold;">${pedido.status || ''}</span></td>
          <td>R$ ${(pedido.valor_total || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
          <td>R$ ${calcularLucroPedido(pedido).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="visualizarPedido('${pedido.id}')"><i class="fas fa-eye"></i></button>
            <button class="btn btn-success btn-sm" onclick="editarPedido('${pedido.id}')"><i class="fas fa-edit"></i></button>
            <button class="btn btn-danger btn-sm" onclick="removerPedido('${pedido.id}')"><i class="fas fa-trash"></i></button>
            ${pedido.status !== 'Concluído' && pedido.status !== 'Cancelado' ? `
              <button class="btn btn-sm btn-concluir" onclick="concluirPedido('${pedido.id}')">
                <i class="fas fa-check"></i>
              </button>
              <button class="btn btn-sm btn-cancelar" onclick="cancelarPedido('${pedido.id}')">
                <i class="fas fa-times"></i>
              </button>
            ` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Função para atualizar o array novoPedidoItens a partir do DOM
    function atualizarNovoPedidoItens() {
      novoPedidoItens = [];
      const itemRows = document.querySelectorAll('#itensContainer .item-row');
      itemRows.forEach(row => {
        const produtoSelect = row.querySelector('.produto-select');
        const quantidadeInput = row.querySelector('.quantidade-input');
        const precoInput = row.querySelector('.preco-input');
        const subtotalInput = row.querySelector('.subtotal-input');
        if (produtoSelect.value) {
          const produto = produtos.find(p => p.id == produtoSelect.value);
          novoPedidoItens.push({
            produto_id: produtoSelect.value,
            produto: produto ? produto.nome : '',
            quantidade: parseFloat(quantidadeInput.value) || 0,
            precoUnitario: parseFloat(precoInput.value) || 0,
            subtotal: parseFloat(subtotalInput.value) || 0,
            preco_custo: produto ? produto.preco_custo : 0
          });
        }
      });
    }

    // Função para salvar pedido (criar ou editar)
    async function salvarPedido() {
      atualizarNovoPedidoItens(); // <-- Garante que novoPedidoItens está atualizado
      const cliente_id = document.getElementById('cliente').value;
      const formaPagamento = document.getElementById('formaPagamento').value;
      const telefone = document.getElementById('telefone').value;
      const email = document.getElementById('email').value;
      const endereco = document.getElementById('endereco').value;
      const observacoes = document.getElementById('observacoes').value;
      
      if (!cliente_id) {
        alert('Selecione um cliente');
        return;
      }
      
      if (!formaPagamento) {
        alert('Selecione uma forma de pagamento');
        return;
      }
      
      if (novoPedidoItens.length === 0) {
        alert('Adicione pelo menos um item ao pedido');
        return;
      }
      
      const data_pedido = new Date().toISOString().split('T')[0];
      const status = 'Em Processamento';
      const valor_total = novoPedidoItens.reduce((sum, item) => sum + item.subtotal, 0);
      
      const editandoId = document.getElementById('salvarPedido').getAttribute('data-editando');
      
      try {
        let response;
        const pedidoData = {
          cliente_id,
          data_pedido,
          status,
          valor_total,
          observacoes: `${observacoes}\n\nInformações adicionais:\nTelefone: ${telefone}\nEmail: ${email}\nEndereço: ${endereco}\nForma de Pagamento: ${formaPagamento}`
        };
        
        if (editandoId) {
          response = await fetch(`/api/pedidos/${editandoId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(pedidoData)
          });
        } else {
          response = await fetch('/api/pedidos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(pedidoData)
          });
        }
        
        if (!response.ok) throw new Error('Erro ao salvar pedido');
        await carregarPedidos();
        fecharModalNovoPedido();
        alert('Pedido salvo com sucesso!');
      } catch (error) {
        alert('Erro ao salvar pedido');
        console.error(error);
      }
    }

    // Função para remover pedido
    async function removerPedido(pedidoId) {
      if (!confirm('Tem certeza que deseja remover este pedido?')) return;
      try {
        const response = await fetch(`/api/pedidos/${pedidoId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Erro ao remover pedido');
        await carregarPedidos();
        alert('Pedido removido com sucesso!');
      } catch (error) {
        alert('Erro ao remover pedido');
        console.error(error);
      }
    }

    // Função para concluir pedido
    async function concluirPedido(pedidoId) {
      if (!confirm('Tem certeza que deseja concluir este pedido?')) return;
      
      try {
        console.log('Iniciando conclusão do pedido:', pedidoId);
        
        const pedido = pedidos.find(p => p.id == pedidoId);
        if (!pedido) {
          alert('Pedido não encontrado!');
          return;
        }

        console.log('Pedido encontrado:', pedido);
        console.log('Status atual:', pedido.status);

        const pedidoData = {
          cliente_id: pedido.cliente_id,
          data_pedido: pedido.data_pedido,
          status: 'Concluído',
          valor_total: pedido.valor_total,
          observacoes: pedido.observacoes
        };

        console.log('Dados para atualização:', pedidoData);

        const response = await fetch(`/api/pedidos/${pedidoId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(pedidoData)
        });

        console.log('Resposta do servidor:', response.status, response.statusText);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Erro ao concluir pedido: ${errorData.error || response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Resultado da atualização:', result);
        
        await carregarPedidos();
        alert('Pedido concluído com sucesso!');
      } catch (error) {
        console.error('Erro ao concluir pedido:', error);
        alert('Erro ao concluir pedido: ' + error.message);
      }
    }

    // Função para cancelar pedido
    async function cancelarPedido(pedidoId) {
      if (!confirm('Tem certeza que deseja cancelar este pedido?')) return;
      try {
        const pedido = pedidos.find(p => p.id == pedidoId);
        if (!pedido) {
          alert('Pedido não encontrado!');
          return;
        }

        const response = await fetch(`/api/pedidos/${pedidoId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            cliente_id: pedido.cliente_id,
            data_pedido: pedido.data_pedido,
            status: 'Cancelado',
            valor_total: pedido.valor_total,
            observacoes: pedido.observacoes,
            itens: pedido.itens
          })
        });

        if (!response.ok) throw new Error('Erro ao cancelar pedido');
        
        await carregarPedidos();
        alert('Pedido cancelado com sucesso!');
      } catch (error) {
        console.error('Erro ao cancelar pedido:', error);
        alert('Erro ao cancelar pedido: ' + error.message);
      }
    }

    // Função para editar pedido (preencher modal)
    async function editarPedido(pedidoId) {
      const pedido = pedidos.find(p => p.id == pedidoId);
      if (!pedido) return;
      
      // Carregar clientes se ainda não foram carregados
      if (clientes.length === 0) {
        await carregarClientes();
      }
      
      abrirModalNovoPedido();
      document.getElementById('cliente').value = pedido.cliente_id || '';
      document.getElementById('observacoes').value = pedido.observacoes || '';
      document.getElementById('salvarPedido').setAttribute('data-editando', pedidoId);
      
      // Preencher informações do cliente se disponível
      preencherInfoCliente();
    }

    // Função para visualizar pedido
    function visualizarPedido(pedidoId) {
      const pedido = pedidos.find(p => p.id == pedidoId);
      if (!pedido) {
        alert('Pedido não encontrado!');
        return;
      }

      // Extrair informações adicionais das observações
      const observacoes = pedido.observacoes || '';
      const telefone = extrairInfo(observacoes, 'Telefone:') || 'Não informado';
      const email = extrairInfo(observacoes, 'Email:') || 'Não informado';
      const endereco = extrairInfo(observacoes, 'Endereço:') || 'Não informado';
      const formaPagamento = extrairInfo(observacoes, 'Forma de Pagamento:') || 'Não informado';

      // Função auxiliar para extrair informações
      function extrairInfo(texto, chave) {
        const regex = new RegExp(`${chave}\\s*([^\\n]+)`, 'i');
        const match = texto.match(regex);
        return match ? match[1].trim() : null;
      }

      // Determinar classe do status
      let statusClass = 'status-processamento';
      if (pedido.status === 'Concluído') statusClass = 'status-concluido';
      else if (pedido.status === 'Cancelado') statusClass = 'status-cancelado';

      // Criar HTML do modal
      const html = `
        <div class="pedido-info">
          <div class="pedido-header">
            <div class="pedido-numero">Pedido #${pedido.id}</div>
            <div class="pedido-status ${statusClass}">${pedido.status || 'Em Processamento'}</div>
          </div>
          
          <div class="info-grid">
            <div class="info-section">
              <h4><i class="fas fa-user"></i> Informações do Cliente</h4>
              <div class="info-item">
                <span class="info-label">Cliente:</span>
                <span class="info-value">${pedido.nome_cliente || pedido.cliente_id || 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Telefone:</span>
                <span class="info-value">${telefone}</span>
              </div>
              <div class="info-item">
                <span class="info-label">E-mail:</span>
                <span class="info-value">${email}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Endereço:</span>
                <span class="info-value">${endereco}</span>
              </div>
            </div>
            
            <div class="info-section">
              <h4><i class="fas fa-credit-card"></i> Informações do Pedido</h4>
              <div class="info-item">
                <span class="info-label">Data:</span>
                <span class="info-value">${pedido.data_pedido || 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Forma de Pagamento:</span>
                <span class="info-value">${formaPagamento}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Status:</span>
                <span class="info-value">${pedido.status || 'Em Processamento'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Valor Total:</span>
                <span class="info-value">R$ ${(pedido.valor_total || 0).toFixed(2).replace('.', ',')}</span>
              </div>
            </div>
          </div>
          
          <div class="itens-table">
            <table>
              <thead>
                <tr>
                  <th>Produto</th>
                  <th>Quantidade</th>
                  <th>Preço Unit.</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                ${pedido.itens ? pedido.itens.map(item => `
                  <tr>
                    <td>${item.produto || 'N/A'}</td>
                    <td style="text-align: center;">${item.quantidade || 0}</td>
                    <td style="text-align: right;">R$ ${(item.precoUnitario || 0).toFixed(2).replace('.', ',')}
                    <td style="text-align: right;">R$ ${(item.subtotal || 0).toFixed(2).replace('.', ',')}</td>
                  </tr>
                `).join('') : '<tr><td colspan="4" style="text-align: center;">Nenhum item encontrado</td></tr>'}
              </tbody>
            </table>
          </div>
          
          <div class="total-section-visualizacao">
            Total: R$ ${(pedido.valor_total || 0).toFixed(2).replace('.', ',')}
          </div>
          
          ${pedido.observacoes ? `
            <div class="observacoes-section">
              <h4><i class="fas fa-sticky-note"></i> Observações</h4>
              <div class="observacoes-texto">${pedido.observacoes}</div>
            </div>
          ` : ''}
        </div>
      `;

      // Preencher modal
      document.getElementById('pedidoDetalhes').innerHTML = html;
      
      // Configurar botões
      document.getElementById('concluirPedido').onclick = () => alterarStatusPedido(pedidoId, 'Concluído');
      document.getElementById('cancelarPedidoBtn').onclick = () => alterarStatusPedido(pedidoId, 'Cancelado');
      document.getElementById('gerarPDFPedidoBtn').onclick = () => gerarPDFPedido(pedidoId);
      
      // Abrir modal
      document.getElementById('visualizarPedidoModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    // Função para alterar status do pedido
    async function alterarStatusPedido(pedidoId, novoStatus) {
      if (!confirm(`Tem certeza que deseja ${novoStatus === 'Concluído' ? 'concluir' : 'cancelar'} este pedido?`)) {
        return;
      }

      try {
        console.log('Iniciando alteração de status do pedido:', pedidoId, 'para:', novoStatus);
        
        const pedido = pedidos.find(p => p.id == pedidoId);
        if (!pedido) {
          alert('Pedido não encontrado!');
          return;
        }

        console.log('Pedido encontrado:', pedido);
        console.log('Status atual:', pedido.status);

        const pedidoData = {
          cliente_id: pedido.cliente_id,
          data_pedido: pedido.data_pedido,
          status: novoStatus,
          valor_total: pedido.valor_total,
          observacoes: pedido.observacoes
        };

        console.log('Dados para atualização:', pedidoData);

        const response = await fetch(`/api/pedidos/${pedidoId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(pedidoData)
        });

        console.log('Resposta do servidor:', response.status, response.statusText);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Erro ao alterar status do pedido: ${errorData.error || response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Resultado da atualização:', result);
        
        await carregarPedidos();
        fecharModalVisualizarPedido();
        alert(`Pedido ${novoStatus === 'Concluído' ? 'concluído' : 'cancelado'} com sucesso!`);
      } catch (error) {
        console.error('Erro ao alterar status:', error);
        alert('Erro ao alterar status do pedido: ' + error.message);
      }
    }

    // Função para fechar modal de visualização
    function fecharModalVisualizarPedido() {
      document.getElementById('visualizarPedidoModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Função para abrir modal de novo pedido
    function abrirModalNovoPedido() {
      document.getElementById('novoPedidoModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Limpar formulário
      document.getElementById('novoPedidoForm').reset();
      document.getElementById('itensContainer').innerHTML = '';
      novoPedidoItens = [];
      itemCounter = 0;
      atualizarTotalPedido();
      
      // Remover atributo de edição se existir
      document.getElementById('salvarPedido').removeAttribute('data-editando');
    }

    // Função para fechar modal de novo pedido
    function fecharModalNovoPedido() {
      document.getElementById('novoPedidoModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Função para adicionar item ao pedido
    function adicionarItem() {
      const itemId = `item-${itemCounter++}`;
      const itemHTML = `
        <div class="item-row" id="${itemId}">
          <div class="form-group">
            <select class="produto-select" onchange="selecionarProduto(this, '${itemId}')">
              <option value="">Selecione um produto</option>
              ${produtos.map(produto => 
                `<option value="${produto.id}" data-preco="${produto.preco_venda || 0}">${produto.nome}</option>`
              ).join('')}
            </select>
          </div>
          <div class="form-group">
            <input type="number" class="quantidade-input" value="1" min="1" onchange="calcularSubtotal('${itemId}')" onkeyup="calcularSubtotal('${itemId}')">
          </div>
          <div class="form-group">
            <input type="number" class="preco-input" step="0.01" readonly>
          </div>
          <div class="form-group">
            <input type="number" class="subtotal-input" step="0.01" readonly>
          </div>
          <button type="button" class="remove-item" onclick="removerItem('${itemId}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      document.getElementById('itensContainer').insertAdjacentHTML('beforeend', itemHTML);
      atualizarNovoPedidoItens();
    }

    // Função para selecionar produto
    function selecionarProduto(select, itemId) {
      const produtoId = select.value;
      const produto = produtos.find(p => p.id == produtoId);
      if (produto) {
        const itemRow = document.getElementById(itemId);
        const precoInput = itemRow.querySelector('.preco-input');
        precoInput.value = produto.preco_venda || 0;
        calcularSubtotal(itemId);
      }
      atualizarNovoPedidoItens();
    }

    // Função para calcular subtotal
    function calcularSubtotal(itemId) {
      const itemRow = document.getElementById(itemId);
      const quantidade = parseFloat(itemRow.querySelector('.quantidade-input').value) || 0;
      const preco = parseFloat(itemRow.querySelector('.preco-input').value) || 0;
      const subtotal = quantidade * preco;
      itemRow.querySelector('.subtotal-input').value = subtotal.toFixed(2);
      atualizarTotalPedido();
      atualizarNovoPedidoItens();
    }

    // Função para remover item
    function removerItem(itemId) {
      document.getElementById(itemId).remove();
      atualizarTotalPedido();
      atualizarNovoPedidoItens();
    }

    // Função para atualizar total do pedido
    function atualizarTotalPedido() {
      const subtotais = Array.from(document.querySelectorAll('.subtotal-input'))
        .map(input => parseFloat(input.value) || 0);
      
      const total = subtotais.reduce((sum, subtotal) => sum + subtotal, 0);
      document.getElementById('totalPedido').textContent = total.toFixed(2).replace('.', ',');
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Verificar se está logado
      if (sessionStorage.getItem('loggedIn') !== 'true') {
        window.location.href = 'index.html';
      }
      // Exibir nome do usuário
      const username = sessionStorage.getItem('username') || 'Usuário';
      document.getElementById('userDisplay').textContent = username;

      // Event listeners do modal
      document.getElementById('btn-novo-pedido').addEventListener('click', abrirModalNovoPedido);
      document.getElementById('closeNovoPedido').addEventListener('click', fecharModalNovoPedido);
      document.getElementById('cancelarPedido').addEventListener('click', fecharModalNovoPedido);
      document.getElementById('addItemBtn').addEventListener('click', adicionarItem);
      document.getElementById('salvarPedido').addEventListener('click', salvarPedido);

      // Event listeners do modal de visualização
      document.getElementById('closeVisualizarPedido').addEventListener('click', fecharModalVisualizarPedido);
      document.getElementById('fecharVisualizarPedido').addEventListener('click', fecharModalVisualizarPedido);

      // Event listener para preencher informações do cliente
      document.getElementById('cliente').addEventListener('change', preencherInfoCliente);

      // Fechar modal ao clicar fora
      window.addEventListener('click', function(event) {
        const modal = document.getElementById('novoPedidoModal');
        if (event.target === modal) {
          fecharModalNovoPedido();
        }
        const modalVisualizar = document.getElementById('visualizarPedidoModal');
        if (event.target === modalVisualizar) {
          fecharModalVisualizarPedido();
        }
      });

      // Fechar modal com ESC
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          fecharModalNovoPedido();
          fecharModalVisualizarPedido();
        }
      });

      // Busca em tempo real
      document.getElementById('busca-pedido').addEventListener('input', function() {
        renderTabelaPedidos(this.value);
      });

      // Exportar PDF
      document.getElementById('btn-exportar-pdf').onclick = function() {
        console.log('Botão exportar PDF clicado');
        gerarPDFTodosPedidos();
      };
      
      // Exportar Excel
      document.getElementById('btn-exportar-excel').onclick = function() {
        gerarExcelTodosPedidos();
      };

      // Ao carregar a página, buscar dados do banco
      carregarPedidos();
      carregarClientes();
      carregarProdutos();
    });

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      sessionStorage.removeItem('loggedIn');
      sessionStorage.removeItem('username');
      window.location.href = 'index.html';
    }

    // Função para calcular o lucro de um pedido
    function calcularLucroPedido(pedido) {
      if (!pedido.itens || !Array.isArray(pedido.itens)) return 0;
      return pedido.itens.reduce((lucro, item) => {
        const venda = parseFloat(item.precoUnitario || item.preco_venda || 0);
        const custo = parseFloat(item.preco_custo || 0);
        const qtd = parseInt(item.quantidade || 0);
        return lucro + (venda - custo) * qtd;
      }, 0);
    }

    // Função para formatar valor em reais
    function formatarMoeda(valor) {
      return `R$ ${valor.toFixed(2).replace('.', ',')}`;
    }

    // Função para gerar PDF de todos os pedidos
    function gerarPDFTodosPedidos() {
      // Tabela de pedidos
      const tableData = pedidos.map(pedido => [
        pedido.id,
        limparCaracteres(pedido.nome_cliente || pedido.cliente_id || 'N/A'),
        pedido.data_pedido || 'N/A',
        limparCaracteres(pedido.status || 'N/A'),
        `R$ ${(pedido.valor_total || 0).toFixed(2).replace('.', ',')}`
      ]);

      // Rest of the function remains unchanged
      // ...
    }

    // Função para gerar PDF do pedido individual
    function gerarPDFPedido(pedidoId) {
      const pedido = pedidos.find(p => p.id === pedidoId);
      if (!pedido) {
        alert('Pedido não encontrado!');
        return;
      }

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Configurações de cores
        const primaryColor = [102, 126, 234];
        const secondaryColor = [118, 75, 162];
        const successColor = [40, 167, 69];
        const dangerColor = [220, 53, 69];

        // Função para limpar caracteres especiais
        function limparCaracteres(texto) {
          if (!texto) return '';
          return texto.toString()
            .replace(/[^\w\s\-.,()@]/g, '')
            .replace(/\s+/g, ' ')
            .trim();
        }

        // Inserir logo no lugar do texto
        carregarImagemBase64('https://i.imgur.com/2jT2EPD.png', function(logoBase64) {
          // Logo centralizada
          const logoWidth = 50;
          const logoHeight = 22;
          const logoX = (210 - logoWidth) / 2;
          const logoY = 8;
          doc.addImage(logoBase64, 'PNG', logoX, logoY, logoWidth, logoHeight);

          // Título do relatório
          doc.setTextColor(0, 0, 0);
          doc.setFontSize(16);
          doc.setFont('helvetica', 'bold');
          doc.text('PEDIDO DE VENDA', 105, 35, { align: 'center' });
          
          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.text(`Data: ${pedido.data_pedido || 'N/A'}`, 105, 42, { align: 'center' });

          // Informações do pedido
          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.text(`PEDIDO #${pedido.id}`, 20, 55);
          
          doc.setFontSize(12);
          doc.setFont('helvetica', 'normal');
          doc.text('Status:', 20, 65);
          
          // Status colorido
          if (pedido.status === 'Concluído') {
            doc.setTextColor(...successColor);
          } else if (pedido.status === 'Cancelado') {
            doc.setTextColor(...dangerColor);
          } else {
            doc.setTextColor(245, 158, 11); // Amarelo para em processamento
          }
          doc.setFont('helvetica', 'bold');
          doc.text(limparCaracteres(pedido.status || 'N/A'), 45, 65);
          
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'normal');

          // Informações do cliente
          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.text('INFORMACOES DO CLIENTE', 20, 85);
          
          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.text(`Cliente: ${limparCaracteres(pedido.nome_cliente || pedido.cliente_id || 'N/A')}`, 20, 95);
          doc.text(`Endereco: ${limparCaracteres(pedido.endereco || 'Nao informado')}`, 20, 102);
          doc.text(`Telefone: ${limparCaracteres(pedido.telefone || 'Nao informado')}`, 20, 109);
          doc.text(`E-mail: ${limparCaracteres(pedido.email || 'Nao informado')}`, 20, 116);
          doc.text(`Forma de Pagamento: ${limparCaracteres(pedido.formaPagamento || 'Nao informado')}`, 20, 123);

          // Itens do pedido
          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.text('ITENS DO PEDIDO', 20, 145);
          
          // Tabela de itens
          const tableData = pedido.itens ? pedido.itens.map(item => [
            limparCaracteres(item.produto || 'N/A'),
            item.quantidade || 0,
            `R$ ${(item.precoUnitario || 0).toFixed(2).replace('.', ',')}`,
            `R$ ${(item.subtotal || 0).toFixed(2).replace('.', ',')}`
          ]) : [];
          
          doc.autoTable({
            startY: 150,
            head: [['Produto', 'Qtd', 'Preco Unit.', 'Subtotal']],
            body: tableData,
            theme: 'grid',
            headStyles: {
              fillColor: primaryColor,
              textColor: [255, 255, 255],
              fontStyle: 'bold',
              fontSize: 10
            },
            styles: {
              fontSize: 9,
              cellPadding: 4,
              lineColor: [200, 200, 200],
              lineWidth: 0.1
            },
            columnStyles: {
              0: { cellWidth: 80 },
              1: { halign: 'center', cellWidth: 20 },
              2: { halign: 'right', cellWidth: 30 },
              3: { halign: 'right', cellWidth: 30 }
            },
            margin: { left: 20, right: 20 }
          });

          // Total
          const finalY = doc.lastAutoTable.finalY + 10;
          doc.setFontSize(12);
          doc.setFont('helvetica', 'bold');
          doc.text(`Valor Total: R$ ${(pedido.valor_total || 0).toFixed(2).replace('.', ',')}`, 150, finalY);

          // Observações
          if (pedido.observacoes) {
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('OBSERVACOES:', 20, finalY + 20);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const observacoes = doc.splitTextToSize(limparCaracteres(pedido.observacoes), 170);
            doc.text(observacoes, 20, finalY + 28);
          }

          // Rodapé
          const pageHeight = doc.internal.pageSize.height;
          doc.setFillColor(240, 240, 240);
          doc.rect(0, pageHeight - 30, 210, 30, 'F');
          doc.setTextColor(100, 100, 100);
          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.text('Este documento foi gerado automaticamente pelo J.P Sistemas Comercial', 105, pageHeight - 20, { align: 'center' });
          doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, pageHeight - 15, { align: 'center' });

          // Salvar PDF
          doc.save(`Pedido_${pedido.id}_${limparCaracteres(pedido.nome_cliente || pedido.cliente_id).replace(/\s+/g, '_')}.pdf`);
        });
      } catch (error) {
        console.error('Erro ao gerar PDF do pedido:', error);
        alert('Erro ao gerar PDF do pedido: ' + error.message);
      }
    }

    // Função para gerar Excel com todos os pedidos
    function gerarExcelTodosPedidos() {
      // Verificar se há pedidos para exportar
      if (!pedidos || pedidos.length === 0) {
        alert('Não há pedidos para exportar. Crie alguns pedidos primeiro.');
        return;
      }

      try {
        // Criar conteúdo CSV
        let csvContent = "ID,Cliente,Data,Status,Valor Total,Forma Pagamento,Telefone,Email\n";
        
        pedidos.forEach(pedido => {
          // Extrair informações adicionais das observações
          const observacoes = pedido.observacoes || '';
          const telefone = extrairInfo(observacoes, 'Telefone:') || 'Não informado';
          const email = extrairInfo(observacoes, 'Email:') || 'Não informado';
          const formaPagamento = extrairInfo(observacoes, 'Forma de Pagamento:') || 'Não informado';

          // Função auxiliar para extrair informações
          function extrairInfo(texto, chave) {
            const regex = new RegExp(`${chave}\\s*([^\\n]+)`, 'i');
            const match = texto.match(regex);
            return match ? match[1].trim() : null;
          }

          csvContent += `${pedido.id},"${pedido.nome_cliente || pedido.cliente_id || 'N/A'}","${pedido.data_pedido || 'N/A'}","${pedido.status || 'N/A'}","${pedido.valor_total || 0}","${formaPagamento}","${telefone}","${email}"\n`;
        });

        // Criar e baixar arquivo
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `Relatorio_Pedidos_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error('Erro ao gerar Excel:', error);
        alert('Erro ao gerar Excel: ' + error.message);
      }
    }

    // Função auxiliar para carregar imagem base64
    function carregarImagemBase64(url, callback) {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.height = this.naturalHeight;
        canvas.width = this.naturalWidth;
        ctx.drawImage(this, 0, 0);
        const dataURL = canvas.toDataURL('image/png');
        callback(dataURL);
      };
      img.onerror = function() {
        // Se não conseguir carregar a imagem, continua sem ela
        callback(null);
      };
      img.src = url;
    }

    function formatarDataHora(dataISO) {
      if (!dataISO) return '';
      const data = new Date(dataISO);
      if (isNaN(data.getTime())) return dataISO;
      return data.toLocaleString('pt-BR', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }
  </script>
</body>
</html> 