<!--
  RESPONSIVIDADE MOBILE:
  - Este arquivo já inclui <meta name="viewport"> e mobile.css para responsividade.
  - Use as classes .coluna-desnecessaria ou .hide-mobile em <th> ou <td> para esconder colunas no mobile.
  - Para navegação fixa no rodapé, utilize <nav class="mobile-nav">.
  - Mantenha sempre o mobile.css atualizado para melhor experiência mobile.
-->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pedidos e Vendas - J.P Sistemas Comercial</title>
  <link rel="icon" href="https://i.imgur.com/QgVsPmF.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="mobile.css">
  <style>
    /* Estilos específicos para pedidos */
    .search-box {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 400px;
      background: var(--white);
      border-radius: var(--border-radius-lg);
      border: 2px solid var(--gray-200);
      box-shadow: var(--shadow);
      padding: 0.75rem 1rem;
      margin: 0 auto 1.5rem auto;
      transition: all 0.3s ease;
    }
    
    .search-box:focus-within {
      border-color: var(--primary);
      box-shadow: var(--shadow-lg);
    }
    
    .search-icon {
      font-size: 1.1rem;
      color: var(--primary);
      margin-right: 0.75rem;
      opacity: 0.8;
    }
    
    #busca-pedido {
      border: none;
      background: transparent;
      outline: none;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      width: 100%;
      color: var(--gray-900);
    }
    
    #busca-pedido::placeholder {
      color: var(--gray-400);
      opacity: 1;
    }
    
    .table-responsive { 
      max-height: 420px; 
      overflow-y: auto; 
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--gray-200);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
    }
    
    .table th, .table td { 
      padding: 0.75rem 1rem; 
      text-align: left; 
      border-bottom: 1px solid var(--gray-200); 
      vertical-align: middle; 
    }
    
    .table th { 
      background: var(--terciary); 
      color: var(--white); 
      font-weight: 600; 
      white-space: nowrap; 
    }
    
    .table tbody tr:hover { 
      background-color: var(--gray-100); 
    }
    
    .table tbody tr:nth-child(even) {
      background-color: var(--gray-50);
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: var(--white);
      margin: 2% auto;
      padding: 0;
      border-radius: var(--border-radius-xl);
      width: 98%;
      max-width: 1200px;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      animation: slideIn 0.3s ease;
      position: relative;
    }

    .modal-header {
      background: var(--terciary);
      color: var(--white);
      padding: 1.25rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .close {
      color: var(--white);
      font-size: 1.75rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
    }

    .close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.25rem 1.5rem;
      background: var(--gray-50);
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
    }

    .form-section {
      margin-bottom: 1.5rem;
    }

    .form-section h4 {
      color: var(--terciary);
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.375rem;
      font-size: 0.875rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.75rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: var(--white);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.1);
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .items-section {
      background: var(--gray-50);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--gray-200);
    }

    .item-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
      padding: 0.75rem;
      background: var(--white);
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-200);
    }

    .item-row:last-child {
      margin-bottom: 0;
    }

    .remove-item {
      background: var(--red-500);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 2rem;
      height: 2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .remove-item:hover {
      background: var(--red-600);
      transform: scale(1.1);
    }

    .add-item-btn {
      background: var(--primary);
      color: var(--white);
      border: none;
      padding: 0.75rem 1rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      width: 100%;
      justify-content: center;
    }

    .add-item-btn:hover {
      background: var(--secondary);
      transform: translateY(-1px);
    }

    .total-section {
      background: var(--terciary);
      color: var(--white);
      padding: 1rem 1.25rem;
      border-radius: var(--border-radius);
      text-align: right;
      font-size: 1.25rem;
      font-weight: bold;
      margin-top: 1rem;
    }

    .total-section h3 {
      margin: 0;
      color: var(--white);
    }

    /* Estilos para visualização de pedido */
    .pedido-info {
      background: var(--white);
      border-radius: var(--border-radius-lg);
      padding: 1.5rem;
      border: 1px solid var(--gray-200);
    }

    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--gray-200);
    }

    .pedido-numero {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--terciary);
    }

    .pedido-status {
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      font-weight: 600;
      font-size: 0.875rem;
    }

    .status-concluido {
      background: var(--green-500);
      color: var(--white);
    }

    .status-cancelado {
      background: var(--red-500);
      color: var(--white);
    }

    .status-processamento {
      background: var(--yellow-500);
      color: var(--white);
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .info-section {
      background: var(--gray-50);
      padding: 1rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-200);
    }

    .info-section h4 {
      color: var(--terciary);
      margin-bottom: 1rem;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .info-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .info-label {
      font-weight: 600;
      color: var(--gray-700);
    }

    .info-value {
      color: var(--gray-900);
    }

    .itens-table {
      margin-bottom: 1.5rem;
    }

    .itens-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .itens-table th {
      background: var(--terciary);
      color: var(--white);
      font-weight: 600;
      padding: 0.75rem;
    }

    .itens-table td {
      padding: 0.625rem 0.75rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .total-section-visualizacao {
      background: var(--terciary);
      color: var(--white);
      padding: 1rem 1.25rem;
      border-radius: var(--border-radius);
      text-align: right;
      font-size: 1.25rem;
      font-weight: bold;
    }

    .observacoes-section {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 1rem;
      border: 1px solid var(--gray-200);
      margin-top: 1.5rem;
    }

    .observacoes-section h4 {
      color: var(--terciary);
      margin-bottom: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .observacoes-texto {
      background: var(--gray-50);
      padding: 0.75rem;
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary);
      font-style: italic;
      color: var(--gray-700);
    }

    /* Estilos específicos para botões de ação de pedidos */
    .btn-concluir {
      background: var(--green-500) !important;
      color: var(--white) !important;
      border: none !important;
    }
    
    .btn-concluir:hover {
      background: var(--green-600) !important;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-cancelar {
      background: var(--red-500) !important;
      color: var(--white) !important;
      border: none !important;
    }
    
    .btn-cancelar:hover {
      background: var(--red-600) !important;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-print {
      background: var(--yellow-500) !important;
      color: var(--white) !important;
      border: none !important;
    }
    
    .btn-print:hover {
      background: var(--yellow-400) !important;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 99%;
        margin: 1% auto;
        max-width: 99vw;
        max-height: 98vh;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .item-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .item-row > * {
        width: 100%;
      }

      .info-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .modal-footer {
        flex-direction: column;
        gap: 0.5rem;
      }

      .modal-footer .btn {
        width: 100%;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { 
        transform: translateY(-50px);
        opacity: 0;
      }
      to { 
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Header -->
    <header>
      <div class="header-content">
        <div class="logo">
          <img src="https://i.imgur.com/2jT2EPD.png" alt="J.P Sistemas" />
        </div>
        <div class="user-info">
          <span>Bem-vindo, <span id="userDisplay">Usuário</span>!</span>
          <a href="#" onclick="logout()" class="btn btn-secondary">
            <i class="fas fa-sign-out-alt"></i> Sair
          </a>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main>
      <div class="container">
        <!-- Dashboard -->
        <div class="dashboard">
          <div class="dashboard-header">
            <h1 class="dashboard-title">Pedidos e Vendas</h1>
            <p class="dashboard-subtitle">Gerencie todos os pedidos e vendas do sistema</p>
          </div>

          <!-- Cards de Estatísticas -->
          <div class="cards">
            <div class="card">
              <div class="card-header">
                <div class="card-icon">
                  <i class="fas fa-shopping-cart" style="color: var(--primary);"></i>
                </div>
                <div class="card-title">Total de Pedidos</div>
              </div>
              <div class="card-value" id="totalPedidos">0</div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <div class="card-icon">
                  <i class="fas fa-check-circle" style="color: var(--green-500);"></i>
                </div>
                <div class="card-title">Pedidos Concluídos</div>
              </div>
              <div class="card-value" id="pedidosConcluidos">0</div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <div class="card-icon">
                  <i class="fas fa-clock" style="color: var(--yellow-500);"></i>
                </div>
                <div class="card-title">Em Processamento</div>
              </div>
              <div class="card-value" id="pedidosProcessamento">0</div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <div class="card-icon">
                  <i class="fas fa-dollar-sign" style="color: var(--terciary);"></i>
                </div>
                <div class="card-title">Valor Total</div>
              </div>
              <div class="card-value" id="valorTotal">R$ 0,00</div>
            </div>
          </div>

          <!-- Seção de Pedidos -->
          <div class="section">
            <div class="section-header">
              <h2 class="section-title">Lista de Pedidos</h2>
              <div class="btn-group">
                <button class="btn btn-primary" onclick="abrirModalNovoPedido()">
                  <i class="fas fa-plus"></i> Novo Pedido
                </button>
                <button class="btn btn-secondary" onclick="gerarPDFTodosPedidos()">
                  <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
                <button class="btn btn-secondary" onclick="gerarExcelTodosPedidos()">
                  <i class="fas fa-file-excel"></i> Exportar Excel
                </button>
              </div>
            </div>

            <!-- Busca -->
            <div class="search-box">
              <i class="fas fa-search search-icon"></i>
              <input type="text" id="busca-pedido" placeholder="Buscar pedidos por ID, cliente, data, status..." onkeyup="filtrarPedidos()">
            </div>

            <!-- Tabela de Pedidos -->
            <div class="table-container">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Cliente</th>
                      <th>Data</th>
                      <th>Status</th>
                      <th>Valor Total</th>
                      <th>Lucro</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody id="pedidos-tbody">
                    <!-- Pedidos serão carregados aqui -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer>
      <div class="container">
        <p class="text-center">© 2024 J.P Sistemas Comercial. Todos os direitos reservados.</p>
      </div>
    </footer>
  </div>

  <!-- Modal para Novo Pedido -->
  <div id="novoPedidoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Novo Pedido</h3>
        <span class="close" id="closeNovoPedido">&times;</span>
      </div>
      <div class="modal-body">
        <form id="novoPedidoForm">
          <!-- Informações do Cliente -->
          <div class="form-section">
            <h4>Informacoes do Cliente</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="tipoCliente">Tipo de Cliente *</label>
                <select id="tipoCliente" required onchange="toggleTipoCliente()">
                  <option value="">Selecione</option>
                  <option value="existente">Cliente Existente</option>
                  <option value="novo">Novo Cliente</option>
                </select>
              </div>
              <div class="form-group">
                <label for="formaPagamento">Forma de Pagamento *</label>
                <select id="formaPagamento" required>
                  <option value="">Selecione</option>
                  <option value="Cartao de Credito">Cartao de Credito</option>
                  <option value="Cartao de Debito">Cartao de Debito</option>
                  <option value="PIX">PIX</option>
                  <option value="Boleto Bancario">Boleto Bancario</option>
                  <option value="Dinheiro">Dinheiro</option>
                  <option value="Transferencia">Transferencia</option>
                </select>
              </div>
            </div>
            <!-- Campos para cliente existente -->
            <div id="clienteExistenteSection" style="display: none;">
              <div class="form-row">
                <div class="form-group full-width">
                  <label for="cliente">Selecionar Cliente *</label>
                  <select id="cliente">
                    <option value="">Carregando clientes...</option>
                  </select>
                </div>
              </div>
            </div>
            <!-- Campos para novo cliente -->
            <div id="novoClienteSection" style="display: none;">
              <div class="form-row">
                <div class="form-group">
                  <label for="nomeCliente">Nome/Razão Social *</label>
                  <input type="text" id="nomeCliente" placeholder="Nome completo ou razão social">
                </div>
                <div class="form-group">
                  <label for="cpfCnpj">CPF/CNPJ</label>
                  <input type="text" id="cpfCnpj" placeholder="000.000.000-00 ou 00.000.000/0000-00">
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="telefone">Telefone</label>
                <input type="tel" id="telefone" placeholder="(11) 99999-9999">
              </div>
              <div class="form-group">
                <label for="email">E-mail</label>
                <input type="email" id="email" placeholder="cliente@empresa.com">
              </div>
            </div>
            <div class="form-group full-width">
              <label for="endereco">Endereco</label>
              <input type="text" id="endereco" placeholder="Rua, numero, bairro, cidade/estado">
            </div>
          </div>
          <!-- Itens do Pedido -->
          <div class="form-section">
            <h4>Itens do Pedido</h4>
            <div class="items-section">
              <!-- Cabeçalho dos campos dos itens -->
              <div class="item-row" style="background:transparent; border:none; margin-bottom:0; font-weight:600;">
                <div style="padding-left:2px;">Descrição</div>
                <div>Quantidade</div>
                <div>Valor</div>
                <div>Subtotal</div>
                <div></div>
              </div>
              <div id="itensContainer">
                <!-- Itens serão adicionados aqui dinamicamente -->
              </div>
              <button type="button" class="add-item-btn" id="addItemBtn">
                <i class="fas fa-plus"></i> Adicionar Item
              </button>
            </div>
            <div class="total-section">
              <h3>Total: R$ <span id="totalPedido">0,00</span></h3>
            </div>
          </div>
          <!-- Observacoes -->
          <div class="form-section">
            <h4>Observacoes</h4>
            <div class="form-group full-width">
              <textarea id="observacoes" rows="3" placeholder="Observacoes sobre o pedido, instrucoes de entrega, etc."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="salvarPedido">
          <i class="fas fa-save"></i> Salvar Pedido
        </button>
        <button type="button" class="btn btn-danger" id="cancelarPedido">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>
  <!-- Modal de Visualização do Pedido -->
  <div id="visualizarPedidoModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
      <div class="modal-header">
        <h3><i class="fas fa-eye"></i> Visualizar Pedido</h3>
        <span class="close" id="closeVisualizarPedido">&times;</span>
      </div>
      <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
        <div id="pedidoDetalhes">
          <!-- Conteúdo dinâmico do pedido -->
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; padding: 16px 24px 16px 24px; background: #f8fafc; border-top: 1px solid #e5e7eb;">
        <button type="button" class="btn btn-success" id="concluirPedido">
          <i class="fas fa-check"></i> Concluir Pedido
        </button>
        <button type="button" class="btn btn-warning" id="cancelarPedidoBtn">
          <i class="fas fa-ban"></i> Cancelar Pedido
        </button>
        <button type="button" class="btn btn-primary" id="gerarPDFPedidoBtn">
          <i class="fas fa-file-pdf"></i> Gerar PDF
        </button>
        <button type="button" class="btn btn-secondary" id="fecharVisualizarPedido">
          <i class="fas fa-times"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts JavaScript -->
  <script>
    // Variáveis globais
    let pedidos = [];
    let clientes = [];
    let produtos = [];
    let pedidoAtual = null;
    let editandoPedido = false;

    // Elementos DOM
    const pedidosTable = document.getElementById('pedidosTable');
    const pedidosTableBody = document.getElementById('pedidos-tbody');
    const novoPedidoModal = document.getElementById('novoPedidoModal');
    const visualizarPedidoModal = document.getElementById('visualizarPedidoModal');
    const novoPedidoForm = document.getElementById('novoPedidoForm');
    const visualizarPedidoForm = document.getElementById('visualizarPedidoForm');
    const closeNovoPedido = document.getElementById('closeNovoPedido');
    const closeVisualizarPedido = document.getElementById('closeVisualizarPedido');
    const searchInput = document.getElementById('busca-pedido');
    const statusFilter = document.getElementById('statusFilter');
    const dataInicioFilter = document.getElementById('dataInicioFilter');
    const dataFimFilter = document.getElementById('dataFimFilter');

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      carregarDados();
      setupEventListeners();
      setupFormValidation();
    });

    // Carregar dados iniciais
    async function carregarDados() {
      try {
        const [pedidosResponse, clientesResponse, produtosResponse] = await Promise.all([
          fetch('/api/pedidos'),
          fetch('/api/clientes'),
          fetch('/api/produtos')
        ]);

        if (pedidosResponse.ok) {
          pedidos = await pedidosResponse.json();
          atualizarTabelaPedidos();
        }

        if (clientesResponse.ok) {
          clientes = await clientesResponse.json();
          preencherSelectClientes();
        }

        if (produtosResponse.ok) {
          produtos = await produtosResponse.json();
          preencherSelectProdutos();
        }
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        mostrarNotificacao('Erro ao carregar dados', 'error');
      }
    }

    // Configurar event listeners
    function setupEventListeners() {
      // Verificar se os elementos existem antes de adicionar listeners
      if (closeNovoPedido) {
        closeNovoPedido.addEventListener('click', () => {
          novoPedidoModal.style.display = 'none';
          limparFormulario();
        });
      }

      if (closeVisualizarPedido) {
        closeVisualizarPedido.addEventListener('click', () => {
          visualizarPedidoModal.style.display = 'none';
        });
      }

      // Fechar modal ao clicar fora
      window.addEventListener('click', (event) => {
        if (event.target === novoPedidoModal) {
          novoPedidoModal.style.display = 'none';
          limparFormulario();
        }
        if (event.target === visualizarPedidoModal) {
          visualizarPedidoModal.style.display = 'none';
        }
      });

      // Busca e filtros
      if (searchInput) {
        searchInput.addEventListener('input', filtrarPedidos);
      }
      if (statusFilter) {
        statusFilter.addEventListener('change', filtrarPedidos);
      }
      if (dataInicioFilter) {
        dataInicioFilter.addEventListener('change', filtrarPedidos);
      }
      if (dataFimFilter) {
        dataFimFilter.addEventListener('change', filtrarPedidos);
      }

      // Formulário novo pedido
      if (novoPedidoForm) {
        novoPedidoForm.addEventListener('submit', handleNovoPedido);
      }
      if (visualizarPedidoForm) {
        visualizarPedidoForm.addEventListener('submit', handleEditarPedido);
      }

      // Adicionar item ao pedido
      const adicionarItemBtn = document.getElementById('addItemBtn');
      if (adicionarItemBtn) {
        adicionarItemBtn.addEventListener('click', adicionarItemAoPedido);
      }

      // Seleção de cliente
      const tipoCliente = document.getElementById('tipoCliente');
      if (tipoCliente) {
        tipoCliente.addEventListener('change', handleTipoClienteChange);
      }
      
      const clienteSelect = document.getElementById('cliente');
      if (clienteSelect) {
        clienteSelect.addEventListener('change', handleClienteSelect);
      }
      
      const novoClienteNome = document.getElementById('nomeCliente');
      if (novoClienteNome) {
        novoClienteNome.addEventListener('input', handleNovoClienteInput);
      }
    }

    // Configurar validação de formulário
    function setupFormValidation() {
      if (!novoPedidoForm) {
        console.warn('Elemento novoPedidoForm não encontrado');
        return;
      }
      
      const requiredFields = novoPedidoForm.querySelectorAll('[required]');
      requiredFields.forEach(field => {
        field.addEventListener('blur', validateField);
        field.addEventListener('input', clearFieldError);
      });
    }

    // Validação de campo
    function validateField(event) {
      const field = event.target;
      const value = field.value.trim();
      
      if (field.hasAttribute('required') && !value) {
        showFieldError(field, 'Este campo é obrigatório');
        return false;
      }

      if (field.type === 'email' && value && !isValidEmail(value)) {
        showFieldError(field, 'Email inválido');
        return false;
      }

      if (field.type === 'tel' && value && !isValidPhone(value)) {
        showFieldError(field, 'Telefone inválido');
        return false;
      }

      clearFieldError(field);
      return true;
    }

    // Mostrar erro de campo
    function showFieldError(field, message) {
      clearFieldError(field);
      field.classList.add('error');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'field-error';
      errorDiv.textContent = message;
      field.parentNode.appendChild(errorDiv);
    }

    // Limpar erro de campo
    function clearFieldError(field) {
      if (!field) return;
      
      field.classList.remove('error');
      const errorDiv = field.parentNode?.querySelector('.field-error');
      if (errorDiv) {
        errorDiv.remove();
      }
    }

    // Validar email
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Validar telefone
    function isValidPhone(phone) {
      const phoneRegex = /^[\d\s\-\(\)\+]+$/;
      return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
    }

    // Preencher select de clientes
    function preencherSelectClientes() {
      const clienteSelect = document.getElementById('cliente');
      if (!clienteSelect) {
        console.warn('Elemento cliente não encontrado');
        return;
      }
      
      clienteSelect.innerHTML = '<option value="">Selecione um cliente</option>';
      
      clientes.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente.id;
        option.textContent = `${cliente.nome} - ${cliente.telefone}`;
        clienteSelect.appendChild(option);
      });
    }

    // Preencher select de produtos
    function preencherSelectProdutos() {
      // Os produtos são carregados mas não há um select fixo
      // Eles serão usados quando o usuário adicionar itens dinamicamente
      console.log(`${produtos.length} produtos carregados`);
    }

    // Atualizar tabela de pedidos
    function atualizarTabelaPedidos() {
      if (!pedidosTableBody) {
        console.warn('Elemento pedidosTableBody não encontrado');
        return;
      }
      
      pedidosTableBody.innerHTML = '';
      
      pedidos.forEach(pedido => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${pedido.id}</td>
          <td>${pedido.cliente.nome}</td>
          <td>${pedido.cliente.telefone}</td>
          <td>${pedido.itens.length} item(s)</td>
          <td>R$ ${pedido.valorTotal.toFixed(2)}</td>
          <td><span class="status-badge status-${pedido.status.toLowerCase()}">${pedido.status}</span></td>
          <td>${formatarData(pedido.dataCriacao)}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="visualizarPedido(${pedido.id})">
              <i class="fas fa-eye"></i> Ver
            </button>
            <button class="btn btn-sm btn-warning" onclick="editarPedido(${pedido.id})">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button class="btn btn-sm btn-danger" onclick="excluirPedido(${pedido.id})">
              <i class="fas fa-trash"></i> Excluir
            </button>
          </td>
        `;
        pedidosTableBody.appendChild(row);
      });
    }

    // Filtrar pedidos
    function filtrarPedidos() {
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      const statusFilterValue = statusFilter ? statusFilter.value : '';
      const dataInicio = dataInicioFilter ? dataInicioFilter.value : '';
      const dataFim = dataFimFilter ? dataFimFilter.value : '';

      const pedidosFiltrados = pedidos.filter(pedido => {
        const matchSearch = !searchTerm || 
          pedido.cliente.nome.toLowerCase().includes(searchTerm) ||
          pedido.cliente.telefone.includes(searchTerm) ||
          pedido.id.toString().includes(searchTerm);

        const matchStatus = !statusFilterValue || pedido.status === statusFilterValue;
        
        const matchData = (!dataInicio || pedido.dataCriacao >= dataInicio) &&
                         (!dataFim || pedido.dataCriacao <= dataFim);

        return matchSearch && matchStatus && matchData;
      });

      atualizarTabelaPedidosComFiltro(pedidosFiltrados);
    }

    // Atualizar tabela com filtro
    function atualizarTabelaPedidosComFiltro(pedidosFiltrados) {
      if (!pedidosTableBody) {
        console.warn('Elemento pedidosTableBody não encontrado');
        return;
      }
      
      pedidosTableBody.innerHTML = '';
      
      pedidosFiltrados.forEach(pedido => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${pedido.id}</td>
          <td>${pedido.cliente.nome}</td>
          <td>${pedido.cliente.telefone}</td>
          <td>${pedido.itens.length} item(s)</td>
          <td>R$ ${pedido.valorTotal.toFixed(2)}</td>
          <td><span class="status-badge status-${pedido.status.toLowerCase()}">${pedido.status}</span></td>
          <td>${formatarData(pedido.dataCriacao)}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="visualizarPedido(${pedido.id})">
              <i class="fas fa-eye"></i> Ver
            </button>
            <button class="btn btn-sm btn-warning" onclick="editarPedido(${pedido.id})">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button class="btn btn-sm btn-danger" onclick="excluirPedido(${pedido.id})">
              <i class="fas fa-trash"></i> Excluir
            </button>
          </td>
        `;
        pedidosTableBody.appendChild(row);
      });
    }

    // Abrir modal novo pedido
    function abrirNovoPedido() {
      novoPedidoModal.style.display = 'block';
      limparFormulario();
      editandoPedido = false;
      pedidoAtual = null;
    }

    // Função para abrir modal novo pedido (alias)
    function abrirModalNovoPedido() {
      abrirNovoPedido();
    }

    // Limpar formulário
    function limparFormulario() {
      if (novoPedidoForm) {
        novoPedidoForm.reset();
      }
      
      const itensContainer = document.getElementById('itensContainer');
      if (itensContainer) {
        itensContainer.innerHTML = '';
      }
      
      const totalElement = document.getElementById('totalPedido');
      if (totalElement) {
        totalElement.textContent = '0,00';
      }
      
      // Limpar erros
      if (novoPedidoForm) {
        const errorFields = novoPedidoForm.querySelectorAll('.error');
        errorFields.forEach(field => clearFieldError(field));
      }
    }

    // Handle tipo de cliente
    function handleTipoClienteChange() {
      const tipoCliente = document.getElementById('tipoCliente').value;
      const clienteExistenteSection = document.getElementById('clienteExistenteSection');
      const novoClienteSection = document.getElementById('novoClienteSection');

      if (tipoCliente === 'existente') {
        if (clienteExistenteSection) clienteExistenteSection.style.display = 'block';
        if (novoClienteSection) novoClienteSection.style.display = 'none';
      } else if (tipoCliente === 'novo') {
        if (clienteExistenteSection) clienteExistenteSection.style.display = 'none';
        if (novoClienteSection) novoClienteSection.style.display = 'block';
      } else {
        if (clienteExistenteSection) clienteExistenteSection.style.display = 'none';
        if (novoClienteSection) novoClienteSection.style.display = 'none';
      }
    }

    // Função para toggle tipo de cliente (alias)
    function toggleTipoCliente() {
      handleTipoClienteChange();
    }

    // Função para selecionar produto
    function selecionarProduto(select, itemId) {
      const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
      if (!itemRow) return;

      const produtoId = select.value;
      const precoInput = itemRow.querySelector('.produto-preco');
      const nomeInput = itemRow.querySelector('.produto-nome');

      if (produtoId) {
        const produto = produtos.find(p => p.id == produtoId);
        if (produto) {
          if (precoInput) precoInput.value = produto.preco.toFixed(2);
          if (nomeInput) nomeInput.value = produto.nome;
          calcularSubtotalItem(itemId);
        }
      } else {
        if (precoInput) precoInput.value = '';
        if (nomeInput) nomeInput.value = '';
        calcularSubtotalItem(itemId);
      }
    }

    // Função para calcular subtotal de um item específico
    function calcularSubtotalItem(itemId) {
      const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
      if (!itemRow) return;

      const quantidadeInput = itemRow.querySelector('.produto-quantidade');
      const precoInput = itemRow.querySelector('.produto-preco');
      const subtotalInput = itemRow.querySelector('.produto-subtotal');

      if (quantidadeInput && precoInput && subtotalInput) {
        const quantidade = parseFloat(quantidadeInput.value) || 0;
        const preco = parseFloat(precoInput.value) || 0;
        const subtotal = quantidade * preco;
        subtotalInput.value = subtotal.toFixed(2);
        calcularTotalPedido();
      }
    }

    // Handle seleção de cliente
    function handleClienteSelect() {
      const clienteId = document.getElementById('cliente').value;
      if (clienteId) {
        const cliente = clientes.find(c => c.id == clienteId);
        if (cliente) {
          const telefoneElement = document.getElementById('telefone');
          const emailElement = document.getElementById('email');
          const enderecoElement = document.getElementById('endereco');
          
          if (telefoneElement) telefoneElement.value = cliente.telefone;
          if (emailElement) emailElement.value = cliente.email || '';
          if (enderecoElement) enderecoElement.value = cliente.endereco || '';
        }
      }
    }

    // Handle input novo cliente
    function handleNovoClienteInput() {
      const nome = document.getElementById('novoClienteNome').value;
      if (nome.length >= 3) {
        // Aqui você pode implementar busca automática de clientes similares
      }
    }

    // Handle seleção de produto
    function handleProdutoSelect() {
      const produtoId = document.getElementById('produtoSelect').value;
      if (produtoId) {
        const produto = produtos.find(p => p.id == produtoId);
        if (produto) {
          document.getElementById('produtoPreco').value = produto.preco.toFixed(2);
          document.getElementById('produtoQuantidade').value = '1';
          calcularSubtotalItem();
        }
      }
    }

    // Handle input novo produto
    function handleNovoProdutoInput() {
      const nome = document.getElementById('novoProdutoNome').value;
      if (nome.length >= 3) {
        // Aqui você pode implementar busca automática de produtos similares
      }
    }

    // Calcular subtotal do item
    function calcularSubtotalItem() {
      const precoElement = document.getElementById('produtoPreco');
      const quantidadeElement = document.getElementById('produtoQuantidade');
      const subtotalElement = document.getElementById('produtoSubtotal');
      
      if (!precoElement || !quantidadeElement || !subtotalElement) {
        return;
      }
      
      const preco = parseFloat(precoElement.value) || 0;
      const quantidade = parseInt(quantidadeElement.value) || 0;
      const subtotal = preco * quantidade;
      subtotalElement.value = subtotal.toFixed(2);
    }

    // Adicionar item ao pedido
    function adicionarItemAoPedido() {
      // Criar uma nova linha de item dinamicamente
      const itensContainer = document.getElementById('itensContainer');
      if (!itensContainer) {
        console.warn('Container de itens não encontrado');
        return;
      }

      const itemId = Date.now();
      const produtosOptions = produtos && produtos.length > 0 
        ? produtos.map(produto => 
            `<option value="${produto.id || ''}">${produto.nome || 'Produto sem nome'} - R$ ${(produto.preco || 0).toFixed(2)}</option>`
          ).join('')
        : '<option value="">Nenhum produto disponível</option>';

      const itemHTML = `
        <div class="item-row" data-item-id="${itemId}">
          <div>
            <select class="produto-select" onchange="selecionarProduto(this, '${itemId}')">
              <option value="">Selecione um produto</option>
              ${produtosOptions}
            </select>
            <input type="text" class="produto-nome" placeholder="Ou digite o nome do produto" style="margin-top: 5px;">
          </div>
          <div>
            <input type="number" class="produto-quantidade" value="1" min="1" onchange="calcularSubtotalItem('${itemId}')">
          </div>
          <div>
            <input type="number" class="produto-preco" step="0.01" placeholder="0.00" onchange="calcularSubtotalItem('${itemId}')">
          </div>
          <div>
            <input type="number" class="produto-subtotal" step="0.01" readonly>
          </div>
          <div>
            <button type="button" class="btn btn-sm btn-danger" onclick="removerItem('${itemId}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;

      itensContainer.insertAdjacentHTML('beforeend', itemHTML);
      calcularTotalPedido();
    }

    // Função para remover item (mantida para compatibilidade)
    function removerItem(itemId) {
      const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
      if (itemElement) {
        itemElement.remove();
        calcularTotalPedido();
      }
    }

    // Função não mais necessária - removida

    // Calcular total do pedido
    function calcularTotalPedido() {
      const itens = document.querySelectorAll('.item-row');
      let total = 0;
      
      itens.forEach(item => {
        const subtotalInput = item.querySelector('.produto-subtotal');
        if (subtotalInput) {
          const subtotal = parseFloat(subtotalInput.value) || 0;
          total += subtotal;
        }
      });
      
      const totalElement = document.getElementById('totalPedido');
      if (totalElement) {
        totalElement.textContent = total.toFixed(2);
      }
    }

    // Handle novo pedido
    async function handleNovoPedido(event) {
      event.preventDefault();
      
      if (!validarFormulario()) {
        return;
      }

      const formData = new FormData(novoPedidoForm);
      const pedidoData = {
        cliente: obterDadosCliente(),
        itens: obterItensPedido(),
        observacoes: formData.get('observacoes'),
        status: 'Pendente'
      };

      try {
        const response = await fetch('/api/pedidos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(pedidoData)
        });

        if (response.ok) {
          const novoPedido = await response.json();
          pedidos.push(novoPedido);
          atualizarTabelaPedidos();
          novoPedidoModal.style.display = 'none';
          limparFormulario();
          mostrarNotificacao('Pedido criado com sucesso!', 'success');
        } else {
          throw new Error('Erro ao criar pedido');
        }
      } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao criar pedido', 'error');
      }
    }

    // Validar formulário
    function validarFormulario() {
      const requiredFields = novoPedidoForm.querySelectorAll('[required]');
      let isValid = true;

      requiredFields.forEach(field => {
        if (!validateField({ target: field })) {
          isValid = false;
        }
      });

      const itens = document.querySelectorAll('.item-row');
      if (itens.length === 0) {
        mostrarNotificacao('Adicione pelo menos um item ao pedido', 'error');
        isValid = false;
      }

      return isValid;
    }

    // Obter dados do cliente
    function obterDadosCliente() {
      const tipoCliente = document.getElementById('tipoCliente').value;
      
      if (tipoCliente === 'existente') {
        const clienteId = document.getElementById('cliente').value;
        return clientes.find(c => c.id == clienteId);
      } else {
        return {
          nome: document.getElementById('nomeCliente').value,
          telefone: document.getElementById('telefone').value,
          email: document.getElementById('email').value,
          endereco: document.getElementById('endereco').value
        };
      }
    }

    // Obter itens do pedido
    function obterItensPedido() {
      const itens = [];
      const itensContainer = document.getElementById('itensContainer');
      if (!itensContainer) {
        return itens;
      }
      
      itensContainer.querySelectorAll('.item-row').forEach(itemElement => {
        const nomeInput = itemElement.querySelector('.produto-nome');
        const quantidadeInput = itemElement.querySelector('.produto-quantidade');
        const precoInput = itemElement.querySelector('.produto-preco');
        const subtotalInput = itemElement.querySelector('.produto-subtotal');
        
        if (nomeInput && quantidadeInput && precoInput && subtotalInput) {
          const nome = nomeInput.value.trim();
          const quantidade = parseInt(quantidadeInput.value) || 0;
          const preco = parseFloat(precoInput.value) || 0;
          const subtotal = parseFloat(subtotalInput.value) || 0;
          
          if (nome && quantidade > 0 && preco > 0) {
            itens.push({
              nome,
              preco,
              quantidade,
              subtotal,
              observacoes: ''
            });
          }
        }
      });
      
      return itens;
    }

    // Visualizar pedido
    function visualizarPedido(pedidoId) {
      const pedido = pedidos.find(p => p.id == pedidoId);
      if (!pedido) return;

      preencherFormularioVisualizacao(pedido);
      visualizarPedidoModal.style.display = 'block';
    }

    // Preencher formulário de visualização
    function preencherFormularioVisualizacao(pedido) {
      const form = visualizarPedidoForm;
      
      // Dados do cliente
      form.querySelector('[name="clienteNome"]').value = pedido.cliente.nome;
      form.querySelector('[name="clienteTelefone"]').value = pedido.cliente.telefone;
      form.querySelector('[name="clienteEmail"]').value = pedido.cliente.email || '';
      form.querySelector('[name="clienteEndereco"]').value = pedido.cliente.endereco || '';
      
      // Itens do pedido
      const itensContainer = form.querySelector('#itensPedidoVisualizacao');
      itensContainer.innerHTML = '';
      
      pedido.itens.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item-pedido';
        itemDiv.innerHTML = `
          <div class="item-info">
            <strong>${item.nome}</strong>
            <span class="item-details">
              ${item.quantidade}x R$ ${item.preco.toFixed(2)} = R$ ${item.subtotal.toFixed(2)}
            </span>
            ${item.observacoes ? `<small class="item-observacoes">${item.observacoes}</small>` : ''}
          </div>
        `;
        itensContainer.appendChild(itemDiv);
      });
      
      // Total e observações
      form.querySelector('[name="valorTotal"]').value = `R$ ${pedido.valorTotal.toFixed(2)}`;
      form.querySelector('[name="observacoes"]').value = pedido.observacoes || '';
      form.querySelector('[name="status"]').value = pedido.status;
      
      // Data de criação
      form.querySelector('[name="dataCriacao"]').value = formatarData(pedido.dataCriacao);
    }

    // Editar pedido
    function editarPedido(pedidoId) {
      const pedido = pedidos.find(p => p.id == pedidoId);
      if (!pedido) return;

      pedidoAtual = pedido;
      editandoPedido = true;
      
      preencherFormularioEdicao(pedido);
      novoPedidoModal.style.display = 'block';
    }

    // Preencher formulário de edição
    function preencherFormularioEdicao(pedido) {
      const form = novoPedidoForm;
      
      // Dados do cliente
      if (pedido.cliente.id) {
        form.querySelector('#tipoCliente').value = 'existente';
        form.querySelector('#cliente').value = pedido.cliente.id;
        handleTipoClienteChange();
      } else {
        form.querySelector('#tipoCliente').value = 'novo';
        form.querySelector('#nomeCliente').value = pedido.cliente.nome;
        form.querySelector('#telefone').value = pedido.cliente.telefone;
        form.querySelector('#email').value = pedido.cliente.email || '';
        form.querySelector('#endereco').value = pedido.cliente.endereco || '';
        handleTipoClienteChange();
      }
      
      // Itens do pedido
      const itensContainer = form.querySelector('#itensContainer');
      if (itensContainer) {
        itensContainer.innerHTML = '';
        
        pedido.itens.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'item-pedido';
          itemDiv.dataset.itemId = item.id || Date.now();
          
          itemDiv.innerHTML = `
            <div class="item-info">
              <strong>${item.nome}</strong>
              <span class="item-details">
                ${item.quantidade}x R$ ${item.preco.toFixed(2)} = R$ ${item.subtotal.toFixed(2)}
              </span>
              ${item.observacoes ? `<small class="item-observacoes">${item.observacoes}</small>` : ''}
            </div>
            <button type="button" class="btn btn-sm btn-danger" onclick="removerItem(${item.id || Date.now()})">
              <i class="fas fa-trash"></i>
            </button>
          `;
          itensContainer.appendChild(itemDiv);
        });
      }
      
      // Observações
      form.querySelector('[name="observacoes"]').value = pedido.observacoes || '';
      
      calcularTotalPedido();
    }

    // Handle editar pedido
    async function handleEditarPedido(event) {
      event.preventDefault();
      
      if (!validarFormulario()) {
        return;
      }

      const formData = new FormData(novoPedidoForm);
      const pedidoData = {
        cliente: obterDadosCliente(),
        itens: obterItensPedido(),
        observacoes: formData.get('observacoes'),
        status: pedidoAtual.status
      };

      try {
        const response = await fetch(`/api/pedidos/${pedidoAtual.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(pedidoData)
        });

        if (response.ok) {
          const pedidoAtualizado = await response.json();
          const index = pedidos.findIndex(p => p.id == pedidoAtual.id);
          if (index !== -1) {
            pedidos[index] = pedidoAtualizado;
          }
          atualizarTabelaPedidos();
          novoPedidoModal.style.display = 'none';
          limparFormulario();
          mostrarNotificacao('Pedido atualizado com sucesso!', 'success');
        } else {
          throw new Error('Erro ao atualizar pedido');
        }
      } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao atualizar pedido', 'error');
      }
    }

    // Excluir pedido
    async function excluirPedido(pedidoId) {
      if (!confirm('Tem certeza que deseja excluir este pedido?')) {
        return;
      }

      try {
        const response = await fetch(`/api/pedidos/${pedidoId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          pedidos = pedidos.filter(p => p.id != pedidoId);
          atualizarTabelaPedidos();
          mostrarNotificacao('Pedido excluído com sucesso!', 'success');
        } else {
          throw new Error('Erro ao excluir pedido');
        }
      } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao excluir pedido', 'error');
      }
    }

    // Exportar dados
    function exportarDados() {
      const pedidosFiltrados = obterPedidosFiltrados();
      
      if (pedidosFiltrados.length === 0) {
        mostrarNotificacao('Nenhum pedido para exportar', 'warning');
        return;
      }

      const csvContent = gerarCSV(pedidosFiltrados);
      downloadCSV(csvContent, 'pedidos.csv');
    }

    // Obter pedidos filtrados
    function obterPedidosFiltrados() {
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      const statusFilterValue = statusFilter ? statusFilter.value : '';
      const dataInicio = dataInicioFilter ? dataInicioFilter.value : '';
      const dataFim = dataFimFilter ? dataFimFilter.value : '';

      return pedidos.filter(pedido => {
        const matchSearch = !searchTerm || 
          pedido.cliente.nome.toLowerCase().includes(searchTerm) ||
          pedido.cliente.telefone.includes(searchTerm) ||
          pedido.id.toString().includes(searchTerm);

        const matchStatus = !statusFilterValue || pedido.status === statusFilterValue;
        
        const matchData = (!dataInicio || pedido.dataCriacao >= dataInicio) &&
                         (!dataFim || pedido.dataCriacao <= dataFim);

        return matchSearch && matchStatus && matchData;
      });
    }

    // Gerar CSV
    function gerarCSV(pedidos) {
      const headers = ['ID', 'Cliente', 'Telefone', 'Itens', 'Valor Total', 'Status', 'Data Criação'];
      const rows = [headers];

      pedidos.forEach(pedido => {
        rows.push([
          pedido.id,
          pedido.cliente.nome,
          pedido.cliente.telefone,
          pedido.itens.length,
          pedido.valorTotal.toFixed(2),
          pedido.status,
          formatarData(pedido.dataCriacao)
        ]);
      });

      return rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    }

    // Download CSV
    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Formatar data
    function formatarData(data) {
      return new Date(data).toLocaleDateString('pt-BR');
    }

    // Mostrar notificação
    function mostrarNotificacao(mensagem, tipo) {
      const notification = document.createElement('div');
      notification.className = `notification notification-${tipo}`;
      notification.textContent = mensagem;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Função de logout
    async function logout() {
      try {
        const response = await fetch('/api/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (response.ok) {
          window.location.href = '/login.html';
        } else {
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('Erro no logout:', error);
        window.location.href = '/login.html';
      }
    }

    // Funções de exportação
    function gerarPDFTodosPedidos() {
      mostrarNotificacao('Funcionalidade de PDF em desenvolvimento', 'info');
    }

    function gerarExcelTodosPedidos() {
      exportarDados(); // Usa a função de exportação CSV existente
    }

    // Event listeners para campos de produto
    document.addEventListener('DOMContentLoaded', function() {
      const produtoPreco = document.getElementById('produtoPreco');
      const produtoQuantidade = document.getElementById('produtoQuantidade');
      
      if (produtoPreco) {
        produtoPreco.addEventListener('input', calcularSubtotalItem);
      }
      
      if (produtoQuantidade) {
        produtoQuantidade.addEventListener('input', calcularSubtotalItem);
      }
    });
  </script>
</body>
</html> 