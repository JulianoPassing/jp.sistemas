<!--
  RESPONSIVIDADE MOBILE:
  - Este arquivo já inclui <meta name="viewport"> e mobile.css para responsividade.
  - Use as classes .coluna-desnecessaria ou .hide-mobile em <th> ou <td> para esconder colunas no mobile.
  - Para navegação fixa no rodapé, utilize <nav class="mobile-nav">.
  - Mantenha sempre o mobile.css atualizado para melhor experiência mobile.
-->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="canonical" href="https://jp-sistemas.com/mesas.html" />
  <title>Comandas e Mesas - J.P Sistemas Comercial</title>
  <link rel="icon" href="https://i.imgur.com/TwZLW6a.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="style-sistema.css">
  <link rel="stylesheet" href="mobile.css">
  <style>
    :root {
      --primary-color: #005a9f;
      --primary-dark: #003766;
      --primary-light: #0077cc;
      --secondary-color: #022656;
      --accent-color: #1e4a8a;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --background: #f8fafc;
      --surface: #ffffff;
      --border: #e5e7eb;
      --shadow: rgba(0, 90, 159, 0.1);
      --shadow-hover: rgba(0, 90, 159, 0.2);
      --success-color: #059669;
      --danger-color: #dc2626;
      --warning-color: #d97706;
      --light-color: #f9fafb;
      --dark-color: #111827;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --border-radius: 16px;
      --primary-blue: #002f4b;
      --light-text: #ecf0f1;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: #F5F7FA;
      min-height: 100vh;
      color: #1F2937;
      padding: 0;
    }
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 20px 0;
      box-shadow: 0 4px 20px rgba(0, 90, 159, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo img {
      width: 150px;
      height: 67px;
      object-fit: contain;
      background: none;
      box-shadow: none;
      border-radius: 0;
      margin: 0;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-info span {
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      font-weight: 500;
    }
    .user-info #userDisplay {
      font-weight: 700;
    }
    .logout-btn {
      background: var(--primary-blue) !important;
      color: var(--light-text) !important;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }
    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 90, 159, 0.3);
    }
    .main-content {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    .breadcrumb a {
      color: var(--light-text);
      text-decoration: none;
      transition: color 0.2s;
    }
    .breadcrumb a:hover { color: #00e6ff; }
    .breadcrumb span { color: rgba(255,255,255,0.6); }
    @keyframes cardFadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card {
      animation: cardFadeIn 0.5s ease-out;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 90, 159, 0.1);
      padding: 32px;
      margin-bottom: 32px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .card-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .card-header h2 {
      font-size: 1.8em;
      color: var(--dark-color);
      font-weight: 600;
      text-align: center;
      font-family: 'Inter', sans-serif;
      background: none;
    }
    .mesas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 16px;
      padding-bottom: 16px;
      max-height: calc(100vh - 320px);
      overflow-y: auto;
    }
    .mesa-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 12px rgba(0,47,75,0.06);
      padding: 0;
      margin-bottom: 0;
      position: relative;
      border: 1px solid #e5e7eb;
      transition: box-shadow 0.25s ease, border-color 0.2s; overflow: hidden;
      min-width: 0;
      display: flex;
      flex-direction: column;
      font-size: 0.95rem;
    }
    .mesa-card:hover {
      box-shadow: 0 4px 16px rgba(0,47,75,0.12);
      border-color: #0d9488;
    }
    .mesa-card.mesa-tempo-alerta {
      border-left: 4px solid #d97706;
    }
    .mesa-card.mesa-tempo-alerta .mesa-header { background: linear-gradient(135deg, #002f4b 0%, #004d73 100%); }
    .mesa-card.mesa-tempo-urgente {
      border-left: 4px solid #dc2626;
    }
    .mesa-card.mesa-tempo-urgente .mesa-header { background: linear-gradient(135deg, #002f4b 0%, #004d73 100%); }
    .mesa-header {
      background: linear-gradient(135deg, #002f4b 0%, #004d73 100%);
      color: #fff;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 10px;
    }
    .mesa-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .mesa-nome {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mesa-nome i { opacity: 0.9; }
    .mesa-meta {
      display: flex;
      gap: 12px;
      font-size: 0.8rem;
      flex-wrap: wrap;
    }
    .mesa-tempo, .mesa-qtd-itens {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: rgba(255,255,255,0.18);
      padding: 5px 10px;
      border-radius: 8px;
      font-weight: 500;
    }
    .mesa-status {
      font-size: 0.98em;
      font-weight: 600;
      color: #ffe066;
      background: rgba(255,224,102,0.13);
      border-radius: 8px;
      padding: 2px 10px;
      margin-left: auto;
      text-shadow: 0 1px 2px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .mesa-itens {
      padding: 16px 20px;
      background: #f9fafb;
    }
    .mesa-itens table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .mesa-itens th {
      background: #f1f5f9;
      color: #334155 !important;
      font-weight: 600;
      text-align: right;
      padding: 10px 12px;
      border-bottom: 2px solid #e2e8f0;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .mesa-itens th:first-child { text-align: left; }
    .mesa-itens td {
      padding: 8px 12px;
      border-bottom: 1px solid #f1f5f9;
      text-align: right;
      color: #475569;
    }
    .mesa-itens td:first-child {
      text-align: left;
      color: #334155;
      font-weight: 500;
    }
    .mesa-itens tr:last-child td { border-bottom: none; }
    .mesa-rodape {
      padding: 10px 20px 16px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
    }
    .mesa-total {
      font-size: 1.1rem;
      font-weight: 700;
      color: #059669;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }
    .mesa-total span:first-child { color: #64748b; font-weight: 500; }
    .mesa-acoes {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .mesa-acoes .btn {
      min-width: 38px;
      width: 38px;
      height: 38px;
      padding: 0;
      margin: 0;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mesa-acoes .btn-secondary { background: #f1f5f9 !important; color: #475569 !important; border: 1px solid #e2e8f0; }
    .mesa-acoes .btn-secondary:hover { background: #e2e8f0 !important; }
    .mesa-acoes .btn-success { background: #059669 !important; color: #fff !important; }
    .mesa-acoes .btn-primary { background: #0d9488 !important; color: #fff !important; }
    .mesa-acoes .btn-danger { background: #dc2626 !important; color: #fff !important; }
    .mesa-acoes .btn i { font-size: 0.95em; }
    .mesa-acoes .btn[title] { position: relative; }
    .mesa-acoes .btn[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 0.93em;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0.95;
      z-index: 10;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      font-family: "Inter", sans-serif;
      font-weight: 500;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }
    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
    }
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #dc2626);
      color: white;
    }
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
    }
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
    }
    .comandas-busca-row {
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .comandas-busca-row input,
    .comandas-busca-row select {
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      background: #fff;
    }
    .comandas-busca-row input { flex: 1; min-width: 200px; }
    .comandas-busca-row select { min-width: 160px; }
    .nova-mesa-form {
      margin-bottom: 20px;
      background: #f9fafb;
      border-radius: 12px;
      padding: 18px 20px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0, 90, 159, 0.05);
      display: flex;
      gap: 14px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .nova-mesa-form .form-group {
      margin-bottom: 0;
      flex: 1;
      min-width: 180px;
    }
    .nova-mesa-form input {
      padding: 12px 14px 12px 44px;
      height: 48px;
      font-size: 1.05rem;
      border: 2px solid var(--border);
      border-radius: 8px;
    }
    .nova-mesa-form .btn { height: 48px; padding: 0 24px; border-radius: 8px; }
    @media (max-width: 900px) {
      .mesas-grid {
        grid-template-columns: 1fr;
      }
      .nova-mesa-form {
        flex-direction: column;
        gap: 10px;
      }
    }
    @media (max-width: 700px) {
      .mesas-grid {
        grid-template-columns: 1fr;
        gap: 14px;
        max-height: calc(100vh - 340px);
      }
      .mesa-card { min-width: 0; }
      .mesa-header-top { flex-direction: column; align-items: flex-start; gap: 8px; }
      .mesa-itens { padding: 12px 16px; }
      .mesa-rodape { padding: 10px 16px 14px; }
    }
    .logo h1, h1, h2, h3, h4, h5, h6, .fa, .fas, .icon, .destaque {
      color: var(--primary-blue) !important;
    }
    .mesa-itens th, .mesa-itens td { color: inherit !important; }
    /* Modo Comandas - tela cheia, conteúdo na tela */
    body.comandas-fullscreen .sistema-header,
    body.comandas-fullscreen .sistema-breadcrumb,
    body.comandas-fullscreen .sistema-page-header,
    body.comandas-fullscreen .footer { display: none !important; }
    body.comandas-fullscreen .sistema-main {
      padding: 1rem;
      max-width: none;
      height: 100vh;
      overflow: hidden;
    }
    body.comandas-fullscreen .sistema-container { max-width: none; padding: 0; height: 100%; }
    body.comandas-fullscreen .sistema-section {
      margin-bottom: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    body.comandas-fullscreen .sistema-section-header,
    body.comandas-fullscreen .nova-mesa-form,
    body.comandas-fullscreen .comandas-busca-row { flex-shrink: 0; }
    body.comandas-fullscreen .mesas-grid {
      flex: 1;
      min-height: 0;
      max-height: none;
      overflow-y: auto;
    }
    .comandas-fullscreen-toggle {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 999;
      padding: 8px 16px;
      background: var(--primary-blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .comandas-fullscreen-toggle:hover { background: #004d73; }
    body:not(.comandas-fullscreen) .comandas-exit-btn { display: none !important; }
    body.comandas-fullscreen .comandas-fullscreen-btn { display: none !important; }
    .comandas-exit-btn {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 999;
      padding: 8px 16px;
      background: #6b7280;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .comandas-exit-btn:hover { background: #4b5563; color: #fff; }
    /* Modal impressão - botões de opção */
    .btn-opcao-impressao {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }
    .btn-opcao-impressao:hover {
      border-color: var(--primary-color);
      background: #f0f9ff;
    }
    .btn-opcao-impressao i {
      font-size: 1.5rem;
      color: #0d9488;
      flex-shrink: 0;
    }
    .btn-opcao-impressao strong { display: block; color: #002f4b; margin-bottom: 4px; font-size: 1rem; }
    .btn-opcao-impressao span { font-size: 0.85rem; color: #6b7280; }
  </style>
</head>
<body class="app-layout" id="comandas-body">
  <button type="button" class="comandas-fullscreen-btn comandas-fullscreen-toggle" id="btn-tela-cheia" title="Modo tela cheia - ocultar menu"><i class="fas fa-expand"></i> Tela cheia</button>
  <a href="mesas.html" class="comandas-exit-btn" id="btn-sair-tela-cheia" title="Sair do modo tela cheia"><i class="fas fa-compress"></i> Sair</a>
  <header class="sistema-header">
    <div class="header-content">
      <a href="painel.html" class="logo"><img src="https://i.imgur.com/EQ1tjZX.png" alt="J.P Sistemas" style="height: 5rem; width: auto; object-fit: contain;" /></a>
      <button class="sistema-mobile-toggle" id="nav-toggle" aria-label="Menu"><i class="fas fa-bars"></i></button>
      <nav id="main-nav">
        <a href="painel.html" class="nav-link">Painel</a>
        <a href="painel-clientes.html" class="nav-link">Clientes</a>
        <a href="produtos.html" class="nav-link">Produtos</a>
        <a href="pedidos.html" class="nav-link active">Pedidos</a>
        <a href="relatorios.html" class="nav-link">Relatórios</a>
        <a href="configuracoes.html" class="nav-link">Configurações</a>
        <a href="ajuda.html" class="nav-link">Ajuda</a>
        <a href="index.html" class="nav-link" title="Site"><i class="fas fa-globe"></i></a>
        <a href="#" class="nav-link nav-sair" onclick="logout(); return false;"><i class="fas fa-sign-out-alt"></i> Sair</a>
      </nav>
    </div>
  </header>
  <main class="sistema-main">
    <div class="sistema-container">
      <nav class="sistema-breadcrumb">
        <a href="painel.html">Painel</a>
        <span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>
        <a href="pedidos.html">Pedidos</a>
        <span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>
        <span>Comandas</span>
      </nav>
      <div class="sistema-page-header">
        <div class="sistema-page-header-icon">
          <i class="fas fa-chair"></i>
        </div>
        <div class="sistema-page-header-text">
          <h1>Comandas e Mesas</h1>
          <p>Restaurantes, bares, mercados e lojas — pedidos em aberto</p>
        </div>
      </div>
    <div class="sistema-section">
      <div class="sistema-section-header">
        <h2 class="sistema-section-title-icon"><i class="fas fa-list"></i> Comandas / Mesas em Aberto</h2>
      </div>
      <p style="font-size:0.9rem;color:#6b7280;margin-bottom:12px;">Restaurantes: Mesa 1, Mesa 2. Bares: Comanda 5. Mercados: Balcão 1. Ou nome do cliente.</p>
      <div class="comandas-busca-row">
        <input type="text" id="busca-comanda" placeholder="Buscar comanda..." />
        <select id="ordenar-comandas">
          <option value="recente">Mais recente</option>
          <option value="antigo">Mais antigo</option>
          <option value="valor">Maior valor</option>
        </select>
      </div>
      <div id="mesa-feedback" style="display:none;margin-bottom:18px;text-align:center;font-weight:500;"></div>
      <form class="nova-mesa-form" id="nova-mesa-form">
        <div class="form-group" style="position:relative;">
          <span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#005a9f;font-size:1.2em;z-index:1;"><i class="fas fa-receipt"></i></span>
          <input type="text" id="mesa-nome" required placeholder="Ex: Mesa 1, Comanda 5, Balcão 2, João Silva, Delivery..." />
        </div>
        <button class="btn btn-primary" id="btn-criar-mesa" type="submit"><i class="fas fa-plus"></i> Nova Comanda</button>
        <a href="pedidos.html" class="btn btn-secondary" style="text-decoration:none;"><i class="fas fa-list"></i> Pedidos</a>
      </form>
      <div class="mesas-grid" id="mesas-grid"></div>
    </div>
    </div>
  </main>
  <footer class="footer" style="width:100%;text-align:center;padding:18px 0 12px 0;color:#fff;font-size:15px;background:transparent;font-family:'Inter',sans-serif;letter-spacing:0.02em;">
    © 2026 J.P Sistemas. Todos os direitos reservados. <a href="https://whatsa.me/5548996852138/?t=Ola,%20gostaria%20de%20mais%20informacoes%20sobre%20os%20sistemas." target="_blank" rel="noopener noreferrer" style="color: #fff; text-decoration: underline; font-weight: 500;">Fale conosco no WhatsApp</a>
  </footer>
  <!-- Modal de Edição de Produtos da Mesa -->
  <div id="modal-editar-produtos" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
    <div class="modal-content" style="background:#fff;border-radius:16px;max-width:700px;width:97vw;padding:32px 28px;box-shadow:0 8px 32px rgba(0,90,159,0.18);position:relative;border:1px solid #e5e7eb;">
      <h3 style="margin-bottom:20px;font-size:1.2em;font-weight:600;color:#002f4b;display:flex;align-items:center;gap:8px;"><i class="fas fa-edit" style="color:#0d9488;"></i> Editar itens da comanda</h3>
      <div id="produtos-mesa-lista"></div>

      <div style="margin-top:24px;text-align:right;">
        <button id="btn-salvar-produtos" class="btn btn-success"><i class="fas fa-save"></i> Salvar</button>
        <button id="btn-cancelar-produtos" class="btn btn-secondary" style="margin-left:8px;">Cancelar</button>
      </div>
      <button id="btn-fechar-modal-produtos" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;color:#888;cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <!-- Modal de Impressão - Seleção de Modelo -->
  <div id="modal-imprimir-comanda" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
    <div class="modal-content" style="background:#fff;border-radius:16px;max-width:420px;width:95vw;padding:28px 24px;box-shadow:0 8px 32px rgba(0,90,159,0.18);position:relative;border:1px solid #e5e7eb;">
      <h3 style="margin-bottom:20px;font-size:1.2em;font-weight:600;color:#002f4b;display:flex;align-items:center;gap:8px;"><i class="fas fa-print" style="color:#0d9488;"></i> Imprimir Comanda</h3>
      <p style="font-size:0.9rem;color:#6b7280;margin-bottom:20px;">Selecione o modelo de impressão conforme sua impressora:</p>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button type="button" id="btn-imprimir-normal" class="btn-opcao-impressao" data-modelo="normal">
          <i class="fas fa-file-alt"></i>
          <div>
            <strong>Impressora Normal (A4)</strong>
            <span>Papel A4, layout completo para impressora de mesa</span>
          </div>
        </button>
        <button type="button" id="btn-imprimir-cupom" class="btn-opcao-impressao" data-modelo="cupom">
          <i class="fas fa-receipt"></i>
          <div>
            <strong>Impressora de Cupom (térmica)</strong>
            <span>Papel 80mm, formato compacto para impressora térmica</span>
          </div>
        </button>
      </div>
      <div style="margin-top:20px;text-align:right;">
        <button type="button" id="btn-cancelar-imprimir" class="btn btn-secondary">Cancelar</button>
      </div>
      <button type="button" id="btn-fechar-modal-imprimir" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.4em;color:#9ca3af;cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <!-- Modal de Finalização com Desconto -->
  <div id="modal-finalizar-mesa" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
    <div class="modal-content" style="background:#fff;border-radius:16px;max-width:420px;width:95vw;padding:32px 24px;box-shadow:0 8px 32px rgba(0,90,159,0.18);position:relative;">
      <h3 style="margin-bottom:18px;font-size:1.25em;font-weight:600;">Fechar comanda / Finalizar venda</h3>
      <div id="finalizar-info"></div>
      <div style="margin-top:24px;text-align:right;">
        <button id="btn-finalizar-mesa" class="btn btn-success"><i class="fas fa-check"></i> Fechar comanda</button>
        <button id="btn-cancelar-finalizar" class="btn btn-secondary" style="margin-left:8px;">Cancelar</button>
      </div>
      <button id="btn-fechar-modal-finalizar" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;color:#888;cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <script>
    let produtos = [];
    let pedidosAbertos = [];
    let username = '';

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      sessionStorage.removeItem('loggedIn');
      sessionStorage.removeItem('username');
      window.location.href = 'sistema.html';
    }
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('fullscreen') === '1') {
        document.getElementById('comandas-body').classList.add('comandas-fullscreen');
      }
      document.getElementById('btn-tela-cheia')?.addEventListener('click', () => {
        window.location.href = 'mesas.html?fullscreen=1';
      });
      document.getElementById('nav-toggle')?.addEventListener('click', function() {
        document.getElementById('main-nav').classList.toggle('open');
      });
      if (sessionStorage.getItem('loggedIn') !== 'true') {
        alert('Acesso negado. Por favor, realize o login.');
        window.location.href = 'index.html';
      }
      username = sessionStorage.getItem('username') || 'Usuário';
      const userDisplay = document.getElementById('userDisplay');
      if (userDisplay) userDisplay.textContent = username;
      carregarProdutos();
      carregarPedidosAbertos();
      document.getElementById('mesa-nome').focus();
      document.getElementById('nova-mesa-form').addEventListener('submit', criarNovaMesa);
      document.getElementById('busca-comanda')?.addEventListener('input', renderMesas);
      document.getElementById('ordenar-comandas')?.addEventListener('change', renderMesas);
      document.getElementById('btn-imprimir-normal')?.addEventListener('click', () => executarImpressao('normal'));
      document.getElementById('btn-imprimir-cupom')?.addEventListener('click', () => executarImpressao('cupom'));
      document.getElementById('btn-cancelar-imprimir')?.addEventListener('click', fecharModalImprimir);
      document.getElementById('btn-fechar-modal-imprimir')?.addEventListener('click', fecharModalImprimir);
    });

    async function carregarProdutos() {
      try {
        const response = await fetch('/api/produtos');
        if (!response.ok) throw new Error('Erro ao buscar produtos');
        produtos = await response.json();
      } catch (e) {
        produtos = [];
      }
    }
    async function carregarPedidosAbertos() {
      try {
        const response = await fetch('/api/pedidos');
        if (!response.ok) throw new Error('Erro ao buscar pedidos');
        const todos = await response.json();
        console.log('Pedidos recebidos:', todos);
        pedidosAbertos = (todos || []).filter(p => p.status === 'Em Aberto');
        console.log('Pedidos em aberto:', pedidosAbertos);
        console.log('Itens dos pedidos:', pedidosAbertos.map(p => ({ id: p.id, itens: p.itens })));
        renderMesas();
      } catch (e) {
        console.error('Erro ao buscar pedidos:', e);
        renderMesas();
      }
    }
    function minutosAbertos(pedido) {
      const dataRef = pedido?.created_at || pedido?.data_pedido;
      if (!dataRef) return 0;
      const d = new Date(dataRef);
      if (isNaN(d.getTime())) return 0;
      return Math.floor((Date.now() - d.getTime()) / 60000);
    }
    function tempoAbertura(pedido) {
      const dataRef = pedido?.created_at || pedido?.data_pedido;
      if (!dataRef) return '';
      const d = new Date(dataRef);
      if (isNaN(d.getTime())) return '';
      const diff = Math.floor((Date.now() - d.getTime()) / 60000);
      if (diff < 1) return 'Agora';
      if (diff < 60) return `${diff} min`;
      const h = Math.floor(diff / 60);
      const m = diff % 60;
      if (h < 24) return m ? `${h}h ${m}min` : `${h}h`;
      const dias = Math.floor(h / 24);
      return `${dias}d`;
    }
    function renderMesas() {
      const grid = document.getElementById('mesas-grid');
      grid.innerHTML = '';
      if (!pedidosAbertos.length) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#888;font-size:1.1em;padding:2rem;"><i class="fas fa-receipt" style="font-size:2.5rem;display:block;margin-bottom:0.5rem;opacity:0.5;"></i>Nenhuma comanda ou mesa em aberto.<br><small>Crie uma nova comanda acima para começar.</small></div>';
        return;
      }
      const termoBusca = (document.getElementById('busca-comanda')?.value || '').trim().toLowerCase();
      const ordenar = document.getElementById('ordenar-comandas')?.value || 'recente';
      let lista = [...pedidosAbertos];
      if (termoBusca) {
        lista = lista.filter(p => {
          const nome = ((p.nome_cliente || '') + ' ' + (p.nome_mesa || '')).toLowerCase();
          return nome.includes(termoBusca);
        });
      }
      const dataRef = (p) => p.created_at || p.data_pedido || 0;
      if (ordenar === 'antigo') lista.sort((a, b) => new Date(dataRef(a)) - new Date(dataRef(b)));
      else if (ordenar === 'valor') lista.sort((a, b) => {
        const ta = (a.itens||[]).reduce((s, i) => s + parseFloat(i.subtotal || i.precoUnitario * i.quantidade || 0), 0);
        const tb = (b.itens||[]).reduce((s, i) => s + parseFloat(i.subtotal || i.precoUnitario * i.quantidade || 0), 0);
        return tb - ta;
      });
      else lista.sort((a, b) => new Date(dataRef(b)) - new Date(dataRef(a)));
      lista.forEach(pedido => {
        let total = (pedido.itens||[]).reduce((sum, i) => {
          const precoUnitario = parseFloat(i.precoUnitario || i.preco_unitario || 0);
          const quantidade = parseInt(i.quantidade || 0);
          return sum + (precoUnitario * quantidade);
        }, 0);
        const qtdItens = (pedido.itens||[]).reduce((s, i) => s + parseInt(i.quantidade || 0), 0);
        const tempo = tempoAbertura(pedido);
        const mins = minutosAbertos(pedido);
        let tempoClass = '';
        if (mins >= 120) tempoClass = 'mesa-tempo-urgente';
        else if (mins >= 60) tempoClass = 'mesa-tempo-alerta';
        const card = document.createElement('div');
        card.className = 'mesa-card' + (tempoClass ? ' ' + tempoClass : '');
        card.innerHTML = `
          <div class="mesa-header">
            <div class="mesa-header-top">
              <div class="mesa-nome"><i class="fas fa-receipt"></i> ${(pedido.nome_cliente && pedido.nome_cliente.trim()) || pedido.nome_mesa || 'Comanda/Mesa'}</div>
              <div class="mesa-meta">
                <span class="mesa-tempo" title="Tempo em aberto"><i class="fas fa-clock"></i> ${tempo || '--'}</span>
                <span class="mesa-qtd-itens" title="Quantidade de itens"><i class="fas fa-cubes"></i> ${qtdItens} itens</span>
              </div>
            </div>
          </div>
          <div class="mesa-itens">
            <table>
              <thead><tr><th>Produto</th><th>Qtd</th><th>Preço</th><th>Subtotal</th></tr></thead>
              <tbody>
                ${(pedido.itens||[]).length ? (pedido.itens||[]).map(i => {
                  const produtoNome = i.produto || i.nome_produto || 'Produto não identificado';
                  const quantidade = parseInt(i.quantidade || 0);
                  const precoUnitario = parseFloat(i.precoUnitario || i.preco_unitario || 0);
                  const subtotal = (i.subtotal != null ? parseFloat(i.subtotal) : precoUnitario * quantidade);
                  return `<tr><td>${produtoNome}</td><td>${quantidade}</td><td>R$ ${precoUnitario.toFixed(2).replace('.', ',')}</td><td>R$ ${subtotal.toFixed(2).replace('.', ',')}</td></tr>`;
                }).join('') : '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:16px;font-size:0.9rem;">Nenhum item adicionado</td></tr>'}
              </tbody>
            </table>
          </div>
          <div class="mesa-rodape">
            <div class="mesa-total"><span>Total:</span> <span>R$ ${total.toFixed(2).replace('.', ',')}</span></div>
            <div class="mesa-acoes">
              <button class="btn btn-secondary" title="Editar itens" onclick="abrirModalEditarProdutos(${pedido.id})"><i class='fas fa-edit'></i></button>
              <button class="btn btn-success" title="Fechar comanda" onclick="abrirModalFinalizarMesa(${pedido.id})"><i class='fas fa-check'></i></button>
              <button class="btn btn-primary" title="Imprimir comanda" onclick="abrirModalImprimir(${pedido.id})"><i class='fas fa-print'></i></button>
              <button class="btn btn-danger" title="Excluir comanda" onclick="excluirMesa(${pedido.id})"><i class='fas fa-trash'></i></button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    async function criarNovaMesa(e) {
      e.preventDefault();
      const nomeInput = document.getElementById('mesa-nome');
      const feedback = document.getElementById('mesa-feedback');
      const btn = document.getElementById('btn-criar-mesa');
      const nome = nomeInput.value.trim();
      feedback.style.display = 'none';
      if (!nome) {
        feedback.textContent = 'Informe o nome da comanda, mesa ou cliente!';
        feedback.style.color = '#dc2626';
        feedback.style.display = 'block';
        nomeInput.focus();
        return;
      }
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
      const pedido = {
        nome_cliente: nome,
        status: 'Em Aberto',
        itens: [],
        data_pedido: getDataHojeBR()
      };
      try {
        const response = await fetch('/api/pedidos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(pedido)
        });
        let novoPedido = null;
        const contentType = response.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          try {
            novoPedido = await response.json();
          } catch (e) {
            console.warn('Falha ao parsear JSON da resposta:', e);
          }
        } else if (response.ok) {
          // Resposta não é JSON, mas status é sucesso
          console.warn('Resposta não é JSON, mas status é sucesso. Mesa criada, mas resposta inesperada.');
        }
        if (response.ok) {
          const idCriado = novoPedido?.id;
          const createdAgora = new Date().toISOString();
          nomeInput.value = '';
          await carregarPedidosAbertos();
          const p = pedidosAbertos.find(x => x.id === idCriado);
          if (p) p.created_at = createdAgora;
          renderMesas();
          feedback.textContent = 'Comanda criada com sucesso!';
          feedback.style.color = '#059669';
          feedback.style.display = 'block';
          nomeInput.focus();
          setTimeout(() => { feedback.style.display = 'none'; }, 2500);
          return;
        }
        // Se chegou aqui, é erro HTTP
        let msg = 'Erro ao criar mesa/pedido!';
        if (contentType.includes('application/json')) {
          try {
            const errData = await response.json();
            if (errData && errData.error) msg += ': ' + errData.error;
          } catch (e) {
            console.warn('Falha ao parsear JSON do erro:', e);
          }
        } else {
          console.warn('Resposta de erro não é JSON. Status:', response.status, 'Content-Type:', contentType);
        }
        throw new Error(msg);
      } catch (e) {
        feedback.textContent = 'Erro ao criar mesa/pedido!';
        feedback.style.color = '#dc2626';
        feedback.style.display = 'block';
        console.error('Erro real ao criar mesa/pedido:', e);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus"></i> Nova Comanda';
      }
    }
    window.editarMesa = async function(id) {
      const pedido = pedidosAbertos.find(p => p.id === id);
      if (!pedido) return;
      const nome = prompt('Editar nome da mesa/pessoa:', pedido.nome_cliente || '');
      if (nome !== null && nome.trim() !== '' && nome !== pedido.nome_cliente) {
        pedido.nome_cliente = nome.trim();
        await fetch(`/api/pedidos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome_cliente: pedido.nome_cliente })
        });
      }
      // Adicionar produtos
      let continuar = true;
      while (continuar) {
        const prodNome = prompt('Digite o nome/código do produto para adicionar (ou deixe vazio para sair):');
        if (!prodNome) break;
        const prod = produtos.find(p => p.nome.toLowerCase().includes(prodNome.toLowerCase()) || String(p.codigo||'').toLowerCase() === prodNome.toLowerCase());
        if (!prod) {
          alert('Produto não encontrado!');
          continue;
        }
        const qtd = parseInt(prompt('Quantidade:', '1')) || 1;
        if (qtd > (prod.estoque ?? 0)) {
          alert('Quantidade maior que o estoque disponível!');
          continue;
        }
        const item = {
          produto: prod.nome,
          produto_id: prod.id,
          quantidade: qtd,
          precoUnitario: parseFloat(prod.preco_venda) || 0,
          subtotal: (parseFloat(prod.preco_venda) || 0) * qtd
        };
        pedido.itens = pedido.itens || [];
        pedido.itens.push(item);
        await fetch(`/api/pedidos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ itens: pedido.itens })
        });
        await carregarPedidosAbertos();
        continuar = confirm('Adicionar mais produtos?');
      }
      await carregarPedidosAbertos();
    }
    window.finalizarMesa = async function(id) {
      if (!confirm('Finalizar este pedido/mesa?')) return;
      
      try {
        // Buscar dados completos do pedido
        const pedido = pedidosAbertos.find(p => p.id === id);
        if (!pedido) {
          alert('Pedido não encontrado!');
          return;
        }

        // Preparar dados para atualização incluindo todos os itens
        const itensFormatados = (pedido.itens || []).map(item => ({
          produto_id: item.produto_id,
          quantidade: item.quantidade,
          preco_unitario: item.precoUnitario || item.preco_unitario || 0
        }));

        const dadosAtualizacao = {
          cliente_id: pedido.cliente_id,
          nome_cliente: pedido.nome_cliente,
          data_pedido: pedido.data_pedido,
          status: 'Concluído',
          valor_total: pedido.valor_total,
          observacoes: pedido.observacoes,
          itens: itensFormatados
        };

        // Fazer a requisição para atualizar o pedido
        const response = await fetch(`/api/pedidos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dadosAtualizacao)
        });

        if (!response.ok) {
          throw new Error('Erro ao finalizar mesa');
        }

        await carregarPedidosAbertos();
        alert('Mesa finalizada com sucesso!');
      } catch (error) {
        console.error('Erro ao finalizar mesa:', error);
        alert('Erro ao finalizar mesa: ' + error.message);
      }
    }
    let pedidoParaImprimir = null;
    window.abrirModalImprimir = function(id) {
      const pedido = pedidosAbertos.find(p => p.id === id);
      if (!pedido) return;
      pedidoParaImprimir = pedido;
      const modal = document.getElementById('modal-imprimir-comanda');
      if (modal) modal.style.display = 'flex';
    };
    function fecharModalImprimir() {
      pedidoParaImprimir = null;
      const modal = document.getElementById('modal-imprimir-comanda');
      if (modal) modal.style.display = 'none';
    }
    function executarImpressao(modelo) {
      const pedido = pedidoParaImprimir;
      if (!pedido) return;
      fecharModalImprimir();
      const data = new Date(pedido.data_pedido || Date.now());
      const dataStr = data.toLocaleDateString('pt-BR');
      let total = (pedido.itens||[]).reduce((sum, i) => sum + (parseFloat(i.precoUnitario||i.preco_unitario)||0) * (parseInt(i.quantidade)||0), 0);
      fetch('/api/empresa').then(res => res.json()).then(empresa => {
        const nomeEmpresa = empresa.nome_fantasia || 'J.P Sistemas';
        const razao = empresa.razao_social || '';
        const cnpj = empresa.cnpj || '';
        const endereco = empresa.endereco || '';
        const email = empresa.email || '';
        const telefone = empresa.telefone || '';
        const mesaNome = pedido.nome_cliente || pedido.nome_mesa || '';
        const itensHtml = (pedido.itens||[]).map(i => {
          const preco = parseFloat(i.precoUnitario||i.preco_unitario)||0;
          const qtd = parseInt(i.quantidade)||0;
          const sub = (i.subtotal != null ? parseFloat(i.subtotal) : preco * qtd).toFixed(2);
          return `<tr><td>${i.produto||''}</td><td>${qtd}</td><td>R$ ${preco.toFixed(2).replace('.',',')}</td><td>R$ ${sub.replace('.',',')}</td></tr>`;
        }).join('');
        let html, winW, winH;
        if (modelo === 'cupom') {
          html = `<html><head><title>Comanda - ${mesaNome}</title>
          <style>
            body{font-family:monospace;font-size:12px;margin:0;padding:0;}
            .doc{width:280px;margin:0 auto;padding:8px;}
            .doc h2{text-align:center;font-size:1em;margin:0 0 6px 0;}
            .doc .linha{border-top:1px dashed #000;margin:6px 0;}
            .doc table{width:100%;border-collapse:collapse;}
            .doc th,.doc td{font-size:11px;padding:2px 0;}
            .doc th{border-bottom:1px solid #000;}
            .doc .total{font-weight:bold;font-size:1.05em;text-align:right;margin-top:6px;}
            .doc .footer{text-align:center;font-size:10px;margin-top:8px;}
            @media print{body{margin:0;}.doc{box-shadow:none;border:none;}}
          </style></head><body onload='window.print()'>
          <div class='doc'>
            <h2>COMANDA - ${nomeEmpresa}</h2>
            <div style='text-align:center;font-size:11px;margin-bottom:4px;'>
              <div><b>${razao}</b></div>
              <div>CNPJ: ${cnpj}</div>
              <div>${endereco}</div>
            </div>
            <div style='margin-bottom:6px;'><b>Mesa:</b> ${mesaNome} | <b>Data:</b> ${dataStr}</div>
            <div class='linha'></div>
            <table><thead><tr><th>Produto</th><th>Qtd</th><th>Vlr</th><th>Sub</th></tr></thead><tbody>${itensHtml}</tbody></table>
            <div class='linha'></div>
            <div class='total'>TOTAL: R$ ${total.toFixed(2).replace('.',',')}</div>
            <div class='footer'>Cupom não fiscal - ${new Date().toLocaleString('pt-BR')}<br>J.P Sistemas</div>
          </div></body></html>`;
          winW = 320; winH = 600;
        } else {
          html = `<html><head><title>Comanda - ${mesaNome}</title>
          <style>
            body{font-family:Inter,sans-serif;font-size:14px;margin:0;padding:20px;color:#1f2937;}
            .doc{max-width:210mm;margin:0 auto;}
            .doc h1{font-size:1.4em;color:#002f4b;text-align:center;margin-bottom:16px;border-bottom:2px solid #002f4b;padding-bottom:12px;}
            .doc .empresa{text-align:center;margin-bottom:20px;color:#6b7280;font-size:0.9em;}
            .doc .info{margin-bottom:16px;padding:12px;background:#f9fafb;border-radius:8px;}
            .doc table{width:100%;border-collapse:collapse;}
            .doc th{background:#002f4b;color:#fff;padding:10px 12px;text-align:left;font-weight:600;}
            .doc th:nth-child(2),.doc th:nth-child(3),.doc th:nth-child(4){text-align:right;}
            .doc td{padding:10px 12px;border-bottom:1px solid #e5e7eb;}
            .doc td:nth-child(2),.doc td:nth-child(3),.doc td:nth-child(4){text-align:right;}
            .doc .total{font-size:1.2em;font-weight:700;color:#059669;text-align:right;margin-top:16px;padding-top:12px;border-top:2px solid #e5e7eb;}
            .doc .footer{text-align:center;font-size:0.85em;color:#9ca3af;margin-top:24px;}
            @media print{body{margin:0;padding:0;}.doc{box-shadow:none;}}
          </style></head><body onload='window.print()'>
          <div class='doc'>
            <h1>COMANDA - ${nomeEmpresa}</h1>
            <div class='empresa'><b>${razao}</b><br>CNPJ: ${cnpj}<br>${endereco}<br>${email} | ${telefone}</div>
            <div class='info'><b>Mesa/Pessoa:</b> ${mesaNome} | <b>Data:</b> ${dataStr} | <b>Status:</b> ${pedido.status}</div>
            <table><thead><tr><th>Produto</th><th>Qtd</th><th>Preço Unit.</th><th>Subtotal</th></tr></thead><tbody>${itensHtml}</tbody></table>
            <div class='total'>TOTAL: R$ ${total.toFixed(2).replace('.',',')}</div>
            <div class='footer'>Documento não fiscal - ${new Date().toLocaleString('pt-BR')} | J.P Sistemas</div>
          </div></body></html>`;
          winW = 800; winH = 700;
        }
        const win = window.open('', '', 'width='+winW+',height='+winH);
        win.document.write(html);
        win.document.close();
      });
    }
    window.excluirMesa = async function(id) {
      if (!confirm('Tem certeza que deseja excluir esta mesa/pedido?')) return;
      try {
        const resp = await fetch(`/api/pedidos/${id}`, { method: 'DELETE' });
        if (!resp.ok) throw new Error('Erro ao excluir mesa');
        pedidosAbertos = pedidosAbertos.filter(p => p.id !== id);
        renderMesas();
      } catch (e) {
        alert('Erro ao excluir mesa!');
      }
    }
    // Funções para abrir modais de edição e finalização de mesa
    window.abrirModalEditarProdutos = function(id) {
      const modal = document.getElementById('modal-editar-produtos');
      const pedido = pedidosAbertos.find(p => p.id === id);
      if (!pedido) return;
      // Variáveis locais para edição
      let itensEdit = JSON.parse(JSON.stringify(pedido.itens || []));
      let nomeEdit = pedido.nome_cliente || '';

      function renderListaProdutos() {
        // Campo para editar nome
        let nomeHtml = `<div style='margin-bottom:16px;'><label style='font-weight:500;color:#374151;'>Nome da Mesa/Pessoa:</label><input id='input-nome-mesa' type='text' value='${nomeEdit}' style='width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:1em;margin-top:6px;transition:border 0.2s;outline:none;' onfocus='this.style.borderColor="#005a9f"' onblur='this.style.borderColor="#e5e7eb"'/></div>`;
        
        // Calcular total
        const total = (itensEdit||[]).reduce((sum, item) => {
          const precoUnitario = parseFloat(item.precoUnitario || item.preco_unitario || 0);
          const quantidade = parseInt(item.quantidade || 0);
          const subtotal = quantidade * precoUnitario;
          return sum + subtotal;
        }, 0);
        
        // Listar produtos já adicionados
        let itensHtml = '';
        if ((itensEdit||[]).length > 0) {
          itensHtml = `
            <div style='margin-bottom:16px;'>
              <h4 style='font-weight:600;color:#374151;margin-bottom:12px;font-size:1.1em;'>Produtos Adicionados:</h4>
              <div style='background:#f9fafb;border-radius:10px;padding:16px;border:1px solid #e5e7eb;'>
                <table style='width:100%;border-collapse:collapse;font-size:0.95em;'>
                  <thead>
                    <tr>
                      <th style='text-align:left;padding:10px 12px;background:linear-gradient(135deg,#002f4b,#004d73);color:#fff;font-weight:600;'>Produto</th>
                      <th style='text-align:center;padding:10px 12px;background:linear-gradient(135deg,#002f4b,#004d73);color:#fff;font-weight:600;'>Qtd</th>
                      <th style='text-align:right;padding:10px 12px;background:linear-gradient(135deg,#002f4b,#004d73);color:#fff;font-weight:600;'>Preço Unit.</th>
                      <th style='text-align:right;padding:10px 12px;background:linear-gradient(135deg,#002f4b,#004d73);color:#fff;font-weight:600;'>Subtotal</th>
                      <th style='text-align:center;padding:10px 12px;background:linear-gradient(135deg,#002f4b,#004d73);color:#fff;font-weight:600;'>Ação</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${(itensEdit||[]).map((item, idx) => {
                      const precoUnitario = parseFloat(item.precoUnitario || item.preco_unitario || 0);
                      const quantidade = parseInt(item.quantidade || 0);
                      const subtotal = quantidade * precoUnitario;
                      return `<tr style='border-bottom:1px solid #f0f0f0;'>
                        <td style='padding:8px 4px;font-weight:500;color:#374151;'>${item.produto}</td>
                        <td style='text-align:center;padding:8px 4px;'>
                          <input type='number' min='1' value='${quantidade}' data-idx='${idx}' class='input-quantidade' style='width:50px;padding:4px 6px;border-radius:6px;border:1.5px solid #e5e7eb;font-size:0.9em;text-align:center;' />
                        </td>
                        <td style='text-align:right;padding:8px 4px;color:#6b7280;'>R$ ${precoUnitario.toFixed(2).replace('.', ',')}</td>
                        <td style='text-align:right;padding:8px 4px;font-weight:600;color:#059669;'>R$ ${subtotal.toFixed(2).replace('.', ',')}</td>
                        <td style='text-align:center;padding:8px 4px;'>
                          <button class='btn btn-danger btn-remover-produto' data-idx='${idx}' title='Remover' style='padding:4px 8px;font-size:0.85em;'><i class='fas fa-trash'></i></button>
                        </td>
                      </tr>`;
                    }).join('')}
                  </tbody>
                </table>
                <div style='margin-top:16px;padding-top:12px;border-top:2px solid #e5e7eb;text-align:right;'>
                  <div style='font-size:1.2em;font-weight:700;color:#059669;'>Total da Mesa: R$ ${total.toFixed(2).replace('.', ',')}</div>
                </div>
              </div>
            </div>`;
        } else {
          itensHtml = '<div style="color:#888;font-size:0.98em;text-align:center;padding:20px;background:#f9fafb;border-radius:10px;border:1px solid #e5e7eb;"><i class="fas fa-shopping-cart" style="font-size:1.5em;margin-bottom:8px;display:block;"></i>Nenhum produto adicionado.</div>';
        }
        
        document.getElementById('produtos-mesa-lista').innerHTML = nomeHtml + itensHtml;
        
        // Atualizar nomeEdit ao digitar
        document.getElementById('input-nome-mesa').oninput = function() {
          nomeEdit = this.value;
        };
        
        // Alterar quantidade
        document.querySelectorAll('.input-quantidade').forEach(input => {
          input.onchange = function() {
            const idx = this.getAttribute('data-idx');
            let val = parseInt(this.value) || 1;
            if (val < 1) val = 1;
            itensEdit[idx].quantidade = val;
            const precoUnitario = parseFloat(itensEdit[idx].precoUnitario || itensEdit[idx].preco_unitario || 0);
            itensEdit[idx].subtotal = val * precoUnitario;
            renderListaProdutos(); // Re-renderizar para atualizar subtotais
          };
        });
        
        // Remover produto
        document.querySelectorAll('.btn-remover-produto').forEach(btn => {
          btn.onclick = function() {
            const idx = this.getAttribute('data-idx');
            itensEdit.splice(idx, 1);
            renderListaProdutos();
          };
        });
      }
      renderListaProdutos();
      
      // Seção de adicionar produtos
      const addProdutosHtml = `
        <div style='margin-top:20px;padding-top:20px;border-top:2px solid #e5e7eb;'>
          <h4 style='font-weight:600;color:#374151;margin-bottom:12px;font-size:1.1em;'>Adicionar Produto:</h4>
          <div style='display:flex;gap:12px;align-items:end;flex-wrap:wrap;'>
            <div style='flex:1;min-width:200px;'>
              <label style='font-weight:500;color:#6b7280;font-size:0.9em;margin-bottom:4px;display:block;'>Selecionar Produto:</label>
              <select id='select-produto' style='width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:1em;background:#fff;transition:border 0.2s;outline:none;' onfocus='this.style.borderColor="#005a9f"' onblur='this.style.borderColor="#e5e7eb"'>
                <option value="">Escolha um produto...</option>
                ${produtos.map(p => {
                  const preco = parseFloat(p.preco_venda || 0);
                  return `<option value='${p.id}' data-preco='${preco}'>${p.nome} - R$ ${preco.toFixed(2).replace('.', ',')}</option>`;
                }).join('')}
              </select>
            </div>
            <div style='min-width:120px;'>
              <label style='font-weight:500;color:#6b7280;font-size:0.9em;margin-bottom:4px;display:block;'>Quantidade:</label>
              <input type='number' id='input-quantidade-add' min='1' value='1' style='width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:1em;text-align:center;transition:border 0.2s;outline:none;' onfocus='this.style.borderColor="#005a9f"' onblur='this.style.borderColor="#e5e7eb"' />
            </div>
            <button id='btn-add-produto' class='btn btn-primary' style='padding:10px 20px;font-size:1em;height:42px;display:flex;align-items:center;gap:8px;'>
              <i class='fas fa-plus'></i> Adicionar
            </button>
          </div>
          <div id='produto-info' style='margin-top:8px;font-size:0.9em;color:#6b7280;display:none;'></div>
        </div>`;
      
      // Adicionar a seção de produtos ao modal
      document.getElementById('produtos-mesa-lista').insertAdjacentHTML('beforeend', addProdutosHtml);
      
      // Preencher select de produtos
      const select = document.getElementById('select-produto');
      
      // Mostrar informações do produto selecionado
      select.onchange = function() {
        const prodId = this.value;
        const infoDiv = document.getElementById('produto-info');
        if (prodId) {
          const prod = produtos.find(p => String(p.id) === String(prodId));
          if (prod) {
            const preco = parseFloat(prod.preco_venda || 0);
            infoDiv.innerHTML = `<i class="fas fa-info-circle"></i> <strong>${prod.nome}</strong> - Preço: R$ ${preco.toFixed(2).replace('.', ',')} | Estoque: ${prod.estoque || 0} unidades`;
            infoDiv.style.display = 'block';
          }
        } else {
          infoDiv.style.display = 'none';
        }
      };
      
      // Adicionar produto
      document.getElementById('btn-add-produto').onclick = function() {
        const prodId = select.value;
        const qtd = parseInt(document.getElementById('input-quantidade-add').value) || 1;
        
        if (!prodId) {
          alert('Selecione um produto!');
          return;
        }
        
        const prod = produtos.find(p => String(p.id) === String(prodId));
        if (!prod) return;
        
        // Verificar estoque
        if (qtd > (prod.estoque ?? 0)) {
          alert(`Quantidade maior que o estoque disponível! Estoque: ${prod.estoque || 0} unidades`);
          return;
        }
        
        // Evitar duplicidade
        if ((itensEdit||[]).some(i => String(i.produto_id) === String(prodId))) {
          alert('Produto já adicionado!');
          return;
        }
        
        itensEdit = itensEdit || [];
        itensEdit.push({
          produto: prod.nome,
          produto_id: prod.id,
          quantidade: qtd,
          precoUnitario: parseFloat(prod.preco_venda) || 0,
          subtotal: (parseFloat(prod.preco_venda) || 0) * qtd
        });
        
        // Limpar campos
        select.value = '';
        document.getElementById('input-quantidade-add').value = '1';
        document.getElementById('produto-info').style.display = 'none';
        
        renderListaProdutos();
      };
      // Salvar alterações
      document.getElementById('btn-salvar-produtos').onclick = async function() {
        const novoNome = nomeEdit.trim();
        if (!novoNome) {
          alert('Informe o nome da mesa/pessoa!');
          return;
        }
        const valor_total = (itensEdit || []).reduce((sum, i) => {
          const precoUnitario = parseFloat(i.precoUnitario || i.preco_unitario || 0);
          const quantidade = parseInt(i.quantidade || 0);
          const subtotal = quantidade * precoUnitario;
          return sum + subtotal;
        }, 0);
        const putBody = {
          ...pedido,
          nome_cliente: novoNome || pedido.nome_cliente || pedido.nome_mesa || 'Mesa/Pessoa',
          itens: (itensEdit || []).map(i => ({
            produto: i.produto || 'Produto não identificado',
            produto_id: i.produto_id,
            quantidade: parseInt(i.quantidade || 0),
            preco_unitario: parseFloat(i.precoUnitario || i.preco_unitario || 0),
            subtotal: parseFloat(i.subtotal || 0)
          })),
          cliente_id: pedido.cliente_id ?? null,
          data_pedido: getDataHojeBR(),
          status: pedido.status ?? 'Em Aberto',
          valor_total: valor_total || 0,
          observacoes: pedido.observacoes ?? ''
        };
        console.log('PUT /api/pedidos/' + id, putBody);
        console.log('Itens sendo enviados:', putBody.itens);
        await fetch(`/api/pedidos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(putBody)
        });
        await carregarPedidosAbertos();
        fecharModalEditarProdutos();
      };
      // Fechar modal
      document.getElementById('btn-fechar-modal-produtos').onclick = fecharModalEditarProdutos;
      document.getElementById('btn-cancelar-produtos').onclick = fecharModalEditarProdutos;
      function fecharModalEditarProdutos() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    window.abrirModalFinalizarMesa = function(id) {
      const modal = document.getElementById('modal-finalizar-mesa');
      const pedido = pedidosAbertos.find(p => p.id === id);
      if (!pedido) return;
      
      const total = (pedido.itens||[]).reduce((sum, i) => {
        const precoUnitario = parseFloat(i.precoUnitario || i.preco_unitario || 0);
        const quantidade = parseInt(i.quantidade || 0);
        return sum + (precoUnitario * quantidade);
      }, 0);
      
      modal.querySelector('h3').textContent = `Finalizar Mesa - ${pedido.nome_cliente || pedido.nome_mesa || 'Mesa/Pessoa'}`;
      
      // Melhorar informações de finalização
      const infoHtml = `
        <div style='background:#f9fafb;border-radius:10px;padding:16px;border:1px solid #e5e7eb;margin-bottom:16px;'>
          <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'>
            <span style='font-weight:600;color:#374151;'>Subtotal:</span>
            <span style='font-size:1.1em;color:#6b7280;'>R$ ${total.toFixed(2).replace('.', ',')}</span>
          </div>
          <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'>
            <span style='font-weight:600;color:#374151;'>Desconto (%):</span>
            <span id='desconto-valor' style='font-size:1.1em;color:#dc2626;'>R$ 0,00</span>
          </div>
          <div style='border-top:2px solid #e5e7eb;padding-top:12px;display:flex;justify-content:space-between;align-items:center;'>
            <span style='font-weight:700;color:#374151;font-size:1.1em;'>Total Final:</span>
            <span id='total-final' style='font-size:1.3em;font-weight:700;color:#059669;'>R$ ${total.toFixed(2).replace('.', ',')}</span>
          </div>
        </div>
        <div style='margin-bottom:16px;'>
          <label style='font-weight:500;color:#374151;margin-bottom:6px;display:block;'>Desconto (%):</label>
          <input type='number' id='desconto' min='0' max='100' value='0' style='width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:1em;text-align:center;transition:border 0.2s;outline:none;' onfocus='this.style.borderColor="#005a9f"' onblur='this.style.borderColor="#e5e7eb"' />
        </div>`;
      
      document.getElementById('finalizar-info').innerHTML = infoHtml;
      
      // Calcular desconto em tempo real
      const descontoInput = document.getElementById('desconto');
      const descontoValorSpan = document.getElementById('desconto-valor');
      const totalFinalSpan = document.getElementById('total-final');
      
      function calcularDesconto() {
        const descontoPercent = parseFloat(descontoInput.value) || 0;
        const valorDesconto = total * (descontoPercent / 100);
        const totalFinal = total - valorDesconto;
        
        descontoValorSpan.textContent = `R$ ${valorDesconto.toFixed(2).replace('.', ',')}`;
        totalFinalSpan.textContent = `R$ ${totalFinal.toFixed(2).replace('.', ',')}`;
        
        if (descontoPercent > 0) {
          descontoValorSpan.style.color = '#dc2626';
        } else {
          descontoValorSpan.style.color = '#6b7280';
        }
      }
      
      descontoInput.oninput = calcularDesconto;
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Botão de finalizar mesa
      document.getElementById('btn-finalizar-mesa').onclick = async function() {
        try {
          const descontoPercent = parseFloat(document.getElementById('desconto').value) || 0;
          const valorDesconto = total * (descontoPercent / 100);
          const totalFinal = total - valorDesconto;
          
          // Buscar dados completos do pedido
          const pedido = pedidosAbertos.find(p => p.id === id);
          if (!pedido) {
            alert('Pedido não encontrado!');
            return;
          }

          // Preparar dados para atualização incluindo todos os itens
          const itensFormatados = (pedido.itens || []).map(item => ({
            produto_id: item.produto_id,
            quantidade: item.quantidade,
            preco_unitario: item.precoUnitario || item.preco_unitario || 0
          }));

          const dadosAtualizacao = {
            cliente_id: pedido.cliente_id,
            nome_cliente: pedido.nome_cliente,
            data_pedido: pedido.data_pedido,
            status: 'Concluído',
            valor_total: totalFinal,
            observacoes: pedido.observacoes || '',
            itens: itensFormatados
          };

          // Fazer a requisição para atualizar o pedido
          const response = await fetch(`/api/pedidos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dadosAtualizacao)
          });

          if (!response.ok) {
            throw new Error('Erro ao finalizar mesa');
          }

          await carregarPedidosAbertos();
          fecharModalFinalizarMesa();
          alert('Mesa finalizada com sucesso!');
        } catch (error) {
          console.error('Erro ao finalizar mesa:', error);
          alert('Erro ao finalizar mesa: ' + error.message);
        }
      };
      
      // Fechar modal
      document.getElementById('btn-fechar-modal-finalizar').onclick = fecharModalFinalizarMesa;
      document.getElementById('btn-cancelar-finalizar').onclick = fecharModalFinalizarMesa;
      
      function fecharModalFinalizarMesa() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }
    // Adicionar função utilitária para data local BR
    function getDataHojeBR() {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const mes = String(hoje.getMonth() + 1).padStart(2, '0');
      const dia = String(hoje.getDate()).padStart(2, '0');
      return `${ano}-${mes}-${dia}`;
    }
  </script>
</body>
</html> 