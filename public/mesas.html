<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mesas e Pedidos em Aberto - J.P Sistemas Comercial</title>
  <link rel="icon" href="https://i.imgur.com/QgVsPmF.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
              --primary-color: #005a9f;
      --primary-dark: #003766;
      --primary-light: #0077cc;
      --secondary-color: #022656;
      --accent-color: #1e4a8a;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --background: #f8fafc;
      --surface: #ffffff;
      --border: #e5e7eb;
      --shadow: rgba(0, 90, 159, 0.1);
      --shadow-hover: rgba(0, 90, 159, 0.2);
      --success-color: #059669;
      --danger-color: #dc2626;
      --warning-color: #d97706;
      --light-color: #f9fafb;
      --dark-color: #111827;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --border-radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #005a9f 0%, #003766 100%);
      min-height: 100vh;
      color: var(--text-primary);
      padding: 0;
    }
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 20px 0;
      box-shadow: 0 4px 20px rgba(0, 90, 159, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo img {
      width: 150px;
      height: 67px;
      object-fit: contain;
      background: none;
      box-shadow: none;
      border-radius: 0;
      margin: 0;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-info span {
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      font-weight: 500;
    }
    .user-info #userDisplay {
      font-weight: 700;
    }
    .logout-btn {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }
    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 90, 159, 0.3);
    }
    .main-content {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 90, 159, 0.1);
      padding: 32px;
      margin-bottom: 32px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .card-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .card-header h2 {
      font-size: 1.8em;
      color: var(--dark-color);
      font-weight: 600;
      text-align: center;
      font-family: 'Poppins', sans-serif;
      background: none;
    }
    .mesas-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 32px;
      margin-top: 18px;
      padding-bottom: 8px;
      overflow-x: auto;
    }
    .mesa-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 18px rgba(0, 90, 159, 0.13);
      padding: 0 0 28px 0;
      margin-bottom: 0;
      position: relative;
      border: 2.5px solid #e5e7eb;
      transition: box-shadow 0.3s, border 0.2s, transform 0.2s;
      overflow: hidden;
      min-width: 320px;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 1.13em;
    }
    .mesa-card:hover {
      box-shadow: 0 8px 32px rgba(0, 90, 159, 0.18);
      border: 2.5px solid var(--primary-color);
      transform: translateY(-2px) scale(1.01);
    }
    .mesa-header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      color: #fff;
      padding: 14px 18px 10px 18px;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
              box-shadow: 0 2px 8px rgba(0,90,159,0.07);
    }
    .mesa-nome {
      font-size: 1.15em;
      font-weight: 700;
      color: #fff;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mesa-status {
      font-size: 0.98em;
      font-weight: 600;
      color: #ffe066;
      background: rgba(255,224,102,0.13);
      border-radius: 8px;
      padding: 2px 10px;
      margin-left: auto;
      text-shadow: 0 1px 2px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .mesa-itens {
      margin: 10px 0 4px 0;
      padding: 0 12px;
    }
    .mesa-itens table {
      width: 100%;
      border-collapse: collapse;
    }
    .mesa-itens th {
      background: #f3f4f6;
      color: var(--primary-color);
      font-weight: 600;
      text-align: right;
      border-bottom: 2px solid #e5e7eb;
    }
    .mesa-itens th:first-child {
      text-align: left;
    }
    .mesa-itens td {
      padding: 8px 6px;
      font-size: 1.05em;
      border-bottom: 1px solid #f0f0f0;
      text-align: right;
    }
    .mesa-itens td:first-child {
      text-align: left;
    }
    .mesa-itens tr:last-child td {
      border-bottom: none;
    }
    .mesa-total {
      font-size: 1.18em;
      font-weight: 700;
      color: var(--success-color);
      margin: 12px 18px 0 0;
      text-align: right;
      letter-spacing: 0.01em;
    }
    .mesa-acoes {
      display: flex;
      gap: 10px;
      margin: 18px 18px 0 0;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .mesa-acoes .btn {
      min-width: 40px;
      font-size: 1.15em;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(37,99,235,0.07);
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mesa-acoes .btn i { font-size: 1.08em; }
    .mesa-acoes .btn[title] { position: relative; }
    .mesa-acoes .btn[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 0.93em;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0.95;
      z-index: 10;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      font-family: "Poppins", sans-serif;
      font-weight: 500;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }
    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
    }
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #dc2626);
      color: white;
    }
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
    }
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
    }
    .nova-mesa-form {
      margin-bottom: 32px;
      background: #f9fafb;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 90, 159, 0.05);
      display: flex;
      gap: 16px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .nova-mesa-form .form-group {
      margin-bottom: 0;
      flex: 1;
    }
    @media (max-width: 900px) {
      .mesas-grid {
        grid-template-columns: 1fr;
      }
      .nova-mesa-form {
        flex-direction: column;
        gap: 10px;
      }
    }
    @media (max-width: 700px) {
      .mesas-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 12px;
      }
      .mesa-card { min-width: 180px; max-width: 98vw; }
      .mesa-header { flex-direction: column; align-items: flex-start; gap: 4px; }
      .mesa-status { margin-left: 0; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <img src="https://i.imgur.com/2jT2EPD.png" alt="Logo J.P Sistemas" />
      </div>
      <div class="user-info">
        <span>Bem-vindo, <span id="userDisplay"></span></span>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Sair
        </button>
        <a href="painel.html" class="logout-btn" style="background: var(--primary-light); margin-left: 8px;">
          <i class="fas fa-arrow-left"></i> Voltar
        </a>
      </div>
    </div>
  </header>
  <main class="main-content">
    <div class="card">
      <div class="card-header">
        <h2>Mesas / Pedidos em Aberto</h2>
      </div>
      <div id="mesa-feedback" style="display:none;margin-bottom:18px;text-align:center;font-weight:500;"></div>
      <form class="nova-mesa-form" id="nova-mesa-form">
        <div class="form-group" style="position:relative;display:flex;align-items:center;flex:1;">
          <span style="position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#005a9f;font-size:1.3em;"><i class="fas fa-chair"></i></span>
          <input type="text" id="mesa-nome" required placeholder="Ex: Mesa 1, João, Família Silva..." style="padding-left:40px;height:48px;font-size:1.13em;border-radius:8px;border:2px solid #e5e7eb;box-shadow:0 2px 8px rgba(0,90,159,0.07);transition:border 0.2s;outline:none;width:100%;" />
        </div>
        <button class="btn btn-primary" id="btn-criar-mesa" type="submit" style="height:48px;font-size:1.13em;padding:0 32px;box-shadow:0 4px 16px rgba(0,90,159,0.13);display:flex;align-items:center;gap:10px;">
          <i class="fas fa-plus"></i> Nova Mesa
        </button>
        <a href="pedidos.html" class="btn btn-secondary" style="height:48px;font-size:1.13em;padding:0 32px;display:flex;align-items:center;gap:10px;text-decoration:none;">
          <i class="fas fa-list"></i> Voltar para Pedidos
        </a>
      </form>
      <div class="mesas-grid" id="mesas-grid"></div>
    </div>
  </main>
  <footer class="footer" style="width:100%;text-align:center;padding:18px 0 12px 0;color:#000;font-size:15px;background:transparent;font-family:'Inter',sans-serif;letter-spacing:0.02em;">
    © 2025 J.P Sistemas. Todos os direitos reservados. <a href="https://whatsa.me/5548996852138/?t=Ola,%20gostaria%20de%20mais%20informacoes%20sobre%20os%20sistemas." target="_blank" style="color: #000; text-decoration: underline; font-weight: 500;">Fale conosco no WhatsApp</a>
  </footer>
  <!-- Modal de Edição de Produtos da Mesa -->
  <div id="modal-editar-produtos" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
    <div class="modal-content" style="background:#fff;border-radius:16px;max-width:700px;width:97vw;padding:48px 36px;box-shadow:0 8px 32px rgba(0,90,159,0.18);position:relative;">
      <h3 style="margin-bottom:18px;font-size:1.25em;font-weight:600;">Editar Produtos da Mesa</h3>
      <div id="produtos-mesa-lista"></div>

      <div style="margin-top:24px;text-align:right;">
        <button id="btn-salvar-produtos" class="btn btn-success"><i class="fas fa-save"></i> Salvar</button>
        <button id="btn-cancelar-produtos" class="btn btn-secondary" style="margin-left:8px;">Cancelar</button>
      </div>
      <button id="btn-fechar-modal-produtos" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;color:#888;cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <!-- Modal de Finalização com Desconto -->
  <div id="modal-finalizar-mesa" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
    <div class="modal-content" style="background:#fff;border-radius:16px;max-width:420px;width:95vw;padding:32px 24px;box-shadow:0 8px 32px rgba(0,90,159,0.18);position:relative;">
      <h3 style="margin-bottom:18px;font-size:1.25em;font-weight:600;">Finalizar Mesa</h3>
      <div id="finalizar-info"></div>
      <div style="margin-top:24px;text-align:right;">
        <button id="btn-fechar-modal-finalizar" class="btn btn-success"><i class="fas fa-save"></i> Finalizar</button>
        <button id="btn-cancelar-finalizar" class="btn btn-secondary" style="margin-left:8px;">Cancelar</button>
      </div>
      <button id="btn-fechar-modal-finalizar" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;color:#888;cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <script>
    let produtos = [];
    let pedidosAbertos = [];
    let username = '';

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      sessionStorage.removeItem('loggedIn');
      sessionStorage.removeItem('username');
      window.location.href = 'index.html';
    }
    document.addEventListener('DOMContentLoaded', () => {
      if (sessionStorage.getItem('loggedIn') !== 'true') {
        alert('Acesso negado. Por favor, realize o login.');
        window.location.href = 'index.html';
      }
      username = sessionStorage.getItem('username') || 'Usuário';
      document.getElementById('userDisplay').textContent = username;
      carregarProdutos();
      carregarPedidosAbertos();
      document.getElementById('mesa-nome').focus();
      document.getElementById('nova-mesa-form').addEventListener('submit', criarNovaMesa);
    });

    async function carregarProdutos() {
      try {
        const response = await fetch('/api/produtos');
        if (!response.ok) throw new Error('Erro ao buscar produtos');
        produtos = await response.json();
      } catch (e) {
        produtos = [];
      }
    }
    async function carregarPedidosAbertos() {
      try {
        const response = await fetch('/api/pedidos');
        if (!response.ok) throw new Error('Erro ao buscar pedidos');
        const todos = await response.json();
        console.log('Pedidos recebidos:', todos);
        pedidosAbertos = (todos || []).filter(p => p.status === 'Em Aberto');
        console.log('Pedidos em aberto:', pedidosAbertos);
        console.log('Itens dos pedidos:', pedidosAbertos.map(p => ({ id: p.id, itens: p.itens })));
        renderMesas();
      } catch (e) {
        console.error('Erro ao buscar pedidos:', e);
        renderMesas();
      }
    }
    function renderMesas() {
      console.log('Renderizando mesas:', pedidosAbertos);
      const grid = document.getElementById('mesas-grid');
      grid.innerHTML = '';
      if (!pedidosAbertos.length) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#888;font-size:1.1em;">Nenhuma mesa/pedido em aberto.</div>';
        return;
      }
      pedidosAbertos.forEach(pedido => {
        console.log('Renderizando pedido:', pedido.id, 'Itens:', pedido.itens);
        let total = (pedido.itens||[]).reduce((sum, i) => {
          const precoUnitario = parseFloat(i.precoUnitario || i.preco_unitario || 0);
          const quantidade = parseInt(i.quantidade || 0);
          return sum + (precoUnitario * quantidade);
        }, 0);
        const card = document.createElement('div');
        card.className = 'mesa-card';
        card.innerHTML = `
          <div class="mesa-header">
            <div class="mesa-nome"><i class="fas fa-chair"></i> ${(pedido.nome_cliente && pedido.nome_cliente.trim()) || pedido.nome_mesa || 'Mesa/Pessoa'}</div>
            <div class="mesa-status"><i class="fas fa-clock"></i> ${pedido.status}</div>
          </div>
          <div class="mesa-itens">
            <table>
              <thead><tr><th>Produto</th><th>Qtd</th><th>Preço</th><th>Subtotal</th></tr></thead>
              <tbody>
                ${(pedido.itens||[]).map(i => {
                  const produtoNome = i.produto || i.nome_produto || 'Produto não identificado';
                  const quantidade = parseInt(i.quantidade || 0);
                  const precoUnitario = parseFloat(i.precoUnitario || i.preco_unitario || 0);
                  const subtotal = parseFloat(i.subtotal || 0);
                  return `<tr><td>${produtoNome}</td><td>${quantidade}</td><td>R$ ${precoUnitario.toFixed(2).replace('.', ',')}</td><td>R$ ${subtotal.toFixed(2).replace('.', ',')}</td></tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
          <div class="mesa-total">Total: R$ ${total.toFixed(2).replace('.', ',')}</div>
          <div class="mesa-acoes">
            <button class="btn btn-secondary" title="Editar Produtos" onclick="abrirModalEditarProdutos(${pedido.id})"><i class='fas fa-edit'></i></button>
            <button class="btn btn-success" title="Finalizar Mesa" onclick="abrirModalFinalizarMesa(${pedido.id})"><i class='fas fa-check'></i></button>
            <button class="btn btn-primary" title="Imprimir Comanda" onclick="imprimirComanda(${pedido.id})"><i class='fas fa-print'></i></button>
            <button class="btn btn-danger" title="Excluir Mesa" onclick="excluirMesa(${pedido.id})"><i class='fas fa-trash'></i></button>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    async function criarNovaMesa(e) {
      e.preventDefault();
      const nomeInput = document.getElementById('mesa-nome');
      const feedback = document.getElementById('mesa-feedback');
      const btn = document.getElementById('btn-criar-mesa');
      const nome = nomeInput.value.trim();
      feedback.style.display = 'none';
      if (!nome) {
        feedback.textContent = 'Informe o nome da mesa ou pessoa!';
        feedback.style.color = '#dc2626';
        feedback.style.display = 'block';
        nomeInput.focus();
        return;
      }
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
      const pedido = {
        nome_cliente: nome,
        status: 'Em Aberto',
        itens: [],
        data_pedido: new Date().toISOString().split('T')[0]
      };
      try {
        const response = await fetch('/api/pedidos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(pedido)
        });
        let novoPedido = null;
        const contentType = response.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          try {
            novoPedido = await response.json();
          } catch (e) {
            console.warn('Falha ao parsear JSON da resposta:', e);
          }
        } else if (response.ok) {
          // Resposta não é JSON, mas status é sucesso
          console.warn('Resposta não é JSON, mas status é sucesso. Mesa criada, mas resposta inesperada.');
        }
        if (response.ok) {
          if (novoPedido && novoPedido.id) {
            // Buscar o pedido recém-criado
            const respPedido = await fetch(`/api/pedidos/${novoPedido.id}`);
            if (respPedido.ok) {
              const respPedidoContentType = respPedido.headers.get('content-type') || '';
              let pedidoCompleto = null;
              if (respPedidoContentType.includes('application/json')) {
                try {
                  pedidoCompleto = await respPedido.json();
                } catch (e) {
                  console.warn('Falha ao parsear JSON do pedido recém-criado:', e);
                }
              } else {
                console.warn('Resposta de /api/pedidos/:id não é JSON. Status:', respPedido.status, 'Content-Type:', respPedidoContentType);
              }
              if (pedidoCompleto) {
                pedidoCompleto.nome_cliente = pedidoCompleto.nome_cliente || nome;
                pedidosAbertos.unshift(pedidoCompleto);
              } else {
                // fallback: adicionar só com nome
                pedidosAbertos.unshift({ id: novoPedido?.id, nome_cliente: nome, status: 'Em Aberto', itens: [], data_pedido: pedido.data_pedido });
              }
            } else {
              // fallback: adicionar só com nome
              pedidosAbertos.unshift({ id: novoPedido?.id, nome_cliente: nome, status: 'Em Aberto', itens: [], data_pedido: pedido.data_pedido });
            }
            renderMesas();
          } else {
            await carregarPedidosAbertos();
          }
          nomeInput.value = '';
          feedback.textContent = contentType.includes('application/json') ? 'Mesa criada com sucesso!' : 'Mesa criada! (resposta inesperada, atualize a página se não aparecer)';
          feedback.style.color = '#059669';
          feedback.style.display = 'block';
          nomeInput.focus();
          setTimeout(() => { feedback.style.display = 'none'; }, 2000);
          return;
        }
        // Se chegou aqui, é erro HTTP
        let msg = 'Erro ao criar mesa/pedido!';
        if (contentType.includes('application/json')) {
          try {
            const errData = await response.json();
            if (errData && errData.error) msg += ': ' + errData.error;
          } catch (e) {
            console.warn('Falha ao parsear JSON do erro:', e);
          }
        } else {
          console.warn('Resposta de erro não é JSON. Status:', response.status, 'Content-Type:', contentType);
        }
        throw new Error(msg);
      } catch (e) {
        feedback.textContent = 'Erro ao criar mesa/pedido!';
        feedback.style.color = '#dc2626';
        feedback.style.display = 'block';
        console.error('Erro real ao criar mesa/pedido:', e);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus"></i> Nova Mesa';
      }
    }
    window.editarMesa = async function(id) {
      const pedido = pedidosAbertos.find(p => p.id === id);
      if (!pedido) return;
      const nome = prompt('Editar nome da mesa/pessoa:', pedido.nome_cliente || '');
      if (nome !== null && nome.trim() !== '' && nome !== pedido.nome_cliente) {
        pedido.nome_cliente = nome.trim();
        await fetch(`/api/pedidos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome_cliente: pedido.nome_cliente })
        });
      }
      // Adicionar produtos
      let continuar = true;
      while (continuar) {
        const prodNome = prompt('Digite o nome/código do produto para adicionar (ou deixe vazio para sair):');
        if (!prodNome) break;
        const prod = produtos.find(p => p.nome.toLowerCase().includes(prodNome.toLowerCase()) || String(p.codigo||'').toLowerCase() === prodNome.toLowerCase());
        if (!prod) {
          alert('Produto não encontrado!');
          continue;
        }
        const qtd = parseInt(prompt('Quantidade:', '1')) || 1;
        if (qtd > (prod.estoque ?? 0)) {
          alert('Quantidade maior que o estoque disponível!');
          continue;
        }
        const item = {
          produto: prod.nome,
          produto_id: prod.id,
          quantidade: qtd,
          precoUnitario: parseFloat(prod.preco_venda) || 0,
          subtotal: (parseFloat(prod.preco_venda) || 0) * qtd
        };
        pedido.itens = pedido.itens || [];
        pedido.itens.push(item);
        await fetch(`/api/pedidos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ itens: pedido.itens })
        });
        await carregarPedidosAbertos();
        continuar = confirm('Adicionar mais produtos?');
      }
      await carregarPedidosAbertos();
    }
    window.finalizarMesa = async function(id) {
      if (!confirm('Finalizar este pedido/mesa?')) return;
      
      try {
        // Buscar dados completos do pedido
        const pedido = pedidosAbertos.find(p => p.id === id);
        if (!pedido) {
          alert('Pedido não encontrado!');
          return;
        }

        // Preparar dados para atualização incluindo todos os itens
        const itensFormatados = (pedido.itens || []).map(item => ({
          produto_id: item.produto_id,
          quantidade: item.quantidade,
          preco_unitario: item.precoUnitario || item.preco_unitario || 0
        }));

        const dadosAtualizacao = {
          cliente_id: pedido.cliente_id,
          nome_cliente: pedido.nome_cliente,
          data_pedido: pedido.data_pedido,
          status: 'Concluído',
          valor_total: pedido.valor_total,
          observacoes: pedido.observacoes,
          itens: itensFormatados
        };

        // Fazer a requisição para atualizar o pedido
        const response = await fetch(`/api/pedidos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dadosAtualizacao)
        });

        if (!response.ok) {
          throw new Error('Erro ao finalizar mesa');
        }

        await carregarPedidosAbertos();
        alert('Mesa finalizada com sucesso!');
      } catch (error) {
        console.error('Erro ao finalizar mesa:', error);
        alert('Erro ao finalizar mesa: ' + error.message);
      }
    }
    window.imprimirComanda = function(id) {
      const pedido = pedidosAbertos.find(p => p.id === id);
      if (!pedido) return;
      const data = new Date(pedido.data_pedido || Date.now());
      const dataStr = data.toLocaleDateString('pt-BR');
      let total = (pedido.itens||[]).reduce((sum, i) => sum + (i.precoUnitario||0) * (i.quantidade||0), 0);
      // Buscar informações da empresa antes de imprimir
      fetch('/api/empresa').then(res => res.json()).then(empresa => {
        const html = `
        <html><head><title>Comanda - ${pedido.nome_cliente||''}</title>
        <style>
          body { font-family: monospace; font-size: 13px; margin: 0; padding: 0; }
          .cupom { width: 280px; margin: 0 auto; padding: 10px; }
          .cupom h2 { text-align: center; font-size: 1.1em; margin: 0 0 8px 0; }
          .cupom .linha { border-top: 1px dashed #000; margin: 6px 0; }
          .cupom .info { margin-bottom: 8px; }
          .cupom table { width: 100%; border-collapse: collapse; }
          .cupom th, .cupom td { font-size: 13px; padding: 2px 0; text-align: left; }
          .cupom th { border-bottom: 1px solid #000; }
          .cupom .total { font-weight: bold; font-size: 1.1em; text-align: right; margin-top: 8px; }
          .cupom .footer { text-align: center; font-size: 11px; margin-top: 10px; }
          @media print { body { margin: 0; } .cupom { box-shadow: none; border: none; } }
        </style></head><body onload='window.print()'>
        <div class='cupom'>
          <h2>COMANDA - ${empresa.nome_fantasia || 'J.P Sistemas'}</h2>
          <div style='text-align:center;font-size:12px;margin-bottom:6px;'>
            <div><b>${empresa.razao_social || ''}</b></div>
            <div>CNPJ: ${empresa.cnpj || ''}</div>
            <div>${empresa.endereco || ''}</div>
            <div>${empresa.email || ''}</div>
            <div>${empresa.telefone || ''}</div>
          </div>
          <div class='info'>
            <b>Mesa/Pessoa:</b> ${pedido.nome_cliente || pedido.nome_mesa || ''}<br>
            <b>Data:</b> ${dataStr}<br>
            <b>Status:</b> ${pedido.status}
          </div>
          <div class='linha'></div>
          <table>
            <thead><tr><th>Produto</th><th>Qtd</th><th>Vlr</th><th>Sub</th></tr></thead>
            <tbody>
              ${(pedido.itens||[]).map(i => `<tr><td>${i.produto}</td><td>${i.quantidade}</td><td>${(Number(i.precoUnitario ?? i.preco_unitario) || 0).toFixed(2)}</td><td>${(Number(i.subtotal) || 0).toFixed(2)}</td></tr>`).join('')}
            </tbody>
          </table>
          <div class='linha'></div>
          <div class='total'>TOTAL: R$ ${total.toFixed(2).replace('.', ',')}</div>
          <div class='footer'>Cupom não fiscal - ${new Date().toLocaleString('pt-BR')}<br>Powered by J.P Sistemas</div>
        </div>
        </body></html>
      `;
      const win = window.open('', '', 'width=320,height=600');
      win.document.write(html);
      win.document.close();
      });
    }
    window.excluirMesa = async function(id) {
      if (!confirm('Tem certeza que deseja excluir esta mesa/pedido?')) return;
      try {
        const resp = await fetch(`/api/pedidos/${id}`, { method: 'DELETE' });
        if (!resp.ok) throw new Error('Erro ao excluir mesa');
        pedidosAbertos = pedidosAbertos.filter(p => p.id !== id);
        renderMesas();
      } catch (e) {
        alert('Erro ao excluir mesa!');
      }
    }
    // Funções para abrir modais de edição e finalização de mesa
    window.abrirModalEditarProdutos = function(id) {
      const modal = document.getElementById('modal-editar-produtos');
      const pedido = pedidosAbertos.find(p => p.id === id);
      if (!pedido) return;
      // Variáveis locais para edição
      let itensEdit = JSON.parse(JSON.stringify(pedido.itens || []));
      let nomeEdit = pedido.nome_cliente || '';

      function renderListaProdutos() {
        // Campo para editar nome
        let nomeHtml = `<div style='margin-bottom:16px;'><label style='font-weight:500;color:#374151;'>Nome da Mesa/Pessoa:</label><input id='input-nome-mesa' type='text' value='${nomeEdit}' style='width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:1em;margin-top:6px;transition:border 0.2s;outline:none;' onfocus='this.style.borderColor="#005a9f"' onblur='this.style.borderColor="#e5e7eb"'/></div>`;
        
        // Calcular total
        const total = (itensEdit||[]).reduce((sum, item) => {
          const precoUnitario = parseFloat(item.precoUnitario || item.preco_unitario || 0);
          const quantidade = parseInt(item.quantidade || 0);
          const subtotal = quantidade * precoUnitario;
          return sum + subtotal;
        }, 0);
        
        // Listar produtos já adicionados
        let itensHtml = '';
        if ((itensEdit||[]).length > 0) {
          itensHtml = `
            <div style='margin-bottom:16px;'>
              <h4 style='font-weight:600;color:#374151;margin-bottom:12px;font-size:1.1em;'>Produtos Adicionados:</h4>
              <div style='background:#f9fafb;border-radius:10px;padding:16px;border:1px solid #e5e7eb;'>
                <table style='width:100%;border-collapse:collapse;font-size:0.95em;'>
                  <thead>
                    <tr style='border-bottom:2px solid #e5e7eb;'>
                      <th style='text-align:left;padding:8px 4px;color:#374151;font-weight:600;'>Produto</th>
                      <th style='text-align:center;padding:8px 4px;color:#374151;font-weight:600;'>Qtd</th>
                      <th style='text-align:right;padding:8px 4px;color:#374151;font-weight:600;'>Preço Unit.</th>
                      <th style='text-align:right;padding:8px 4px;color:#374151;font-weight:600;'>Subtotal</th>
                      <th style='text-align:center;padding:8px 4px;color:#374151;font-weight:600;'>Ação</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${(itensEdit||[]).map((item, idx) => {
                      const precoUnitario = parseFloat(item.precoUnitario || item.preco_unitario || 0);
                      const quantidade = parseInt(item.quantidade || 0);
                      const subtotal = quantidade * precoUnitario;
                      return `<tr style='border-bottom:1px solid #f0f0f0;'>
                        <td style='padding:8px 4px;font-weight:500;color:#374151;'>${item.produto}</td>
                        <td style='text-align:center;padding:8px 4px;'>
                          <input type='number' min='1' value='${quantidade}' data-idx='${idx}' class='input-quantidade' style='width:50px;padding:4px 6px;border-radius:6px;border:1.5px solid #e5e7eb;font-size:0.9em;text-align:center;' />
                        </td>
                        <td style='text-align:right;padding:8px 4px;color:#6b7280;'>R$ ${precoUnitario.toFixed(2).replace('.', ',')}</td>
                        <td style='text-align:right;padding:8px 4px;font-weight:600;color:#059669;'>R$ ${subtotal.toFixed(2).replace('.', ',')}</td>
                        <td style='text-align:center;padding:8px 4px;'>
                          <button class='btn btn-danger btn-remover-produto' data-idx='${idx}' title='Remover' style='padding:4px 8px;font-size:0.85em;'><i class='fas fa-trash'></i></button>
                        </td>
                      </tr>`;
                    }).join('')}
                  </tbody>
                </table>
                <div style='margin-top:16px;padding-top:12px;border-top:2px solid #e5e7eb;text-align:right;'>
                  <div style='font-size:1.2em;font-weight:700;color:#059669;'>Total da Mesa: R$ ${total.toFixed(2).replace('.', ',')}</div>
                </div>
              </div>
            </div>`;
        } else {
          itensHtml = '<div style="color:#888;font-size:0.98em;text-align:center;padding:20px;background:#f9fafb;border-radius:10px;border:1px solid #e5e7eb;"><i class="fas fa-shopping-cart" style="font-size:1.5em;margin-bottom:8px;display:block;"></i>Nenhum produto adicionado.</div>';
        }
        
        document.getElementById('produtos-mesa-lista').innerHTML = nomeHtml + itensHtml;
        
        // Atualizar nomeEdit ao digitar
        document.getElementById('input-nome-mesa').oninput = function() {
          nomeEdit = this.value;
        };
        
        // Alterar quantidade
        document.querySelectorAll('.input-quantidade').forEach(input => {
          input.onchange = function() {
            const idx = this.getAttribute('data-idx');
            let val = parseInt(this.value) || 1;
            if (val < 1) val = 1;
            itensEdit[idx].quantidade = val;
            const precoUnitario = parseFloat(itensEdit[idx].precoUnitario || itensEdit[idx].preco_unitario || 0);
            itensEdit[idx].subtotal = val * precoUnitario;
            renderListaProdutos(); // Re-renderizar para atualizar subtotais
          };
        });
        
        // Remover produto
        document.querySelectorAll('.btn-remover-produto').forEach(btn => {
          btn.onclick = function() {
            const idx = this.getAttribute('data-idx');
            itensEdit.splice(idx, 1);
            renderListaProdutos();
          };
        });
      }
      renderListaProdutos();
      
      // Seção de adicionar produtos
      const addProdutosHtml = `
        <div style='margin-top:20px;padding-top:20px;border-top:2px solid #e5e7eb;'>
          <h4 style='font-weight:600;color:#374151;margin-bottom:12px;font-size:1.1em;'>Adicionar Produto:</h4>
          <div style='display:flex;gap:12px;align-items:end;flex-wrap:wrap;'>
            <div style='flex:1;min-width:200px;'>
              <label style='font-weight:500;color:#6b7280;font-size:0.9em;margin-bottom:4px;display:block;'>Selecionar Produto:</label>
              <select id='select-produto' style='width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:1em;background:#fff;transition:border 0.2s;outline:none;' onfocus='this.style.borderColor="#005a9f"' onblur='this.style.borderColor="#e5e7eb"'>
                <option value="">Escolha um produto...</option>
                ${produtos.map(p => {
                  const preco = parseFloat(p.preco_venda || 0);
                  return `<option value='${p.id}' data-preco='${preco}'>${p.nome} - R$ ${preco.toFixed(2).replace('.', ',')}</option>`;
                }).join('')}
              </select>
            </div>
            <div style='min-width:120px;'>
              <label style='font-weight:500;color:#6b7280;font-size:0.9em;margin-bottom:4px;display:block;'>Quantidade:</label>
              <input type='number' id='input-quantidade-add' min='1' value='1' style='width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:1em;text-align:center;transition:border 0.2s;outline:none;' onfocus='this.style.borderColor="#005a9f"' onblur='this.style.borderColor="#e5e7eb"' />
            </div>
            <button id='btn-add-produto' class='btn btn-primary' style='padding:10px 20px;font-size:1em;height:42px;display:flex;align-items:center;gap:8px;'>
              <i class='fas fa-plus'></i> Adicionar
            </button>
          </div>
          <div id='produto-info' style='margin-top:8px;font-size:0.9em;color:#6b7280;display:none;'></div>
        </div>`;
      
      // Adicionar a seção de produtos ao modal
      document.getElementById('produtos-mesa-lista').insertAdjacentHTML('beforeend', addProdutosHtml);
      
      // Preencher select de produtos
      const select = document.getElementById('select-produto');
      
      // Mostrar informações do produto selecionado
      select.onchange = function() {
        const prodId = this.value;
        const infoDiv = document.getElementById('produto-info');
        if (prodId) {
          const prod = produtos.find(p => String(p.id) === String(prodId));
          if (prod) {
            const preco = parseFloat(prod.preco_venda || 0);
            infoDiv.innerHTML = `<i class="fas fa-info-circle"></i> <strong>${prod.nome}</strong> - Preço: R$ ${preco.toFixed(2).replace('.', ',')} | Estoque: ${prod.estoque || 0} unidades`;
            infoDiv.style.display = 'block';
          }
        } else {
          infoDiv.style.display = 'none';
        }
      };
      
      // Adicionar produto
      document.getElementById('btn-add-produto').onclick = function() {
        const prodId = select.value;
        const qtd = parseInt(document.getElementById('input-quantidade-add').value) || 1;
        
        if (!prodId) {
          alert('Selecione um produto!');
          return;
        }
        
        const prod = produtos.find(p => String(p.id) === String(prodId));
        if (!prod) return;
        
        // Verificar estoque
        if (qtd > (prod.estoque ?? 0)) {
          alert(`Quantidade maior que o estoque disponível! Estoque: ${prod.estoque || 0} unidades`);
          return;
        }
        
        // Evitar duplicidade
        if ((itensEdit||[]).some(i => String(i.produto_id) === String(prodId))) {
          alert('Produto já adicionado!');
          return;
        }
        
        itensEdit = itensEdit || [];
        itensEdit.push({
          produto: prod.nome,
          produto_id: prod.id,
          quantidade: qtd,
          precoUnitario: parseFloat(prod.preco_venda) || 0,
          subtotal: (parseFloat(prod.preco_venda) || 0) * qtd
        });
        
        // Limpar campos
        select.value = '';
        document.getElementById('input-quantidade-add').value = '1';
        document.getElementById('produto-info').style.display = 'none';
        
        renderListaProdutos();
      };
      // Salvar alterações
      document.getElementById('btn-salvar-produtos').onclick = async function() {
        const novoNome = nomeEdit.trim();
        if (!novoNome) {
          alert('Informe o nome da mesa/pessoa!');
          return;
        }
        const valor_total = (itensEdit || []).reduce((sum, i) => {
          const precoUnitario = parseFloat(i.precoUnitario || i.preco_unitario || 0);
          const quantidade = parseInt(i.quantidade || 0);
          const subtotal = quantidade * precoUnitario;
          return sum + subtotal;
        }, 0);
        const putBody = {
          ...pedido,
          nome_cliente: novoNome || pedido.nome_cliente || pedido.nome_mesa || 'Mesa/Pessoa',
          itens: (itensEdit || []).map(i => ({
            produto: i.produto || 'Produto não identificado',
            produto_id: i.produto_id,
            quantidade: parseInt(i.quantidade || 0),
            preco_unitario: parseFloat(i.precoUnitario || i.preco_unitario || 0),
            subtotal: parseFloat(i.subtotal || 0)
          })),
          cliente_id: pedido.cliente_id ?? null,
          data_pedido: (pedido.data_pedido ?? new Date().toISOString().split('T')[0]).split('T')[0],
          status: pedido.status ?? 'Em Aberto',
          valor_total: valor_total || 0,
          observacoes: pedido.observacoes ?? ''
        };
        console.log('PUT /api/pedidos/' + id, putBody);
        console.log('Itens sendo enviados:', putBody.itens);
        await fetch(`/api/pedidos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(putBody)
        });
        await carregarPedidosAbertos();
        fecharModalEditarProdutos();
      };
      // Fechar modal
      document.getElementById('btn-fechar-modal-produtos').onclick = fecharModalEditarProdutos;
      document.getElementById('btn-cancelar-produtos').onclick = fecharModalEditarProdutos;
      function fecharModalEditarProdutos() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    window.abrirModalFinalizarMesa = function(id) {
      const modal = document.getElementById('modal-finalizar-mesa');
      const pedido = pedidosAbertos.find(p => p.id === id);
      if (!pedido) return;
      
      const total = (pedido.itens||[]).reduce((sum, i) => {
        const precoUnitario = parseFloat(i.precoUnitario || i.preco_unitario || 0);
        const quantidade = parseInt(i.quantidade || 0);
        return sum + (precoUnitario * quantidade);
      }, 0);
      
      modal.querySelector('h3').textContent = `Finalizar Mesa - ${pedido.nome_cliente || pedido.nome_mesa || 'Mesa/Pessoa'}`;
      
      // Melhorar informações de finalização
      const infoHtml = `
        <div style='background:#f9fafb;border-radius:10px;padding:16px;border:1px solid #e5e7eb;margin-bottom:16px;'>
          <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'>
            <span style='font-weight:600;color:#374151;'>Subtotal:</span>
            <span style='font-size:1.1em;color:#6b7280;'>R$ ${total.toFixed(2).replace('.', ',')}</span>
          </div>
          <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'>
            <span style='font-weight:600;color:#374151;'>Desconto (%):</span>
            <span id='desconto-valor' style='font-size:1.1em;color:#dc2626;'>R$ 0,00</span>
          </div>
          <div style='border-top:2px solid #e5e7eb;padding-top:12px;display:flex;justify-content:space-between;align-items:center;'>
            <span style='font-weight:700;color:#374151;font-size:1.1em;'>Total Final:</span>
            <span id='total-final' style='font-size:1.3em;font-weight:700;color:#059669;'>R$ ${total.toFixed(2).replace('.', ',')}</span>
          </div>
        </div>
        <div style='margin-bottom:16px;'>
          <label style='font-weight:500;color:#374151;margin-bottom:6px;display:block;'>Desconto (%):</label>
          <input type='number' id='desconto' min='0' max='100' value='0' style='width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:1em;text-align:center;transition:border 0.2s;outline:none;' onfocus='this.style.borderColor="#005a9f"' onblur='this.style.borderColor="#e5e7eb"' />
        </div>`;
      
      document.getElementById('finalizar-info').innerHTML = infoHtml;
      
      // Calcular desconto em tempo real
      const descontoInput = document.getElementById('desconto');
      const descontoValorSpan = document.getElementById('desconto-valor');
      const totalFinalSpan = document.getElementById('total-final');
      
      function calcularDesconto() {
        const descontoPercent = parseFloat(descontoInput.value) || 0;
        const valorDesconto = total * (descontoPercent / 100);
        const totalFinal = total - valorDesconto;
        
        descontoValorSpan.textContent = `R$ ${valorDesconto.toFixed(2).replace('.', ',')}`;
        totalFinalSpan.textContent = `R$ ${totalFinal.toFixed(2).replace('.', ',')}`;
        
        if (descontoPercent > 0) {
          descontoValorSpan.style.color = '#dc2626';
        } else {
          descontoValorSpan.style.color = '#6b7280';
        }
      }
      
      descontoInput.oninput = calcularDesconto;
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Fechar modal
      document.getElementById('btn-fechar-modal-finalizar').onclick = fecharModalFinalizarMesa;
      document.getElementById('btn-cancelar-finalizar').onclick = fecharModalFinalizarMesa;
      
      function fecharModalFinalizarMesa() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }
  </script>
</body>
</html> 