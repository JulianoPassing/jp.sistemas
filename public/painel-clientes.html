<!--
  RESPONSIVIDADE MOBILE:
  - Este arquivo já inclui <meta name="viewport"> e mobile.css para responsividade.
  - Use as classes .coluna-desnecessaria ou .hide-mobile em <th> ou <td> para esconder colunas no mobile.
  - Para navegação fixa no rodapé, utilize <nav class="mobile-nav">.
  - Mantenha sempre o mobile.css atualizado para melhor experiência mobile.
-->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Clientes - J.P Sistemas Comercial</title>
  <link rel="icon" href="https://i.imgur.com/QgVsPmF.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="mobile.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="app-layout">
    <header>
      <div class="header-content">
        <div class="logo">
          <img src="https://i.imgur.com/2jT2EPD.png" alt="Logo J.P Sistemas" />
        </div>
        <nav>
          <span class="welcome-message">Bem-vindo, <span id="userDisplay"></span></span>
          <button class="btn btn-danger" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
          <a href="painel.html" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
          </a>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">
        <div class="dashboard">
          <div class="dashboard-header">
            <h1 class="dashboard-title">Gestão de Clientes</h1>
            <p class="dashboard-subtitle">Cadastre, edite e gerencie seus clientes de forma eficiente</p>
          </div>

          <!-- Formulário de Cadastro/Edição -->
          <div class="section">
            <div class="section-header">
              <h2 class="section-title" id="form-title">Cadastrar Novo Cliente</h2>
            </div>
            
            <div class="card">
              <form id="cliente-form">
                <div class="grid grid-cols-1 grid-cols-2 grid-cols-3">
                  <div class="form-group">
                    <label for="razao" class="form-label">Nome ou Razão Social</label>
                    <input type="text" id="razao" name="razao" class="form-input" required placeholder="Digite Nome ou Razão Social" />
                  </div>
                  <div class="form-group">
                    <label for="cnpj" class="form-label">CPF/CNPJ</label>
                    <input type="text" id="cnpj" name="cnpj" class="form-input" required placeholder="Digite CPF ou CNPJ" />
                  </div>
                  <div class="form-group">
                    <label for="ie" class="form-label">IE (Opcional)</label>
                    <input type="text" id="ie" name="ie" class="form-input" placeholder="Digite IE (se houver)" />
                  </div>
                  <div class="form-group">
                    <label for="endereco" class="form-label">Endereço</label>
                    <input type="text" id="endereco" name="endereco" class="form-input" placeholder="Digite o endereço (opcional)" />
                  </div>
                  <div class="form-group">
                    <label for="bairro" class="form-label">Bairro</label>
                    <input type="text" id="bairro" name="bairro" class="form-input" placeholder="Digite o bairro (opcional)" />
                  </div>
                  <div class="form-group">
                    <label for="cidade" class="form-label">Cidade</label>
                    <input type="text" id="cidade" name="cidade" class="form-input" required placeholder="Digite a cidade" />
                  </div>
                  <div class="form-group">
                    <label for="estado" class="form-label">Estado</label>
                    <input type="text" id="estado" name="estado" class="form-input" required placeholder="Digite o estado" />
                  </div>
                  <div class="form-group">
                    <label for="cep" class="form-label">CEP</label>
                    <input type="text" id="cep" name="cep" class="form-input" placeholder="Digite o CEP (opcional)" />
                  </div>
                  <div class="form-group">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" id="email" name="email" class="form-input" required placeholder="Digite o email" />
                  </div>
                  <div class="form-group">
                    <label for="telefone" class="form-label">Telefone</label>
                    <input type="text" id="telefone" name="telefone" class="form-input" required placeholder="Digite o telefone" />
                  </div>
                  <div class="form-group">
                    <label for="transporte" class="form-label">Transporte (Opcional)</label>
                    <input type="text" id="transporte" name="transporte" class="form-input" placeholder="Digite Transporte (se houver)" />
                  </div>
                  <div class="form-group">
                    <label for="prazo" class="form-label">Prazo (Opcional)</label>
                    <input type="text" id="prazo" name="prazo" class="form-input" placeholder="Digite Prazo (se houver)" />
                  </div>
                  <div class="form-group" style="grid-column: 1/3;">
                    <label for="obs" class="form-label">Observações</label>
                    <input type="text" id="obs" name="obs" class="form-input" placeholder="Digite observações (opcional)" />
                  </div>
                </div>
                <div class="actions">
                  <button type="submit" class="btn btn-primary" id="btn-salvar">
                    <i class="fas fa-save"></i> Salvar
                  </button>
                  <button type="button" class="btn btn-danger" id="btn-cancelar" style="display:none;">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                </div>
                <input type="hidden" id="cliente-id" />
              </form>
            </div>
          </div>

          <!-- Gestão de Clientes -->
          <div class="section">
            <div class="section-header">
              <h2 class="section-title">Gestão de Clientes</h2>
              <div class="btn-group">
                <button class="btn btn-primary" id="btn-exportar-pdf">
                  <i class="fas fa-file-pdf"></i> Baixar PDF
                </button>
                <button class="btn btn-success" id="btn-exportar-excel">
                  <i class="fas fa-file-excel"></i> Baixar Excel
                </button>
                <button class="btn btn-warning" id="btn-download-modelo">
                  <i class="fas fa-download"></i> Baixar Modelo
                </button>
                <button class="btn btn-info" id="btn-importar-planilha">
                  <i class="fas fa-upload"></i> Importar Planilha
                </button>
              </div>
            </div>
            
            <div class="search-container">
              <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="busca-cliente" placeholder="Buscar cliente..." autocomplete="off" />
              </div>
              <ul id="sugestoes-clientes" class="sugestoes-clientes"></ul>
            </div>

            <div class="table-container">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nome/Razão Social</th>
                      <th>CPF/CNPJ</th>
                      <th>Cidade/UF</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody id="clientes-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <p class="text-center">
          © 2025 J.P Sistemas. Todos os direitos reservados. 
          <a href="https://whatsa.me/5548996852138/?t=Ola,%20gostaria%20de%20mais%20informacoes%20sobre%20os%20sistemas." target="_blank" style="color: var(--white); text-decoration: underline; font-weight: 500;">Fale conosco no WhatsApp</a>
        </p>
      </div>
    </footer>
  </div>

  <!-- Input oculto para importação de arquivo -->
  <input type="file" id="input-importar" accept=".xlsx,.xls,.csv" style="display: none;" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* Estilos específicos para esta página */
    .btn-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      width: 100%;
      flex-wrap: wrap;
    }

    .search-container {
      display: flex;
      justify-content: center;
      position: relative;
      margin-bottom: 24px;
    }

    .search-box {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 500px;
      background: var(--white);
      border-radius: var(--border-radius-lg);
      border: 2px solid var(--gray-200);
      box-shadow: var(--shadow);
      padding: 4px 20px 4px 20px;
      transition: all 0.3s ease;
    }

    .search-box:focus-within {
      border-color: var(--terciary);
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .search-icon {
      font-size: 1.2rem;
      color: var(--terciary);
      margin-right: 12px;
      opacity: 0.8;
    }

    #busca-cliente {
      border: none;
      background: transparent;
      outline: none;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      width: 100%;
      padding: 12px 0;
      color: var(--gray-900);
    }

    #busca-cliente::placeholder {
      color: var(--gray-400);
      opacity: 1;
    }

    .sugestoes-clientes {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      background: var(--white);
      border: 2px solid var(--gray-200);
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      z-index: 1001;
      list-style: none;
      padding: 0;
      display: none;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.95rem;
    }

    .sugestoes-clientes.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .sugestoes-clientes li {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 1px solid var(--gray-100);
      transition: all 0.2s ease;
      color: var(--gray-900);
      line-height: 1.4;
    }

    .sugestoes-clientes li:last-child {
      border-bottom: none;
    }

    .sugestoes-clientes li:hover,
    .sugestoes-clientes li.active {
      background: var(--ea-green-100);
      color: var(--terciary);
    }

    .table-responsive {
      max-height: 500px;
      overflow-y: auto;
      border-radius: var(--border-radius);
    }

    .table-responsive::-webkit-scrollbar {
      width: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
      background: var(--terciary);
      border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
      background: var(--terciary-100);
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--white);
      max-width: 500px;
      margin: 60px auto;
      padding: 32px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
      position: relative;
      border: 1px solid var(--gray-200);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--terciary);
      font-weight: 600;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray-500);
      transition: color 0.2s ease;
    }

    .modal-close:hover {
      color: var(--gray-700);
    }

    .modal-body {
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .modal-content {
        margin: 20px;
        padding: 20px;
      }
      
      .modal-header {
        margin-bottom: 15px;
      }
      
      .modal-body {
        margin-top: 15px;
      }
    }
  </style>

  <script>
    const API_URL = '/api/clientes';
    let clientes = [];
    let clientesFiltrados = [];
    
    async function carregarClientes() {
      try {
        const resp = await fetch(API_URL, { credentials: 'include' });
        if (!resp.ok) throw new Error('Erro ao buscar clientes na API');
        clientes = await resp.json();
        clientesFiltrados = clientes;
        renderTabela();
      } catch (e) {
        alert('Erro ao carregar os dados dos clientes. Verifique se a API está disponível.');
      }
    }
    
    function renderTabela() {
      const tbody = document.getElementById('clientes-tbody');
      tbody.innerHTML = '';
      (clientesFiltrados || []).forEach(cli => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${cli.id ?? ''}</td>
          <td>${cli.razao ?? ''}</td>
          <td>${cli.cnpj ?? ''}</td>
          <td>${cli.cidade ?? ''} / ${cli.estado ?? ''}</td>
          <td>
            <button class="btn btn-primary btn-ver-mais" data-id="${cli.id}">
              <i class="fas fa-eye"></i> Ver Mais
            </button>
            <button class="btn btn-success btn-editar" data-id="${cli.id}">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button class="btn btn-danger btn-remover" data-id="${cli.id}">
              <i class="fas fa-trash"></i> Remover
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.btn-ver-mais').forEach(btn => {
        btn.onclick = function() {
          const id = this.getAttribute('data-id');
          const cliente = clientes.find(c => String(c.id) === String(id));
          if (cliente) mostrarModalCliente(cliente);
        };
      });
      
      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.onclick = function() {
          const id = this.getAttribute('data-id');
          const cliente = clientes.find(c => String(c.id) === String(id));
          if (cliente) preencherFormularioEdicao(cliente);
        };
      });
      
      document.querySelectorAll('.btn-remover').forEach(btn => {
        btn.onclick = async function() {
          const id = this.getAttribute('data-id');
          const cliente = clientes.find(c => String(c.id) === String(id));
          if (!cliente) return;
          
          const senha = prompt('Digite a senha para confirmar a exclusão:');
          if (senha !== 'excluir@95') {
            alert('Senha incorreta. Exclusão cancelada.');
            return;
          }
          
          if (confirm(`Tem certeza que deseja remover o cliente "${cliente.razao}"?`)) {
            try {
              await fetch(`${API_URL}/${id}`, { method: 'DELETE', credentials: 'include' });
              alert('Cliente removido com sucesso!');
              await carregarClientes();
            } catch (err) {
              alert('Erro ao remover cliente.');
            }
          }
        };
      });
    }
    
    function filtrarClientes(texto) {
      const termo = texto.trim().toLowerCase();
      if (!termo) {
        clientesFiltrados = clientes;
      } else {
        clientesFiltrados = clientes.filter(cli =>
          (cli.razao && String(cli.razao).toLowerCase().includes(termo)) ||
          (cli.cnpj && String(cli.cnpj).toLowerCase().includes(termo)) ||
          (cli.cidade && String(cli.cidade).toLowerCase().includes(termo)) ||
          (cli.estado && String(cli.estado).toLowerCase().includes(termo)) ||
          (cli.telefone && String(cli.telefone).toLowerCase().includes(termo)) ||
          (cli.email && String(cli.email).toLowerCase().includes(termo))
        );
      }
      renderTabela();
      mostrarSugestoes(texto);
    }
    
    function mostrarSugestoes(texto) {
      const ul = document.getElementById('sugestoes-clientes');
      const termo = texto.trim().toLowerCase();
      if (!termo || clientesFiltrados.length === 0) {
        ul.classList.remove('show');
        ul.innerHTML = '';
        return;
      }
      const sugestoes = clientesFiltrados.slice(0, 8);
      ul.innerHTML = sugestoes.map(cli =>
        `<li data-cnpj="${cli.cnpj}"><strong>${cli.razao}</strong><br><small>${cli.cnpj} - ${cli.cidade}/${cli.estado}</small></li>`
      ).join('');
      ul.classList.add('show');
    }
    
    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      sessionStorage.removeItem('loggedIn');
      sessionStorage.removeItem('username');
      window.location.href = 'sistema.html';
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      if (sessionStorage.getItem('loggedIn') !== 'true') {
        alert('Acesso negado. Por favor, realize o login.');
        window.location.href = 'index.html';
      }
      
      const username = sessionStorage.getItem('username') || 'Usuário';
      document.getElementById('userDisplay').textContent = username;
      
      carregarClientes();
      document.getElementById('btn-exportar-pdf').onclick = exportarClientesPDF;
      document.getElementById('btn-exportar-excel').onclick = exportarClientesExcel;
      document.getElementById('btn-download-modelo').onclick = downloadModeloPlanilha;
      document.getElementById('btn-importar-planilha').onclick = () => document.getElementById('input-importar').click();
      document.getElementById('input-importar').onchange = importarPlanilha;
      
      document.getElementById('busca-cliente').addEventListener('input', function() {
        filtrarClientes(this.value);
      });
      
      document.getElementById('sugestoes-clientes').addEventListener('mousedown', function(e) {
        if (e.target.tagName === 'LI' || e.target.closest('li')) {
          const li = e.target.closest('li');
          const texto = li.querySelector('strong').textContent;
          document.getElementById('busca-cliente').value = texto;
          filtrarClientes(texto);
          this.classList.remove('show');
        }
      });
      
      document.getElementById('busca-cliente').addEventListener('blur', function() {
        setTimeout(() => {
          document.getElementById('sugestoes-clientes').classList.remove('show');
        }, 150);
      });
    });

    function exportarClientesPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Configurações de cores
      const primaryColor = [0, 90, 159];
      const secondaryColor = [0, 55, 102];

      // Inserir logo no cabeçalho
      carregarImagemBase64('https://i.imgur.com/2jT2EPD.png', function(logoBase64) {
        // Logo centralizada
        const logoWidth = 50;
        const logoHeight = 22;
        const logoX = (210 - logoWidth) / 2;
        const logoY = 8;
        doc.addImage(logoBase64, 'PNG', logoX, logoY, logoWidth, logoHeight);

        // Cabeçalho
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('RELATÓRIO DE CLIENTES', 105, 35, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 45, { align: 'center' });

        // Informações do relatório
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Carteira de Clientes', 20, 60);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(`Total de Clientes: ${clientes.length}`, 20, 70);

        // Tabela de clientes com dados limpos
        const tableData = clientes.map(cliente => [
          (cliente.razao || '').replace(/[^\w\s\-\.]/g, ''), // Remove caracteres especiais
          (cliente.cnpj || '').replace(/[^\w\s\-\.]/g, ''),
          `${(cliente.cidade || '').replace(/[^\w\s\-\.]/g, '')} / ${(cliente.estado || '').replace(/[^\w\s\-\.]/g, '')}`,
          (cliente.telefone || '').replace(/[^\w\s\-\.]/g, ''),
          (cliente.email || '').replace(/[^\w\s@\-\.]/g, '') // Mantém @ para emails
        ]);

        doc.autoTable({
          startY: 80,
          head: [['Razão Social', 'CNPJ', 'Cidade/UF', 'Telefone', 'Email']],
          body: tableData,
          theme: 'grid',
          headStyles: {
            fillColor: primaryColor,
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 10
          },
          styles: {
            fontSize: 9,
            cellPadding: 4,
            lineColor: [200, 200, 200],
            lineWidth: 0.1
          },
          columnStyles: {
            0: { cellWidth: 55, halign: 'left' },
            1: { cellWidth: 35, halign: 'center' },
            2: { cellWidth: 30, halign: 'center' },
            3: { cellWidth: 30, halign: 'center' },
            4: { cellWidth: 40, halign: 'left' }
          },
          alternateRowStyles: {
            fillColor: [248, 249, 250]
          },
          margin: { top: 80, right: 10, bottom: 10, left: 10 }
        });

        // Estatísticas por estado
        const finalY = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Distribuição por Estado:', 20, finalY);

        const estados = {};
        clientes.forEach(cliente => {
          const estado = (cliente.estado || 'Não informado').replace(/[^\w\s\-\.]/g, '');
          estados[estado] = (estados[estado] || 0) + 1;
        });

        let yPos = finalY + 10;
        let coluna = 0;
        const colunas = 2;
        const larguraColuna = 80;
        
        Object.entries(estados).forEach(([estado, count], index) => {
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
            coluna = 0;
          }
          
          const xPos = 25 + (coluna * larguraColuna);
          
          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.text(`${estado}: ${count} cliente(s)`, xPos, yPos);
          
          coluna++;
          if (coluna >= colunas) {
            coluna = 0;
            yPos += 8;
          }
        });

        // Rodapé
        const pageHeight = doc.internal.pageSize.height;
        doc.setFillColor(240, 240, 240);
        doc.rect(0, pageHeight - 30, 210, 30, 'F');
        
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text('Este documento foi gerado automaticamente pelo J.P Sistemas Comercial', 105, pageHeight - 20, { align: 'center' });
        doc.text(`Total de clientes: ${clientes.length}`, 105, pageHeight - 15, { align: 'center' });

        // Salvar PDF
        const hoje = new Date();
        const dataAtual = `${hoje.getDate().toString().padStart(2, '0')}-${(hoje.getMonth() + 1).toString().padStart(2, '0')}-${hoje.getFullYear()}`;
        doc.save(`Relatorio_Clientes_${dataAtual}.pdf`);
      });
    }

    // Função auxiliar para carregar imagem base64
    function carregarImagemBase64(url, callback) {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.height = this.naturalHeight;
        canvas.width = this.naturalWidth;
        ctx.drawImage(this, 0, 0);
        const dataURL = canvas.toDataURL('image/png');
        callback(dataURL);
      };
      img.onerror = function() {
        // Se não conseguir carregar a imagem, continua sem ela
        callback(null);
      };
      img.src = url;
    }

    function exportarClientesExcel() {
      const ws_data = [
        ['Razão Social', 'CNPJ', 'Cidade/UF', 'Telefone', 'Email'],
        ...clientes.map(cli => [
          cli.razao,
          cli.cnpj,
          `${cli.cidade} / ${cli.estado}`,
          cli.telefone,
          cli.email
        ])
      ];
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
      const hoje = new Date();
      const dataAtual = `${hoje.getDate().toString().padStart(2, '0')}-${(hoje.getMonth() + 1).toString().padStart(2, '0')}-${hoje.getFullYear()}`;
      XLSX.writeFile(wb, `Carteira_Clientes_${dataAtual}.xlsx`);
    }

    if (!document.getElementById('modal-cliente')) {
      const modal = document.createElement('div');
      modal.id = 'modal-cliente';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <button id="fechar-modal-cliente" class="modal-close">&times;</button>
          <div class="modal-header">
            <h2>Detalhes do Cliente</h2>
          </div>
          <div class="modal-body" id="modal-cliente-conteudo"></div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('fechar-modal-cliente').onclick = () => {
        modal.style.display = 'none';
      };
      modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
    }
    
    function mostrarModalCliente(cli) {
      const conteudo = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px 20px;">
          <div><b>ID:</b><br>${cli.id ?? ''}</div>
          <div><b>Nome/Razão Social:</b><br>${cli.razao ?? ''}</div>
          <div><b>CPF/CNPJ:</b><br>${cli.cnpj ?? ''}</div>
          <div><b>IE:</b><br>${cli.ie ?? ''}</div>
          <div style="grid-column:1/3"><b>Endereço:</b><br>${cli.endereco ?? ''}</div>
          <div><b>Bairro:</b><br>${cli.bairro ?? ''}</div>
          <div><b>Cidade:</b><br>${cli.cidade ?? ''}</div>
          <div><b>Estado:</b><br>${cli.estado ?? ''}</div>
          <div><b>CEP:</b><br>${cli.cep ?? ''}</div>
          <div style="grid-column:1/3"><b>Email:</b><br>${cli.email ?? ''}</div>
          <div style="grid-column:1/3"><b>Telefone:</b><br>${cli.telefone ?? ''}</div>
          <div style="grid-column:1/3"><b>Transporte:</b><br>${cli.transporte ?? ''}</div>
          <div style="grid-column:1/3"><b>Prazo:</b><br>${cli.prazo ?? ''}</div>
          <div style="grid-column:1/3"><b>Observações:</b><br>${cli.obs ?? ''}</div>
        </div>
      `;
      document.getElementById('modal-cliente-conteudo').innerHTML = conteudo;
      document.getElementById('modal-cliente').style.display = 'block';
    }

    function preencherFormularioEdicao(cli) {
      document.getElementById('form-title').textContent = 'Editar Cliente';
      document.getElementById('razao').value = cli.razao || '';
      document.getElementById('cnpj').value = cli.cnpj || '';
      document.getElementById('ie').value = cli.ie || '';
      document.getElementById('endereco').value = cli.endereco || '';
      document.getElementById('bairro').value = cli.bairro || '';
      document.getElementById('cidade').value = cli.cidade || '';
      document.getElementById('estado').value = cli.estado || '';
      document.getElementById('cep').value = cli.cep || '';
      document.getElementById('email').value = cli.email || '';
      document.getElementById('telefone').value = cli.telefone || '';
      document.getElementById('transporte').value = cli.transporte || '';
      document.getElementById('prazo').value = cli.prazo || '';
      document.getElementById('obs').value = cli.obs || '';
      document.getElementById('cliente-id').value = cli.id;
      document.getElementById('btn-cancelar').style.display = '';
    }

    document.getElementById('btn-cancelar').onclick = function() {
      limparFormulario();
    };

    function limparFormulario() {
      document.getElementById('form-title').textContent = 'Cadastrar Novo Cliente';
      document.getElementById('cliente-form').reset();
      document.getElementById('cliente-id').value = '';
      document.getElementById('btn-cancelar').style.display = 'none';
    }

    document.getElementById('cliente-form').onsubmit = async function(e) {
      e.preventDefault();
      
      // Validar CPF/CNPJ antes de enviar
      const cnpjValue = document.getElementById('cnpj').value.replace(/\D/g, '');
      if (cnpjValue.length > 0 && !validarCPFCNPJ(cnpjValue)) {
        const continuar = window.confirm('O CPF/CNPJ informado parece estar inválido. Deseja continuar mesmo assim?');
        if (!continuar) {
          document.getElementById('cnpj').focus();
          return false;
        }
      }
      
      const cliente = {
        razao: document.getElementById('razao').value,
        cnpj: document.getElementById('cnpj').value,
        ie: document.getElementById('ie').value,
        endereco: document.getElementById('endereco').value,
        bairro: document.getElementById('bairro').value,
        cidade: document.getElementById('cidade').value,
        estado: document.getElementById('estado').value,
        cep: document.getElementById('cep').value,
        email: document.getElementById('email').value,
        telefone: document.getElementById('telefone').value,
        transporte: document.getElementById('transporte').value,
        prazo: document.getElementById('prazo').value,
        obs: document.getElementById('obs').value
      };
      const id = document.getElementById('cliente-id').value;
      try {
        if (id) {
          await fetch(`${API_URL}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cliente),
            credentials: 'include'
          });
          alert('Cliente atualizado com sucesso!');
        } else {
          await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cliente),
            credentials: 'include'
          });
          alert('Cliente cadastrado com sucesso!');
        }
        limparFormulario();
        await carregarClientes();
      } catch (err) {
        alert('Erro ao salvar cliente.');
      }
    };

    // Funções para formatação automática de CPF/CNPJ
    function formatarCPFCNPJ(valor) {
      // Remove tudo que não é dígito
      const numeros = valor.replace(/\D/g, '');
      
      // Se não tem números, retorna vazio
      if (numeros.length === 0) {
        return '';
      }
      
      // Se tem 11 dígitos ou menos, formata como CPF
      if (numeros.length <= 11) {
        if (numeros.length <= 3) {
          return numeros;
        } else if (numeros.length <= 6) {
          return numeros.replace(/(\d{3})(\d{0,3})/, '$1.$2');
        } else if (numeros.length <= 9) {
          return numeros.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
        } else {
          return numeros.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
        }
      }
      // Se tem 14 dígitos ou menos, formata como CNPJ
      else if (numeros.length <= 14) {
        if (numeros.length <= 2) {
          return numeros;
        } else if (numeros.length <= 5) {
          return numeros.replace(/(\d{2})(\d{0,3})/, '$1.$2');
        } else if (numeros.length <= 8) {
          return numeros.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
        } else if (numeros.length <= 12) {
          return numeros.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
        } else {
          return numeros.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, '$1.$2.$3/$4-$5');
        }
      }
      // Se tem mais de 14 dígitos, trunca para 14
      else {
        return numeros.substring(0, 14).replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
      }
    }

    function validarCPFCNPJ(valor) {
      const numeros = valor.replace(/\D/g, '');
      
      // Se não tem números, não é válido
      if (numeros.length === 0) {
        return false;
      }
      
      // Se tem menos de 11 dígitos, não é válido
      if (numeros.length < 11) {
        return false;
      }
      
      if (numeros.length === 11) {
        // Validação básica de CPF
        if (numeros === '00000000000' || numeros === '11111111111' || 
            numeros === '22222222222' || numeros === '33333333333' || 
            numeros === '44444444444' || numeros === '55555555555' || 
            numeros === '66666666666' || numeros === '77777777777' || 
            numeros === '88888888888' || numeros === '99999999999') {
          return false;
        }
        
        // Validação dos dígitos verificadores do CPF
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(numeros.charAt(i)) * (10 - i);
        }
        let resto = 11 - (soma % 11);
        let digito1 = resto < 2 ? 0 : resto;
        
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(numeros.charAt(i)) * (11 - i);
        }
        resto = 11 - (soma % 11);
        let digito2 = resto < 2 ? 0 : resto;
        
        return parseInt(numeros.charAt(9)) === digito1 && parseInt(numeros.charAt(10)) === digito2;
      } else if (numeros.length === 14) {
        // Validação básica de CNPJ
        if (numeros === '00000000000000' || numeros === '11111111111111' || 
            numeros === '22222222222222' || numeros === '33333333333333' || 
            numeros === '44444444444444' || numeros === '55555555555555' || 
            numeros === '66666666666666' || numeros === '77777777777777' || 
            numeros === '88888888888888' || numeros === '99999999999999') {
          return false;
        }
        
        // Validação dos dígitos verificadores do CNPJ
        let tamanho = numeros.length - 2;
        let numeros2 = numeros.substring(0, tamanho);
        let digitos = numeros.substring(tamanho);
        let soma = 0;
        let pos = tamanho - 7;
        
        for (let i = tamanho; i >= 1; i--) {
          soma += parseInt(numeros2.charAt(tamanho - i)) * pos--;
          if (pos < 2) pos = 9;
        }
        
        let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
        if (resultado !== parseInt(digitos.charAt(0))) return false;
        
        tamanho = tamanho + 1;
        numeros2 = numeros.substring(0, tamanho);
        soma = 0;
        pos = tamanho - 7;
        
        for (let i = tamanho; i >= 1; i--) {
          soma += parseInt(numeros2.charAt(tamanho - i)) * pos--;
          if (pos < 2) pos = 9;
        }
        
        resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
        return resultado === parseInt(digitos.charAt(1));
      }
      
      // Se tem mais de 14 dígitos, não é válido
      return false;
    }

    // Função para download do modelo de planilha
    function downloadModeloPlanilha() {
      // Dados do modelo
      const dados = [
        ['Razão Social', 'CPF/CNPJ', 'Inscrição Estadual', 'Endereço', 'Bairro', 'Cidade', 'Estado', 'CEP', 'Email', 'Telefone', 'Transporte', 'Prazo', 'Observações'],
        ['Empresa Exemplo Ltda', '12.345.678/0001-90', '123456789', 'Rua das Flores, 123', 'Centro', 'São Paulo', 'SP', '01234-567', 'contato@empresa.com', '(11) 99999-9999', 'Transportadora ABC', '30 dias', 'Cliente preferencial'],
        ['João Silva', '123.456.789-00', '', 'Av. Principal, 456', 'Jardim', 'Rio de Janeiro', 'RJ', '20000-000', 'joao@email.com', '(21) 88888-8888', 'Correios', '15 dias', ''],
        ['', '', '', '', '', '', '', '', '', '', '', '', '']
      ];

      // Criar workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(dados);

      // Ajustar largura das colunas
      const colWidths = [
        { wch: 25 }, // Razão Social
        { wch: 18 }, // CPF/CNPJ
        { wch: 15 }, // IE
        { wch: 30 }, // Endereço
        { wch: 15 }, // Bairro
        { wch: 15 }, // Cidade
        { wch: 5 },  // Estado
        { wch: 10 }, // CEP
        { wch: 25 }, // Email
        { wch: 15 }, // Telefone
        { wch: 20 }, // Transporte
        { wch: 10 }, // Prazo
        { wch: 30 }  // Observações
      ];
      ws['!cols'] = colWidths;

      // Adicionar planilha ao workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Modelo Clientes');

      // Download do arquivo
      XLSX.writeFile(wb, 'modelo_clientes.xlsx');
    }

    // Função para importar planilha
    async function importarPlanilha(event) {
      const file = event.target.files[0];
      const btn = document.getElementById('btn-importar-planilha');
      let originalText = btn ? btn.innerHTML : '';
      if (!file) return;

      try {
        // Mostrar loading
        if (btn) {
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
          btn.disabled = true;
        }

        const data = await readExcelFile(file);
        
        if (!data || data.length === 0) {
          alert('Nenhum dado encontrado na planilha.');
          return;
        }

        // Validar cabeçalhos
        const headers = data[0];
        const expectedHeaders = ['Razão Social', 'CPF/CNPJ', 'Inscrição Estadual', 'Endereço', 'Bairro', 'Cidade', 'Estado', 'CEP', 'Email', 'Telefone', 'Transporte', 'Prazo', 'Observações'];
        
        if (!validateHeaders(headers, expectedHeaders)) {
          alert('Formato da planilha inválido. Use o modelo fornecido.');
          return;
        }

        // Processar dados
        const clientesParaImportar = [];
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (row[0] && String(row[0]).trim()) { // Verificar se tem razão social
            const cliente = {
              razao: (row[0] != null ? String(row[0]).trim() : ''),
              cnpj: (row[1] != null ? String(row[1]).trim() : ''),
              ie: (row[2] != null ? String(row[2]).trim() : ''),
              endereco: (row[3] != null ? String(row[3]).trim() : ''),
              bairro: (row[4] != null ? String(row[4]).trim() : ''),
              cidade: (row[5] != null ? String(row[5]).trim() : ''),
              estado: (row[6] != null ? String(row[6]).trim() : ''),
              cep: (row[7] != null ? String(row[7]).trim() : ''),
              email: (row[8] != null ? String(row[8]).trim() : ''),
              telefone: (row[9] != null ? String(row[9]).trim() : ''),
              transporte: (row[10] != null ? String(row[10]).trim() : ''),
              prazo: (row[11] != null ? String(row[11]).trim() : ''),
              obs: (row[12] != null ? String(row[12]).trim() : '')
            };
            clientesParaImportar.push(cliente);
          }
        }

        if (clientesParaImportar.length === 0) {
          alert('Nenhum cliente válido encontrado na planilha.');
          return;
        }

        // Confirmar importação
        const confirmacao = confirm(`Encontrados ${clientesParaImportar.length} clientes para importar. Deseja continuar?`);
        if (!confirmacao) return;

        // Importar clientes
        let sucessos = 0;
        let erros = 0;

        for (const cliente of clientesParaImportar) {
          try {
            await fetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(cliente),
              credentials: 'include'
            });
            sucessos++;
          } catch (error) {
            console.error('Erro ao importar cliente:', cliente.razao, error);
            erros++;
          }
        }

        // Mostrar resultado
        alert(`Importação concluída!\nSucessos: ${sucessos}\nErros: ${erros}`);
        
        // Recarregar lista de clientes
        await carregarClientes();

      } catch (error) {
        console.error('Erro ao processar planilha:', error);
        alert('Erro ao processar a planilha. Verifique se o arquivo está no formato correto.');
      } finally {
        // Restaurar botão
        if (btn) {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
        // Limpar input
        event.target.value = '';
      }
    }

    // Função para ler arquivo Excel
    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            resolve(jsonData);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    // Função para validar cabeçalhos
    function validateHeaders(headers, expectedHeaders) {
      if (!headers || headers.length < expectedHeaders.length) {
        return false;
      }
      
      for (let i = 0; i < expectedHeaders.length; i++) {
        if (!headers[i] || headers[i].toString().trim() !== expectedHeaders[i]) {
          return false;
        }
      }
      
      return true;
    }

    // Adicionar event listener para formatação automática
    document.addEventListener('DOMContentLoaded', function() {
      const cnpjInput = document.getElementById('cnpj');
      
      cnpjInput.addEventListener('input', function(e) {
        const valor = e.target.value;
        const formatado = formatarCPFCNPJ(valor);
        e.target.value = formatado;
      });
      
      cnpjInput.addEventListener('blur', function(e) {
        const valor = e.target.value.replace(/\D/g, '');
        if (valor.length > 0 && !validarCPFCNPJ(valor)) {
          const continuar = window.confirm('CPF/CNPJ inválido! Deseja continuar mesmo assim?');
          if (!continuar) {
            setTimeout(() => {
              e.target.focus();
            }, 100);
          }
        }
      });
    });
  </script>
</body>
</html> 
