<!--
  RESPONSIVIDADE MOBILE:
  - Este arquivo já inclui <meta name="viewport"> e mobile.css para responsividade.
  - Use as classes .coluna-desnecessaria ou .hide-mobile em <th> ou <td> para esconder colunas no mobile.
  - Para navegação fixa no rodapé, utilize <nav class="mobile-nav">.
  - Mantenha sempre o mobile.css atualizado para melhor experiência mobile.
-->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="canonical" href="https://jp-sistemas.com/painel-clientes.html" />
  <title>Gestao de Clientes - J.P Sistemas Comercial</title>
  <link rel="icon" href="https://i.imgur.com/TwZLW6a.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="style-sistema.css">
  <link rel="stylesheet" href="mobile.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary-color: #005a9f;
      --primary-dark: #003766;
      --primary-light: #0077cc;
      --secondary-color: #022656;
      --accent-color: #1e4a8a;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --background: #f8fafc;
      --surface: #ffffff;
      --border: #e5e7eb;
      --shadow: rgba(0, 90, 159, 0.1);
      --shadow-hover: rgba(0, 90, 159, 0.2);
      --success-color: #059669;
      --danger-color: #dc2626;
      --warning-color: #d97706;
      --light-color: #f9fafb;
      --dark-color: #111827;
      --bg-color: #f3f4f6;
      --card-bg: rgba(255, 255, 255, 0.95);
      --border-color: rgba(156, 163, 175, 0.2);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --border-radius: 16px;
      --border-radius-lg: 24px;
      --primary-blue: #002f4b;
      --light-text: #ecf0f1;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", sans-serif;
      font-size: 16px;
      background: #F5F7FA;
      color: #1F2937;
      padding: 0;
      min-height: 100vh;
    }

    .logout-btn {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 90, 159, 0.3);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    #logo-container {
      text-align: center;
      margin-bottom: 32px;
    }

    #logo {
      max-width: 120px;
      height: auto;
      filter: brightness(0) invert(1) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
      opacity: 0.9;
      transition: transform 0.3s ease;
    }

    #logo:hover {
      transform: scale(1.05);
    }

    .main-content {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .card {
      animation: cardFadeIn 0.5s ease-out;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      padding: 32px;
      margin-bottom: 32px;
      border: 1px solid #E5E7EB;
      transition: all 0.3s ease;
    }

    @keyframes cardFadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .card-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .card-header .btn-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      width: 100%;
      flex-wrap: wrap;
    }

    .card-header h2 {
      font-size: 1.8em;
      color: var(--dark-color);
      font-weight: 600;
      text-align: center;
      font-family: 'Inter', sans-serif;
      background: none;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-family: "Inter", sans-serif;
      font-weight: 500;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #dc2626);
      color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark-color);
      font-size: 0.9rem;
    }

    input[type="text"],
    input[type="email"] {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-family: "Inter", sans-serif;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
    }

    input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: white;
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .search-container {
      display: flex;
      justify-content: center;
      position: relative;
      margin-bottom: 24px;
    }

    .search-box {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 500px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      border: 2px solid var(--border-color);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      padding: 4px 20px 4px 20px;
      transition: all 0.3s ease;
    }

    .search-box:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 12px 35px rgba(99, 102, 241, 0.15);
      transform: translateY(-2px);
    }

    .search-icon {
      font-size: 1.2rem;
      color: var(--primary-color);
      margin-right: 12px;
      opacity: 0.8;
    }

    #busca-cliente {
      border: none;
      background: transparent;
      outline: none;
      font-size: 1rem;
      font-family: "Inter", sans-serif;
      width: 100%;
      padding: 12px 0;
      color: var(--text-color);
    }

    #busca-cliente::placeholder {
      color: #9ca3af;
      opacity: 1;
    }

    .sugestoes-clientes {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 2px solid var(--border-color);
      border-radius: 0 0 20px 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      z-index: 1001;
      list-style: none;
      padding: 0;
      display: none;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.95rem;
    }

    .sugestoes-clientes.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .sugestoes-clientes li {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      color: var(--dark-color);
      line-height: 1.4;
    }

    .sugestoes-clientes li:last-child {
      border-bottom: none;
    }

    .sugestoes-clientes li:hover,
    .sugestoes-clientes li.active {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary-color);
    }

    .table-container {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      vertical-align: middle;
    }

    thead th {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      font-weight: 600;
      white-space: nowrap;
      font-size: 0.9rem;
    }

    tbody tr {
      transition: all 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(99, 102, 241, 0.05);
      transform: scale(1.01);
    }

    .table-responsive {
      max-height: 500px;
      overflow-y: auto;
      border-radius: var(--border-radius);
    }

    .table-responsive::-webkit-scrollbar {
      width: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
      background: var(--primary-hover);
    }

    .footer {
      width: 100%;
      text-align: center;
      padding: 18px 0 12px 0;
      background: #1F2937;
      color: #fff;
      font-size: 15px;
      background: transparent;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.02em;
    }

    .btn, .logout-btn, button {
      background: var(--primary-blue) !important;
      color: var(--light-text) !important;
    }

    .logo h1, h1, h2, h3, h4, h5, h6, .fa, .fas, .icon, .destaque {
      color: var(--primary-blue) !important;
    }

    table tr td, table tr th {
      color: var(--primary-blue) !important;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
  <body class="app-layout">
  <header class="sistema-header">
    <div class="header-content">
      <a href="painel.html" class="logo"><img src="https://i.imgur.com/EQ1tjZX.png" alt="J.P Sistemas" style="height: 5rem; width: auto; object-fit: contain;" /></a>
      <button class="sistema-mobile-toggle" id="nav-toggle" aria-label="Menu"><i class="fas fa-bars"></i></button>
      <nav id="main-nav">
        <a href="painel.html" class="nav-link">Painel</a>
        <a href="painel-clientes.html" class="nav-link active">Clientes</a>
        <a href="produtos.html" class="nav-link">Produtos</a>
        <a href="pedidos.html" class="nav-link">Pedidos</a>
        <a href="relatorios.html" class="nav-link">Relatórios</a>
        <a href="configuracoes.html" class="nav-link">Configurações</a>
        <a href="ajuda.html" class="nav-link">Ajuda</a>
        <a href="index.html" class="nav-link" title="Site"><i class="fas fa-globe"></i></a>
        <a href="#" class="nav-link nav-sair" onclick="logout(); return false;"><i class="fas fa-sign-out-alt"></i> Sair</a>
      </nav>
    </div>
  </header>

  <main class="sistema-main">
    <div class="sistema-container">
      <nav class="sistema-breadcrumb">
        <a href="painel.html">Painel</a>
        <span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>
        <span>Clientes</span>
      </nav>
      <div class="sistema-page-header">
        <div class="sistema-page-header-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="sistema-page-header-text">
          <h1>Gestão de Clientes</h1>
          <p>Cadastre e gerencie seus clientes</p>
        </div>
      </div>
    <div class="sistema-section" id="form-card">
      <div class="sistema-section-header">
        <h2 class="sistema-section-title-icon" id="form-title"><i class="fas fa-user-plus"></i> Cadastrar Novo Cliente</h2>
      </div>
      <form id="cliente-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="razao">Nome ou Razao Social</label>
            <input type="text" id="razao" name="razao" required placeholder="Digite Nome ou Razao Social" />
          </div>
          <div class="form-group">
            <label for="cnpj">CPF/CNPJ</label>
            <input type="text" id="cnpj" name="cnpj" required placeholder="Digite CPF ou CNPJ" />
          </div>
          <div class="form-group">
            <label for="ie">IE (Opcional)</label>
            <input type="text" id="ie" name="ie" placeholder="Digite IE (se houver)" />
          </div>
          <div class="form-group">
            <label for="endereco">Endereco</label>
            <input type="text" id="endereco" name="endereco" placeholder="Digite o endereco (opcional)" />
          </div>
          <div class="form-group">
            <label for="bairro">Bairro</label>
            <input type="text" id="bairro" name="bairro" placeholder="Digite o bairro (opcional)" />
          </div>
          <div class="form-group">
            <label for="cidade">Cidade</label>
            <input type="text" id="cidade" name="cidade" required placeholder="Digite a cidade" />
          </div>
          <div class="form-group">
            <label for="estado">Estado</label>
            <input type="text" id="estado" name="estado" required placeholder="Digite o estado" />
          </div>
          <div class="form-group">
            <label for="cep">CEP</label>
            <input type="text" id="cep" name="cep" placeholder="Digite o CEP (opcional)" />
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required placeholder="Digite o email" />
          </div>
          <div class="form-group">
            <label for="telefone">Telefone</label>
            <input type="text" id="telefone" name="telefone" required placeholder="Digite o telefone" />
          </div>
          <div class="form-group">
            <label for="transporte">Transporte (Opcional)</label>
            <input type="text" id="transporte" name="transporte" placeholder="Digite Transporte (se houver)" />
          </div>
          <div class="form-group">
            <label for="prazo">Prazo (Opcional)</label>
            <input type="text" id="prazo" name="prazo" placeholder="Digite Prazo (se houver)" />
          </div>
          <div class="form-group" style="grid-column: 1/3;">
            <label for="obs">Observacoes</label>
            <input type="text" id="obs" name="obs" placeholder="Digite observacoes (opcional)" />
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-success" id="btn-salvar">
            <i class="fas fa-save"></i> Salvar
          </button>
          <button type="button" class="btn btn-danger" id="btn-cancelar" style="display:none;">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
        <input type="hidden" id="cliente-id" />
      </form>
    </div>

    <div class="sistema-section">
      <div class="sistema-section-header">
        <h2 class="sistema-section-title-icon"><i class="fas fa-list"></i> Lista de Clientes</h2>
        <div class="btn-group">
          <button class="btn btn-primary" id="btn-exportar-pdf">
            <i class="fas fa-file-pdf"></i> Baixar PDF
          </button>
          <button class="btn btn-success" id="btn-exportar-excel">
            <i class="fas fa-file-excel"></i> Baixar Excel
          </button>
          <button class="btn btn-warning" id="btn-download-modelo">
            <i class="fas fa-download"></i> Baixar Modelo
          </button>
          <button class="btn btn-info" id="btn-importar-planilha">
            <i class="fas fa-upload"></i> Importar Planilha
          </button>
      </div>
      </div>
      
      <div class="search-container">
        <div class="search-box">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="busca-cliente" placeholder="Buscar cliente..." autocomplete="off" />
        </div>
        <ul id="sugestoes-clientes" class="sugestoes-clientes"></ul>
      </div>

      <div class="table-container">
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome/Razao Social</th>
              <th>CPF/CNPJ</th>
              <th>Cidade/UF</th>
              <th>Acoes</th>
            </tr>
          </thead>
          <tbody id="clientes-tbody">
            <tr><td colspan="5"><div class="table-skeleton"><div class="skeleton-row"><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div></div><div class="skeleton-row"><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div></div></div></td></tr>
          </tbody>
        </table>
      </div>
          </div>
    </div>
    </div>
    
    <!-- Input oculto para importação de arquivo -->
    <input type="file" id="input-importar" accept=".xlsx,.xls,.csv" style="display: none;" />
  </main>
  <footer class="footer">
    © 2026 J.P Sistemas. Todos os direitos reservados. <a href="https://whatsa.me/5548996852138/?t=Ola,%20gostaria%20de%20mais%20informacoes%20sobre%20os%20sistemas." target="_blank" rel="noopener noreferrer" style="color: #fff; text-decoration: underline; font-weight: 500;">Fale conosco no WhatsApp</a>
  </footer>

  <script>
    document.getElementById('nav-toggle')?.addEventListener('click', function() {
      document.getElementById('main-nav').classList.toggle('open');
    });
    const API_URL = '/api/clientes';
    let clientes = [];
    let clientesFiltrados = [];
    
    async function carregarClientes() {
      try {
        const resp = await fetch(API_URL, { credentials: 'include' });
        if (resp.status === 401) {
          sessionStorage.removeItem('loggedIn');
          sessionStorage.removeItem('username');
          alert('Sessao expirada. Por favor, faca login novamente.');
          window.location.href = 'sistema.html';
          return;
        }
        if (!resp.ok) throw new Error('Erro ao buscar clientes na API');
        clientes = await resp.json();
        clientesFiltrados = Array.isArray(clientes) ? clientes : [];
        renderTabela();
      } catch (e) {
        alert('Erro ao carregar os dados dos clientes. Verifique se a API esta disponivel.');
      }
    }
    
    function renderTabela() {
      const tbody = document.getElementById('clientes-tbody');
      tbody.innerHTML = '';
      const lista = clientesFiltrados || [];
      if (lista.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-users-slash empty-state-icon"></i><div class="empty-state-title">Nenhum cliente encontrado</div><div class="empty-state-text">Cadastre clientes em "Cadastrar Novo Cliente" ou ajuste a busca.</div></div></td></tr>';
        return;
      }
      lista.forEach(cli => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${cli.id ?? ''}</td>
          <td>${cli.razao ?? ''}</td>
          <td>${cli.cnpj ?? ''}</td>
          <td>${cli.cidade ?? ''} / ${cli.estado ?? ''}</td>
          <td>
            <button class="btn btn-primary btn-ver-mais" data-id="${cli.id}">
              <i class="fas fa-eye"></i> Ver Mais
            </button>
            <button class="btn btn-info btn-documentos" data-id="${cli.id}" data-razao="${(cli.razao || '').replace(/"/g, '&quot;')}" style="background:#0d9488!important;">
              <i class="fas fa-paperclip"></i> Documentos
            </button>
            <button class="btn btn-success btn-editar" data-id="${cli.id}">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button class="btn btn-danger btn-remover" data-id="${cli.id}">
              <i class="fas fa-trash"></i> Remover
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.btn-ver-mais').forEach(btn => {
        btn.onclick = function() {
          const id = this.getAttribute('data-id');
          const cliente = clientes.find(c => String(c.id) === String(id));
          if (cliente) mostrarModalCliente(cliente);
        };
      });

      document.querySelectorAll('.btn-documentos').forEach(btn => {
        btn.onclick = function() {
          const id = this.getAttribute('data-id');
          const razao = this.getAttribute('data-razao') || '';
          abrirModalDocumentos(id, razao);
        };
      });
      
      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.onclick = function() {
          const id = this.getAttribute('data-id');
          const cliente = clientes.find(c => String(c.id) === String(id));
          if (cliente) preencherFormularioEdicao(cliente);
        };
      });
      
      document.querySelectorAll('.btn-remover').forEach(btn => {
        btn.onclick = async function() {
          const id = this.getAttribute('data-id');
          const cliente = clientes.find(c => String(c.id) === String(id));
          if (!cliente) return;
          
          const senha = prompt('Digite a senha para confirmar a exclusao:');
          if (senha !== 'excluir@95') {
            alert('Senha incorreta. Exclusao cancelada.');
            return;
          }
          
          if (confirm(`Tem certeza que deseja remover o cliente "${cliente.razao}"?`)) {
            try {
              await fetch(`${API_URL}/${id}`, { method: 'DELETE', credentials: 'include' });
              alert('Cliente removido com sucesso!');
              await carregarClientes();
            } catch (err) {
              alert('Erro ao remover cliente.');
            }
          }
        };
      });
    }
    
    function filtrarClientes(texto) {
      const termo = texto.trim().toLowerCase();
      if (!termo) {
        clientesFiltrados = clientes;
      } else {
        clientesFiltrados = clientes.filter(cli =>
          (cli.razao && String(cli.razao).toLowerCase().includes(termo)) ||
          (cli.cnpj && String(cli.cnpj).toLowerCase().includes(termo)) ||
          (cli.cidade && String(cli.cidade).toLowerCase().includes(termo)) ||
          (cli.estado && String(cli.estado).toLowerCase().includes(termo)) ||
          (cli.telefone && String(cli.telefone).toLowerCase().includes(termo)) ||
          (cli.email && String(cli.email).toLowerCase().includes(termo))
        );
      }
      renderTabela();
      mostrarSugestoes(texto);
    }
    
    function mostrarSugestoes(texto) {
      const ul = document.getElementById('sugestoes-clientes');
      const termo = texto.trim().toLowerCase();
      if (!termo || clientesFiltrados.length === 0) {
        ul.classList.remove('show');
        ul.innerHTML = '';
        return;
      }
      const sugestoes = clientesFiltrados.slice(0, 8);
      ul.innerHTML = sugestoes.map(cli =>
        `<li data-cnpj="${cli.cnpj}"><strong>${cli.razao}</strong><br><small>${cli.cnpj} - ${cli.cidade}/${cli.estado}</small></li>`
      ).join('');
      ul.classList.add('show');
    }
    
    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      sessionStorage.removeItem('loggedIn');
      sessionStorage.removeItem('username');
      window.location.href = 'sistema.html';
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      if (sessionStorage.getItem('loggedIn') !== 'true') {
        alert('Acesso negado. Por favor, realize o login.');
        window.location.href = 'sistema.html';
        return;
      }
      
      const username = sessionStorage.getItem('username') || 'Usuário';
      const userDisplayEl = document.getElementById('userDisplay');
      if (userDisplayEl) userDisplayEl.textContent = username;
      
      carregarClientes();
      document.getElementById('btn-exportar-pdf').onclick = exportarClientesPDF;
      document.getElementById('btn-exportar-excel').onclick = exportarClientesExcel;
      document.getElementById('btn-download-modelo').onclick = downloadModeloPlanilha;
      document.getElementById('btn-importar-planilha').onclick = () => document.getElementById('input-importar').click();
      document.getElementById('input-importar').onchange = importarPlanilha;
      
      document.getElementById('busca-cliente').addEventListener('input', function() {
        filtrarClientes(this.value);
      });
      
      document.getElementById('sugestoes-clientes').addEventListener('mousedown', function(e) {
        if (e.target.tagName === 'LI' || e.target.closest('li')) {
          const li = e.target.closest('li');
          const texto = li.querySelector('strong').textContent;
          document.getElementById('busca-cliente').value = texto;
          filtrarClientes(texto);
          this.classList.remove('show');
        }
      });
      
      document.getElementById('busca-cliente').addEventListener('blur', function() {
        setTimeout(() => {
          document.getElementById('sugestoes-clientes').classList.remove('show');
        }, 150);
      });
    });

    function exportarClientesPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Configurações de cores
      const primaryColor = [0, 90, 159];
      const secondaryColor = [0, 55, 102];

      // Inserir logo no cabeçalho
      carregarImagemBase64('https://i.imgur.com/2jT2EPD.png', function(logoBase64) {
        // Logo centralizada
        const logoWidth = 50;
        const logoHeight = 22;
        const logoX = (210 - logoWidth) / 2;
        const logoY = 8;
        doc.addImage(logoBase64, 'PNG', logoX, logoY, logoWidth, logoHeight);

        // Cabeçalho
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('RELATÓRIO DE CLIENTES', 105, 35, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 45, { align: 'center' });

        // Informações do relatório
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Carteira de Clientes', 20, 60);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(`Total de Clientes: ${clientes.length}`, 20, 70);

        // Tabela de clientes com dados limpos
        const tableData = clientes.map(cliente => [
          (cliente.razao || '').replace(/[^\w\s\-\.]/g, ''), // Remove caracteres especiais
          (cliente.cnpj || '').replace(/[^\w\s\-\.]/g, ''),
          `${(cliente.cidade || '').replace(/[^\w\s\-\.]/g, '')} / ${(cliente.estado || '').replace(/[^\w\s\-\.]/g, '')}`,
          (cliente.telefone || '').replace(/[^\w\s\-\.]/g, ''),
          (cliente.email || '').replace(/[^\w\s@\-\.]/g, '') // Mantém @ para emails
        ]);

        doc.autoTable({
          startY: 80,
          head: [['Razão Social', 'CNPJ', 'Cidade/UF', 'Telefone', 'Email']],
          body: tableData,
          theme: 'grid',
          headStyles: {
            fillColor: primaryColor,
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 10
          },
          styles: {
            fontSize: 9,
            cellPadding: 4,
            lineColor: [200, 200, 200],
            lineWidth: 0.1
          },
          columnStyles: {
            0: { cellWidth: 55, halign: 'left' },
            1: { cellWidth: 35, halign: 'center' },
            2: { cellWidth: 30, halign: 'center' },
            3: { cellWidth: 30, halign: 'center' },
            4: { cellWidth: 40, halign: 'left' }
          },
          alternateRowStyles: {
            fillColor: [248, 249, 250]
          },
          margin: { top: 80, right: 10, bottom: 10, left: 10 }
        });

        // Estatísticas por estado
        const finalY = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Distribuição por Estado:', 20, finalY);

        const estados = {};
        clientes.forEach(cliente => {
          const estado = (cliente.estado || 'Não informado').replace(/[^\w\s\-\.]/g, '');
          estados[estado] = (estados[estado] || 0) + 1;
        });

        let yPos = finalY + 10;
        let coluna = 0;
        const colunas = 2;
        const larguraColuna = 80;
        
        Object.entries(estados).forEach(([estado, count], index) => {
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
            coluna = 0;
          }
          
          const xPos = 25 + (coluna * larguraColuna);
          
          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.text(`${estado}: ${count} cliente(s)`, xPos, yPos);
          
          coluna++;
          if (coluna >= colunas) {
            coluna = 0;
            yPos += 8;
          }
        });

        // Rodapé
        const pageHeight = doc.internal.pageSize.height;
        doc.setFillColor(240, 240, 240);
        doc.rect(0, pageHeight - 30, 210, 30, 'F');
        
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text('Este documento foi gerado automaticamente pelo J.P Sistemas Comercial', 105, pageHeight - 20, { align: 'center' });
        doc.text(`Total de clientes: ${clientes.length}`, 105, pageHeight - 15, { align: 'center' });

        // Salvar PDF
        const hoje = new Date();
        const dataAtual = `${hoje.getDate().toString().padStart(2, '0')}-${(hoje.getMonth() + 1).toString().padStart(2, '0')}-${hoje.getFullYear()}`;
        doc.save(`Relatorio_Clientes_${dataAtual}.pdf`);
      });
    }

    // Função auxiliar para carregar imagem base64
    function carregarImagemBase64(url, callback) {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.height = this.naturalHeight;
        canvas.width = this.naturalWidth;
        ctx.drawImage(this, 0, 0);
        const dataURL = canvas.toDataURL('image/png');
        callback(dataURL);
      };
      img.onerror = function() {
        // Se não conseguir carregar a imagem, continua sem ela
        callback(null);
      };
      img.src = url;
    }

    function exportarClientesExcel() {
      const ws_data = [
        ['Razão Social', 'CNPJ', 'Cidade/UF', 'Telefone', 'Email'],
        ...clientes.map(cli => [
          cli.razao,
          cli.cnpj,
          `${cli.cidade} / ${cli.estado}`,
          cli.telefone,
          cli.email
        ])
      ];
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
      const hoje = new Date();
      const dataAtual = `${hoje.getDate().toString().padStart(2, '0')}-${(hoje.getMonth() + 1).toString().padStart(2, '0')}-${hoje.getFullYear()}`;
      XLSX.writeFile(wb, `Carteira_Clientes_${dataAtual}.xlsx`);
    }

    if (!document.getElementById('modal-cliente')) {
      const modal = document.createElement('div');
      modal.id = 'modal-cliente';
      modal.style.display = 'none';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.5)';
      modal.style.zIndex = '2000';
      modal.style.backdropFilter = 'blur(5px)';
      modal.innerHTML = `
        <div style="background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);max-width:500px;margin:60px auto;padding:32px;border-radius:20px;box-shadow:0 25px 50px rgba(0,0,0,0.25);position:relative;border:1px solid rgba(255,255,255,0.2);">
          <button id="fechar-modal-cliente" style="position:absolute;top:15px;right:20px;font-size:1.5rem;background:none;border:none;cursor:pointer;color:#666;">&times;</button>
          <h2 style="margin-bottom:20px;font-size:1.5rem;color:#1e293b;font-weight:600;">Detalhes do Cliente</h2>
          <div id="modal-cliente-conteudo"></div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('fechar-modal-cliente').onclick = () => {
        modal.style.display = 'none';
      };
      modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
    }

    if (!document.getElementById('modal-documentos')) {
      const modalDoc = document.createElement('div');
      modalDoc.id = 'modal-documentos';
      modalDoc.style.display = 'none';
      modalDoc.style.position = 'fixed';
      modalDoc.style.top = '0';
      modalDoc.style.left = '0';
      modalDoc.style.width = '100vw';
      modalDoc.style.height = '100vh';
      modalDoc.style.background = 'rgba(0,0,0,0.5)';
      modalDoc.style.zIndex = '2001';
      modalDoc.style.backdropFilter = 'blur(5px)';
      modalDoc.innerHTML = `
        <div style="background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);max-width:560px;margin:40px auto;padding:28px;border-radius:20px;box-shadow:0 25px 50px rgba(0,0,0,0.25);position:relative;border:1px solid rgba(255,255,255,0.2);max-height:90vh;overflow:auto;">
          <button id="fechar-modal-documentos" style="position:absolute;top:15px;right:20px;font-size:1.5rem;background:none;border:none;cursor:pointer;color:#666;">&times;</button>
          <h2 id="modal-documentos-titulo" style="margin-bottom:16px;font-size:1.25rem;color:#1e293b;font-weight:600;">Documentos do Cliente</h2>
          <p style="color:#64748b;font-size:0.9rem;margin-bottom:16px;">Aceito: PDF e imagens (JPEG, PNG, GIF, WebP). Máx. 15 MB por arquivo. Você pode selecionar vários de uma vez.</p>
          <form id="form-upload-documento" style="margin-bottom:20px;">
            <input type="file" id="input-documento" name="arquivo" accept=".pdf,image/jpeg,image/jpg,image/png,image/gif,image/webp" multiple style="margin-bottom:10px;display:block;width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;" />
            <button type="submit" class="btn" id="btn-anexar-doc" style="background:#0d9488!important;color:#fff!important;">
              <i class="fas fa-upload"></i> Anexar documento
            </button>
          </form>
          <hr style="border:none;border-top:1px solid #e2e8f0;margin:16px 0;" />
          <h3 style="font-size:1rem;color:#334155;margin-bottom:12px;">Documentos anexados</h3>
          <ul id="lista-documentos-cliente" style="list-style:none;padding:0;margin:0;"></ul>
        </div>
      `;
      document.body.appendChild(modalDoc);
      document.getElementById('fechar-modal-documentos').onclick = () => {
        modalDoc.style.display = 'none';
      };
      modalDoc.onclick = (e) => { if (e.target === modalDoc) modalDoc.style.display = 'none'; };
      document.getElementById('form-upload-documento').onsubmit = async function(e) {
        e.preventDefault();
        const input = document.getElementById('input-documento');
        const clienteId = modalDoc.getAttribute('data-cliente-id');
        if (!clienteId || !input.files || input.files.length === 0) {
          alert('Selecione um ou mais arquivos (PDF ou imagem).');
          return;
        }
        const btn = document.getElementById('btn-anexar-doc');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        try {
          const formData = new FormData();
          for (let i = 0; i < input.files.length; i++) {
            formData.append('arquivo', input.files[i]);
          }
          const resp = await fetch(`/api/clientes/${clienteId}/documentos`, {
            method: 'POST',
            credentials: 'include',
            body: formData
          });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) {
            alert(data.error || 'Erro ao anexar documento.');
            return;
          }
          input.value = '';
          await carregarListaDocumentos(clienteId);
        } catch (err) {
          alert('Erro ao enviar arquivo.');
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-upload"></i> Anexar documento';
        }
      };
    }
    
    function abrirModalDocumentos(clienteId, razao) {
      const modalDoc = document.getElementById('modal-documentos');
      if (!modalDoc) return;
      modalDoc.setAttribute('data-cliente-id', clienteId);
      document.getElementById('modal-documentos-titulo').textContent = 'Documentos — ' + (razao || 'Cliente #' + clienteId);
      document.getElementById('input-documento').value = '';
      modalDoc.style.display = 'block';
      carregarListaDocumentos(clienteId);
    }
    
    async function carregarListaDocumentos(clienteId) {
      const ul = document.getElementById('lista-documentos-cliente');
      if (!ul) return;
      ul.innerHTML = '<li style="padding:12px;color:#64748b;"><i class="fas fa-spinner fa-spin"></i> Carregando...</li>';
      try {
        const resp = await fetch(`/api/clientes/${clienteId}/documentos`, { credentials: 'include' });
        const docs = await resp.json();
        if (!resp.ok) {
          ul.innerHTML = '<li style="padding:12px;color:#dc2626;">Erro ao carregar documentos.</li>';
          return;
        }
        if (docs.length === 0) {
          ul.innerHTML = '<li style="padding:12px;color:#64748b;">Nenhum documento anexado.</li>';
          return;
        }
        ul.innerHTML = docs.map(d => {
          const data = d.created_at ? new Date(d.created_at).toLocaleDateString('pt-BR') : '';
          const tipo = (d.tipo_mime || '').includes('pdf') ? 'file-pdf' : 'file-image';
          return `<li style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9;">
            <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(d.nome_original)}"><i class="fas fa-${tipo}" style="margin-right:8px;color:#0d9488;"></i>${escapeHtml(d.nome_original)}</span>
            <span style="font-size:0.85rem;color:#64748b;margin-right:8px;">${data}</span>
            <button type="button" class="btn btn-abrir-doc" data-cliente-id="${clienteId}" data-doc-id="${d.id}" style="margin-right:8px;padding:4px 10px;background:#0d9488!important;color:#fff!important;border:none;border-radius:6px;cursor:pointer;" title="Abrir"><i class="fas fa-external-link-alt"></i> Abrir</button>
            <button type="button" class="btn btn-danger btn-excluir-doc" data-cliente-id="${clienteId}" data-doc-id="${d.id}" style="padding:4px 10px;font-size:0.85rem;"><i class="fas fa-trash"></i></button>
          </li>`;
        }).join('');
        document.querySelectorAll('.btn-abrir-doc').forEach(btn => {
          btn.onclick = async function() {
            const cid = this.getAttribute('data-cliente-id');
            const did = this.getAttribute('data-doc-id');
            try {
              const r = await fetch(`/api/clientes/${cid}/documentos/${did}/arquivo`, { credentials: 'include' });
              if (!r.ok) { alert('Erro ao abrir documento.'); return; }
              const blob = await r.blob();
              const url = URL.createObjectURL(blob);
              window.open(url, '_blank');
            } catch (_) { alert('Erro ao abrir documento.'); }
          };
        });
        document.querySelectorAll('.btn-excluir-doc').forEach(btn => {
          btn.onclick = async function() {
            const cid = this.getAttribute('data-cliente-id');
            const did = this.getAttribute('data-doc-id');
            if (!confirm('Remover este documento?')) return;
            try {
              const r = await fetch(`/api/clientes/${cid}/documentos/${did}`, { method: 'DELETE', credentials: 'include' });
              if (r.ok) await carregarListaDocumentos(cid);
              else alert('Erro ao remover.');
            } catch (_) { alert('Erro ao remover.'); }
          };
        });
      } catch (_) {
        ul.innerHTML = '<li style="padding:12px;color:#dc2626;">Erro ao carregar documentos.</li>';
      }
    }
    
    function escapeHtml(s) {
      if (!s) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    
    function mostrarModalCliente(cli) {
      const conteudo = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px 20px;color:#1f2937;">
          <div><b>ID:</b><br>${cli.id ?? ''}</div>
          <div><b>Nome/Razão Social:</b><br>${cli.razao ?? ''}</div>
          <div><b>CPF/CNPJ:</b><br>${cli.cnpj ?? ''}</div>
          <div><b>IE:</b><br>${cli.ie ?? ''}</div>
          <div style="grid-column:1/3"><b>Endereço:</b><br>${cli.endereco ?? ''}</div>
          <div><b>Bairro:</b><br>${cli.bairro ?? ''}</div>
          <div><b>Cidade:</b><br>${cli.cidade ?? ''}</div>
          <div><b>Estado:</b><br>${cli.estado ?? ''}</div>
          <div><b>CEP:</b><br>${cli.cep ?? ''}</div>
          <div style="grid-column:1/3"><b>Email:</b><br>${cli.email ?? ''}</div>
          <div style="grid-column:1/3"><b>Telefone:</b><br>${cli.telefone ?? ''}</div>
          <div style="grid-column:1/3"><b>Transporte:</b><br>${cli.transporte ?? ''}</div>
          <div style="grid-column:1/3"><b>Prazo:</b><br>${cli.prazo ?? ''}</div>
          <div style="grid-column:1/3"><b>Observações:</b><br>${cli.obs ?? ''}</div>
        </div>
      `;
      document.getElementById('modal-cliente-conteudo').innerHTML = conteudo;
      document.getElementById('modal-cliente').style.display = 'block';
    }

    function preencherFormularioEdicao(cli) {
      document.getElementById('form-title').textContent = 'Editar Cliente';
      document.getElementById('razao').value = cli.razao || '';
      document.getElementById('cnpj').value = cli.cnpj || '';
      document.getElementById('ie').value = cli.ie || '';
      document.getElementById('endereco').value = cli.endereco || '';
      document.getElementById('bairro').value = cli.bairro || '';
      document.getElementById('cidade').value = cli.cidade || '';
      document.getElementById('estado').value = cli.estado || '';
      document.getElementById('cep').value = cli.cep || '';
      document.getElementById('email').value = cli.email || '';
      document.getElementById('telefone').value = cli.telefone || '';
      document.getElementById('transporte').value = cli.transporte || '';
      document.getElementById('prazo').value = cli.prazo || '';
      document.getElementById('obs').value = cli.obs || '';
      document.getElementById('cliente-id').value = cli.id;
      document.getElementById('btn-cancelar').style.display = '';
    }

    document.getElementById('btn-cancelar').onclick = function() {
      limparFormulario();
    };

    function limparFormulario() {
      document.getElementById('form-title').textContent = 'Cadastrar Novo Cliente';
      document.getElementById('cliente-form').reset();
      document.getElementById('cliente-id').value = '';
      document.getElementById('btn-cancelar').style.display = 'none';
    }

    document.getElementById('cliente-form').onsubmit = async function(e) {
      e.preventDefault();
      
      // Validar CPF/CNPJ antes de enviar
      const cnpjValue = document.getElementById('cnpj').value.replace(/\D/g, '');
      if (cnpjValue.length > 0 && !validarCPFCNPJ(cnpjValue)) {
        const continuar = window.confirm('O CPF/CNPJ informado parece estar invalido. Deseja continuar mesmo assim?');
        if (!continuar) {
          document.getElementById('cnpj').focus();
          return false;
        }
      }
      
      const cliente = {
        razao: document.getElementById('razao').value,
        cnpj: document.getElementById('cnpj').value,
        ie: document.getElementById('ie').value,
        endereco: document.getElementById('endereco').value,
        bairro: document.getElementById('bairro').value,
        cidade: document.getElementById('cidade').value,
        estado: document.getElementById('estado').value,
        cep: document.getElementById('cep').value,
        email: document.getElementById('email').value,
        telefone: document.getElementById('telefone').value,
        transporte: document.getElementById('transporte').value,
        prazo: document.getElementById('prazo').value,
        obs: document.getElementById('obs').value
      };
      const id = document.getElementById('cliente-id').value;
      try {
        if (id) {
          await fetch(`${API_URL}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cliente),
            credentials: 'include'
          });
          alert('Cliente atualizado com sucesso!');
        } else {
          await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cliente),
            credentials: 'include'
          });
          alert('Cliente cadastrado com sucesso!');
        }
        limparFormulario();
        await carregarClientes();
      } catch (err) {
        alert('Erro ao salvar cliente.');
      }
    };

    // Funções para formatação automática de CPF/CNPJ
    function formatarCPFCNPJ(valor) {
      // Remove tudo que nao e digito
      const numeros = valor.replace(/\D/g, '');
      
      // Se nao tem numeros, retorna vazio
      if (numeros.length === 0) {
        return '';
      }
      
      // Se tem 11 digitos ou menos, formata como CPF
      if (numeros.length <= 11) {
        if (numeros.length <= 3) {
          return numeros;
        } else if (numeros.length <= 6) {
          return numeros.replace(/(\d{3})(\d{0,3})/, '$1.$2');
        } else if (numeros.length <= 9) {
          return numeros.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
        } else {
          return numeros.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
        }
      }
      // Se tem 14 digitos ou menos, formata como CNPJ
      else if (numeros.length <= 14) {
        if (numeros.length <= 2) {
          return numeros;
        } else if (numeros.length <= 5) {
          return numeros.replace(/(\d{2})(\d{0,3})/, '$1.$2');
        } else if (numeros.length <= 8) {
          return numeros.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
        } else if (numeros.length <= 12) {
          return numeros.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
        } else {
          return numeros.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, '$1.$2.$3/$4-$5');
        }
      }
      // Se tem mais de 14 digitos, trunca para 14
      else {
        return numeros.substring(0, 14).replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
      }
    }

    function validarCPFCNPJ(valor) {
      const numeros = valor.replace(/\D/g, '');
      
      // Se nao tem numeros, nao e valido
      if (numeros.length === 0) {
        return false;
      }
      
      // Se tem menos de 11 digitos, nao e valido
      if (numeros.length < 11) {
        return false;
      }
      
      if (numeros.length === 11) {
        // Validacao basica de CPF
        if (numeros === '00000000000' || numeros === '11111111111' || 
            numeros === '22222222222' || numeros === '33333333333' || 
            numeros === '44444444444' || numeros === '55555555555' || 
            numeros === '66666666666' || numeros === '77777777777' || 
            numeros === '88888888888' || numeros === '99999999999') {
          return false;
        }
        
        // Validacao dos digitos verificadores do CPF
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(numeros.charAt(i)) * (10 - i);
        }
        let resto = 11 - (soma % 11);
        let digito1 = resto < 2 ? 0 : resto;
        
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(numeros.charAt(i)) * (11 - i);
        }
        resto = 11 - (soma % 11);
        let digito2 = resto < 2 ? 0 : resto;
        
        return parseInt(numeros.charAt(9)) === digito1 && parseInt(numeros.charAt(10)) === digito2;
      } else if (numeros.length === 14) {
        // Validacao basica de CNPJ
        if (numeros === '00000000000000' || numeros === '11111111111111' || 
            numeros === '22222222222222' || numeros === '33333333333333' || 
            numeros === '44444444444444' || numeros === '55555555555555' || 
            numeros === '66666666666666' || numeros === '77777777777777' || 
            numeros === '88888888888888' || numeros === '99999999999999') {
          return false;
        }
        
        // Validacao dos digitos verificadores do CNPJ
        let tamanho = numeros.length - 2;
        let numeros2 = numeros.substring(0, tamanho);
        let digitos = numeros.substring(tamanho);
        let soma = 0;
        let pos = tamanho - 7;
        
        for (let i = tamanho; i >= 1; i--) {
          soma += parseInt(numeros2.charAt(tamanho - i)) * pos--;
          if (pos < 2) pos = 9;
        }
        
        let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
        if (resultado !== parseInt(digitos.charAt(0))) return false;
        
        tamanho = tamanho + 1;
        numeros2 = numeros.substring(0, tamanho);
        soma = 0;
        pos = tamanho - 7;
        
        for (let i = tamanho; i >= 1; i--) {
          soma += parseInt(numeros2.charAt(tamanho - i)) * pos--;
          if (pos < 2) pos = 9;
        }
        
        resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
        return resultado === parseInt(digitos.charAt(1));
      }
      
      // Se tem mais de 14 digitos, nao e valido
      return false;
    }

    // Função para download do modelo de planilha
    function downloadModeloPlanilha() {
      // Dados do modelo
      const dados = [
        ['Razão Social', 'CPF/CNPJ', 'Inscrição Estadual', 'Endereço', 'Bairro', 'Cidade', 'Estado', 'CEP', 'Email', 'Telefone', 'Transporte', 'Prazo', 'Observações'],
        ['Empresa Exemplo Ltda', '12.345.678/0001-90', '123456789', 'Rua das Flores, 123', 'Centro', 'São Paulo', 'SP', '01234-567', 'contato@empresa.com', '(11) 99999-9999', 'Transportadora ABC', '30 dias', 'Cliente preferencial'],
        ['João Silva', '123.456.789-00', '', 'Av. Principal, 456', 'Jardim', 'Rio de Janeiro', 'RJ', '20000-000', 'joao@email.com', '(21) 88888-8888', 'Correios', '15 dias', ''],
        ['', '', '', '', '', '', '', '', '', '', '', '', '']
      ];

      // Criar workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(dados);

      // Ajustar largura das colunas
      const colWidths = [
        { wch: 25 }, // Razão Social
        { wch: 18 }, // CPF/CNPJ
        { wch: 15 }, // IE
        { wch: 30 }, // Endereço
        { wch: 15 }, // Bairro
        { wch: 15 }, // Cidade
        { wch: 5 },  // Estado
        { wch: 10 }, // CEP
        { wch: 25 }, // Email
        { wch: 15 }, // Telefone
        { wch: 20 }, // Transporte
        { wch: 10 }, // Prazo
        { wch: 30 }  // Observações
      ];
      ws['!cols'] = colWidths;

      // Adicionar planilha ao workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Modelo Clientes');

      // Download do arquivo
      XLSX.writeFile(wb, 'modelo_clientes.xlsx');
    }

    // Função para importar planilha
    async function importarPlanilha(event) {
      const file = event.target.files[0];
      const btn = document.getElementById('btn-importar-planilha');
      let originalText = btn ? btn.innerHTML : '';
      if (!file) return;

      try {
        // Mostrar loading
        if (btn) {
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
          btn.disabled = true;
        }

        const data = await readExcelFile(file);
        
        if (!data || data.length === 0) {
          alert('Nenhum dado encontrado na planilha.');
          return;
        }

        // Validar cabeçalhos
        const headers = data[0];
        const expectedHeaders = ['Razão Social', 'CPF/CNPJ', 'Inscrição Estadual', 'Endereço', 'Bairro', 'Cidade', 'Estado', 'CEP', 'Email', 'Telefone', 'Transporte', 'Prazo', 'Observações'];
        
        if (!validateHeaders(headers, expectedHeaders)) {
          alert('Formato da planilha inválido. Use o modelo fornecido.');
          return;
        }

        // Processar dados
        const clientesParaImportar = [];
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (row[0] && String(row[0]).trim()) { // Verificar se tem razão social
            const cliente = {
              razao: (row[0] != null ? String(row[0]).trim() : ''),
              cnpj: (row[1] != null ? String(row[1]).trim() : ''),
              ie: (row[2] != null ? String(row[2]).trim() : ''),
              endereco: (row[3] != null ? String(row[3]).trim() : ''),
              bairro: (row[4] != null ? String(row[4]).trim() : ''),
              cidade: (row[5] != null ? String(row[5]).trim() : ''),
              estado: (row[6] != null ? String(row[6]).trim() : ''),
              cep: (row[7] != null ? String(row[7]).trim() : ''),
              email: (row[8] != null ? String(row[8]).trim() : ''),
              telefone: (row[9] != null ? String(row[9]).trim() : ''),
              transporte: (row[10] != null ? String(row[10]).trim() : ''),
              prazo: (row[11] != null ? String(row[11]).trim() : ''),
              obs: (row[12] != null ? String(row[12]).trim() : '')
            };
            clientesParaImportar.push(cliente);
          }
        }

        if (clientesParaImportar.length === 0) {
          alert('Nenhum cliente válido encontrado na planilha.');
          return;
        }

        // Confirmar importação
        const confirmacao = confirm(`Encontrados ${clientesParaImportar.length} clientes para importar. Deseja continuar?`);
        if (!confirmacao) return;

        // Importar clientes
        let sucessos = 0;
        let erros = 0;

        for (const cliente of clientesParaImportar) {
          try {
            await fetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(cliente),
              credentials: 'include'
            });
            sucessos++;
          } catch (error) {
            console.error('Erro ao importar cliente:', cliente.razao, error);
            erros++;
          }
        }

        // Mostrar resultado
        alert(`Importação concluída!\nSucessos: ${sucessos}\nErros: ${erros}`);
        
        // Recarregar lista de clientes
        await carregarClientes();

      } catch (error) {
        console.error('Erro ao processar planilha:', error);
        alert('Erro ao processar a planilha. Verifique se o arquivo está no formato correto.');
      } finally {
        // Restaurar botão
        if (btn) {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
        // Limpar input
        event.target.value = '';
      }
    }

    // Função para ler arquivo Excel
    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            resolve(jsonData);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    // Função para validar cabeçalhos
    function validateHeaders(headers, expectedHeaders) {
      if (!headers || headers.length < expectedHeaders.length) {
        return false;
      }
      
      for (let i = 0; i < expectedHeaders.length; i++) {
        if (!headers[i] || headers[i].toString().trim() !== expectedHeaders[i]) {
          return false;
        }
      }
      
      return true;
    }

    // Adicionar event listener para formatacao automatica
    document.addEventListener('DOMContentLoaded', function() {
      const cnpjInput = document.getElementById('cnpj');
      
      cnpjInput.addEventListener('input', function(e) {
        const valor = e.target.value;
        const formatado = formatarCPFCNPJ(valor);
        e.target.value = formatado;
      });
      
      cnpjInput.addEventListener('blur', function(e) {
        const valor = e.target.value.replace(/\D/g, '');
        if (valor.length > 0 && !validarCPFCNPJ(valor)) {
          const continuar = window.confirm('CPF/CNPJ invalido! Deseja continuar mesmo assim?');
          if (!continuar) {
            setTimeout(() => {
              e.target.focus();
            }, 100);
          }
        }
      });
    });
  </script>
</body>
</html> 
