<!--
  RESPONSIVIDADE MOBILE:
  - Este arquivo já inclui <meta name="viewport"> e mobile.css para responsividade.
  - Use as classes .coluna-desnecessaria ou .hide-mobile em <th> ou <td> para esconder colunas no mobile.
  - Para navegação fixa no rodapé, utilize <nav class="mobile-nav">.
  - Mantenha sempre o mobile.css atualizado para melhor experiência mobile.
-->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Clientes - J.P Sistemas Comercial</title>
  <link rel="icon" href="https://i.imgur.com/QgVsPmF.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="mobile.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="app-layout">
    <!-- Header -->
    <header>
      <div class="header-content">
        <a href="index.html" class="logo">
          <h1>J.P Sistemas</h1>
        </a>
        <nav>
          <div class="user-info">
            <span>Bem-vindo, <span id="userDisplay"></span></span>
            <a href="sistema.html" class="nav-link">
              <i class="fas fa-sign-out-alt"></i> Sair
            </a>
          </div>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main>
      <div class="container">
        <!-- Dashboard -->
        <div class="dashboard">
          <div class="dashboard-header">
            <h1 class="dashboard-title">Gestão de Clientes</h1>
            <p class="dashboard-subtitle">Gerencie seus clientes e informações</p>
          </div>
        </div>

        <!-- Search Section -->
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-search"></i>
              Buscar Clientes
            </h2>
          </div>

          <div class="card">
            <div class="search-container">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <input type="text" id="searchInput" class="form-input" placeholder="Buscar por nome, CPF/CNPJ, telefone...">
                </div>
                <div>
                  <select id="filterStatus" class="form-input">
                    <option value="">Todos os status</option>
                    <option value="ativo">Ativo</option>
                    <option value="inativo">Inativo</option>
                  </select>
                </div>
                <div>
                  <button onclick="buscarClientes()" class="btn btn-primary">
                    <i class="fas fa-search"></i> Buscar
                  </button>
                  <button onclick="limparBusca()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Limpar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions Section -->
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-tools"></i>
              Ações
            </h2>
          </div>

          <div class="card">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <button onclick="abrirModalAdicionar()" class="btn btn-primary">
                <i class="fas fa-plus"></i> Adicionar Cliente
              </button>
              <button onclick="exportarClientes()" class="btn btn-secondary">
                <i class="fas fa-download"></i> Exportar
              </button>
              <button onclick="importarClientes()" class="btn btn-secondary">
                <i class="fas fa-upload"></i> Importar
              </button>
              <button onclick="voltarPainel()" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
            </div>
          </div>
        </div>

        <!-- Clients List Section -->
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-users"></i>
              Lista de Clientes
            </h2>
          </div>

          <div class="card">
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>Nome/Razão Social</th>
                    <th>CPF/CNPJ</th>
                    <th>Telefone</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="clientesTableBody">
                  <!-- Dados serão carregados dinamicamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer>
      <div class="container">
        <p class="text-center">&copy; 2024 J.P Sistemas. Todos os direitos reservados.</p>
      </div>
    </footer>
  </div>

  <!-- Modal Adicionar/Editar Cliente -->
  <div id="modalCliente" class="modal">
    <div class="modal-overlay" onclick="fecharModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Adicionar Cliente</h3>
        <button class="modal-close" onclick="fecharModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="clienteForm">
          <div class="form-group">
            <label for="nome">Nome/Razão Social *</label>
            <input type="text" id="nome" name="nome" class="form-input" required>
          </div>
          
          <div class="form-group">
            <label for="cpfCnpj">CPF/CNPJ</label>
            <input type="text" id="cpfCnpj" name="cpfCnpj" class="form-input">
          </div>
          
          <div class="form-group">
            <label for="telefone">Telefone</label>
            <input type="text" id="telefone" name="telefone" class="form-input">
          </div>
          
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" class="form-input">
          </div>
          
          <div class="form-group">
            <label for="endereco">Endereço</label>
            <input type="text" id="endereco" name="endereco" class="form-input">
          </div>
          
          <div class="form-group">
            <label for="cidade">Cidade</label>
            <input type="text" id="cidade" name="cidade" class="form-input">
          </div>
          
          <div class="form-group">
            <label for="estado">Estado</label>
            <input type="text" id="estado" name="estado" class="form-input">
          </div>
          
          <div class="form-group">
            <label for="cep">CEP</label>
            <input type="text" id="cep" name="cep" class="form-input">
          </div>
          
          <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status" class="form-input">
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="observacoes">Observações</label>
            <textarea id="observacoes" name="observacoes" class="form-input" rows="3"></textarea>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Salvar
            </button>
            <button type="button" onclick="fecharModal()" class="btn btn-secondary">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação -->
  <div id="modalConfirmacao" class="modal">
    <div class="modal-overlay" onclick="fecharModalConfirmacao()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirmar Ação</h3>
        <button class="modal-close" onclick="fecharModalConfirmacao()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirmacaoMensagem">Tem certeza que deseja realizar esta ação?</p>
        <div class="grid grid-cols-2 gap-4">
          <button onclick="confirmarAcao()" class="btn btn-danger">
            <i class="fas fa-check"></i> Confirmar
          </button>
          <button onclick="fecharModalConfirmacao()" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Input para importação de arquivo -->
  <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="processarImportacao(event)">

  <script>
    // Variáveis globais
    let clientes = [];
    let clienteEditando = null;
    let acaoConfirmacao = null;

    // Carregar informações do usuário
    document.addEventListener('DOMContentLoaded', function() {
      const user = JSON.parse(localStorage.getItem('user'));
      if (user && user.nome) {
        // Capitalizar primeira letra do nome
        const nomeCapitalizado = user.nome.charAt(0).toUpperCase() + user.nome.slice(1);
        document.getElementById('userDisplay').textContent = nomeCapitalizado;
      } else {
        document.getElementById('userDisplay').textContent = 'Usuário';
      }

      carregarClientes();
      configurarEventos();
    });

    // Verificar autenticação
    function checkAuth() {
      const user = localStorage.getItem('user');
      if (!user) {
        window.location.href = 'sistema.html';
      }
    }

    // Verificar autenticação ao carregar a página
    checkAuth();

    // Verificar autenticação periodicamente
    setInterval(checkAuth, 30000);

    // Configurar eventos
    function configurarEventos() {
      document.getElementById('searchInput').addEventListener('input', function() {
        buscarClientes();
      });

      document.getElementById('filterStatus').addEventListener('change', function() {
        buscarClientes();
      });

      document.getElementById('clienteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        salvarCliente();
      });
    }

    // Carregar clientes
    async function carregarClientes() {
      try {
        const response = await fetch('/api/clientes');
        clientes = await response.json();
        atualizarTabelaClientes(clientes);
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        mostrarNotificacao('Erro ao carregar clientes', 'error');
      }
    }

    // Atualizar tabela de clientes
    function atualizarTabelaClientes(listaClientes) {
      const tbody = document.getElementById('clientesTableBody');
      tbody.innerHTML = '';

      listaClientes.forEach(cliente => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${cliente.nome || cliente.razao || ''}</td>
          <td>${cliente.cpf || cliente.cnpj || ''}</td>
          <td>${cliente.telefone || ''}</td>
          <td>${cliente.email || ''}</td>
          <td>
            <span class="badge ${cliente.status === 'ativo' ? 'badge-success' : 'badge-warning'}">
              ${cliente.status || 'ativo'}
            </span>
          </td>
          <td>
            <button onclick="editarCliente('${cliente.id}')" class="btn btn-secondary">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="excluirCliente('${cliente.id}')" class="btn btn-danger">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Buscar clientes
    function buscarClientes() {
      const termo = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('filterStatus').value;

      const clientesFiltrados = clientes.filter(cliente => {
        const matchTermo = !termo || 
          (cliente.nome && cliente.nome.toLowerCase().includes(termo)) ||
          (cliente.razao && cliente.razao.toLowerCase().includes(termo)) ||
          (cliente.cpf && cliente.cpf.includes(termo)) ||
          (cliente.cnpj && cliente.cnpj.includes(termo)) ||
          (cliente.telefone && cliente.telefone.includes(termo));

        const matchStatus = !status || cliente.status === status;

        return matchTermo && matchStatus;
      });

      atualizarTabelaClientes(clientesFiltrados);
    }

    // Limpar busca
    function limparBusca() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterStatus').value = '';
      atualizarTabelaClientes(clientes);
    }

    // Abrir modal para adicionar cliente
    function abrirModalAdicionar() {
      clienteEditando = null;
      document.getElementById('modalTitle').textContent = 'Adicionar Cliente';
      document.getElementById('clienteForm').reset();
      document.getElementById('modalCliente').style.display = 'flex';
    }

    // Editar cliente
    function editarCliente(id) {
      const cliente = clientes.find(c => c.id === id);
      if (!cliente) return;

      clienteEditando = cliente;
      document.getElementById('modalTitle').textContent = 'Editar Cliente';
      
      // Preencher formulário
      document.getElementById('nome').value = cliente.nome || cliente.razao || '';
      document.getElementById('cpfCnpj').value = cliente.cpf || cliente.cnpj || '';
      document.getElementById('telefone').value = cliente.telefone || '';
      document.getElementById('email').value = cliente.email || '';
      document.getElementById('endereco').value = cliente.endereco || '';
      document.getElementById('cidade').value = cliente.cidade || '';
      document.getElementById('estado').value = cliente.estado || '';
      document.getElementById('cep').value = cliente.cep || '';
      document.getElementById('status').value = cliente.status || 'ativo';
      document.getElementById('observacoes').value = cliente.observacoes || '';

      document.getElementById('modalCliente').style.display = 'flex';
    }

    // Salvar cliente
    async function salvarCliente() {
      const formData = new FormData(document.getElementById('clienteForm'));
      const dados = Object.fromEntries(formData.entries());

      try {
        const url = clienteEditando ? `/api/clientes/${clienteEditando.id}` : '/api/clientes';
        const method = clienteEditando ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dados)
        });

        if (response.ok) {
          mostrarNotificacao(
            clienteEditando ? 'Cliente atualizado com sucesso!' : 'Cliente adicionado com sucesso!',
            'success'
          );
          fecharModal();
          carregarClientes();
        } else {
          throw new Error('Erro ao salvar cliente');
        }
      } catch (error) {
        console.error('Erro ao salvar cliente:', error);
        mostrarNotificacao('Erro ao salvar cliente', 'error');
      }
    }

    // Excluir cliente
    function excluirCliente(id) {
      const cliente = clientes.find(c => c.id === id);
      if (!cliente) return;

      acaoConfirmacao = () => confirmarExclusao(id);
      document.getElementById('confirmacaoMensagem').textContent = 
        `Tem certeza que deseja excluir o cliente "${cliente.nome || cliente.razao}"?`;
      document.getElementById('modalConfirmacao').style.display = 'flex';
    }

    // Confirmar exclusão
    async function confirmarExclusao(id) {
      try {
        const response = await fetch(`/api/clientes/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          mostrarNotificacao('Cliente excluído com sucesso!', 'success');
          carregarClientes();
        } else {
          throw new Error('Erro ao excluir cliente');
        }
      } catch (error) {
        console.error('Erro ao excluir cliente:', error);
        mostrarNotificacao('Erro ao excluir cliente', 'error');
      }
    }

    // Exportar clientes
    function exportarClientes() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(clientes.map(cliente => ({
        'Nome/Razão Social': cliente.nome || cliente.razao || '',
        'CPF/CNPJ': cliente.cpf || cliente.cnpj || '',
        'Telefone': cliente.telefone || '',
        'Email': cliente.email || '',
        'Endereço': cliente.endereco || '',
        'Cidade': cliente.cidade || '',
        'Estado': cliente.estado || '',
        'CEP': cliente.cep || '',
        'Status': cliente.status || 'ativo',
        'Observações': cliente.observacoes || ''
      })));

      XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
      XLSX.writeFile(wb, 'clientes.xlsx');
    }

    // Importar clientes
    function importarClientes() {
      document.getElementById('fileInput').click();
    }

    // Processar importação
    function processarImportacao(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);

          // Processar dados importados
          const clientesImportados = jsonData.map(row => ({
            nome: row['Nome/Razão Social'] || row['Nome'] || row['Razão Social'] || '',
            cpf: row['CPF/CNPJ'] || row['CPF'] || row['CNPJ'] || '',
            telefone: row['Telefone'] || '',
            email: row['Email'] || '',
            endereco: row['Endereço'] || row['Endereco'] || '',
            cidade: row['Cidade'] || '',
            estado: row['Estado'] || '',
            cep: row['CEP'] || '',
            status: row['Status'] || 'ativo',
            observacoes: row['Observações'] || row['Observacoes'] || ''
          }));

          // Salvar clientes importados
          salvarClientesImportados(clientesImportados);
        } catch (error) {
          console.error('Erro ao processar arquivo:', error);
          mostrarNotificacao('Erro ao processar arquivo', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Salvar clientes importados
    async function salvarClientesImportados(clientesImportados) {
      try {
        const response = await fetch('/api/clientes/importar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(clientesImportados)
        });

        if (response.ok) {
          mostrarNotificacao('Clientes importados com sucesso!', 'success');
          carregarClientes();
        } else {
          throw new Error('Erro ao importar clientes');
        }
      } catch (error) {
        console.error('Erro ao importar clientes:', error);
        mostrarNotificacao('Erro ao importar clientes', 'error');
      }
    }

    // Voltar para o painel
    function voltarPainel() {
      window.location.href = 'painel.html';
    }

    // Fechar modal
    function fecharModal() {
      document.getElementById('modalCliente').style.display = 'none';
      clienteEditando = null;
    }

    // Fechar modal de confirmação
    function fecharModalConfirmacao() {
      document.getElementById('modalConfirmacao').style.display = 'none';
      acaoConfirmacao = null;
    }

    // Confirmar ação
    function confirmarAcao() {
      if (acaoConfirmacao) {
        acaoConfirmacao();
      }
      fecharModalConfirmacao();
    }

    // Mostrar notificação
    function mostrarNotificacao(mensagem, tipo) {
      const notification = document.createElement('div');
      notification.className = `notification notification-${tipo}`;
      notification.innerHTML = `
        <div class="notification-content">
          <span>${mensagem}</span>
          <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 5000);
    }

    // Fechar modais ao clicar fora
    window.onclick = function(event) {
      const modalCliente = document.getElementById('modalCliente');
      const modalConfirmacao = document.getElementById('modalConfirmacao');
      
      if (event.target === modalCliente) {
        fecharModal();
      }
      if (event.target === modalConfirmacao) {
        fecharModalConfirmacao();
      }
    };
  </script>
</body>
</html> 
