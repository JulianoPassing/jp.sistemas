<!--
  RESPONSIVIDADE MOBILE:
  - Este arquivo já inclui <meta name="viewport"> e mobile.css para responsividade.
  - Use as classes .coluna-desnecessaria ou .hide-mobile em <th> ou <td> para esconder colunas no mobile.
  - Para navegação fixa no rodapé, utilize <nav class="mobile-nav">.
  - Mantenha sempre o mobile.css atualizado para melhor experiência mobile.
-->
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestao de Produtos - J.P Sistemas Comercial</title>
    <link rel="icon" href="https://i.imgur.com/QgVsPmF.png" type="image/png" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="mobile.css">
  </head>
  <body>
    <div class="app-layout">
      <!-- Header -->
      <header>
        <div class="header-content">
          <a href="index.html" class="logo">
            <h1>J.P Sistemas</h1>
          </a>
          <nav>
            <div class="user-info">
              <span>Bem-vindo, <span id="userDisplay"></span></span>
              <a href="sistema.html" class="nav-link">
                <i class="fas fa-sign-out-alt"></i> Sair
              </a>
            </div>
          </nav>
        </div>
      </header>

      <!-- Main Content -->
      <main>
        <div class="container">
          <!-- Dashboard -->
          <div class="dashboard">
            <div class="dashboard-header">
              <h1 class="dashboard-title">Gestão de Produtos</h1>
              <p class="dashboard-subtitle">Gerencie seu catálogo de produtos</p>
            </div>
          </div>

          <!-- Search Section -->
          <div class="section">
            <div class="section-header">
              <h2 class="section-title">
                <i class="fas fa-search"></i>
                Buscar Produtos
              </h2>
            </div>

            <div class="card">
              <div class="search-container">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <input type="text" id="searchInput" class="form-input" placeholder="Buscar por nome, código...">
                  </div>
                  <div>
                    <select id="filterCategoria" class="form-input">
                      <option value="">Todas as categorias</option>
                      <option value="bebidas">Bebidas</option>
                      <option value="comidas">Comidas</option>
                      <option value="sobremesas">Sobremesas</option>
                      <option value="outros">Outros</option>
                    </select>
                  </div>
                  <div>
                    <button onclick="buscarProdutos()" class="btn btn-primary">
                      <i class="fas fa-search"></i> Buscar
                    </button>
                    <button onclick="limparBusca()" class="btn btn-secondary">
                      <i class="fas fa-times"></i> Limpar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions Section -->
          <div class="section">
            <div class="section-header">
              <h2 class="section-title">
                <i class="fas fa-tools"></i>
                Ações
              </h2>
            </div>

            <div class="card">
              <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <button onclick="abrirModalAdicionar()" class="btn btn-primary">
                  <i class="fas fa-plus"></i> Adicionar Produto
                </button>
                <button onclick="importarProdutos()" class="btn btn-secondary">
                  <i class="fas fa-upload"></i> Importar
                </button>
                <button onclick="exportarProdutos()" class="btn btn-secondary">
                  <i class="fas fa-download"></i> Exportar
                </button>
                <button onclick="gerarRelatorio()" class="btn btn-secondary">
                  <i class="fas fa-chart-bar"></i> Relatório
                </button>
                <button onclick="voltarPainel()" class="btn btn-secondary">
                  <i class="fas fa-arrow-left"></i> Voltar
                </button>
              </div>
            </div>
          </div>

          <!-- Products List Section -->
          <div class="section">
            <div class="section-header">
              <h2 class="section-title">
                <i class="fas fa-boxes"></i>
                Lista de Produtos
              </h2>
            </div>

            <div class="card">
              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Nome</th>
                      <th>Código</th>
                      <th>Categoria</th>
                      <th>Preço</th>
                      <th>Estoque</th>
                      <th>Status</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody id="produtosTableBody">
                    <!-- Dados serão carregados dinamicamente -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer>
        <div class="container">
          <p class="text-center">&copy; 2024 J.P Sistemas. Todos os direitos reservados.</p>
        </div>
      </footer>
    </div>

    <!-- Modal Adicionar/Editar Produto -->
    <div id="modalProduto" class="modal">
      <div class="modal-overlay" onclick="fecharModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Adicionar Produto</h3>
          <button class="modal-close" onclick="fecharModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="produtoForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="form-group">
                <label for="nome">Nome do Produto *</label>
                <input type="text" id="nome" name="nome" class="form-input" required>
              </div>
              
              <div class="form-group">
                <label for="codigo">Código</label>
                <input type="text" id="codigo" name="codigo" class="form-input">
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="form-group">
                <label for="categoria">Categoria</label>
                <select id="categoria" name="categoria" class="form-input">
                  <option value="">Selecione uma categoria</option>
                  <option value="bebidas">Bebidas</option>
                  <option value="comidas">Comidas</option>
                  <option value="sobremesas">Sobremesas</option>
                  <option value="outros">Outros</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="preco">Preço *</label>
                <input type="number" id="preco" name="preco" class="form-input" required step="0.01" min="0">
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="form-group">
                <label for="estoque">Estoque</label>
                <input type="number" id="estoque" name="estoque" class="form-input" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="estoqueMinimo">Estoque Mínimo</label>
                <input type="number" id="estoqueMinimo" name="estoqueMinimo" class="form-input" min="0" value="0">
              </div>
            </div>
            
            <div class="form-group">
              <label for="descricao">Descrição</label>
              <textarea id="descricao" name="descricao" class="form-input" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label for="status">Status</label>
              <select id="status" name="status" class="form-input">
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
              </select>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Salvar
              </button>
              <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="modalConfirmacao" class="modal">
      <div class="modal-overlay" onclick="fecharModalConfirmacao()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Confirmar Ação</h3>
          <button class="modal-close" onclick="fecharModalConfirmacao()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <p id="confirmacaoMensagem">Tem certeza que deseja realizar esta ação?</p>
          <div class="grid grid-cols-2 gap-4">
            <button onclick="confirmarAcao()" class="btn btn-danger">
              <i class="fas fa-check"></i> Confirmar
            </button>
            <button onclick="fecharModalConfirmacao()" class="btn btn-secondary">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Input para importação de arquivo -->
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="processarImportacao(event)">

    <script>
      // Variáveis globais
      let produtos = [];
      let produtoEditando = null;
      let acaoConfirmacao = null;

      // Carregar informações do usuário
      document.addEventListener('DOMContentLoaded', function() {
        const user = JSON.parse(localStorage.getItem('user'));
        if (user && user.nome) {
          // Capitalizar primeira letra do nome
          const nomeCapitalizado = user.nome.charAt(0).toUpperCase() + user.nome.slice(1);
          document.getElementById('userDisplay').textContent = nomeCapitalizado;
        } else {
          document.getElementById('userDisplay').textContent = 'Usuário';
        }

        carregarProdutos();
        configurarEventos();
      });

      // Verificar autenticação
      function checkAuth() {
        const user = localStorage.getItem('user');
        if (!user) {
          window.location.href = 'sistema.html';
        }
      }

      // Verificar autenticação ao carregar a página
      checkAuth();

      // Verificar autenticação periodicamente
      setInterval(checkAuth, 30000);

      // Configurar eventos
      function configurarEventos() {
        document.getElementById('searchInput').addEventListener('input', function() {
          buscarProdutos();
        });

        document.getElementById('filterCategoria').addEventListener('change', function() {
          buscarProdutos();
        });

        document.getElementById('produtoForm').addEventListener('submit', function(e) {
          e.preventDefault();
          salvarProduto();
        });
      }

      // Carregar produtos
      async function carregarProdutos() {
        try {
          const response = await fetch('/api/produtos');
          produtos = await response.json();
          atualizarTabelaProdutos(produtos);
        } catch (error) {
          console.error('Erro ao carregar produtos:', error);
          mostrarNotificacao('Erro ao carregar produtos', 'error');
        }
      }

      // Atualizar tabela de produtos
      function atualizarTabelaProdutos(listaProdutos) {
        const tbody = document.getElementById('produtosTableBody');
        tbody.innerHTML = '';

        listaProdutos.forEach(produto => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${produto.nome}</td>
            <td>${produto.codigo || '-'}</td>
            <td>${produto.categoria || '-'}</td>
            <td>R$ ${parseFloat(produto.preco).toFixed(2)}</td>
            <td>
              <span class="${produto.estoque <= (produto.estoque_minimo || 0) ? 'text-red-600' : 'text-green-600'}">
                ${produto.estoque || 0}
              </span>
            </td>
            <td>
              <span class="badge ${produto.status === 'ativo' ? 'badge-success' : 'badge-warning'}">
                ${produto.status || 'ativo'}
              </span>
            </td>
            <td>
              <button onclick="editarProduto('${produto.id}')" class="btn btn-secondary">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="excluirProduto('${produto.id}')" class="btn btn-danger">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      // Buscar produtos
      function buscarProdutos() {
        const termo = document.getElementById('searchInput').value.toLowerCase();
        const categoria = document.getElementById('filterCategoria').value;

        const produtosFiltrados = produtos.filter(produto => {
          const matchTermo = !termo || 
            (produto.nome && produto.nome.toLowerCase().includes(termo)) ||
            (produto.codigo && produto.codigo.toLowerCase().includes(termo));

          const matchCategoria = !categoria || produto.categoria === categoria;

          return matchTermo && matchCategoria;
        });

        atualizarTabelaProdutos(produtosFiltrados);
      }

      // Limpar busca
      function limparBusca() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterCategoria').value = '';
        atualizarTabelaProdutos(produtos);
      }

      // Abrir modal para adicionar produto
      function abrirModalAdicionar() {
        produtoEditando = null;
        document.getElementById('modalTitle').textContent = 'Adicionar Produto';
        document.getElementById('produtoForm').reset();
        document.getElementById('modalProduto').style.display = 'flex';
      }

      // Editar produto
      function editarProduto(id) {
        const produto = produtos.find(p => p.id === id);
        if (!produto) return;

        produtoEditando = produto;
        document.getElementById('modalTitle').textContent = 'Editar Produto';
        
        // Preencher formulário
        document.getElementById('nome').value = produto.nome || '';
        document.getElementById('codigo').value = produto.codigo || '';
        document.getElementById('categoria').value = produto.categoria || '';
        document.getElementById('preco').value = produto.preco || '';
        document.getElementById('estoque').value = produto.estoque || 0;
        document.getElementById('estoqueMinimo').value = produto.estoque_minimo || 0;
        document.getElementById('descricao').value = produto.descricao || '';
        document.getElementById('status').value = produto.status || 'ativo';

        document.getElementById('modalProduto').style.display = 'flex';
      }

      // Salvar produto
      async function salvarProduto() {
        const formData = new FormData(document.getElementById('produtoForm'));
        const dados = Object.fromEntries(formData.entries());

        try {
          const url = produtoEditando ? `/api/produtos/${produtoEditando.id}` : '/api/produtos';
          const method = produtoEditando ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
          });

          if (response.ok) {
            mostrarNotificacao(
              produtoEditando ? 'Produto atualizado com sucesso!' : 'Produto adicionado com sucesso!',
              'success'
            );
            fecharModal();
            carregarProdutos();
          } else {
            throw new Error('Erro ao salvar produto');
          }
        } catch (error) {
          console.error('Erro ao salvar produto:', error);
          mostrarNotificacao('Erro ao salvar produto', 'error');
        }
      }

      // Excluir produto
      function excluirProduto(id) {
        const produto = produtos.find(p => p.id === id);
        if (!produto) return;

        acaoConfirmacao = () => confirmarExclusao(id);
        document.getElementById('confirmacaoMensagem').textContent = 
          `Tem certeza que deseja excluir o produto "${produto.nome}"?`;
        document.getElementById('modalConfirmacao').style.display = 'flex';
      }

      // Confirmar exclusão
      async function confirmarExclusao(id) {
        try {
          const response = await fetch(`/api/produtos/${id}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            mostrarNotificacao('Produto excluído com sucesso!', 'success');
            carregarProdutos();
          } else {
            throw new Error('Erro ao excluir produto');
          }
        } catch (error) {
          console.error('Erro ao excluir produto:', error);
          mostrarNotificacao('Erro ao excluir produto', 'error');
        }
      }

      // Importar produtos
      function importarProdutos() {
        document.getElementById('fileInput').click();
      }

      // Processar importação
      function processarImportacao(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // Aqui você implementaria a lógica para processar o arquivo
            // Por simplicidade, vamos apenas mostrar uma notificação
            mostrarNotificacao('Funcionalidade de importação em desenvolvimento', 'info');
          } catch (error) {
            console.error('Erro ao processar arquivo:', error);
            mostrarNotificacao('Erro ao processar arquivo', 'error');
          }
        };
        reader.readAsText(file);
      }

      // Exportar produtos
      function exportarProdutos() {
        const produtosParaExportar = produtos.map(produto => ({
          'Nome': produto.nome,
          'Código': produto.codigo || '',
          'Categoria': produto.categoria || '',
          'Preço': `R$ ${parseFloat(produto.preco).toFixed(2)}`,
          'Estoque': produto.estoque || 0,
          'Estoque Mínimo': produto.estoque_minimo || 0,
          'Status': produto.status || 'ativo',
          'Descrição': produto.descricao || ''
        }));

        // Criar CSV
        const headers = Object.keys(produtosParaExportar[0]);
        const csvContent = [
          headers.join(','),
          ...produtosParaExportar.map(row => 
            headers.map(header => `"${row[header]}"`).join(',')
          )
        ].join('\n');

        // Download do arquivo
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'produtos.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        mostrarNotificacao('Produtos exportados com sucesso!', 'success');
      }

      // Gerar relatório
      function gerarRelatorio() {
        const totalProdutos = produtos.length;
        const produtosAtivos = produtos.filter(p => p.status === 'ativo').length;
        const produtosComEstoqueBaixo = produtos.filter(p => 
          p.estoque <= (p.estoque_minimo || 0)
        ).length;
        const valorTotalEstoque = produtos.reduce((acc, p) => 
          acc + (parseFloat(p.preco) * (p.estoque || 0)), 0
        );

        const relatorio = `
          RELATÓRIO DE PRODUTOS
          
          Total de Produtos: ${totalProdutos}
          Produtos Ativos: ${produtosAtivos}
          Produtos com Estoque Baixo: ${produtosComEstoqueBaixo}
          Valor Total em Estoque: R$ ${valorTotalEstoque.toFixed(2)}
          
          Gerado em: ${new Date().toLocaleString('pt-BR')}
        `;

        alert(relatorio);
      }

      // Voltar para o painel
      function voltarPainel() {
        window.location.href = 'painel.html';
      }

      // Fechar modal
      function fecharModal() {
        document.getElementById('modalProduto').style.display = 'none';
        produtoEditando = null;
      }

      // Fechar modal de confirmação
      function fecharModalConfirmacao() {
        document.getElementById('modalConfirmacao').style.display = 'none';
        acaoConfirmacao = null;
      }

      // Confirmar ação
      function confirmarAcao() {
        if (acaoConfirmacao) {
          acaoConfirmacao();
        }
        fecharModalConfirmacao();
      }

      // Mostrar notificação
      function mostrarNotificacao(mensagem, tipo) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${tipo}`;
        notification.innerHTML = `
          <div class="notification-content">
            <span>${mensagem}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 5000);
      }

      // Fechar modais ao clicar fora
      window.onclick = function(event) {
        const modalProduto = document.getElementById('modalProduto');
        const modalConfirmacao = document.getElementById('modalConfirmacao');
        
        if (event.target === modalProduto) {
          fecharModal();
        }
        if (event.target === modalConfirmacao) {
          fecharModalConfirmacao();
        }
      };

      // Checagem de autenticação via cookie/JWT
      async function checkAuthAndUser() {
        try {
          const res = await fetch('/api/auth/user', { credentials: 'include' });
          if (!res.ok) throw new Error('Não autenticado');
          const data = await res.json();
          if (data && data.nome) {
            // Capitalizar primeira letra do nome
            const nomeCapitalizado = data.nome.charAt(0).toUpperCase() + data.nome.slice(1);
            document.getElementById('userDisplay').textContent = nomeCapitalizado;
          } else {
            document.getElementById('userDisplay').textContent = 'Usuário';
          }
        } catch (e) {
          window.location.href = 'sistema.html';
        }
      }
      document.addEventListener('DOMContentLoaded', checkAuthAndUser);
      setInterval(checkAuthAndUser, 30000); // Verificar a cada 30 segundos
    </script>
  </body>
</html>
