# Sistema Multi-Tenancy - JP CobranÃ§as

## VisÃ£o Geral

O Sistema JP CobranÃ§as agora implementa **multi-tenancy completo** onde cada usuÃ¡rio possui seu prÃ³prio banco de dados isolado. Isso garante:

- **Isolamento total** de dados entre usuÃ¡rios
- **SeguranÃ§a mÃ¡xima** - dados de um usuÃ¡rio nunca podem ser acessados por outro
- **Escalabilidade** - cada usuÃ¡rio pode ter seu prÃ³prio crescimento de dados
- **Backup individual** - cada banco pode ser backupado separadamente
- **Performance otimizada** - consultas mais rÃ¡pidas em bancos menores

## Arquitetura Implementada

### Estrutura de Bancos de Dados

```
MariaDB Server
â”œâ”€â”€ jpsistemas_users (Banco central de usuÃ¡rios)
â”‚   â””â”€â”€ usuarios_cobrancas (Tabela de autenticaÃ§Ã£o)
â”œâ”€â”€ jpsistemas_sessions (Banco de sessÃµes)
â”‚   â””â”€â”€ sessions (Tabela de sessÃµes ativas)
â”œâ”€â”€ jpsistemas_diego (Banco individual do usuÃ¡rio diego)
â”‚   â”œâ”€â”€ clientes_cobrancas
â”‚   â”œâ”€â”€ emprestimos
â”‚   â”œâ”€â”€ cobrancas
â”‚   â””â”€â”€ pagamentos
â”œâ”€â”€ jpsistemas_cobranca (Banco individual do usuÃ¡rio cobranca)
â”‚   â”œâ”€â”€ clientes_cobrancas
â”‚   â”œâ”€â”€ emprestimos
â”‚   â”œâ”€â”€ cobrancas
â”‚   â””â”€â”€ pagamentos
â””â”€â”€ ... (um banco por usuÃ¡rio)
```

### Nomenclatura dos Bancos

O nome do banco de dados de cada usuÃ¡rio segue o padrÃ£o:
```
jpsistemas_{username}
```

Exemplo:
- UsuÃ¡rio: `diego` â†’ Banco: `jpsistemas_diego`
- UsuÃ¡rio: `cobranca` â†’ Banco: `jpsistemas_cobranca`
- UsuÃ¡rio: `maria_silva` â†’ Banco: `jpsistemas_maria_silva`

## ImplementaÃ§Ã£o TÃ©cnica

### 1. FunÃ§Ã£o de ConexÃ£o Multi-Tenant

```javascript
// FunÃ§Ã£o para criar conexÃ£o com banco de cobranÃ§as do usuÃ¡rio
async function createCobrancasConnection(username) {
  const dbName = `jpsistemas_${username.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
  const dbConfig = {
    host: process.env.DB_HOST || 'localhost',
    user: process.env.DB_USER || 'jpsistemas',
    password: process.env.DB_PASSWORD || 'SuaSenhaForte123!',
    database: dbName,
    charset: 'utf8mb4'
  };
  
  try {
    const connection = await mysql.createConnection(dbConfig);
    return connection;
  } catch (error) {
    console.error(`Erro ao conectar ao banco de cobranÃ§as do usuÃ¡rio ${username}:`, error);
    throw error;
  }
}
```

### 2. CriaÃ§Ã£o AutomÃ¡tica de Bancos

```javascript
// FunÃ§Ã£o para criar banco de dados de cobranÃ§as do usuÃ¡rio
async function createCobrancasDatabase(username) {
  const dbName = `jpsistemas_${username.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
  
  try {
    // Conectar como root para criar o banco
    const rootConnection = await mysql.createConnection({
      host: process.env.DB_HOST || 'localhost',
      user: process.env.DB_USER || 'jpsistemas',
      password: process.env.DB_PASSWORD || 'SuaSenhaForte123!',
      charset: 'utf8mb4'
    });

    // Criar banco de dados
    await rootConnection.execute(`CREATE DATABASE IF NOT EXISTS \`${dbName}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci`);
    
    // Conectar ao banco criado e criar tabelas
    const cobrancasConnection = await createCobrancasConnection(username);
    
    // Criar todas as tabelas necessÃ¡rias...
    
    await rootConnection.end();
    await cobrancasConnection.end();
    
    console.log(`Banco de dados ${dbName} criado com sucesso para o usuÃ¡rio ${username}`);
    return true;
  } catch (error) {
    console.error(`Erro ao criar banco de dados de cobranÃ§as para ${username}:`, error);
    throw error;
  }
}
```

### 3. Middleware de AutenticaÃ§Ã£o

```javascript
// Middleware para inicializar banco se necessÃ¡rio
async function ensureDatabase(req, res, next) {
  try {
    const username = req.session.cobrancasUser;
    if (!username) {
      return res.status(401).json({ error: 'UsuÃ¡rio nÃ£o autenticado' });
    }
    await createCobrancasDatabase(username);
    next();
  } catch (error) {
    console.error('Erro ao garantir banco de dados:', error);
    res.status(500).json({ error: 'Erro interno do servidor' });
  }
}
```

### 4. Rotas Multi-Tenant

Todas as rotas agora usam o banco especÃ­fico do usuÃ¡rio:

```javascript
// Exemplo: Rota de clientes
router.get('/clientes', ensureDatabase, async (req, res) => {
  try {
    const username = req.session.cobrancasUser;
    const connection = await createCobrancasConnection(username);
    const [clientes] = await connection.execute(`
      SELECT * FROM clientes_cobrancas 
      ORDER BY nome ASC
    `);
    await connection.end();
    res.json(clientes);
  } catch (error) {
    console.error('Erro ao buscar clientes:', error);
    res.status(500).json({ error: 'Erro interno do servidor' });
  }
});
```

## Fluxo de AutenticaÃ§Ã£o

### 1. Login do UsuÃ¡rio
```javascript
POST /api/cobrancas/login
{
  "username": "diego",
  "password": "diego123"
}
```

### 2. VerificaÃ§Ã£o de Credenciais
- Sistema verifica credenciais no banco `jpsistemas_users`
- Se vÃ¡lido, verifica se o banco `jpsistemas_diego` existe
- Se nÃ£o existir, cria automaticamente

### 3. CriaÃ§Ã£o da SessÃ£o
```javascript
// Criar banco de dados do usuÃ¡rio se nÃ£o existir
await createCobrancasDatabase(username);

// Salva na sessÃ£o o usuÃ¡rio
req.session.cobrancasUser = username;
req.session.cobrancasDb = `jpsistemas_${username.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
```

### 4. Acesso aos Dados
Todas as requisiÃ§Ãµes subsequentes usam o banco especÃ­fico do usuÃ¡rio:
```javascript
const username = req.session.cobrancasUser;
const connection = await createCobrancasConnection(username);
```

## Tabelas por Banco de UsuÃ¡rio

Cada banco de usuÃ¡rio contÃ©m as seguintes tabelas:

### 1. `clientes_cobrancas`
```sql
CREATE TABLE clientes_cobrancas (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome VARCHAR(255) NOT NULL,
  cpf_cnpj VARCHAR(18),
  email VARCHAR(255),
  telefone VARCHAR(20),
  endereco VARCHAR(255),
  cidade VARCHAR(100),
  estado VARCHAR(2),
  cep VARCHAR(9),
  status VARCHAR(50) DEFAULT 'Ativo',
  observacoes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_nome (nome),
  INDEX idx_cpf_cnpj (cpf_cnpj),
  INDEX idx_email (email),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

### 2. `emprestimos`
```sql
CREATE TABLE emprestimos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  cliente_id INT,
  valor DECIMAL(10,2) NOT NULL,
  data_emprestimo DATE NOT NULL,
  data_vencimento DATE NOT NULL,
  juros_mensal DECIMAL(5,2) DEFAULT 0.00,
  multa_atraso DECIMAL(5,2) DEFAULT 0.00,
  status VARCHAR(50) DEFAULT 'Ativo',
  observacoes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (cliente_id) REFERENCES clientes_cobrancas(id) ON DELETE SET NULL,
  INDEX idx_cliente_id (cliente_id),
  INDEX idx_data_vencimento (data_vencimento),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

### 3. `cobrancas`
```sql
CREATE TABLE cobrancas (
  id INT AUTO_INCREMENT PRIMARY KEY,
  emprestimo_id INT,
  cliente_id INT,
  valor_original DECIMAL(10,2) NOT NULL,
  valor_atualizado DECIMAL(10,2) NOT NULL,
  juros_calculados DECIMAL(10,2) DEFAULT 0.00,
  multa_calculada DECIMAL(10,2) DEFAULT 0.00,
  data_vencimento DATE NOT NULL,
  dias_atraso INT DEFAULT 0,
  status VARCHAR(50) DEFAULT 'Pendente',
  data_cobranca DATE,
  observacoes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (emprestimo_id) REFERENCES emprestimos(id) ON DELETE SET NULL,
  FOREIGN KEY (cliente_id) REFERENCES clientes_cobrancas(id) ON DELETE SET NULL,
  INDEX idx_emprestimo_id (emprestimo_id),
  INDEX idx_cliente_id (cliente_id),
  INDEX idx_data_vencimento (data_vencimento),
  INDEX idx_status (status),
  INDEX idx_dias_atraso (dias_atraso)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

### 4. `pagamentos`
```sql
CREATE TABLE pagamentos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  cobranca_id INT,
  valor_pago DECIMAL(10,2) NOT NULL,
  data_pagamento DATE NOT NULL,
  forma_pagamento VARCHAR(50),
  observacoes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (cobranca_id) REFERENCES cobrancas(id) ON DELETE SET NULL,
  INDEX idx_cobranca_id (cobranca_id),
  INDEX idx_data_pagamento (data_pagamento)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

## Vantagens do Multi-Tenancy

### ğŸ”’ SeguranÃ§a
- **Isolamento total**: Dados de um usuÃ¡rio nunca podem ser acessados por outro
- **Sem vazamento**: Mesmo se houver bug no cÃ³digo, dados ficam isolados
- **Auditoria**: Cada banco pode ser auditado independentemente

### ğŸ“ˆ Escalabilidade
- **Crescimento individual**: Cada usuÃ¡rio pode ter quantos dados quiser
- **Performance**: Consultas sÃ£o mais rÃ¡pidas (banco menor)
- **ManutenÃ§Ã£o**: Problemas em um banco nÃ£o afetam outros

### ğŸ’¾ Backup e Restore
- **Backup granular**: Pode fazer backup de usuÃ¡rios especÃ­ficos
- **Restore seletivo**: Pode restaurar apenas um usuÃ¡rio
- **MigraÃ§Ã£o**: Pode mover usuÃ¡rios entre servidores facilmente

## Comandos de AdministraÃ§Ã£o

### Listar Todos os Bancos de UsuÃ¡rios
```sql
SHOW DATABASES LIKE 'jpsistemas_%';
```

### Verificar Tamanho dos Bancos
```sql
SELECT 
  table_schema AS 'Database',
  ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)',
  COUNT(*) AS 'Tables'
FROM information_schema.tables 
WHERE table_schema LIKE 'jpsistemas_%'
GROUP BY table_schema
ORDER BY SUM(data_length + index_length) DESC;
```

### Backup de UsuÃ¡rio EspecÃ­fico
```bash
# Usando mysqldump
mysqldump -u jpsistemas -p --single-transaction --routines --triggers \
  --default-character-set=utf8mb4 jpsistemas_diego > backup_diego.sql

# Usando MariaBackup (mais rÃ¡pido)
mariabackup --backup --target-dir=/tmp/backup_diego \
  --user=jpsistemas --password=SuaSenhaForte123! \
  --databases=jpsistemas_diego
```

### Restore de UsuÃ¡rio EspecÃ­fico
```bash
# Usando mysql
mysql -u jpsistemas -p jpsistemas_diego < backup_diego.sql

# Usando MariaBackup
mariabackup --copy-back --target-dir=/tmp/backup_diego
```

### Remover UsuÃ¡rio e Seus Dados
```sql
DROP DATABASE jpsistemas_diego;
DELETE FROM jpsistemas_users.usuarios_cobrancas WHERE username = 'diego';
```

## Script de Teste

**Arquivo:** `scripts/test-multi-tenancy.js`

Este script testa:
- Se o sistema estÃ¡ rodando
- Se o login funciona para diferentes usuÃ¡rios
- Se os bancos de dados sÃ£o criados corretamente
- Se as tabelas existem em cada banco
- Se o isolamento de dados estÃ¡ funcionando

## Como Testar

### 1. Via Script
```bash
cd /caminho/para/jp.sistemas
node scripts/test-multi-tenancy.js
```

### 2. Via Navegador
1. Abra: `http://localhost:3000/jp.cobrancas/login.html`
2. FaÃ§a login com: `diego` / `diego123`
3. Crie alguns clientes e emprÃ©stimos
4. FaÃ§a logout
5. FaÃ§a login com: `cobranca` / `cobranca123`
6. Verifique se nÃ£o vÃª os dados do diego
7. Crie dados prÃ³prios
8. FaÃ§a logout e login novamente com diego
9. Verifique se nÃ£o vÃª os dados do cobranca

## Resultado Esperado

âœ… **Isolamento total**: Cada usuÃ¡rio vÃª apenas seus prÃ³prios dados
âœ… **Bancos separados**: `jpsistemas_diego` e `jpsistemas_cobranca`
âœ… **CriaÃ§Ã£o automÃ¡tica**: Bancos e tabelas criados automaticamente
âœ… **Performance**: Consultas mais rÃ¡pidas
âœ… **SeguranÃ§a**: Dados completamente isolados

## BenefÃ­cios Implementados

1. **SeguranÃ§a mÃ¡xima**: Isolamento total de dados
2. **Escalabilidade**: Cada usuÃ¡rio pode crescer independentemente
3. **Manutenibilidade**: Problemas isolados por usuÃ¡rio
4. **Backup granular**: Backup individual por usuÃ¡rio
5. **Performance**: Consultas mais eficientes

## PrÃ³ximos Passos

1. Testar o sistema multi-tenancy
2. Verificar isolamento de dados
3. Configurar backup automÃ¡tico
4. Monitorar performance
5. Documentar procedimentos de manutenÃ§Ã£o

---

**Status:** âœ… **IMPLEMENTADO**
**Data:** $(date)
**ResponsÃ¡vel:** Assistente IA 